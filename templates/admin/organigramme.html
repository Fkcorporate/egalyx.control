{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="fas fa-sitemap text-primary me-2"></i>
            Organigramme de l'entreprise
        </h1>
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-download me-2"></i>Exporter
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <a class="dropdown-item" href="{{ url_for('admin_organigramme_pdf') }}">
                        <i class="fas fa-file-pdf text-danger me-2"></i>PDF (impression)
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="{{ url_for('admin_organigramme_png') }}">
                        <i class="fas fa-file-image text-success me-2"></i>PNG (image)
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="{{ url_for('admin_organigramme_exporter', format='html') }}">
                        <i class="fas fa-file-code text-primary me-2"></i>HTML (web)
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="#" onclick="imprimerOrganigramme()">
                        <i class="fas fa-print text-secondary me-2"></i>Imprimer
                    </a>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Conteneur pour l'organigramme -->
    <div class="organigramme-container bg-white p-4 rounded shadow">
        {% if organigramme_html %}
            {{ organigramme_html|safe }}
        {% else %}
            <iframe srcdoc="{{ organigramme_html|e }}" style="width: 100%; height: 800px; border: none;"></iframe>
        {% endif %}
    </div>
</div>

<!-- Modal de configuration -->
<div class="modal fade" id="configOrganigrammeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuration de l'organigramme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formConfigOrganigramme">
                    <div class="mb-3">
                        <label class="form-label">Niveaux à afficher</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showDirections" checked>
                            <label class="form-check-label">Directions</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showServices" checked>
                            <label class="form-check-label">Services</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Format d'export</label>
                        <select class="form-select" id="exportFormat">
                            <option value="pdf">PDF (impression)</option>
                            <option value="png">PNG (image)</option>
                            <option value="html">HTML (web)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Style</label>
                        <select class="form-select" id="styleOrganigramme">
                            <option value="moderne">Moderne (couleurs)</option>
                            <option value="classique">Classique (noir/blanc)</option>
                            <option value="compact">Compact</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="exporterAvecConfig()">
                    <i class="fas fa-download me-2"></i>Exporter
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function imprimerOrganigramme() {
    const printContent = document.querySelector('.organigramme-container').innerHTML;
    const originalTitle = document.title;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Organigramme - Impression</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    @media print {
                        body { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${printContent}
                <script>
                    window.onload = function() { window.print(); window.close(); }
                <\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}

function exporterAvecConfig() {
    const format = document.getElementById('exportFormat').value;
    window.location.href = `/admin/organigramme/exporter/${format}`;
}

// Charger les données via API pour une version interactive
async function chargerDonneesOrganigramme() {
    try {
        const response = await fetch('/api/organigramme/donnees');
        const data = await response.json();
        
        console.log('Données organigramme:', data);
        
        // Mettre à jour les statistiques
        document.getElementById('totalDirections').textContent = data.total_directions;
        document.getElementById('totalServices').textContent = data.total_services;
        
    } catch (error) {
        console.error('Erreur chargement données:', error);
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    chargerDonneesOrganigramme();
});
</script>
{% endblock %}