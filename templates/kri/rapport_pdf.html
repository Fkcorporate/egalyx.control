<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport {{ kri.get_type_display() }} - {{ kri.nom }}</title>
    <style>
        /* Styles généraux */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            color: #2c3e50;
            line-height: 1.6;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
        }
        
        /* En-tête du document */
        .document-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 40px;
            margin-bottom: 30px;
            border-radius: 0 0 20px 20px;
        }
        
        .document-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .document-header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .document-header .badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
        }
        
        .badge-kri {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-kpi {
            background-color: #28a745;
            color: white;
        }
        
        /* Métadonnées */
        .meta-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #2a5298;
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
        }
        
        .meta-icon {
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #2a5298;
            font-size: 18px;
        }
        
        .meta-content {
            flex: 1;
        }
        
        .meta-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .meta-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Sections */
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 20px;
            color: #1e3c72;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #2a5298;
        }
        
        /* Cartes */
        .card-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            overflow: hidden;
        }
        
        .card-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Seuils */
        .thresholds {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        
        .threshold-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .threshold-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .threshold-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .threshold-value.alerte {
            color: #ffc107;
        }
        
        .threshold-value.critique {
            color: #dc3545;
        }
        
        .threshold-value.cible {
            color: #17a2b8;
        }
        
        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-unit {
            font-size: 12px;
            color: #6c757d;
        }
        
        /* Tableau */
        .table-container {
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background-color: #1e3c72;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .badge-etat {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-normal {
            background-color: #28a745;
            color: white;
        }
        
        .badge-alerte {
            background-color: #ffc107;
            color: #2c3e50;
        }
        
        .badge-critique {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-hors-cible {
            background-color: #dc3545;
            color: white;
        }
        
        /* Pied de page */
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
        }
        
        .footer .company {
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 5px;
        }
        
        /* Utilitaires */
        .text-muted {
            color: #6c757d;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        /* Graphique ASCII pour l'écart */
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            position: relative;
        }
        
        .progress-bar {
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        }
        
        .progress-marker {
            position: absolute;
            top: 0;
            width: 4px;
            height: 20px;
            background-color: #1e3c72;
            border-radius: 2px;
        }
        
        /* Page break */
        .page-break {
            page-break-before: always;
        }
        
        /* En-tête de page */
        @page {
            size: A4;
            margin: 2cm;
            
            @top-center {
                content: "{{ kri.get_type_display() }} - {{ kri.nom }}";
                font-size: 9px;
                color: #6c757d;
            }
            
            @bottom-center {
                content: "Page " counter(page) " sur " counter(pages);
                font-size: 9px;
                color: #6c757d;
            }
        }
    </style>
</head>
<body>
    <!-- En-tête du document -->
    <div class="document-header">
        <h1>{{ kri.get_type_display() }} : {{ kri.nom }}</h1>
        <div class="subtitle">Rapport généré le {{ date_generation.strftime('%d %B %Y à %H:%M') }}</div>
        <span class="badge {% if kri.type_indicateur == 'kri' %}badge-kri{% else %}badge-kpi{% endif %}">
            {{ kri.get_type_display() }}
        </span>
    </div>
    
    <!-- Métadonnées -->
    <div class="meta-info">
        <div class="meta-grid">
            <div class="meta-item">
                <div class="meta-icon">
                    <i class="fas fa-tag"></i>
                </div>
                <div class="meta-content">
                    <div class="meta-label">Référence</div>
                    <div class="meta-value">{{ kri.nom }}</div>
                </div>
            </div>
            
            <div class="meta-item">
                <div class="meta-icon">
                    <i class="fas fa-ruler"></i>
                </div>
                <div class="meta-content">
                    <div class="meta-label">Unité</div>
                    <div class="meta-value">{{ kri.unite_mesure or 'Non spécifiée' }}</div>
                </div>
            </div>
            
            <div class="meta-item">
                <div class="meta-icon">
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="meta-content">
                    <div class="meta-label">Fréquence</div>
                    <div class="meta-value">{{ kri.frequence_mesure|title or 'Non définie' }}</div>
                </div>
            </div>
            
            <div class="meta-item">
                <div class="meta-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="meta-content">
                    <div class="meta-label">Responsable</div>
                    <div class="meta-value">{{ kri.responsable_mesure.username if kri.responsable_mesure else 'Non assigné' }}</div>
                </div>
            </div>
            
            <div class="meta-item">
                <div class="meta-icon">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="meta-content">
                    <div class="meta-label">Catégorie</div>
                    <div class="meta-value">{{ kri.categorie|title or 'Non catégorisé' }}</div>
                </div>
            </div>
            
            <div class="meta-item">
                <div class="meta-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="meta-content">
                    <div class="meta-label">Source</div>
                    <div class="meta-value">{{ kri.source_donnees or 'Non spécifiée' }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Description -->
    {% if kri.description %}
    <div class="section">
        <div class="section-title">
            <i class="fas fa-align-left"></i> Description
        </div>
        <div class="card">
            <div class="card-body">
                {{ kri.description|nl2br }}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Seuils et cibles -->
    <div class="section">
        <div class="section-title">
            <i class="fas fa-bell"></i> Seuils et cibles
        </div>
        
        <div class="thresholds">
            {% if kri.type_indicateur == 'kpi' and kri.seuil_cible %}
            <div class="threshold-item">
                <div class="threshold-label">Cible</div>
                <div class="threshold-value cible">{{ "%.2f"|format(kri.seuil_cible) }} {{ kri.unite_mesure }}</div>
            </div>
            {% endif %}
            
            {% if kri.seuil_alerte %}
            <div class="threshold-item">
                <div class="threshold-label">Seuil d'alerte</div>
                <div class="threshold-value alerte">{{ "%.2f"|format(kri.seuil_alerte) }} {{ kri.unite_mesure }}</div>
            </div>
            {% endif %}
            
            {% if kri.seuil_critique %}
            <div class="threshold-item">
                <div class="threshold-label">Seuil critique</div>
                <div class="threshold-value critique">{{ "%.2f"|format(kri.seuil_critique) }} {{ kri.unite_mesure }}</div>
            </div>
            {% endif %}
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <strong>Sens d'évaluation :</strong> {{ kri.get_description_sens_evaluation() }}
            </div>
        </div>
    </div>
    
    <!-- Dernière mesure et état -->
    {% if derniere_mesure %}
    <div class="section">
        <div class="section-title">
            <i class="fas fa-chart-line"></i> Dernière mesure
        </div>
        
        <div class="card-container">
            <div class="card">
                <div class="card-header">Valeur actuelle</div>
                <div class="card-body">
                    <div style="font-size: 36px; font-weight: 700; color: #1e3c72;">
                        {{ "%.2f"|format(derniere_mesure.valeur) }}
                        <small style="font-size: 16px; color: #6c757d;">{{ kri.unite_mesure }}</small>
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="badge-etat {% if kri.get_etat_alerte(derniere_mesure.valeur) in ['critique', 'hors_cible'] %}badge-critique{% elif kri.get_etat_alerte(derniere_mesure.valeur) in ['alerte', 'sous_performance'] %}badge-alerte{% else %}badge-normal{% endif %}">
                            {{ kri.get_libelle_etat(derniere_mesure.valeur) }}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Date de mesure</div>
                <div class="card-body">
                    <div style="font-size: 24px; font-weight: 600;">
                        {{ derniere_mesure.date_mesure.strftime('%d/%m/%Y') }}
                    </div>
                    <div class="text-muted">
                        {{ derniere_mesure.date_mesure.strftime('%H:%M') }}
                    </div>
                </div>
            </div>
        </div>
        
        {% if kri.type_indicateur == 'kpi' and kri.seuil_cible and ecart_cible is not none %}
        <div class="card mt-3">
            <div class="card-header">Écart par rapport à la cible</div>
            <div class="card-body">
                <div class="progress-container">
                    <div class="progress-bar" style="width: {{ 50 + (ecart_cible/2) if ecart_cible > 0 else 50 + (ecart_cible/2) }}%"></div>
                    <div class="progress-marker" style="left: 50%;"></div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <span style="font-weight: 700; {% if ecart_cible > 10 %}color: #dc3545{% elif ecart_cible > 5 %}color: #ffc107{% elif ecart_cible < -10 %}color: #dc3545{% elif ecart_cible < -5 %}color: #ffc107{% else %}color: #28a745{% endif %}">
                        {{ "%+.1f"|format(ecart_cible) }}%
                    </span>
                    <span class="text-muted"> par rapport à la cible</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Statistiques -->
    {% if statistiques and statistiques.nb_mesures > 0 %}
    <div class="section">
        <div class="section-title">
            <i class="fas fa-chart-bar"></i> Statistiques globales
        </div>
        
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value">{{ "%.2f"|format(statistiques.moyenne) }}</div>
                <div class="stat-label">Moyenne</div>
                <div class="stat-unit">{{ kri.unite_mesure }}</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-value">{{ "%.2f"|format(statistiques.minimum) }}</div>
                <div class="stat-label">Minimum</div>
                <div class="stat-unit">{{ kri.unite_mesure }}</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-value">{{ "%.2f"|format(statistiques.maximum) }}</div>
                <div class="stat-label">Maximum</div>
                <div class="stat-unit">{{ kri.unite_mesure }}</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-value">{{ statistiques.nb_mesures }}</div>
                <div class="stat-label">Nombre de mesures</div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">Tendance</div>
            <div class="card-body">
                <div style="display: flex; align-items: center;">
                    <div style="font-size: 24px; margin-right: 15px;">
                        {% if statistiques.tendance == 'hausse' %}
                        <i class="fas fa-arrow-up" style="color: #dc3545;"></i>
                        {% elif statistiques.tendance == 'baisse' %}
                        <i class="fas fa-arrow-down" style="color: #28a745;"></i>
                        {% else %}
                        <i class="fas fa-minus" style="color: #ffc107;"></i>
                        {% endif %}
                    </div>
                    <div>
                        <strong style="font-size: 18px;">
                            {% if statistiques.tendance == 'hausse' %}En hausse{% elif statistiques.tendance == 'baisse' %}En baisse{% else %}Stable{% endif %}
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Historique des mesures -->
    {% if mesures %}
    <div class="section page-break">
        <div class="section-title">
            <i class="fas fa-history"></i> Historique des mesures
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Valeur</th>
                        <th>État</th>
                        <th>Écart cible</th>
                        <th>Commentaire</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mesure in mesures %}
                    <tr>
                        <td>{{ mesure.date_mesure.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td><strong>{{ "%.2f"|format(mesure.valeur) }}</strong> {{ kri.unite_mesure }}</td>
                        <td>
                            <span class="badge-etat {% if kri.get_etat_alerte(mesure.valeur) in ['critique', 'hors_cible'] %}badge-critique{% elif kri.get_etat_alerte(mesure.valeur) in ['alerte', 'sous_performance'] %}badge-alerte{% else %}badge-normal{% endif %}">
                                {{ kri.get_libelle_etat(mesure.valeur) }}
                            </span>
                        </td>
                        <td>
                            {% if kri.type_indicateur == 'kpi' and kri.seuil_cible %}
                                {% set ecart = ((mesure.valeur - kri.seuil_cible) / kri.seuil_cible * 100) if kri.seuil_cible != 0 else 0 %}
                                <span style="color: {% if ecart|abs < 5 %}#28a745{% elif ecart|abs < 10 %}#ffc107{% else %}#dc3545{% endif %};">
                                    {{ "%+.1f"|format(ecart) }}%
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ mesure.commentaire|truncate(50) if mesure.commentaire else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Pied de page -->
    <div class="footer">
        <div class="company">Egalyx control Corporate</div>
        <div>Rapport généré automatiquement - Tous droits réservés</div>
        <div>Document confidentiel - {{ date_generation.strftime('%d/%m/%Y') }}</div>
    </div>
</body>
</html>