{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        {% if action == 'creer' %}Nouvelle source de données{% else %}Modifier la source{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="sourceForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Nom de la source *</label>
                                    {{ form.nom(class="form-control", placeholder="Ex: API Satisfaction HubSpot") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Type de source *</label>
                                    {{ form.type_source(class="form-select", id="type_source") }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            {{ form.description(class="form-control", rows=2, 
                              placeholder="Description de la source...") }}
                        </div>

                        <!-- Section API -->
                        <div id="config_api" class="config-section border rounded p-3 mb-3" style="display: none;">
                            <h6 class="text-primary"><i class="fas fa-cloud me-2"></i>Configuration API</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">URL</label>
                                        {{ form.api_url(class="form-control", placeholder="https://api.example.com/data") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Méthode</label>
                                        {{ form.api_method(class="form-select") }}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Headers (JSON)</label>
                                {{ form.api_headers(class="form-control", rows=2, 
                                  placeholder='{"Content-Type": "application/json"}') }}
                            </div>
                        </div>

                        <!-- Section Fichier -->
                        <div id="config_fichier" class="config-section border rounded p-3 mb-3" style="display: none;">
                            <h6 class="text-success"><i class="fas fa-file me-2"></i>Configuration Fichier</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Chemin du fichier</label>
                                        {{ form.fichier_chemin(class="form-control", placeholder="/path/to/file.csv") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Format</label>
                                        {{ form.fichier_format(class="form-select") }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Base de données -->
                        <div id="config_bdd" class="config-section border rounded p-3 mb-3" style="display: none;">
                            <h6 class="text-warning"><i class="fas fa-database me-2"></i>Configuration Base de données</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Type</label>
                                        {{ form.bdd_type(class="form-select") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Hôte</label>
                                        {{ form.bdd_host(class="form-control", placeholder="localhost") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Port</label>
                                        {{ form.bdd_port(class="form-control", placeholder="5432") }}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">Nom de la base</label>
                                        {{ form.bdd_nom(class="form-control", placeholder="ma_base") }}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Requête SQL</label>
                                {{ form.bdd_requete(class="form-control", rows=3,
                                  placeholder="SELECT * FROM table WHERE date >= CURRENT_DATE") }}
                            </div>
                        </div>

                        <!-- Section Authentification -->
                        <div class="border rounded p-3 mb-3">
                            <h6 class="text-secondary"><i class="fas fa-lock me-2"></i>Authentification</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Type</label>
                                        {{ form.auth_type(class="form-select", id="auth_type") }}
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <div id="auth_basic" class="auth-section" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                {{ form.auth_username(class="form-control mb-2", placeholder="Nom d'utilisateur") }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.auth_password(class="form-control mb-2", placeholder="Mot de passe", type="password") }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="auth_bearer" class="auth-section" style="display: none;">
                                        {{ form.auth_token(class="form-control", placeholder="Bearer Token") }}
                                    </div>
                                    
                                    <div id="auth_api_key" class="auth-section" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                {{ form.auth_key_name(class="form-control mb-2", placeholder="Nom de la clé (X-API-Key)") }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.auth_key_value(class="form-control mb-2", placeholder="Valeur de la clé") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fréquence -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fréquence de rafraîchissement</label>
                            {{ form.frequence_rafraichissement(class="form-control", type="number") }}
                            <small class="text-muted">
                                86400 = 24h, 3600 = 1h, 900 = 15min
                            </small>
                        </div>

                        <!-- Boutons -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                {% if action == 'creer' %}Créer la source{% else %}Mettre à jour{% endif %}
                            </button>
                            <a href="{{ url_for('liste_sources_donnees') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('type_source').addEventListener('change', function() {
    document.querySelectorAll('.config-section').forEach(s => s.style.display = 'none');
    if (this.value) {
        document.getElementById('config_' + this.value).style.display = 'block';
    }
});

document.getElementById('auth_type').addEventListener('change', function() {
    document.querySelectorAll('.auth-section').forEach(s => s.style.display = 'none');
    if (this.value) {
        document.getElementById('auth_' + this.value).style.display = 'block';
    }
});

// Initialiser les sections au chargement
document.addEventListener('DOMContentLoaded', function() {
    const typeSource = document.getElementById('type_source').value;
    if (typeSource) {
        document.getElementById('config_' + typeSource).style.display = 'block';
    }
});
</script>
{% endblock %}