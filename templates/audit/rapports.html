{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-alt me-2"></i>{{ t("Rapports d'Audit") }}</h2>
    <div>
        {% if current_user.has_permission('can_manage_audit') %}
        <a href="{{ url_for('liste_audits') }}" class="btn btn-outline-primary">
            <i class="fas fa-list me-1"></i>{{ t("Voir tous les audits") }}
        </a>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-start border-primary border-4">
            <div class="card-body">
                <h3 class="text-primary">{{ audits|length }}</h3>
                <p class="text-muted mb-0">{{ t("Audits") }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-start border-info border-4">
            <div class="card-body">
                <h3 class="text-info">{{ constatations_total }}</h3>
                <p class="text-muted mb-0">{{ t("Constatations") }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-start border-warning border-4">
            <div class="card-body">
                <h3 class="text-warning">{{ recommandations_total }}</h3>
                <p class="text-muted mb-0">{{ t("Recommandations") }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-start border-success border-4">
            <div class="card-body">
                <h3 class="text-success">{{ plans_action_total }}</h3>
                <p class="text-muted mb-0">{{ t("Plans d'Action") }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">{{ t("Audits Disponibles") }}</h5>
            </div>
            <div class="card-body">
                {% if audits %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>{{ t("Référence") }}</th>
                                <th>{{ t("Titre") }}</th>
                                <th>{{ t("Type") }}</th>
                                <th>{{ t("Statut") }}</th>
                                <th class="text-center">{{ t("Rapport") }}</th>
                                <th class="text-center">{{ t("Fichiers") }}</th>
                                {% if current_user.has_permission('can_manage_audit') %}
                                <th class="text-center">{{ t("Actions") }}</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for audit in audits %}
                            <tr>
                                <td><strong class="text-primary">{{ audit.reference }}</strong></td>
                                <td>{{ audit.titre|truncate(30) }}</td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ audit.type_audit }}</span>
                                </td>
                                <td>
                                    {% if audit.statut == 'planifie' %}
                                    <span class="badge bg-secondary">{{ t("Planifié") }}</span>
                                    {% elif audit.statut == 'en_cours' %}
                                    <span class="badge bg-warning">{{ t("En cours") }}</span>
                                    {% elif audit.statut == 'termine' %}
                                    <span class="badge bg-success">{{ t("Terminé") }}</span>
                                    {% elif audit.statut == 'annule' %}
                                    <span class="badge bg-danger">{{ t("Annulé") }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('rapport_audit_complet', audit_id=audit.id) }}" 
                                           class="btn btn-outline-primary" 
                                           title="{{ t("Voir le rapport") }}">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('export_rapport_audit_pdf', audit_id=audit.id) }}" 
                                           class="btn btn-outline-success" 
                                           title="{{ t("Exporter en PDF") }}">
                                            <i class="fas fa-file-pdf"></i>
                                        </a>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% set fichiers_count = fichiers_par_audit.get(audit.id, [])|length %}
                                    {% if fichiers_count > 0 %}
                                    <div class="d-flex align-items-center justify-content-center">
                                        <span class="badge bg-info me-2">
                                            {{ fichiers_count }}
                                        </span>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-info view-files-btn"
                                                data-audit-id="{{ audit.id }}"
                                                title="{{ t("Voir les fichiers") }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                {% if current_user.has_permission('can_manage_audit') %}
                                <td class="text-center">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary add-file-btn"
                                            data-audit-id="{{ audit.id }}"
                                            data-audit-ref="{{ audit.reference }}"
                                            title="{{ t("Ajouter un fichier") }}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">{{ t("Aucun audit disponible pour le moment.") }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">{{ t("Répartition par Type") }}</h5>
            </div>
            <div class="card-body">
                <canvas id="chartTypesAudit" height="200"></canvas>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">{{ t("Statut des Audits") }}</h5>
            </div>
            <div class="card-body">
                <canvas id="chartStatutsAudit" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-paperclip me-2"></i>{{ t("Fichiers Joints") }}
                    <span class="badge bg-primary ms-2">
                        {{ total_fichiers_rapport if total_fichiers_rapport is defined else 0 }}
                    </span>
                </h5>
                {% if current_user.has_permission('can_manage_audit') %}
                <button type="button" 
                        class="btn btn-primary btn-sm"
                        data-bs-toggle="modal" 
                        data-bs-target="#uploadModal">
                    <i class="fas fa-plus me-1"></i>{{ t("Ajouter") }}
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if fichiers_par_audit and fichiers_par_audit|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>{{ t("Audit") }}</th>
                                <th>{{ t("Fichier") }}</th>
                                <th>{{ t("Type") }}</th>
                                <th>{{ t("Taille") }}</th>
                                <th>{{ t("Description") }}</th>
                                <th>{{ t("Ajouté le") }}</th>
                                <th class="text-center">{{ t("Actions") }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for audit_id, fichiers in fichiers_par_audit.items() %}
                                {% set audit_info = audits_dict.get(audit_id) %}
                                {% for fichier in fichiers %}
                                <tr>
                                    <td>
                                        {% if audit_info %}
                                        <div class="fw-semibold">{{ audit_info.reference }}</div>
                                        <small class="text-muted">{{ audit_info.titre|truncate(30) }}</small>
                                        {% else %}
                                        <span class="text-muted">Audit #{{ audit_id }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas {{ 
                                                'fa-file-pdf text-danger' if fichier.type_fichier == 'pdf' 
                                                else 'fa-file-word text-primary' if fichier.type_fichier in ['doc', 'docx'] 
                                                else 'fa-file-excel text-success' if fichier.type_fichier in ['xls', 'xlsx'] 
                                                else 'fa-file-powerpoint text-warning' if fichier.type_fichier in ['ppt', 'pptx']
                                                else 'fa-file-image text-info' if fichier.type_fichier in ['jpg', 'jpeg', 'png', 'gif']
                                                else 'fa-file-alt text-secondary' 
                                            }} me-2 fs-5"></i>
                                            <div>
                                                <div class="fw-medium">{{ fichier.nom_fichier|truncate(25) }}</div>
                                                <small class="text-muted">
                                                    {{ fichier.created_at|format_datetime if fichier.created_at else '' }}
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark text-uppercase">
                                            .{{ fichier.type_fichier }}
                                        </span>
                                    </td>
                                    <td>{{ fichier.taille_formatee if fichier.taille_formatee else '-' }}</td>
                                    <td>
                                        {% if fichier.description %}
                                        <span title="{{ fichier.description }}">
                                            {{ fichier.description|truncate(40) }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ fichier.created_at|format_datetime if fichier.created_at else '' }}</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('telecharger_fichier_rapport_audit', fichier_id=fichier.id) }}" 
                                               class="btn btn-outline-primary" 
                                               title="{{ t("Télécharger") }}"
                                               target="_blank">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            {% if current_user.has_permission('can_manage_audit') or 
                                                current_user.id == fichier.uploaded_by or
                                                (audit_info and (current_user.id == audit_info.created_by or current_user.id == audit_info.responsable_id)) %}
                                            <button type="button" 
                                                    class="btn btn-outline-danger delete-file-btn"
                                                    data-file-id="{{ fichier.id }}"
                                                    data-file-name="{{ fichier.nom_fichier }}"
                                                    title="{{ t("Supprimer") }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                    <p class="text-muted">{{ t("Aucun fichier joint aux rapports.") }}</p>
                    {% if current_user.has_permission('can_manage_audit') %}
                    <p class="text-muted small">{{ t("Cliquez sur 'Ajouter' pour joindre des documents aux rapports d'audit.") }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'ajout de fichier (global) -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cloud-upload-alt me-2"></i>{{ t("Ajouter un Fichier") }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t("Fermer") }}"></button>
            </div>
            <form id="uploadForm" action="{{ url_for('upload_fichier_rapport_global') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="auditSelect" class="form-label">{{ t("Sélectionner un audit") }} <span class="text-danger">*</span></label>
                        <select class="form-select" id="auditSelect" name="audit_id" required>
                            <option value="">{{ t("-- Choisir un audit --") }}</option>
                            {% for audit in audits %}
                            <option value="{{ audit.id }}">{{ audit.reference }} - {{ audit.titre|truncate(40) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fichier" class="form-label">{{ t("Sélectionner un fichier") }} <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="fichier" name="fichier" required>
                        <div class="form-text">
                            {{ t("Formats acceptés : PDF, DOC/DOCX, XLS/XLSX, PPT/PPTX, JPG/PNG, TXT") }}
                            <br>{{ t("Taille maximale : 10 Mo") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">{{ t("Description (optionnelle)") }}</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="{{ t("Description du fichier...") }}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ t("Annuler") }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>{{ t("Téléverser") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour l'ajout rapide de fichier -->
<div class="modal fade" id="quickUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    {{ t("Ajouter un fichier à") }} <span id="auditRef" class="fw-semibold"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t("Fermer") }}"></button>
            </div>
            <form id="quickUploadForm" action="{{ url_for('upload_fichier_rapport_global') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="quickAuditId" name="audit_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quickFichier" class="form-label">{{ t("Sélectionner un fichier") }} <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="quickFichier" name="fichier" required>
                        <div class="form-text">
                            {{ t("Formats acceptés : PDF, DOC/DOCX, XLS/XLSX, PPT/PPTX, JPG/PNG, TXT") }}
                            <br>{{ t("Taille maximale : 10 Mo") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="quickDescription" class="form-label">{{ t("Description (optionnelle)") }}</label>
                        <textarea class="form-control" id="quickDescription" name="description" rows="3" 
                                  placeholder="{{ t("Description du fichier...") }}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ t("Annuler") }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>{{ t("Téléverser") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ t("Confirmation de suppression") }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t("Fermer") }}"></button>
            </div>
            <div class="modal-body">
                <p>{{ t("Êtes-vous sûr de vouloir supprimer le fichier") }} <strong id="fileNameToDelete"></strong> ?</p>
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    {{ t("Cette action est irréversible. Le fichier sera définitivement supprimé.") }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ t("Annuler") }}</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>{{ t("Supprimer définitivement") }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let fileToDelete = null;
    
    // Initialiser les graphiques
    initCharts();
    
    // Initialiser les événements
    initEventListeners();
    
    function initCharts() {
        // Graphique des types d'audit
        const ctxTypes = document.getElementById('chartTypesAudit');
        if (ctxTypes) {
            new Chart(ctxTypes.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: {{ types_audit.labels|tojson if types_audit and types_audit.labels else [] }},
                    datasets: [{
                        data: {{ types_audit.data|tojson if types_audit and types_audit.data else [] }},
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                        ],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
        
        // Graphique des statuts
        const ctxStatuts = document.getElementById('chartStatutsAudit');
        if (ctxStatuts) {
            new Chart(ctxStatuts.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: {{ statuts_audit.labels|tojson if statuts_audit and statuts_audit.labels else [] }},
                    datasets: [{
                        data: {{ statuts_audit.data|tojson if statuts_audit and statuts_audit.data else [] }},
                        backgroundColor: [
                            '#6c757d', '#ffc107', '#28a745', '#dc3545'
                        ],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
    }
    
    function initEventListeners() {
        // Gestion de l'upload global
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                const auditId = document.getElementById('auditSelect').value;
                const fileInput = document.getElementById('fichier');
                
                if (!auditId) {
                    e.preventDefault();
                    showToast('warning', 'Veuillez sélectionner un audit');
                    return;
                }
                
                if (!fileInput.files[0]) {
                    e.preventDefault();
                    showToast('warning', 'Veuillez sélectionner un fichier');
                    return;
                }
                
                // Validation de la taille (10MB max)
                const maxSize = 10 * 1024 * 1024;
                if (fileInput.files[0].size > maxSize) {
                    e.preventDefault();
                    showToast('error', 'Le fichier est trop volumineux. Taille maximum : 10 Mo');
                    return;
                }
                
                // Afficher l'indicateur de chargement
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Téléversement...';
                    submitBtn.disabled = true;
                }
            });
        }
        
        // Gestion de l'upload rapide
        const quickUploadForm = document.getElementById('quickUploadForm');
        if (quickUploadForm) {
            quickUploadForm.addEventListener('submit', function(e) {
                const fileInput = document.getElementById('quickFichier');
                
                if (!fileInput.files[0]) {
                    e.preventDefault();
                    showToast('warning', 'Veuillez sélectionner un fichier');
                    return;
                }
                
                // Validation de la taille (10MB max)
                const maxSize = 10 * 1024 * 1024;
                if (fileInput.files[0].size > maxSize) {
                    e.preventDefault();
                    showToast('error', 'Le fichier est trop volumineux. Taille maximum : 10 Mo');
                    return;
                }
                
                // Afficher l'indicateur de chargement
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Téléversement...';
                    submitBtn.disabled = true;
                }
            });
        }
        
        // Gestion des boutons "Ajouter un fichier" (rapide)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.add-file-btn')) {
                const button = e.target.closest('.add-file-btn');
                const auditId = button.getAttribute('data-audit-id');
                const auditRef = button.getAttribute('data-audit-ref');
                
                document.getElementById('quickAuditId').value = auditId;
                document.getElementById('auditRef').textContent = auditRef;
                
                // Réinitialiser le formulaire
                document.getElementById('quickUploadForm').reset();
                
                // Afficher le modal
                const modal = new bootstrap.Modal(document.getElementById('quickUploadModal'));
                modal.show();
            }
            
            // Gestion des boutons "Voir les fichiers"
            if (e.target.closest('.view-files-btn')) {
                const button = e.target.closest('.view-files-btn');
                const auditId = button.getAttribute('data-audit-id');
                scrollToAuditFiles(auditId);
            }
            
            // Gestion des boutons "Supprimer"
            if (e.target.closest('.delete-file-btn')) {
                const button = e.target.closest('.delete-file-btn');
                const fileId = button.getAttribute('data-file-id');
                const fileName = button.getAttribute('data-file-name');
                
                showDeleteConfirmation(fileId, fileName);
            }
        });
        
        // Confirmation de suppression
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', handleDeleteConfirmation);
        }
    }
    
    function scrollToAuditFiles(auditId) {
        // Trouver l'audit dans le tableau
        const rows = document.querySelectorAll('.table-hover tbody tr');
        let foundRow = null;
        
        for (let row of rows) {
            const refElement = row.querySelector('td:first-child .fw-semibold');
            if (refElement) {
                // Chercher la ligne correspondant à l'audit
                // Vous devrez peut-être adapter cette logique selon vos données
                const rowAuditId = row.querySelector('[data-audit-id]');
                if (rowAuditId && rowAuditId.getAttribute('data-audit-id') === auditId) {
                    foundRow = row;
                    break;
                }
            }
        }
        
        if (foundRow) {
            // Surligner la ligne
            foundRow.classList.add('table-info');
            
            // Scroll vers la ligne
            foundRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Retirer le surlignement après 3 secondes
            setTimeout(() => {
                foundRow.classList.remove('table-info');
            }, 3000);
        } else {
            showToast('info', 'Aucun fichier trouvé pour cet audit');
        }
    }
    
    function showDeleteConfirmation(fileId, fileName) {
        fileToDelete = { id: fileId, name: fileName };
        
        document.getElementById('fileNameToDelete').textContent = fileName;
        
        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        modal.show();
    }
    
    function handleDeleteConfirmation() {
        if (!fileToDelete) return;
        
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Suppression...';
        deleteBtn.disabled = true;
        
        fetch(`/fichier-rapport-audit/${fileToDelete.id}/supprimer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({ confirm: true })
        })
        .then(response => response.json())
        .then(data => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
            if (modal) modal.hide();
            
            if (data.success) {
                showToast('success', 'Fichier supprimé avec succès');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showToast('error', 'Une erreur est survenue');
        })
        .finally(() => {
            deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Supprimer définitivement';
            deleteBtn.disabled = false;
            fileToDelete = null;
        });
    }
    
    function showToast(type, message) {
        // Créer un toast
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        const toastId = 'toast-' + Date.now();
        
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas ${getToastIcon(type)} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
        
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1060';
        document.body.appendChild(container);
        return container;
    }
    
    function getToastIcon(type) {
        switch(type) {
            case 'success': return 'fa-check-circle';
            case 'error': return 'fa-exclamation-circle';
            case 'warning': return 'fa-exclamation-triangle';
            default: return 'fa-info-circle';
        }
    }
});
</script>

<style>
/* Styles personnalisés */
.card {
    border: none;
    border-radius: 0.5rem;
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,.125);
    background-color: #f8f9fa;
}

.table th {
    font-weight: 600;
    color: #495057;
    border-top: none;
}

.badge {
    font-weight: 500;
    letter-spacing: 0.3px;
}

.btn-outline-primary:hover {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-outline-success:hover {
    background-color: #1cc88a;
    border-color: #1cc88a;
}

.btn-outline-danger:hover {
    background-color: #e74a3b;
    border-color: #e74a3b;
}

.btn-outline-info:hover {
    background-color: #36b9cc;
    border-color: #36b9cc;
}

/* Animation pour les nouvelles lignes */
@keyframes highlightRow {
    0% { background-color: rgba(78, 115, 223, 0.1); }
    100% { background-color: transparent; }
}

.highlight-row {
    animation: highlightRow 2s ease-out;
}

/* Styles pour les icônes de fichiers */
.fa-file-pdf { color: #e74a3b; }
.fa-file-word { color: #2b579a; }
.fa-file-excel { color: #217346; }
.fa-file-powerpoint { color: #d24726; }
.fa-file-image { color: #1cc88a; }
.fa-file-alt { color: #6c757d; }

/* Surlignement de ligne */
.table-info {
    background-color: rgba(78, 115, 223, 0.1) !important;
    transition: background-color 0.3s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
    
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .btn-group {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .btn-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    /* Masquer certaines colonnes sur mobile */
    .table th:nth-child(3),
    .table td:nth-child(3),
    .table th:nth-child(6),
    .table td:nth-child(6) {
        display: none;
    }
}
</style>
{% endblock %}
