{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-file-alt me-2"></i>
            Rapport d'Audit Complet - {{ audit.reference }}
        </h2>
        <div>
         <!-- Dans votre template rapport_complet.html ou detail_audit.html -->
        <div class="btn-group">
            <a href="{{ url_for('rapport_audit_pdf_elegant', audit_id=audit.id) }}" 
               class="btn btn-primary" target="_blank">
                <i class="fas fa-file-pdf me-1"></i> PDF pro
            </a>
            <a href="{{ url_for('export_audit_excel', audit_id=audit.id) }}" 
               class="btn btn-success">
                <i class="fas fa-file-excel me-1"></i> Export Excel pro
            </a>
        </div>
            <a href="{{ url_for('detail_audit', id=audit.id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> {{ t("Back to audit") }} </a>
            <a href="{{ url_for('export_rapport_audit_pdf', audit_id=audit.id) }}" class="btn btn-danger">
                <i class="fas fa-file-pdf me-1"></i> {{ t("Exporter PDF") }} </a>
            <a href="{{ url_for('export_rapport_audit_word', audit_id=audit.id) }}" class="btn btn-primary">
                <i class="fas fa-file-word me-1"></i> {{ t("Exporter Word") }} </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="card-title mb-0">
                <i class="fas fa-clipboard-check me-2"></i>
                Rapport d'Audit - {{ audit.titre }}
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td width="40%"><strong> {{ t("Référence :") }} </strong></td>
                            <td>{{ audit.reference }}</td>
                        </tr>
                        <tr>
                            <td><strong> {{ t("Titre :") }} </strong></td>
                            <td>{{ audit.titre }}</td>
                        </tr>
                        <tr>
                            <td><strong> {{ t("Audit type:") }} </strong></td>
                            <td>
                                <span class="badge bg-primary">{{ audit.type_audit }}</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong> {{ t("Audited process:") }} </strong></td>
                            <td>
                                {% if audit.processus %}
                                    <span class="badge bg-info">{{ audit.processus.nom }}</span>
                                {% else %}
                                    <span class="text-muted"> {{ t("Not specified") }} </span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td width="40%"><strong> {{ t("Statut :") }} </strong></td>
                            <td>
                                <span class="badge bg-{{ 'success' if audit.statut == 'termine' else 'warning' if audit.statut == 'en_cours' else 'info' if audit.statut == 'planifie' else 'secondary' }}">
                                    {{ audit.statut|upper }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong> {{ t("Responsible :") }} </strong></td>
                            <td>
                                {% if audit.responsable %}
                                    <span class="badge bg-secondary">{{ audit.responsable.username }}</span>
                                {% else %}
                                    <span class="text-muted"> {{ t("Non assigné") }} </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong> {{ t("Date début :") }} </strong></td>
                            <td>
                                {% if audit.date_debut_prevue %}
                                    {{ audit.date_debut_prevue.strftime('%d/%m/%Y') }}
                                {% else %}
                                    <span class="text-muted"> {{ t("Non définie") }} </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong> {{ t("Generation date:") }} </strong></td>
                            <td>{{ current_datetime.strftime('%d/%m/%Y à %H:%M') }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="row mt-3">
                {% if audit.description %}
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <strong><i class="fas fa-align-left me-2"></i> {{ t("Description") }} </strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ audit.description }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if audit.objectifs %}
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <strong><i class="fas fa-bullseye me-2"></i> {{ t("Objectifs") }} </strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ audit.objectifs }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            {% if audit.portee %}
            <div class="mt-3">
                <div class="card">
                    <div class="card-header">
                        <strong><i class="fas fa-bullseye me-2"></i> {{ t("Audit scope") }} </strong>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">{{ audit.portee }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if audit.criteres %}
            <div class="mt-3">
                <div class="card">
                    <div class="card-header">
                        <strong><i class="fas fa-list-check me-2"></i> {{ t("Audit criteria") }} </strong>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">{{ audit.criteres }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ rapport.statistiques.total_constatations }}</h3>
                    <small> {{ t("Findings") }} </small>
                    <div class="mt-2">
                        {% for type, count in rapport.statistiques.constatations_par_type.items() %}
                        <small class="d-block">{{ type|replace('_', ' ')|title }}: {{ count }}</small>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ rapport.statistiques.total_recommandations }}</h3>
                    <small> {{ t("Recommendations") }} </small>
                    <div class="mt-2">
                        {% for statut, count in rapport.statistiques.recommandations_par_statut.items() %}
                        <small class="d-block">{{ statut|replace('_', ' ')|title }}: {{ count }}</small>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ rapport.statistiques.total_plans_action }}</h3>
                    <small> {{ t("Action Plans") }} </small>
                    <div class="mt-2">
                        <small class="d-block">Actifs: {{ rapport.statistiques.plans_action_actifs }}</small>
                        <small class="d-block">Avancement: {{ rapport.statistiques.taux_avancement_moyen|round(1) }}%</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">
                        {{ rapport.statistiques.constatations_par_gravite.get('critique', 0) }}
                    </h3>
                    <small> {{ t("Critical Findings") }} </small>
                    <div class="mt-2">
                        {% for gravite, count in rapport.statistiques.constatations_par_gravite.items() %}
                        <small class="d-block">{{ gravite|title }}: {{ count }}</small>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i> {{ t("Detailed Findings") }} </h5>
        </div>
        <div class="card-body">
            {% if rapport.constatations %}
                {% for constatation in rapport.constatations %}
                <div class="card mb-3">
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ constatation.reference }}</h6>
                            <small class="text-muted">
                                Créée le {{ constatation.created_at.strftime('%d/%m/%Y') }} 
                                par {{ constatation.createur.username if constatation.createur else 'Système' }}
                                
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-{{ 'danger' if constatation.type == 'non_conformite' else 'warning' if constatation.type == 'observation' else 'info' }} me-2">
                                {{ constatation.type_display }}
                            </span>
                            <span class="badge bg-{{ 'danger' if constatation.gravite == 'critique' else 'warning' if constatation.gravite == 'majeure' else 'info' if constatation.gravite == 'moyenne' else 'secondary' }}">
                                {{ constatation.gravite_display }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-align-left me-1"></i> {{ t("Description") }} </h6>
                            <p class="mb-0">{{ constatation.description }}</p>
                        </div>

                        {% if constatation.processus_concerne %}
                        <div class="mb-3">
                            <h6><i class="fas fa-project-diagram me-1"></i> {{ t("Process concerned") }} </h6>
                            <p class="mb-0">{{ constatation.processus_concerne }}</p>
                        </div>
                        {% endif %}

                        {% if constatation.cause_racine %}
                        <div class="mb-3">
                            <h6><i class="fas fa-search me-1"></i> {{ t("Root cause identified") }} </h6>
                            <p class="mb-0">{{ constatation.cause_racine }}</p>
                        </div>
                        {% endif %}

                        {% if constatation.conclusion %}
                        <div class="mb-3">
                            <h6><i class="fas fa-file-alt me-1"></i> {{ t("Conclusion (for final report)") }} </h6>
                            <div class="alert alert-info mb-0">
                                {{ constatation.conclusion }}
                            </div>
                        </div>
                        {% endif %}

                        {% if constatation.commentaires %}
                        <div class="mb-3">
                            <h6><i class="fas fa-comment me-1"></i> {{ t("Additional comments") }} </h6>
                            <div class="alert alert-warning mb-0">
                                {{ constatation.commentaires }}
                            </div>
                        </div>
                        {% endif %}

                        {% if constatation.recommandations_immediates %}
                        <div class="mb-3">
                            <h6><i class="fas fa-bolt me-1"></i> {{ t("Immediate recommendations") }} </h6>
                            <div class="alert alert-success mb-0">
                                {{ constatation.recommandations_immediates }}
                            </div>
                        </div>
                        {% endif %}

                        {% if constatation.documents_justificatifs %}
                        <div class="mb-3">
                            <h6><i class="fas fa-file me-1"></i> {{ t("Supporting documents") }} </h6>
                            <p class="mb-0">{{ constatation.documents_justificatifs }}</p>
                        </div>
                        {% endif %}

                        {% if constatation.risque %}
                        <div class="mb-3">
                            <h6><i class="fas fa-bug me-1"></i> {{ t("Associated risk") }} </h6>
                            <div class="alert alert-danger mb-0">
                                <strong>{{ constatation.risque.reference }}</strong> - {{ constatation.risque.intitule }}<br>
                                <small>Catégorie: {{ constatation.risque.categorie }} | Niveau: {{ constatation.risque.niveau }} | Score: {{ constatation.risque.score }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if constatation.preuves %}
                        <div class="mb-3">
                            <h6><i class="fas fa-paperclip me-1"></i> {{ t("Related evidence") }} </h6>
                            <ul class="list-group">
                                {% for preuve in constatation.preuves %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file me-2"></i>
                                        {{ preuve.nom }}
                                        {% if preuve.commentaire %}
                                        <br><small class="text-muted ms-4">{{ preuve.commentaire }}</small>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <small class="text-muted me-3">
                                            {{ preuve.responsable }} - {{ preuve.date_upload }}
                                        </small>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if constatation.recommandations_liees %}
                        <div class="mb-3">
                            <h6><i class="fas fa-lightbulb me-1"></i> {{ t("Related recommendations") }} </h6>
                            <div class="list-group">
                                {% for reco in constatation.recommandations_liees %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ reco.reference }}</strong>
                                            <br>
                                            <small class="text-muted">{{ reco.description }}</small>
                                        </div>
                                        <span class="badge bg-{{ 'success' if reco.statut == 'termine' else 'warning' if reco.statut == 'en_cours' else 'danger' if reco.statut == 'retarde' else 'secondary' }}">
                                            {{ reco.statut_display }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="mt-3">
                            <h6><i class="fas fa-info-circle me-1"></i> {{ t("Statut") }} </h6>
                            <span class="badge bg-{{ 'success' if constatation.statut == 'clos' else 'info' if constatation.statut == 'en_action' else 'warning' if constatation.statut == 'a_valider' else 'secondary' }}">
                                {{ constatation.statut_display }}
                            </span>
                            <small class="text-muted ms-3">
                                Dernière modification: {{ constatation.updated_at.strftime('%d/%m/%Y à %H:%M') if constatation.updated_at else 'N/A' }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                    <h5> {{ t("No findings") }} </h5>
                    <p class="text-muted"> {{ t("This audit does not contain any findings.") }} </p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-lightbulb me-2"></i> {{ t("Detailed Recommendations") }} </h5>
        </div>
        <div class="card-body">
            {% if rapport.recommandations %}
                {% for recommandation in rapport.recommandations %}
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ recommandation.reference }}</h6>
                            <small class="text-muted">
                                Créée le {{ recommandation.created_at.strftime('%d/%m/%Y') }}
                                {% if recommandation.responsable %}
                                    | Responsable: {{ recommandation.responsable }}
                                {% endif %}
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-{{ 'warning' if recommandation.type == 'corrective' else 'info' if recommandation.type == 'preventive' else 'success' }} me-2">
                                {{ recommandation.type_display }}
                            </span>
                            <span class="badge bg-{{ 'success' if recommandation.statut == 'termine' else 'warning' if recommandation.statut == 'en_cours' else 'danger' if recommandation.statut == 'retarde' else 'secondary' }}">
                                {{ recommandation.statut_display }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-align-left me-1"></i> {{ t("Description") }} </h6>
                            <p class="mb-0">{{ recommandation.description }}</p>
                        </div>

                        {% if recommandation.categorie %}
                        <div class="mb-3">
                            <h6><i class="fas fa-tag me-1"></i> {{ t("Catégorie") }} </h6>
                            <span class="badge bg-secondary">{{ recommandation.categorie_display }}</span>
                        </div>
                        {% endif %}

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><i class="fas fa-calendar me-1"></i> {{ t("Lead time") }} </h6>
                                <p class="mb-0">{{ recommandation.delai_display }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-clock me-1"></i> {{ t("Due date") }} </h6>
                                <p class="mb-0">
                                    {% if recommandation.date_echeance %}
                                        {{ recommandation.date_echeance.strftime('%d/%m/%Y') }}
                                        {% if recommandation.est_en_retard %}
                                            <span class="badge bg-danger ms-2"> {{ t("EN RETARD") }} </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted"> {{ t("Non définie") }} </span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6><i class="fas fa-chart-line me-1"></i> {{ t("Prioritization") }} </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <small>Urgence : {{ recommandation.urgence }}/5</small>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-warning" style="width: {{ (recommandation.urgence or 0) * 20 }}%"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <small>Impact : {{ recommandation.impact_operationnel }}/5</small>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-danger" style="width: {{ (recommandation.impact_operationnel or 0) * 20 }}%"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <small> {{ t("Priority Score") }} </small>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-{{ 'danger' if recommandation.score_priorite >= 80 else 'warning' if recommandation.score_priorite >= 60 else 'success' }}" 
                                             style="width: {{ recommandation.score_priorite }}%">
                                        </div>
                                    </div>
                                    <small>{{ recommandation.score_priorite }}/100</small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6><i class="fas fa-tasks me-1"></i> {{ t("Avancement") }} </h6>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-3" style="height: 10px;">
                                    <div class="progress-bar bg-{{ 'success' if recommandation.taux_avancement == 100 else 'warning' }}" 
                                         style="width: {{ recommandation.taux_avancement }}%">
                                    </div>
                                </div>
                                <span class="fw-bold">{{ recommandation.taux_avancement }}%</span>
                            </div>
                        </div>

                        {% if recommandation.constatation %}
                        <div class="mb-3">
                            <h6><i class="fas fa-exclamation-triangle me-1"></i> {{ t("Related finding") }} </h6>
                            <div class="alert alert-info mb-0">
                                <strong>{{ recommandation.constatation.reference }}</strong><br>
                                <small>{{ recommandation.constatation.description }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if recommandation.risque %}
                        <div class="mb-3">
                            <h6><i class="fas fa-bug me-1"></i> {{ t("Associated risk") }} </h6>
                            <div class="alert alert-danger mb-0">
                                <strong>{{ recommandation.risque.reference }}</strong> - {{ recommandation.risque.intitule }}<br>
                                <small>Catégorie: {{ recommandation.risque.categorie }} | Niveau: {{ recommandation.risque.niveau }} | Score: {{ recommandation.risque.score }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if recommandation.plan_action %}
                        <div class="mb-3">
                            <h6><i class="fas fa-tasks me-1"></i> {{ t("Related action plan") }} </h6>
                            <div class="alert alert-success mb-0">
                                <strong>{{ recommandation.plan_action.nom }}</strong><br>
                                <small>Statut: {{ recommandation.plan_action.statut }} | Réalisation: {{ recommandation.plan_action.pourcentage_realisation }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-lightbulb fa-3x text-muted mb-3"></i>
                    <h5> {{ t("No recommendation") }} </h5>
                    <p class="text-muted"> {{ t("This audit does not contain any recommendations.") }} </p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-tasks me-2"></i> {{ t("Detailed Action Plans") }} </h5>
        </div>
        <div class="card-body">
            {% if rapport.plans_action %}
                {% for plan in rapport.plans_action %}
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ plan.nom }}</h6>
                            <small class="text-muted">
                                Créé le {% if plan and plan.created_at %}{{ plan.created_at.strftime('%d/%m/%Y') }}{% else %}{{ "Date inconnue" }}{% endif %}
                                {% if plan.responsable %}
                                    | Responsable: {{ plan.responsable }}
                                {% endif %}
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-{{ 'success' if plan.statut == 'termine' else 'warning' if plan.statut == 'en_cours' else 'danger' if plan.statut == 'retarde' else 'secondary' }}">
                                {{ plan.statut_display }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        
                        {% if plan.description %}
                        <div class="mb-3">
                            <h6><i class="fas fa-align-left me-1"></i> {{ t("Description") }} </h6>
                            <p class="mb-0">{{ plan.description }}</p>
                        </div>
                        {% endif %}

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <h6><i class="fas fa-calendar-start me-1"></i> {{ t("Start date") }} </h6>
                                <p class="mb-0">
                                    {% if plan.date_debut %}
                                        {{ plan.date_debut.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        <span class="text-muted"> {{ t("Non définie") }} </span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-calendar-check me-1"></i> {{ t("Expected end date") }} </h6>
                                <p class="mb-0">
                                    {% if plan.date_fin_prevue %}
                                        {{ plan.date_fin_prevue.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        <span class="text-muted"> {{ t("Non définie") }} </span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-chart-line me-1"></i> {{ t("Réalisation") }} </h6>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-3" style="height: 10px;">
                                        <div class="progress-bar bg-{{ 'success' if plan.pourcentage_realisation == 100 else 'warning' }}" 
                                             style="width: {{ plan.pourcentage_realisation }}%">
                                        </div>
                                    </div>
                                    <span class="fw-bold">{{ plan.pourcentage_realisation }}%</span>
                                </div>
                            </div>
                        </div>

                        {% if plan.recommandation %}
                        <div class="mb-3">
                            <h6><i class="fas fa-lightbulb me-1"></i> {{ t("Related recommendation") }} </h6>
                            <div class="alert alert-info mb-0">
                                <strong>{{ plan.recommandation.reference }}</strong><br>
                                <small>{{ plan.recommandation.description }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if plan.risque %}
                        <div class="mb-3">
                            <h6><i class="fas fa-bug me-1"></i> {{ t("Associated risk") }} </h6>
                            <div class="alert alert-danger mb-0">
                                <strong>{{ plan.risque.reference }}</strong> - {{ plan.risque.intitule }}<br>
                                <small>Niveau: {{ plan.risque.niveau }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if plan.taches %}
                        <div class="mb-3">
                            <h6><i class="fas fa-list-check me-1"></i> {{ t("Tâches") }} </h6>
                            <div class="list-group">
                                {% for tache in plan.taches %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ tache.description }}</strong>
                                            {% if tache.responsable %}
                                            <br>
                                            <small class="text-muted">Responsable: {{ tache.responsable }}</small>
                                            {% endif %}
                                        </div>
                                        <div>
                                            {% if tache.date_echeance %}
                                            <small class="text-muted me-3">
                                                Échéance: {{ tache.date_echeance.strftime('%d/%m/%Y') }}
                                            </small>
                                            {% endif %}
                                            <span class="badge bg-{{ 'success' if tache.statut == 'termine' else 'warning' if tache.statut == 'en_cours' else 'danger' if tache.statut == 'retarde' else 'secondary' }}">
                                                {{ tache.statut }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5> {{ t("No action plan") }} </h5>
                    <p class="text-muted"> {{ t("This audit does not contain any action plan.") }} </p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="fas fa-chart-bar me-2"></i> {{ t("Summary and Conclusions") }} </h5>
        </div>
        <div class="card-body">
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-thumbs-up me-2"></i> {{ t("Points Forts") }} </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                {% set recommandations_terminees = rapport.recommandations|selectattr('statut', 'equalto', 'termine')|list|length %}
                                {% if recommandations_terminees > 0 %}
                                <li class="list-group-item">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>{{ recommandations_terminees }}</strong> {{ t("recommendations completed") }} </li>
                                {% endif %}
                                
                                {% if rapport.statistiques.plans_action_actifs > 0 %}
                                <li class="list-group-item">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>{{ rapport.statistiques.plans_action_actifs }}</strong> {{ t("active action plans") }} </li>
                                {% endif %}
                                
                                {% set constatations_closes = rapport.statistiques.constatations_par_statut.get('clos', 0) %}
                                {% if constatations_closes > 0 %}
                                <li class="list-group-item">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>{{ constatations_closes }}</strong> {{ t("constatations closes") }} </li>
                                {% endif %}
                                
                                {% set constatations_conformite = rapport.statistiques.constatations_par_type.get('conformite', 0) %}
                                {% if constatations_conformite > 0 %}
                                <li class="list-group-item">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>{{ constatations_conformite }}</strong> {{ t("compliance findings") }} </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i> {{ t("Improvement Points") }} </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                {% set recommandations_retard = rapport.recommandations|selectattr('est_en_retard', 'equalto', true)|list|length %}
                                {% if recommandations_retard > 0 %}
                                <li class="list-group-item">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    <strong>{{ recommandations_retard }}</strong> {{ t("recommandations en retard") }} </li>
                                {% endif %}
                                
                                {% set constatations_critiques = rapport.statistiques.constatations_par_gravite.get('critique', 0) %}
                                {% if constatations_critiques > 0 %}
                                <li class="list-group-item">
                                    <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                    <strong>{{ constatations_critiques }}</strong> {{ t("constatations critiques") }} </li>
                                {% endif %}
                                
                                {% set constatations_non_conformite = rapport.statistiques.constatations_par_type.get('non_conformite', 0) %}
                                {% if constatations_non_conformite > 0 %}
                                <li class="list-group-item">
                                    <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                    <strong>{{ constatations_non_conformite }}</strong> {{ t("non-conformities identified") }} </li>
                                {% endif %}
                                
                                {% if rapport.statistiques.taux_avancement_moyen < 50 %}
                                <li class="list-group-item">
                                    <i class="fas fa-tachometer-alt text-warning me-2"></i> {{ t("Low average advancement rate:") }} <strong>{{ rapport.statistiques.taux_avancement_moyen|round(1) }}%</strong>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bullhorn me-2"></i>
                        Recommandations Générales
                        {% if current_user.has_role('admin') %}
                        <a href="{{ url_for('admin_recommandations_globales') }}" 
                        class="btn btn-sm btn-outline-primary float-end">
                            <i class="fas fa-cog"></i> {{ t("Gérer") }} </a>
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i> {{ t("Recommendations for continuous improvement") }} </h6>
                        
                        {% if rapport.recommandations_globales %}
                        <ol class="mb-0">
                            {% for reco in rapport.recommandations_globales %}
                            <li>{{ reco.texte }}</li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="mb-0 text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune recommandation globale n'est configurée. 
                            {% if current_user.has_role('admin') %}
                            <a href="{{ url_for('admin_recommandations_globales') }}"> {{ t("Add some from the administration") }} </a>.
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>

                    <div class="mt-3">
                        <h6><i class="fas fa-plus-circle me-2"></i> {{ t("Additional recommendations for this audit") }} </h6>
                        <textarea class="form-control" id="recommandations-manuelles" rows="3" 
                                placeholder="{{ t("Add specific recommendations to this audit here...") }}"></textarea>
                        <button class="btn btn-sm btn-success mt-2" onclick="ajouterRecommandationManuelle()">
                            <i class="fas fa-save me-1"></i> {{ t("Add to report") }} </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-file-contract me-2"></i> {{ t("General Conclusion") }} </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary">
                        <p> {{ t("L'audit") }} <strong>{{ audit.reference }}</strong> {{ t("made it possible to identify") }} <strong>{{ rapport.statistiques.total_constatations }}</strong> constatations, 
                           dont <strong>{{ rapport.statistiques.constatations_par_type.get('non_conformite', 0) }}</strong> {{ t("non-conformities and") }} <strong>{{ rapport.statistiques.constatations_par_gravite.get('critique', 0) }}</strong> {{ t("critical points.") }} </p>
                        
                        <p> {{ t("The management system has demonstrated its ability to identify and address discrepancies through") }} <strong>{{ rapport.statistiques.total_recommandations }}</strong> {{ t("recommendations issued and") }} <strong>{{ rapport.statistiques.total_plans_action }}</strong> {{ t("action plans implemented.") }} </p>
                        
                        <p> {{ t("The overall progress rate of the actions is") }} <strong>{{ rapport.statistiques.taux_avancement_moyen|round(1) }}%</strong>, 
                           indiquant une prise en charge effective des points identifiés.</p>
                        
                        <p class="mb-0"><strong> {{ t("Final recommendation:") }} </strong> Maintenir la dynamique d'amélioration continue et programmer un audit 
                           de suivi dans 6 mois pour vérifier l'efficacité et la pérennité des actions mises en œuvre.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 p-3 bg-light rounded text-center">
        <p class="mb-2">
            <strong>Rapport généré le {{ current_datetime.strftime('%d/%m/%Y à %H:%M') }}</strong>
        </p>
        <p class="text-muted mb-0"> {{ t("Integrated Management System - Internal Control") }} <br> {{ t("This document is confidential and intended for internal use only") }} </p>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
    margin-bottom: 1rem;
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    background-color: #f8f9fa;
}

.badge {
    font-size: 0.75em;
    font-weight: 500;
}

.alert {
    border: none;
    border-left: 4px solid;
}

.alert-info {
    border-left-color: #0dcaf0;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-success {
    border-left-color: #198754;
}

.alert-danger {
    border-left-color: #dc3545;
}

.alert-secondary {
    border-left-color: #6c757d;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.list-group-item:last-child {
    border-bottom: none;
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}

@media print {
    .btn {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000;
        page-break-inside: avoid;
    }
    
    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000;
    }
    
    .badge {
        border: 1px solid #000;
        color: #000 !important;
        background-color: transparent !important;
    }
}
</style>

<script>
function ajouterRecommandationManuelle() {
    const textarea = document.getElementById('recommandations-manuelles');
    const texte = textarea.value.trim();
    
    if (texte) {
        // Créer un nouvel élément de liste
        const liste = document.querySelector('.alert-info ol');
        if (!liste) {
            // Créer la liste si elle n'existe pas
            const alertDiv = document.querySelector('.alert-info');
            const liste = document.createElement('ol');
            liste.className = 'mb-0';
            alertDiv.appendChild(liste);
        }
        
        const nouvelElement = document.createElement('li');
        nouvelElement.textContent = texte;
        document.querySelector('.alert-info ol').appendChild(nouvelElement);
        
        // Effacer le textarea
        textarea.value = '';
        
        // Afficher un message de confirmation
        alert('Recommandation ajoutée au rapport (cette recommandation sera perdue à la fermeture de la page)');
    }
}
</script>
{% endblock %}
