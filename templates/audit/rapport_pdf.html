<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport d'Audit - {{ audit.reference }}</title>
    <style>
        /* ============================================
           STYLES G√âN√âRAUX - DESIGN BLEU PUR
           ============================================ */
        @page {
            size: A4;
            margin: 2cm 1.5cm;
            
            @top-center {
                content: "RAPPORT D'AUDIT";
                font-family: 'Helvetica', 'Arial', sans-serif;
                font-size: 9pt;
                color: #1e3a8a;
                letter-spacing: 1px;
            }
            
            @bottom-right {
                content: "Page " counter(page) " / " counter(pages);
                font-family: 'Helvetica', 'Arial', sans-serif;
                font-size: 9pt;
                color: #1e3a8a;
            }
            
            @bottom-left {
                content: "G√©n√©r√© le {{ generation_date }}";
                font-family: 'Helvetica', 'Arial', sans-serif;
                font-size: 9pt;
                color: #1e3a8a;
            }
        }
        
        /* Page de garde */
        @page :first {
            margin-top: 4cm;
            
            @top-center {
                content: "";
            }
        }
        
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            line-height: 1.6;
            color: #1e293b;
            background: white;
        }
        
        /* ============================================
           TYPOGRAPHIE - TOUT EN BLEU
           ============================================ */
        h1 {
            font-size: 28pt;
            font-weight: 300;
            color: #1e3a8a;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }
        
        h2 {
            font-size: 20pt;
            font-weight: 400;
            color: #1e3a8a;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 8px;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        h3 {
            font-size: 16pt;
            font-weight: 500;
            color: #2563eb;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        h4 {
            font-size: 14pt;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 10px;
        }
        
        h5 {
            font-size: 12pt;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 10px;
        }
        
        /* ============================================
           PAGE DE GARDE - BLEUE
           ============================================ */
        .cover-page {
            text-align: center;
            page-break-after: always;
            padding: 0;
            margin: 0;
        }
        
        .cover-title {
            font-size: 42pt;
            font-weight: 200;
            color: #1e3a8a;
            margin-top: 120px;
            letter-spacing: 2px;
        }
        
        .cover-subtitle {
            font-size: 24pt;
            font-weight: 300;
            color: #2563eb;
            margin-top: 20px;
        }
        
        .cover-reference {
            font-size: 18pt;
            color: #3b82f6;
            margin-top: 30px;
            font-family: monospace;
        }
        
        .cover-date {
            font-size: 14pt;
            color: #60a5fa;
            margin-top: 200px;
        }
        
        .cover-logo svg path {
            stroke: #2563eb;
            fill: none;
        }
        
        /* ============================================
           CARTES ET CONTENEURS - BLEUS
           ============================================ */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.15);
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dbeafe;
            page-break-inside: avoid;
        }
        
        .card-header {
            border-bottom: 1px solid #dbeafe;
            padding-bottom: 15px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #1e3a8a;
        }
        
        .card-header i {
            color: #2563eb;
            margin-right: 10px;
        }
        
        /* ============================================
           GRILLE ET MISE EN PAGE
           ============================================ */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col-3 {
            flex: 0 0 25%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        .col-4 {
            flex: 0 0 33.333%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        .col-6 {
            flex: 0 0 50%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        .col-8 {
            flex: 0 0 66.666%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        .col-12 {
            flex: 0 0 100%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        /* ============================================
           STATISTIQUES ET KPI - BLEUS
           ============================================ */
        .kpi-grid {
            display: flex;
            flex-wrap: wrap;
            margin: 20px -10px;
        }
        
        .kpi-item {
            flex: 1;
            min-width: 150px;
            margin: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 15px 35px rgba(37, 99, 235, 0.3);
        }
        
        .kpi-item.primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
        }
        
        .kpi-item.success {
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
        }
        
        .kpi-item.warning {
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
        }
        
        .kpi-item.info {
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
        }
        
        .kpi-value {
            font-size: 36pt;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .kpi-label {
            font-size: 11pt;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* ============================================
           TABLEAUX - BLEUS
           ============================================ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 10pt;
        }
        
        th {
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
            color: white;
            font-weight: 600;
            padding: 12px 10px;
            text-align: left;
            border-radius: 5px 5px 0 0;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #dbeafe;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover td {
            background-color: #eff6ff;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        /* ============================================
           BADGES ET √âTIQUETTES - TOUS BLEUS
           ============================================ */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 9pt;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }
        
        .badge-success {
            background: #2563eb;
            color: white;
        }
        
        .badge-warning {
            background: #2563eb;
            color: white;
        }
        
        .badge-danger {
            background: #2563eb;
            color: white;
        }
        
        .badge-info {
            background: #3b82f6;
            color: white;
        }
        
        .badge-primary {
            background: #1e3a8a;
            color: white;
        }
        
        .badge-secondary {
            background: #60a5fa;
            color: white;
        }
        
        /* ============================================
           BARRES DE PROGRESSION - BLEUES
           ============================================ */
        .progress {
            background: #dbeafe;
            border-radius: 50px;
            height: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 50px;
            background: linear-gradient(90deg, #2563eb 0%, #1e3a8a 100%);
        }
        
        .progress-bar-success {
            background: linear-gradient(90deg, #2563eb 0%, #1e3a8a 100%);
        }
        
        .progress-bar-warning {
            background: linear-gradient(90deg, #2563eb 0%, #1e3a8a 100%);
        }
        
        .progress-bar-info {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        }
        
        /* ============================================
           SECTIONS SP√âCIFIQUES - BLEUES
           ============================================ */
        .signature-section {
            margin-top: 50px;
            page-break-inside: avoid;
            border-top: 2px dashed #2563eb;
            padding-top: 30px;
        }
        
        .signature-box {
            display: inline-block;
            width: 45%;
            margin: 0 2%;
            text-align: center;
        }
        
        .signature-line {
            border-bottom: 1px solid #1e3a8a;
            margin: 20px 0 10px;
            padding-top: 20px;
        }
        
        .comment-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 15px 0;
            font-style: italic;
            border-radius: 0 8px 8px 0;
        }
        
        /* ============================================
           MISE EN PAGE DES PREUVES - BLEUE
           ============================================ */
        .preuve-item {
            background: #eff6ff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 9pt;
        }
        
        .preuve-item i {
            color: #2563eb;
            margin-right: 8px;
        }
        
        /* ============================================
           SAUTS DE PAGE
           ============================================ */
        .page-break {
            page-break-before: always;
        }
        
        .no-break {
            page-break-inside: avoid;
        }
        
        /* ============================================
           COULEURS PERSONNALIS√âES - BLEU PUR
           ============================================ */
        .text-primary { color: #2563eb; }
        .text-success { color: #2563eb; }
        .text-warning { color: #2563eb; }
        .text-danger { color: #2563eb; }
        .text-muted { color: #6b7280; }
        .text-info { color: #3b82f6; }
        
        .bg-primary { background: #2563eb; }
        .bg-light { background: #eff6ff; }
        .bg-info-light { background: #dbeafe; }
        
        /* ============================================
           LISTES - BLEUES
           ============================================ */
        ul li {
            margin-bottom: 8px;
        }
        
        ul li::marker {
            color: #2563eb;
        }
        
        ol li {
            margin-bottom: 8px;
        }
        
        ol li::marker {
            color: #2563eb;
            font-weight: bold;
        }
        
        hr {
            border: none;
            border-top: 1px solid #dbeafe;
            margin: 20px 0;
        }
        
        /* ============================================
           MARGES ET ESPACEMENTS
           ============================================ */
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mt-3 { margin-top: 30px; }
        .mt-4 { margin-top: 40px; }
        .mt-5 { margin-top: 50px; }
        
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .mb-3 { margin-bottom: 30px; }
        .mb-4 { margin-bottom: 40px; }
        .mb-5 { margin-bottom: 50px; }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        /* ============================================
           IMPRESSION
           ============================================ */
        @media print {
            .no-print { display: none; }
            a { text-decoration: none; color: #1e293b; }
        }
    </style>
</head>
<body>
    <!-- ============================================
         PAGE DE GARDE - BLEUE
         ============================================ -->
    <div class="cover-page">
        <div class="cover-logo">
            <!-- Logo en bleu -->
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 17L12 22L22 17" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12L12 17L22 12" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        
        <h1 class="cover-title">RAPPORT D'AUDIT</h1>
        <h2 class="cover-subtitle">{{ audit.titre }}</h2>
        <div class="cover-reference">{{ audit.reference }}</div>
        
        <div class="cover-date">
            {{ generation_date }}<br>
            {{ generation_heure }}
        </div>
    </div>

    <!-- ============================================
         SECTION 1: R√âSUM√â EX√âCUTIF
         ============================================ -->
    <div class="page-break">
        <h2>üìä R√©sum√© Ex√©cutif</h2>
        
        <div class="kpi-grid">
            <div class="kpi-item primary">
                <div class="kpi-value">{{ audit.score_global|default(0) }}%</div>
                <div class="kpi-label">Score Global</div>
            </div>
            <div class="kpi-item success">
                <div class="kpi-value">{{ statistiques.total_constatations }}</div>
                <div class="kpi-label">Constatations</div>
            </div>
            <div class="kpi-item warning">
                <div class="kpi-value">{{ statistiques.total_recommandations }}</div>
                <div class="kpi-label">Recommandations</div>
            </div>
            <div class="kpi-item info">
                <div class="kpi-value">{{ statistiques.taux_realisation_recommandations|default(0) }}%</div>
                <div class="kpi-label">Taux R√©alisation</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> Informations Cl√©s
            </div>
            <div class="row">
                <div class="col-6">
                    <table style="border: none;">
                        <tr>
                            <td><strong>R√©f√©rence :</strong></td>
                            <td>{{ audit.reference }}</td>
                        </tr>
                        <tr>
                            <td><strong>Type d'audit :</strong></td>
                            <td><span class="badge badge-info">{{ audit.type_audit }}</span></td>
                        </tr>
                        <tr>
                            <td><strong>Statut :</strong></td>
                            <td>
                                <span class="badge badge-{{ 'success' if audit.statut == 'termine' else 'warning' if audit.statut == 'en_cours' else 'info' }}">
                                    {{ audit.statut|title }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Responsable :</strong></td>
                            <td>{{ audit.responsable_obj.username if audit.responsable_obj else 'Non assign√©' }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-6">
                    <table>
                        <tr>
                            <td><strong>P√©riode :</strong></td>
                            <td>
                                {% if audit.date_debut_prevue and audit.date_fin_prevue %}
                                    {{ audit.date_debut_prevue.strftime('%d/%m/%Y') }} - {{ audit.date_fin_prevue.strftime('%d/%m/%Y') }}
                                {% else %}
                                    Non d√©finie
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Processus :</strong></td>
                            <td>{{ audit.processus_audite_display|default('Non sp√©cifi√©') }}</td>
                        </tr>
                        <tr>
                            <td><strong>Cr√©√© par :</strong></td>
                            <td>{{ createur_audit.username if createur_audit else 'Syst√®me' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Date cr√©ation :</strong></td>
                            <td>{{ audit.created_at.strftime('%d/%m/%Y') if audit.created_at else '' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        {% if audit.description %}
        <div class="card">
            <div class="card-header">
                <i class="fas fa-align-left"></i> Description
            </div>
            <div class="comment-box">
                {{ audit.description }}
            </div>
        </div>
        {% endif %}

        {% if audit.objectifs %}
        <div class="card">
            <div class="card-header">
                <i class="fas fa-bullseye"></i> Objectifs
            </div>
            <div class="comment-box">
                {{ audit.objectifs }}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ============================================
         SECTION 2: CONSTATATIONS
         ============================================ -->
    <div class="page-break">
        <h2>üîç Constatations d'Audit</h2>
        
        <!-- Statistiques des constatations -->
        <div class="row mb-4">
            <div class="col-3">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.constatations_par_type.get('non_conformite', 0) }}</h4>
                    <small class="text-muted">Non-conformit√©s</small>
                </div>
            </div>
            <div class="col-3">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.constatations_par_type.get('observation', 0) }}</h4>
                    <small class="text-muted">Observations</small>
                </div>
            </div>
            <div class="col-3">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.constatations_par_gravite.get('critique', 0) }}</h4>
                    <small class="text-muted">Critiques</small>
                </div>
            </div>
            <div class="col-3">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.constatations_par_statut.get('clos', 0) }}</h4>
                    <small class="text-muted">Closes</small>
                </div>
            </div>
        </div>

        {% for constatation in constatations %}
        <div class="card no-break">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>
                        <i class="fas fa-exclamation-triangle"></i> 
                        {{ constatation.reference }}
                    </span>
                    <div>
                        <span class="badge badge-{{ 'danger' if constatation.gravite == 'critique' else 'warning' if constatation.gravite == 'majeure' else 'info' }}">
                            {{ constatation.gravite_display }}
                        </span>
                        <span class="badge badge-{{ 'danger' if constatation.type == 'non_conformite' else 'warning' }}">
                            {{ constatation.type_display }}
                        </span>
                        <span class="badge badge-{{ 'success' if constatation.statut == 'clos' else 'warning' }}">
                            {{ constatation.statut_display }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-8">
                    <p><strong>Description :</strong> {{ constatation.description }}</p>
                    
                    {% if constatation.processus_concerne %}
                    <p><strong>Processus concern√© :</strong> {{ constatation.processus_concerne }}</p>
                    {% endif %}
                    
                    {% if constatation.cause_racine %}
                    <div class="comment-box">
                        <strong>Cause racine :</strong><br>
                        {{ constatation.cause_racine }}
                    </div>
                    {% endif %}
                    
                    {% if constatation.recommandations_immediates %}
                    <div class="bg-light p-2 mt-2">
                        <strong>Recommandations imm√©diates :</strong><br>
                        {{ constatation.recommandations_immediates }}
                    </div>
                    {% endif %}
                    
                    {% if constatation.commentaires %}
                    <div class="mt-2">
                        <small class="text-muted"><i class="fas fa-comment"></i> {{ constatation.commentaires }}</small>
                    </div>
                    {% endif %}
                    
                    {% if constatation.preuves %}
                    <div class="mt-2">
                        <strong>Preuves :</strong>
                        {% for preuve in constatation.preuves %}
                        <div class="preuve-item">
                            <i class="fas fa-paperclip"></i> {{ preuve.nom }}
                            {% if preuve.commentaire %}
                            <br><small class="text-muted">{{ preuve.commentaire }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="col-4">
                    <div class="bg-light p-3 rounded">
                        <h5>Risque associ√©</h5>
                        {% if constatation.risque %}
                        <p><strong>{{ constatation.risque.reference }}</strong><br>
                        {{ constatation.risque.intitule }}</p>
                        <p>
                            <span class="badge badge-info">
                                {{ constatation.risque.niveau }}
                            </span>
                            Score: {{ constatation.risque.score }}
                        </p>
                        {% else %}
                        <p class="text-muted">Aucun risque associ√©</p>
                        {% endif %}
                        
                        {% if constatation.recommandations_liees %}
                        <h5 class="mt-3">Recommandations li√©es</h5>
                        <ul>
                            {% for reco in constatation.recommandations_liees %}
                            <li>
                                <strong>{{ reco.reference }}</strong><br>
                                <small>{{ reco.description }}</small><br>
                                <span class="badge badge-{{ 'success' if reco.statut == 'termine' else 'warning' }}">
                                    {{ reco.statut_display }}
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <p class="text-muted">Aucune constatation enregistr√©e.</p>
        </div>
        {% endfor %}
    </div>

    <!-- ============================================
         SECTION 3: RECOMMANDATIONS
         ============================================ -->
    <div class="page-break">
        <h2>üí° Recommandations</h2>
        
        <!-- Statistiques des recommandations -->
        <div class="row mb-4">
            <div class="col-4">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.recommandations_par_type.get('corrective', 0) }}</h4>
                    <small class="text-muted">Correctives</small>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.recommandations_par_type.get('preventive', 0) }}</h4>
                    <small class="text-muted">Pr√©ventives</small>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.recommandations_par_statut.get('termine', 0) }}</h4>
                    <small class="text-muted">Termin√©es</small>
                </div>
            </div>
        </div>

        {% for recommandation in recommandations %}
        <div class="card no-break">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>
                        <i class="fas fa-lightbulb"></i> 
                        {{ recommandation.reference }}
                    </span>
                    <div>
                        <span class="badge badge-{{ 'success' if recommandation.statut == 'termine' else 'warning' if recommandation.statut == 'en_cours' else 'info' }}">
                            {{ recommandation.statut_display }}
                        </span>
                        <span class="badge badge-primary">Priorit√©: {{ recommandation.score_priorite }}/100</span>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-8">
                    <p><strong>Description :</strong> {{ recommandation.description }}</p>
                    
                    <div class="row">
                        <div class="col-6">
                            <strong>Type :</strong> {{ recommandation.type_display }}
                        </div>
                        <div class="col-6">
                            <strong>Cat√©gorie :</strong> {{ recommandation.categorie_display|default('Non d√©finie') }}
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-6">
                            <strong>D√©lai :</strong> {{ recommandation.delai_display|default('Non d√©fini') }}
                        </div>
                        <div class="col-6">
                            <strong>√âch√©ance :</strong> 
                            {% if recommandation.date_echeance_str %}
                                <span class="text-primary">
                                    {{ recommandation.date_echeance_str }}
                                    {% if recommandation.est_en_retard %} (EN RETARD){% endif %}
                                </span>
                            {% else %}
                                Non d√©finie
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <strong>Avancement :</strong>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ recommandation.taux_avancement }}%"></div>
                        </div>
                        <small>{{ recommandation.taux_avancement }}%</small>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-6">
                            <small><strong>Cr√©√© par :</strong> {{ recommandation.createur|default('Syst√®me') }}</small>
                        </div>
                        <div class="col-6">
                            <small><strong>Responsable :</strong> {{ recommandation.responsable|default('Non assign√©') }}</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-4">
                    <div class="bg-light p-3 rounded">
                        {% if recommandation.constatation %}
                        <h5>Constatation source</h5>
                        <p><strong>{{ recommandation.constatation.reference }}</strong><br>
                        <small>{{ recommandation.constatation.description }}</small></p>
                        {% endif %}
                        
                        {% if recommandation.risque %}
                        <h5 class="mt-3">Risque associ√©</h5>
                        <p><strong>{{ recommandation.risque.reference }}</strong><br>
                        {{ recommandation.risque.intitule }}</p>
                        <p>
                            <span class="badge badge-info">
                                {{ recommandation.risque.niveau }}
                            </span>
                        </p>
                        {% endif %}
                        
                        {% if recommandation.plan_action %}
                        <h5 class="mt-3">Plan d'action</h5>
                        <p><strong>{{ recommandation.plan_action.nom }}</strong><br>
                        <span class="badge badge-{{ 'success' if recommandation.plan_action.statut == 'termine' else 'warning' }}">
                            {{ recommandation.plan_action.statut_display }}
                        </span></p>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ recommandation.plan_action.pourcentage_realisation }}%"></div>
                        </div>
                        <small>{{ recommandation.plan_action.pourcentage_realisation }}%</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <p class="text-muted">Aucune recommandation enregistr√©e.</p>
        </div>
        {% endfor %}
    </div>

    <!-- ============================================
         SECTION 4: PLANS D'ACTION
         ============================================ -->
    <div class="page-break">
        <h2>üìã Plans d'Action</h2>
        
        <div class="row mb-4">
            <div class="col-4">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.plans_action_actifs }}</h4>
                    <small class="text-muted">Plans actifs</small>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center">
                    <h4 class="text-primary">{{ statistiques.taux_avancement_moyen|default(0) }}%</h4>
                    <small class="text-muted">Avancement moyen</small>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center">
                    <h4 class="text-primary">{{ echeances_a_venir|length }}</h4>
                    <small class="text-muted">√âch√©ances 7 jours</small>
                </div>
            </div>
        </div>

        {% for plan in plans_action %}
        <div class="card no-break">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>
                        <i class="fas fa-tasks"></i> 
                        {{ plan.nom }}
                    </span>
                    <span class="badge badge-{{ 'success' if plan.statut == 'termine' else 'warning' if plan.statut == 'en_cours' else 'info' }}">
                        {{ plan.statut_display }}
                    </span>
                </div>
            </div>
            
            <div class="row">
                <div class="col-8">
                    {% if plan.description %}
                    <p><strong>Description :</strong> {{ plan.description }}</p>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-4">
                            <strong>D√©but :</strong> {{ plan.date_debut_str|default('Non d√©finie') }}
                        </div>
                        <div class="col-4">
                            <strong>Fin pr√©vue :</strong> {{ plan.date_fin_prevue_str|default('Non d√©finie') }}
                        </div>
                        <div class="col-4">
                            <strong>Fin r√©elle :</strong> {{ plan.date_fin_reelle_str|default('-') }}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <strong>Progression globale :</strong>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ plan.pourcentage_realisation }}%"></div>
                        </div>
                        <small>{{ plan.pourcentage_realisation }}%</small>
                    </div>
                    
                    {% if plan.sous_actions %}
                    <div class="mt-3">
                        <h5>Sous-actions</h5>
                        <table>
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Statut</th>
                                    <th>√âch√©ance</th>
                                    <th>Responsable</th>
                                    <th>Avancement</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sa in plan.sous_actions %}
                                <tr>
                                    <td>{{ sa.description[:50] }}...</td>
                                    <td>
                                        <span class="badge badge-{{ 'success' if sa.statut == 'termine' else 'warning' }}">
                                            {{ sa.statut_display }}
                                        </span>
                                    </td>
                                    <td>{{ sa.date_fin_prevue_str|default('-') }}</td>
                                    <td>{{ sa.responsable|default('-') }}</td>
                                    <td>{{ sa.pourcentage_realisation }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-4">
                    <div class="bg-light p-3 rounded">
                        {% if plan.recommandation %}
                        <h5>Recommandation source</h5>
                        <p><strong>{{ plan.recommandation.reference }}</strong><br>
                        <small>{{ plan.recommandation.description }}</small></p>
                        {% endif %}
                        
                        {% if plan.risque %}
                        <h5 class="mt-3">Risque associ√©</h5>
                        <p><strong>{{ plan.risque.reference }}</strong><br>
                        {{ plan.risque.intitule }}</p>
                        {% endif %}
                        
                        {% if plan.responsable_obj %}
                        <h5 class="mt-3">Responsable</h5>
                        <p>{{ plan.responsable_obj.username }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <p class="text-muted">Aucun plan d'action enregistr√©.</p>
        </div>
        {% endfor %}
    </div>

    <!-- ============================================
         SECTION 5: ANALYSE ET RECOMMANDATIONS GLOBALES
         ============================================ -->
    <div class="page-break">
        <h2>üìà Analyse & Recommandations Globales</h2>
        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line"></i> Analyse Synth√©tique
            </div>
            
            <div class="row">
                <div class="col-6">
                    <h5>Points Forts</h5>
                    <ul>
                        <li>Score global de {{ audit.score_global|default(0) }}%</li>
                        <li>{{ statistiques.constatations_par_statut.get('clos', 0) }} constatations closes sur {{ statistiques.total_constatations }}</li>
                        <li>{{ statistiques.recommandations_par_statut.get('termine', 0) }} recommandations termin√©es</li>
                        <li>Taux de r√©alisation des recommandations : {{ statistiques.taux_realisation_recommandations|default(0) }}%</li>
                    </ul>
                </div>
                <div class="col-6">
                    <h5>Points d'Am√©lioration</h5>
                    <ul>
                        <li>{{ statistiques.constatations_par_gravite.get('critique', 0) }} constatations critiques √† traiter en priorit√©</li>
                        <li>{{ statistiques.recommandations_par_statut.get('a_traiter', 0) }} recommandations en attente</li>
                        <li>{{ statistiques.plans_action_actifs }} plans d'action en cours</li>
                        <li>Avancement moyen des plans : {{ statistiques.taux_avancement_moyen|default(0) }}%</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-lightbulb"></i> Recommandations Strat√©giques
            </div>
            
            <ol>
                {% for recommandation in recommandations_globales %}
                <li class="mb-2">{{ recommandation }}</li>
                {% endfor %}
            </ol>
        </div>

        {% if echeances_a_venir %}
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-alt"></i> √âch√©ances √† venir (7 jours)
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>R√©f√©rence</th>
                        <th>Description</th>
                        <th>√âch√©ance</th>
                        <th>Jours restants</th>
                    </tr>
                </thead>
                <tbody>
                    {% for echeance in echeances_a_venir %}
                    <tr>
                        <td>
                            {% if echeance.type == 'recommandation' %}
                            <span class="badge badge-info">Recommandation</span>
                            {% else %}
                            <span class="badge badge-warning">Plan d'action</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if echeance.type == 'recommandation' %}
                            {{ echeance.objet.reference }}
                            {% else %}
                            {{ echeance.objet.reference }}
                            {% endif %}
                        </td>
                        <td>
                            {% if echeance.type == 'recommandation' %}
                            {{ echeance.objet.description[:50] }}...
                            {% else %}
                            {{ echeance.objet.nom }}
                            {% endif %}
                        </td>
                        <td>
                            {% if echeance.type == 'recommandation' %}
                            {{ echeance.objet.date_echeance.strftime('%d/%m/%Y') }}
                            {% else %}
                            {{ echeance.objet.date_fin_prevue.strftime('%d/%m/%Y') }}
                            {% endif %}
                        </td>
                        <td class="text-primary">
                            {{ echeance.jours_restants }} jour(s)
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- ============================================
         SECTION 6: FICHIERS JOINTS
         ============================================ -->
    {% if fichiers_rapport %}
    <div class="page-break">
        <h2>üìé Fichiers joints au rapport</h2>
        
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Nom du fichier</th>
                        <th>Type</th>
                        <th>Taille</th>
                        <th>Description</th>
                        <th>Date d'ajout</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fichier in fichiers_rapport %}
                    <tr>
                        <td>{{ fichier.nom_fichier }}</td>
                        <td><span class="badge badge-info">{{ fichier.type_fichier|default('N/A') }}</span></td>
                        <td>{{ format_taille(fichier.taille) if fichier.taille else 'N/A' }}</td>
                        <td>{{ fichier.description|default('-') }}</td>
                        <td>{{ fichier.created_at.strftime('%d/%m/%Y') if fichier.created_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div class="mt-3">
                <p><strong>Total :</strong> {{ stats_fichiers.total }} fichiers ({{ stats_fichiers.total_taille_formatee }})</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ============================================
         SECTION 7: SIGNATURES ET CL√îTURE
         ============================================ -->
    <div class="page-break">
        <h2>‚úÖ Cl√¥ture du Rapport</h2>
        
        <div class="card text-center">
            <p>Le pr√©sent rapport a √©t√© √©tabli conform√©ment aux proc√©dures d'audit en vigueur.</p>
            <p>Il refl√®te la situation de l'audit √† la date du {{ generation_date }}.</p>
        </div>

        <div class="signature-section">
            <div class="signature-box">
                <div class="signature-line"></div>
                <p><strong>L'Auditeur Responsable</strong></p>
                <p>{{ audit.responsable_obj.username if audit.responsable_obj else '' }}</p>
                <p>{{ generation_date }}</p>
            </div>
            
            <div class="signature-box">
                <div class="signature-line"></div>
                <p><strong>Le Responsable Qualit√©</strong></p>
                <p>{{ createur_audit.username if createur_audit else '' }}</p>
                <p>{{ generation_date }}</p>
            </div>
        </div>
        
        <div class="text-center mt-5">
            <small class="text-muted">
                Document g√©n√©r√© automatiquement par le Syst√®me de Management Int√©gr√©<br>
                ID du rapport : RAP-{{ audit.reference }}-{{ generation_date|replace('/', '') }}
            </small>
        </div>
    </div>
</body>
</html>
