{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-tasks me-2"></i>Plan d'Action: {{ plan_action.nom }}</h2>
    <div>
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#modifierPlanModal">
            <i class="fas fa-edit me-1"></i> {{ t("Modifier") }} </button>
        <a href="{{ url_for('liste_plans_action') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> {{ t("Retour") }} </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"> {{ t("Plan Information") }} </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong> {{ t("Référence:") }} </strong> {{ plan_action.reference }}<br>
                        <strong> {{ t("Nom:") }} </strong> {{ plan_action.nom }}<br>
                        <strong> {{ t("Audit:") }} </strong> 
                        <a href="{{ url_for('detail_audit', id=plan_action.audit.id) }}">
                            {{ plan_action.audit.reference }} - {{ plan_action.audit.titre|truncate(50) }}
                        </a><br>
                        <strong> {{ t("Statut:") }} </strong> 
                        {% if plan_action.statut == 'en_attente' %}
                        <span class="badge bg-secondary"> {{ t("En attente") }} </span>
                        {% elif plan_action.statut == 'en_cours' %}
                        <span class="badge bg-warning"> {{ t("En cours") }} </span>
                        {% elif plan_action.statut == 'termine' %}
                        <span class="badge bg-success"> {{ t("Terminé") }} </span>
                        {% elif plan_action.statut == 'retarde' %}
                        <span class="badge bg-danger"> {{ t("Retardé") }} </span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong> {{ t("Responsible:") }} </strong> 
                        {% if plan_action.responsable %}
                        {{ plan_action.responsable.username }}
                        {% else %}
                        <span class="text-muted"> {{ t("Non assigné") }} </span>
                        {% endif %}<br>
                        <strong> {{ t("Start date:") }} </strong> 
                        {{ plan_action.date_debut.strftime('%d/%m/%Y') if plan_action.date_debut else 'Non définie' }}<br>
                        <strong> {{ t("Expected end date:") }} </strong> 
                        {{ plan_action.date_fin_prevue.strftime('%d/%m/%Y') if plan_action.date_fin_prevue else 'Non définie' }}<br>
                        {% if plan_action.date_fin_reelle %}
                        <strong> {{ t("Actual end date:") }} </strong> 
                        {{ plan_action.date_fin_reelle.strftime('%d/%m/%Y') }}
                        {% endif %}
                    </div>
                </div>
                
                {% if plan_action.description %}
                <hr>
                <strong> {{ t("Description:") }} </strong>
                <p class="mt-2">{{ plan_action.description }}</p>
                {% endif %}

                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong> {{ t("Progress:") }} </strong>
                        <div class="progress mt-2" style="height: 25px;">
                            <div class="progress-bar 
                                {% if plan_action.progression_reelle >= 80 %}bg-success
                                {% elif plan_action.progression_reelle >= 50 %}bg-warning
                                {% else %}bg-danger{% endif %}" 
                                role="progressbar" 
                                style="width: {{ plan_action.progression_reelle }}%">
                                {{ plan_action.progression_reelle }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        {% if plan_action.est_en_retard %}
                        <div class="alert alert-danger py-2 mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong> {{ t("En retard!") }} </strong> {{ t("The planned end date has passed") }} </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list-check me-2"></i> {{ t("Sous-actions") }} <span class="badge bg-primary ms-2">{{ plan_action.sous_actions|length }}</span>
                </h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#ajouterSousActionModal">
                    <i class="fas fa-plus me-1"></i> {{ t("Ajouter") }} </button>
            </div>
            <div class="card-body">
                {% if plan_action.sous_actions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="25%"> {{ t("Description") }} </th>
                                <th width="15%"> {{ t("Responsable") }} </th>
                                <th width="15%"> {{ t("Dates") }} </th>
                                <th width="15%"> {{ t("Avancement") }} </th>
                                <th width="15%"> {{ t("Statut") }} </th>
                                <th width="15%"> {{ t("Actions") }} </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sous_action in plan_action.sous_actions %}
                            <tr>
                                <td>
                                    <strong>{{ sous_action.description|truncate(80) }}</strong>
                                    {% if sous_action.reference %}
                                    <br><small class="text-muted">{{ sous_action.reference }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sous_action.responsable %}
                                    {{ sous_action.responsable.username }}
                                    {% else %}
                                    <span class="text-muted"> {{ t("Non assigné") }} </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sous_action.date_debut %}
                                    <small>Début: {{ sous_action.date_debut.strftime('%d/%m/%Y') }}</small><br>
                                    {% endif %}
                                    {% if sous_action.date_fin_prevue %}
                                    <small>Fin: {{ sous_action.date_fin_prevue.strftime('%d/%m/%Y') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar 
                                            {% if sous_action.pourcentage_realisation >= 100 %}bg-success
                                            {% elif sous_action.pourcentage_realisation >= 50 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ sous_action.pourcentage_realisation }}%">
                                            {{ sous_action.pourcentage_realisation }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if sous_action.statut == 'a_faire' %}
                                    <span class="badge bg-secondary"> {{ t("À faire") }} </span>
                                    {% elif sous_action.statut == 'en_cours' %}
                                    <span class="badge bg-warning"> {{ t("En cours") }} </span>
                                    {% elif sous_action.statut == 'termine' %}
                                    <span class="badge bg-success"> {{ t("Terminé") }} </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('espace_travail_sous_action', sous_action_id=sous_action.id) }}" 
                                            class="btn btn-outline-info" title="Espace de travail">
                                            <i class="fas fa-comments"></i>
                                        </a>
                                        <button class="btn btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#modifierSousActionModal{{ sous_action.id }}"
                                                title="{{ t("Modifier") }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#changerStatutSousActionModal{{ sous_action.id }}"
                                                title="{{ t("Change status") }}">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <form method="POST" 
                                              action="{{ url_for('supprimer_sous_action', sous_action_id=sous_action.id) }}" 
                                              class="d-inline"
                                              onsubmit="return confirm('Supprimer cette sous-action ?');">
                                            <button type="submit" class="btn btn-outline-danger" title="{{ t("Supprimer") }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-list-check fa-3x text-muted mb-3"></i>
                    <p class="text-muted"> {{ t("No sub-actions created for this plan.") }} </p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ajouterSousActionModal">
                        <i class="fas fa-plus me-1"></i> {{ t("Add the first sub-action") }} </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-bolt me-2"></i> {{ t("Quick Actions") }} </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('modifier_statut_plan_action', plan_id=plan_action.id) }}">
                    <div class="mb-3">
                        <label class="form-label"><strong> {{ t("Change status") }} </strong></label>
                        <select name="statut" class="form-select">
                            <option value="en_attente" {% if plan_action.statut == 'en_attente' %}selected{% endif %}> {{ t("En attente") }} </option>
                            <option value="en_cours" {% if plan_action.statut == 'en_cours' %}selected{% endif %}> {{ t("En cours") }} </option>
                            <option value="termine" {% if plan_action.statut == 'termine' %}selected{% endif %}> {{ t("Terminé") }} </option>
                            <option value="retarde" {% if plan_action.statut == 'retarde' %}selected{% endif %}> {{ t("Retardé") }} </option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-save me-1"></i> {{ t("To update") }} </button>
                </form>
                
                <hr>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#ajouterSousActionModal">
                        <i class="fas fa-plus me-1"></i> {{ t("New sub-action") }} </button>
                    
                    <a href="{{ url_for('detail_audit', id=plan_action.audit.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-clipboard-list me-1"></i> {{ t("View the audit") }} </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i> {{ t("Statistics") }} </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="text-primary">{{ plan_action.sous_actions|length }}</h4>
                        <small class="text-muted"> {{ t("Sub-actions") }} </small>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-success">{{ plan_action.progression_reelle }}%</h4>
                        <small class="text-muted"> {{ t("Progression") }} </small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted"> {{ t("Sub-actions by status:") }} </small>
                    <div class="mt-2">
                        {% set sous_actions_terminees = plan_action.sous_actions|selectattr('statut', 'equalto', 'termine')|list|length %}
                        {% set sous_actions_en_cours = plan_action.sous_actions|selectattr('statut', 'equalto', 'en_cours')|list|length %}
                        {% set sous_actions_a_faire = plan_action.sous_actions|selectattr('statut', 'equalto', 'a_faire')|list|length %}
                        
                        <div class="d-flex justify-content-between mb-1">
                            <span>Terminées: {{ sous_actions_terminees }}</span>
                            <span class="badge bg-success">{{ sous_actions_terminees }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>En cours: {{ sous_actions_en_cours }}</span>
                            <span class="badge bg-warning">{{ sous_actions_en_cours }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>À faire: {{ sous_actions_a_faire }}</span>
                            <span class="badge bg-secondary">{{ sous_actions_a_faire }}</span>
                        </div>
                    </div>
                </div>
                
                {% if plan_action.est_en_retard %}
                <div class="alert alert-warning py-2">
                    <i class="fas fa-clock me-2"></i>
                    <strong> {{ t("Attention:") }} </strong> {{ t("This plan is late") }} </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ajouterSousActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('ajouter_sous_action', plan_id=plan_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title"> {{ t("Add a sub-action") }} </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Description *") }} </label>
                        <textarea class="form-control" name="description" rows="3" required 
                                  placeholder="{{ t("Describe the task to be accomplished...") }}"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"> {{ t("Start date") }} </label>
                            <input type="date" class="form-control" name="date_debut">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"> {{ t("Expected end date") }} </label>
                            <input type="date" class="form-control" name="date_fin_prevue">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Responsable") }} </label>
                        <select class="form-select" name="responsable_id">
                            <option value=""> {{ t("Select...") }} </option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Percentage of achievement") }} </label>
                        <input type="range" class="form-range" id="pourcentageRange" name="pourcentage_realisation" min="0" max="100" value="0">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="pourcentageValue">0%</small>
                            <small>100%</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> {{ t("Annuler") }} </button>
                    <button type="submit" class="btn btn-primary"> {{ t("Ajouter") }} </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modifierPlanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('modifier_plan_action', plan_id=plan_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title"> {{ t("Edit action plan") }} </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Nom *") }} </label>
                        <input type="text" class="form-control" name="nom" value="{{ plan_action.nom }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Description") }} </label>
                        <textarea class="form-control" name="description" rows="3">{{ plan_action.description or '' }}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"> {{ t("Start date") }} </label>
                            <input type="date" class="form-control" name="date_debut" 
                                   value="{{ plan_action.date_debut.strftime('%Y-%m-%d') if plan_action.date_debut else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"> {{ t("Expected end date") }} </label>
                            <input type="date" class="form-control" name="date_fin_prevue" 
                                   value="{{ plan_action.date_fin_prevue.strftime('%Y-%m-%d') if plan_action.date_fin_prevue else '' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Responsable") }} </label>
                        <select class="form-select" name="responsable_id">
                            <option value=""> {{ t("Select...") }} </option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if plan_action.responsable_id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Percentage of achievement") }} </label>
                        <input type="range" class="form-range" id="planPourcentageRange" name="pourcentage_realisation" 
                               min="0" max="100" value="{{ plan_action.pourcentage_realisation or 0 }}">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="planPourcentageValue">{{ plan_action.pourcentage_realisation or 0 }}%</small>
                            <small>100%</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> {{ t("Annuler") }} </button>
                    <button type="submit" class="btn btn-primary"> {{ t("Enregistrer") }} </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% for sous_action in plan_action.sous_actions %}
<div class="modal fade" id="modifierSousActionModal{{ sous_action.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('modifier_sous_action', sous_action_id=sous_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title"> {{ t("Edit sub-action") }} </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Description *") }} </label>
                        <textarea class="form-control" name="description" rows="3" required>{{ sous_action.description }}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"> {{ t("Start date") }} </label>
                            <input type="date" class="form-control" name="date_debut" 
                                   value="{{ sous_action.date_debut.strftime('%Y-%m-%d') if sous_action.date_debut else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"> {{ t("Expected end date") }} </label>
                            <input type="date" class="form-control" name="date_fin_prevue" 
                                   value="{{ sous_action.date_fin_prevue.strftime('%Y-%m-%d') if sous_action.date_fin_prevue else '' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Responsable") }} </label>
                        <select class="form-select" name="responsable_id">
                            <option value=""> {{ t("Select...") }} </option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if sous_action.responsable_id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"> {{ t("Percentage of achievement") }} </label>
                        <input type="range" class="form-range sous-action-range" 
                               name="pourcentage_realisation" min="0" max="100" 
                               value="{{ sous_action.pourcentage_realisation or 0 }}" 
                               data-target="pourcentageValue{{ sous_action.id }}">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="pourcentageValue{{ sous_action.id }}">{{ sous_action.pourcentage_realisation or 0 }}%</small>
                            <small>100%</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> {{ t("Annuler") }} </button>
                    <button type="submit" class="btn btn-primary"> {{ t("Enregistrer") }} </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="changerStatutSousActionModal{{ sous_action.id }}" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('modifier_statut_sous_action', sous_action_id=sous_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title"> {{ t("Change status") }} </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"> {{ t("New status") }} </label>
                        <select class="form-select" name="statut">
                            <option value="a_faire" {% if sous_action.statut == 'a_faire' %}selected{% endif %}> {{ t("À faire") }} </option>
                            <option value="en_cours" {% if sous_action.statut == 'en_cours' %}selected{% endif %}> {{ t("En cours") }} </option>
                            <option value="termine" {% if sous_action.statut == 'termine' %}selected{% endif %}> {{ t("Terminé") }} </option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> {{ t("Annuler") }} </button>
                    <button type="submit" class="btn btn-primary"> {{ t("Changer") }} </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pourcentage pour ajout de sous-action
    const pourcentageRange = document.getElementById('pourcentageRange');
    const pourcentageValue = document.getElementById('pourcentageValue');
    
    if (pourcentageRange && pourcentageValue) {
        pourcentageRange.addEventListener('input', function() {
            pourcentageValue.textContent = this.value + '%';
        });
    }
    
    // Pourcentage pour modification de plan
    const planPourcentageRange = document.getElementById('planPourcentageRange');
    const planPourcentageValue = document.getElementById('planPourcentageValue');
    
    if (planPourcentageRange && planPourcentageValue) {
        planPourcentageRange.addEventListener('input', function() {
            planPourcentageValue.textContent = this.value + '%';
        });
    }
    
    // Pourcentage pour modification de sous-actions
    const sousActionRanges = document.querySelectorAll('.sous-action-range');
    sousActionRanges.forEach(range => {
        const targetId = range.getAttribute('data-target');
        const targetElement = document.getElementById(targetId);
        
        if (range && targetElement) {
            range.addEventListener('input', function() {
                targetElement.textContent = this.value + '%';
            });
        }
    });
    
    // Focus sur le premier champ des modals quand ils s'ouvrent
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            const firstInput = this.querySelector('input, textarea, select');
            if (firstInput) firstInput.focus();
        });
    });
});
</script>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.progress {
    border-radius: 10px;
    overflow: hidden;
}

.card-header {
    background-color: #f8f9fa;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}

.modal-backdrop {
    z-index: 1040;
}

.modal {
    z-index: 1055;
}
</style>
{% endblock %}
