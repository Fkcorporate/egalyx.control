{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4">

    <!-- En-t√™te minimaliste -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <span class="text-uppercase small fw-semibold text-muted tracking-wide">{{ t("PLAN D'ACTION") }}</span>
            <h2 class="fw-semibold mt-1 mb-0" style="color: #1e293b; font-size: 2rem; letter-spacing: -0.02em;">
                <i class="fas fa-tasks me-3" style="color: #94a3b8; font-size: 1.8rem;"></i>{{ plan_action.nom }}
            </h2>
            <div class="mt-2 d-flex align-items-center gap-3">
                <div style="height: 2px; width: 60px; background: linear-gradient(90deg, #3b82f6, #8b5cf6);"></div>
                <span class="small text-muted">{{ plan_action.reference }}</span>
            </div>
        </div>
        <div>
            <button class="btn px-4 py-2 me-2" data-bs-toggle="modal" data-bs-target="#modifierPlanModal"
                    style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                <i class="fas fa-edit me-2" style="font-size: 0.9rem;"></i>{{ t("Modifier") }}
            </button>
            <a href="{{ url_for('liste_plans_action') }}" class="btn px-4 py-2"
               style="border-radius: 10px; background: #0f172a; color: white; border: none;">
                <i class="fas fa-arrow-left me-2" style="font-size: 0.9rem;"></i>{{ t("Retour") }}
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Colonne principale -->
        <div class="col-md-8">
            
            <!-- Carte Informations -->
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px; overflow: hidden;">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-semibold mb-0" style="color: #1e293b;">
                        <i class="fas fa-info-circle me-2" style="color: #64748b;"></i>{{ t("Informations g√©n√©rales") }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="d-flex flex-column gap-3">
                                <div>
                                    <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("R√âF√âRENCE") }}</span>
                                    <div class="mt-1 fw-medium">{{ plan_action.reference }}</div>
                                </div>
                                <div>
                                    <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("AUDIT LI√â") }}</span>
                                    <div class="mt-1">
                                        {% if plan_action.audit and plan_action.audit.id %}
                                        <a href="{{ url_for('detail_audit', id=plan_action.audit.id) }}" class="text-decoration-none">
                                            <i class="fas fa-clipboard-check me-1"></i> {{ plan_action.audit.reference }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-times-circle me-1"></i> Non li√© √† un audit
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("RESPONSABLE") }}</span>
                                    <div class="mt-1">
                                        {% if plan_action.responsable %}
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" 
                                                 style="width: 32px; height: 32px; border: 1px solid #e2e8f0;">
                                                <span class="small fw-medium" style="color: #475569;">{{ plan_action.responsable.username[0].upper() }}</span>
                                            </div>
                                            <span class="fw-medium">{{ plan_action.responsable.username }}</span>
                                        </div>
                                        {% else %}
                                        <span class="text-muted">‚Äî</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column gap-3">
                                <div>
                                    <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("STATUT") }}</span>
                                    <div class="mt-1">
                                        {% if plan_action.statut == 'en_attente' %}
                                        <span class="badge rounded-pill px-3 py-2 fw-normal" style="background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0;">
                                            <i class="fas fa-clock me-1" style="font-size: 0.8rem;"></i>{{ t("En attente") }}
                                        </span>
                                        {% elif plan_action.statut == 'en_cours' %}
                                        <span class="badge rounded-pill px-3 py-2 fw-normal" style="background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe;">
                                            <i class="fas fa-play-circle me-1" style="font-size: 0.8rem;"></i>{{ t("En cours") }}
                                        </span>
                                        {% elif plan_action.statut == 'termine' %}
                                        <span class="badge rounded-pill px-3 py-2 fw-normal" style="background: #dcfce7; color: #166534; border: 1px solid #bbf7d0;">
                                            <i class="fas fa-check-circle me-1" style="font-size: 0.8rem;"></i>{{ t("Termin√©") }}
                                        </span>
                                        {% elif plan_action.statut == 'retarde' %}
                                        <span class="badge rounded-pill px-3 py-2 fw-normal" style="background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca;">
                                            <i class="fas fa-exclamation-circle me-1" style="font-size: 0.8rem;"></i>{{ t("Retard√©") }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("DATES") }}</span>
                                    <div class="mt-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fas fa-calendar-alt me-2" style="color: #94a3b8; font-size: 0.9rem;"></i>
                                            <span class="small">{{ t("D√©but") }}: {{ plan_action.date_debut.strftime('%d/%m/%Y') if plan_action.date_debut else 'Non d√©finie' }}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-calendar-check me-2" style="color: #94a3b8; font-size: 0.9rem;"></i>
                                            <span class="small">{{ t("Fin pr√©vue") }}: {{ plan_action.date_fin_prevue.strftime('%d/%m/%Y') if plan_action.date_fin_prevue else 'Non d√©finie' }}</span>
                                        </div>
                                        {% if plan_action.date_fin_reelle %}
                                        <div class="d-flex align-items-center mt-1">
                                            <i class="fas fa-check-circle me-2" style="color: #22c55e; font-size: 0.9rem;"></i>
                                            <span class="small">{{ t("Fin r√©elle") }}: {{ plan_action.date_fin_reelle.strftime('%d/%m/%Y') }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if plan_action.description %}
                    <div class="mt-4 pt-3" style="border-top: 1px solid #f1f5f9;">
                        <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("DESCRIPTION") }}</span>
                        <p class="mt-2 text-muted" style="line-height: 1.6;">{{ plan_action.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Barre de progression -->
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("PROGRESSION GLOBALE") }}</span>
                        <span class="fw-semibold" style="color: {% if plan_action.progression_reelle >= 80 %}#22c55e{% elif plan_action.progression_reelle >= 50 %}#eab308{% else %}#ef4444{% endif %};">
                            {{ plan_action.progression_reelle }}%
                        </span>
                    </div>
                    <div class="progress" style="height: 8px; background: #e2e8f0; border-radius: 4px;">
                        <div class="progress-bar {% if plan_action.progression_reelle >= 80 %}bg-success{% elif plan_action.progression_reelle >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                             style="width: {{ plan_action.progression_reelle }}%; border-radius: 4px;"></div>
                    </div>
                    
                    {% if plan_action.est_en_retard %}
                    <div class="mt-3 p-3 rounded-3" style="background: #fef2f2; border: 1px solid #fee2e2;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2" style="color: #ef4444;"></i>
                            <span class="small fw-medium" style="color: #b91c1c;">{{ t("Ce plan est en retard") }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sous-actions -->
            <div class="card border-0 shadow-sm" style="border-radius: 16px; overflow: hidden;">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h5 class="fw-semibold mb-0" style="color: #1e293b;">
                        <i class="fas fa-list-check me-2" style="color: #64748b;"></i>{{ t("Sous-actions") }}
                        <span class="badge rounded-pill ms-2" style="background: #f1f5f9; color: #475569; font-weight: normal;">
                            {{ plan_action.sous_actions|length }}
                        </span>
                    </h5>
                    <button class="btn px-3 py-1" data-bs-toggle="modal" data-bs-target="#ajouterSousActionModal"
                            style="border-radius: 8px; background: #0f172a; color: white; font-size: 0.9rem;">
                        <i class="fas fa-plus me-1"></i>{{ t("Ajouter") }}
                    </button>
                </div>
                
                <div class="card-body p-0">
                    {% if plan_action.sous_actions %}
                    <div class="table-responsive">
                        <table class="table mb-0" style="min-width: 900px;">
                            <thead style="background: #f8fafc; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                <tr>
                                    <th class="px-4 py-3 text-uppercase small fw-semibold text-muted tracking-wide">{{ t("DESCRIPTION") }}</th>
                                    <th class="px-4 py-3 text-uppercase small fw-semibold text-muted tracking-wide">{{ t("RESPONSABLE") }}</th>
                                    <th class="px-4 py-3 text-uppercase small fw-semibold text-muted tracking-wide">{{ t("DATES") }}</th>
                                    <th class="px-4 py-3 text-uppercase small fw-semibold text-muted tracking-wide">{{ t("AVANCEMENT") }}</th>
                                    <th class="px-4 py-3 text-uppercase small fw-semibold text-muted tracking-wide">{{ t("STATUT") }}</th>
                                    <th class="px-4 py-3 text-uppercase small fw-semibold text-muted tracking-wide">{{ t("ACTIONS") }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sous_action in plan_action.sous_actions %}
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td class="px-4 py-3">
                                        <div class="fw-medium" style="color: #1e293b;">{{ sous_action.description|truncate(80) }}</div>
                                        {% if sous_action.reference %}
                                        <small class="text-muted">{{ sous_action.reference }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        {% if sous_action.responsable %}
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" 
                                                 style="width: 28px; height: 28px; border: 1px solid #e2e8f0;">
                                                <span class="small fw-medium" style="color: #475569;">{{ sous_action.responsable.username[0].upper() }}</span>
                                            </div>
                                            <span class="small">{{ sous_action.responsable.username }}</span>
                                        </div>
                                        {% else %}
                                        <span class="small text-muted">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <small>
                                            {% if sous_action.date_debut %}
                                            <div><span class="text-muted">{{ t("D√©but") }}:</span> {{ sous_action.date_debut.strftime('%d/%m/%Y') }}</div>
                                            {% endif %}
                                            {% if sous_action.date_fin_prevue %}
                                            <div><span class="text-muted">{{ t("Fin") }}:</span> {{ sous_action.date_fin_prevue.strftime('%d/%m/%Y') }}</div>
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1" style="height: 6px; background: #e2e8f0; border-radius: 3px;">
                                                <div class="progress-bar {% if sous_action.pourcentage_realisation >= 100 %}bg-success{% elif sous_action.pourcentage_realisation >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                     style="width: {{ sous_action.pourcentage_realisation }}%; border-radius: 3px;"></div>
                                            </div>
                                            <span class="ms-2 small fw-medium" style="min-width: 35px;">{{ sous_action.pourcentage_realisation }}%</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        {% if sous_action.statut == 'a_faire' %}
                                        <span class="badge rounded-pill px-3 py-2 fw-normal" style="background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0;">
                                            {{ t("√Ä faire") }}
                                        </span>
                                        {% elif sous_action.statut == 'en_cours' %}
                                        <span class="badge rounded-pill px-3 py-2 fw-normal" style="background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe;">
                                            {{ t("En cours") }}
                                        </span>
                                        {% elif sous_action.statut == 'termine' %}
                                        <span class="badge rounded-pill px-3 py-2 fw-normal" style="background: #dcfce7; color: #166534; border: 1px solid #bbf7d0;">
                                            {{ t("Termin√©") }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="btn-group">
                                            <a href="{{ url_for('espace_travail_sous_action', sous_action_id=sous_action.id) }}" 
                                               class="btn btn-sm px-3" style="background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; border-radius: 8px 0 0 8px;">
                                                <i class="fas fa-comments"></i>
                                            </a>
                                            <button class="btn btn-sm px-3" data-bs-toggle="modal" 
                                                    data-bs-target="#modifierSousActionModal{{ sous_action.id }}"
                                                    style="background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; border-left: none;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm px-3" data-bs-toggle="modal" 
                                                    data-bs-target="#changerStatutSousActionModal{{ sous_action.id }}"
                                                    style="background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; border-left: none;">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <form method="POST" action="{{ url_for('supprimer_sous_action', sous_action_id=sous_action.id) }}" 
                                                  class="d-inline" onsubmit="return confirm('{{ t("Supprimer cette sous-action ?") }}');">
                                                <button type="submit" class="btn btn-sm px-3" 
                                                        style="background: #f8fafc; color: #ef4444; border: 1px solid #e2e8f0; border-left: none; border-radius: 0 8px 8px 0;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-list-check fa-3x" style="color: #cbd5e1;"></i>
                        </div>
                        <h6 class="fw-medium mb-2" style="color: #334155;">{{ t("Aucune sous-action") }}</h6>
                        <p class="small text-muted mb-4">{{ t("Commencez par ajouter une premi√®re sous-action.") }}</p>
                        <button class="btn px-4 py-2" data-bs-toggle="modal" data-bs-target="#ajouterSousActionModal"
                                style="border-radius: 10px; background: #0f172a; color: white;">
                            <i class="fas fa-plus me-2"></i>{{ t("Ajouter une sous-action") }}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Colonne lat√©rale -->
        <div class="col-md-4">
            
            <!-- Actions rapides -->
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px;">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-semibold mb-0" style="color: #1e293b;">
                        <i class="fas fa-bolt me-2" style="color: #64748b;"></i>{{ t("Actions rapides") }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <form method="POST" action="{{ url_for('modifier_statut_plan_action', plan_id=plan_action.id) }}">
                        <div class="mb-3">
                            <label class="form-label text-xs text-muted text-uppercase fw-semibold tracking-wide mb-2">
                                {{ t("Changer le statut") }}
                            </label>
                            <select name="statut" class="form-select border-0 bg-light px-3 py-2" style="border-radius: 10px;">
                                <option value="en_attente" {% if plan_action.statut == 'en_attente' %}selected{% endif %}>üìã {{ t("En attente") }}</option>
                                <option value="en_cours" {% if plan_action.statut == 'en_cours' %}selected{% endif %}>‚öôÔ∏è {{ t("En cours") }}</option>
                                <option value="termine" {% if plan_action.statut == 'termine' %}selected{% endif %}>‚úÖ {{ t("Termin√©") }}</option>
                                <option value="retarde" {% if plan_action.statut == 'retarde' %}selected{% endif %}>‚ö†Ô∏è {{ t("Retard√©") }}</option>
                            </select>
                        </div>
                        <button type="submit" class="btn w-100 px-4 py-2 mb-3"
                                style="border-radius: 10px; background: #0f172a; color: white;">
                            <i class="fas fa-save me-2"></i>{{ t("Mettre √† jour") }}
                        </button>
                    </form>
                    
                    <hr class="my-3" style="border-color: #e2e8f0;">
                    
                    <div class="d-grid gap-2">
                        <button class="btn w-100 px-4 py-2" data-bs-toggle="modal" data-bs-target="#ajouterSousActionModal"
                                style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0; text-align: left;">
                            <i class="fas fa-plus me-2" style="color: #64748b;"></i>{{ t("Nouvelle sous-action") }}
                        </button>
                        
                        {% if plan_action.audit and plan_action.audit.id %}
                        <a href="{{ url_for('detail_audit', id=plan_action.audit.id) }}" class="btn w-100 px-4 py-2"
                        style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0; text-align: left;">
                            <i class="fas fa-clipboard-list me-2" style="color: #0891b2;"></i>{{ t("Voir l'audit") }}
                        </a>
                        {% else %}
                        <button class="btn w-100 px-4 py-2" disabled
                                style="border-radius: 10px; background: #f8fafc; color: #94a3b8; border: 1px solid #e2e8f0; text-align: left; cursor: not-allowed;">
                            <i class="fas fa-clipboard-list me-2" style="color: #94a3b8;"></i>{{ t("Aucun audit li√©") }}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-semibold mb-0" style="color: #1e293b;">
                        <i class="fas fa-chart-pie me-2" style="color: #64748b;"></i>{{ t("Statistiques") }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="row g-4 text-center">
                        <div class="col-6">
                            <div class="p-3 rounded-3" style="background: #f8fafc;">
                                <h3 class="fw-semibold mb-1" style="color: #0891b2;">{{ plan_action.sous_actions|length }}</h3>
                                <small class="text-muted text-uppercase fw-semibold tracking-wide">{{ t("Sous-actions") }}</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-3" style="background: #f8fafc;">
                                <h3 class="fw-semibold mb-1" style="color: {% if plan_action.progression_reelle >= 80 %}#22c55e{% elif plan_action.progression_reelle >= 50 %}#eab308{% else %}#ef4444{% endif %};">{{ plan_action.progression_reelle }}%</h3>
                                <small class="text-muted text-uppercase fw-semibold tracking-wide">{{ t("Progression") }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <span class="text-xs text-muted text-uppercase fw-semibold tracking-wide">{{ t("R√âPARTITION") }}</span>
                        
                        {% set sous_actions_terminees = plan_action.sous_actions|selectattr('statut', 'equalto', 'termine')|list|length %}
                        {% set sous_actions_en_cours = plan_action.sous_actions|selectattr('statut', 'equalto', 'en_cours')|list|length %}
                        {% set sous_actions_a_faire = plan_action.sous_actions|selectattr('statut', 'equalto', 'a_faire')|list|length %}
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small"><i class="fas fa-circle me-2" style="color: #22c55e; font-size: 0.6rem;"></i>{{ t("Termin√©es") }}</span>
                                <span class="badge rounded-pill" style="background: #dcfce7; color: #166534;">{{ sous_actions_terminees }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small"><i class="fas fa-circle me-2" style="color: #eab308; font-size: 0.6rem;"></i>{{ t("En cours") }}</span>
                                <span class="badge rounded-pill" style="background: #fef9c3; color: #854d0e;">{{ sous_actions_en_cours }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small"><i class="fas fa-circle me-2" style="color: #94a3b8; font-size: 0.6rem;"></i>{{ t("√Ä faire") }}</span>
                                <span class="badge rounded-pill" style="background: #f1f5f9; color: #475569;">{{ sous_actions_a_faire }}</span>
                            </div>
                        </div>
                    </div>
                    
                    {% if plan_action.est_en_retard %}
                    <div class="mt-4 p-3 rounded-3" style="background: #fef2f2;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock me-2" style="color: #ef4444;"></i>
                            <span class="small fw-medium" style="color: #b91c1c;">{{ t("Attention: Ce plan est en retard") }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajouter Sous-action -->
<div class="modal fade" id="ajouterSousActionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 16px; box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15);">
            
            <div class="px-4 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="text-uppercase small fw-semibold text-muted tracking-wide">{{ t("CR√âATION") }}</span>
                        <h5 class="fw-semibold mt-1 mb-0" style="color: #1e293b;">{{ t("Nouvelle sous-action") }}</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="opacity: 0.5;"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('ajouter_sous_action', plan_id=plan_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="modal-body px-4 py-3">
                    <div class="mb-3">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Description") }} <span class="text-danger">*</span></label>
                        <textarea class="form-control border-0 bg-light px-3 py-2" name="description" rows="3" required 
                                  style="border-radius: 10px; resize: none;"></textarea>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Date d√©but") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-3 py-2" name="date_debut" style="border-radius: 10px;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Date fin pr√©vue") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-3 py-2" name="date_fin_prevue" style="border-radius: 10px;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Responsable") }}</label>
                        <select class="form-select border-0 bg-light px-3 py-2" name="responsable_id" style="border-radius: 10px;">
                            <option value="">{{ t("Non assign√©") }}</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Avancement initial") }}</label>
                        <input type="range" class="form-range" id="pourcentageRange" name="pourcentage_realisation" min="0" max="100" value="0">
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">0%</small>
                            <small class="fw-medium" id="pourcentageValue">0%</small>
                            <small class="text-muted">100%</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 px-4 pb-4 pt-2">
                    <button type="button" class="btn px-4 py-2 me-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0;">
                        {{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn px-4 py-2"
                            style="border-radius: 10px; background: #0f172a; color: white;">
                        <i class="fas fa-plus me-2"></i>{{ t("Ajouter") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifier Plan -->
<div class="modal fade" id="modifierPlanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 16px; box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15);">
            
            <div class="px-4 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="text-uppercase small fw-semibold text-muted tracking-wide">{{ t("MODIFICATION") }}</span>
                        <h5 class="fw-semibold mt-1 mb-0" style="color: #1e293b;">{{ t("Modifier le plan") }}</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="opacity: 0.5;"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('modifier_plan_action', plan_id=plan_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="modal-body px-4 py-3">
                    <div class="mb-3">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Nom") }} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control border-0 bg-light px-3 py-2" name="nom" value="{{ plan_action.nom }}" required style="border-radius: 10px;">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Description") }}</label>
                        <textarea class="form-control border-0 bg-light px-3 py-2" name="description" rows="3" style="border-radius: 10px;">{{ plan_action.description or '' }}</textarea>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Date d√©but") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-3 py-2" name="date_debut" 
                                   value="{{ plan_action.date_debut.strftime('%Y-%m-%d') if plan_action.date_debut else '' }}" style="border-radius: 10px;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Date fin pr√©vue") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-3 py-2" name="date_fin_prevue" 
                                   value="{{ plan_action.date_fin_prevue.strftime('%Y-%m-%d') if plan_action.date_fin_prevue else '' }}" style="border-radius: 10px;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Responsable") }}</label>
                        <select class="form-select border-0 bg-light px-3 py-2" name="responsable_id" style="border-radius: 10px;">
                            <option value="">{{ t("Non assign√©") }}</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if plan_action.responsable_id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Avancement") }}</label>
                        <input type="range" class="form-range" id="planPourcentageRange" name="pourcentage_realisation" 
                               min="0" max="100" value="{{ plan_action.pourcentage_realisation or 0 }}">
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">0%</small>
                            <small class="fw-medium" id="planPourcentageValue">{{ plan_action.pourcentage_realisation or 0 }}%</small>
                            <small class="text-muted">100%</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 px-4 pb-4 pt-2">
                    <button type="button" class="btn px-4 py-2 me-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0;">
                        {{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn px-4 py-2"
                            style="border-radius: 10px; background: #0f172a; color: white;">
                        <i class="fas fa-save me-2"></i>{{ t("Enregistrer") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals pour chaque sous-action -->
{% for sous_action in plan_action.sous_actions %}
<!-- Modal Modifier Sous-action -->
<div class="modal fade" id="modifierSousActionModal{{ sous_action.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 16px; box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15);">
            
            <div class="px-4 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="text-uppercase small fw-semibold text-muted tracking-wide">{{ t("MODIFICATION") }}</span>
                        <h5 class="fw-semibold mt-1 mb-0" style="color: #1e293b;">{{ t("Modifier la sous-action") }}</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="opacity: 0.5;"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('modifier_sous_action', sous_action_id=sous_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="modal-body px-4 py-3">
                    <div class="mb-3">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Description") }} <span class="text-danger">*</span></label>
                        <textarea class="form-control border-0 bg-light px-3 py-2" name="description" rows="3" required style="border-radius: 10px;">{{ sous_action.description }}</textarea>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Date d√©but") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-3 py-2" name="date_debut" 
                                   value="{{ sous_action.date_debut.strftime('%Y-%m-%d') if sous_action.date_debut else '' }}" style="border-radius: 10px;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Date fin pr√©vue") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-3 py-2" name="date_fin_prevue" 
                                   value="{{ sous_action.date_fin_prevue.strftime('%Y-%m-%d') if sous_action.date_fin_prevue else '' }}" style="border-radius: 10px;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Responsable") }}</label>
                        <select class="form-select border-0 bg-light px-3 py-2" name="responsable_id" style="border-radius: 10px;">
                            <option value="">{{ t("Non assign√©") }}</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if sous_action.responsable_id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Avancement") }}</label>
                        <input type="range" class="form-range sous-action-range" 
                               name="pourcentage_realisation" min="0" max="100" 
                               value="{{ sous_action.pourcentage_realisation or 0 }}" 
                               data-target="pourcentageValue{{ sous_action.id }}">
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">0%</small>
                            <small class="fw-medium" id="pourcentageValue{{ sous_action.id }}">{{ sous_action.pourcentage_realisation or 0 }}%</small>
                            <small class="text-muted">100%</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 px-4 pb-4 pt-2">
                    <button type="button" class="btn px-4 py-2 me-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0;">
                        {{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn px-4 py-2"
                            style="border-radius: 10px; background: #0f172a; color: white;">
                        <i class="fas fa-save me-2"></i>{{ t("Enregistrer") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Changer Statut Sous-action -->
<div class="modal fade" id="changerStatutSousActionModal{{ sous_action.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 16px; box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15);">
            
            <div class="px-4 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="text-uppercase small fw-semibold text-muted tracking-wide">{{ t("STATUT") }}</span>
                        <h5 class="fw-semibold mt-1 mb-0" style="color: #1e293b;">{{ t("Changer le statut") }}</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="opacity: 0.5;"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('modifier_statut_sous_action', sous_action_id=sous_action.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="modal-body px-4 py-3">
                    <div class="mb-2">
                        <label class="form-label text-xs text-muted fw-semibold mb-2">{{ t("Nouveau statut") }}</label>
                        <select class="form-select border-0 bg-light px-3 py-2" name="statut" style="border-radius: 10px;">
                            <option value="a_faire" {% if sous_action.statut == 'a_faire' %}selected{% endif %}>üìã {{ t("√Ä faire") }}</option>
                            <option value="en_cours" {% if sous_action.statut == 'en_cours' %}selected{% endif %}>‚öôÔ∏è {{ t("En cours") }}</option>
                            <option value="termine" {% if sous_action.statut == 'termine' %}selected{% endif %}>‚úÖ {{ t("Termin√©") }}</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-footer border-0 px-4 pb-4 pt-2">
                    <button type="button" class="btn px-4 py-2 me-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0;">
                        {{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn px-4 py-2"
                            style="border-radius: 10px; background: #0f172a; color: white;">
                        {{ t("Changer") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<style>
/* Styles sobres et √©l√©gants */
.tracking-wide {
    letter-spacing: 0.05em;
}

.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

.card {
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: 0 8px 16px -8px rgba(0, 0, 0, 0.1) !important;
}

.table tbody tr:hover {
    background-color: #f8fafc;
}

.progress-bar {
    transition: width 0.6s ease;
}

/* Mode sombre */
[data-bs-theme="dark"] {
    --text-primary: #f1f5f9;
    --bg-card: #1e293b;
    --border-color: #334155;
}

[data-bs-theme="dark"] .card {
    background: #1e293b;
}

[data-bs-theme="dark"] h2,
[data-bs-theme="dark"] h3,
[data-bs-theme="dark"] h5,
[data-bs-theme="dark"] h6 {
    color: #f1f5f9 !important;
}

[data-bs-theme="dark"] .text-muted {
    color: #94a3b8 !important;
}

[data-bs-theme="dark"] .bg-light {
    background: #334155 !important;
}

[data-bs-theme="dark"] .table {
    color: #e2e8f0;
}

[data-bs-theme="dark"] .table tbody tr:hover {
    background-color: #334155;
}

[data-bs-theme="dark"] .modal-content {
    background: #1e293b;
}

[data-bs-theme="dark"] .border-bottom {
    border-color: #334155 !important;
}

[data-bs-theme="dark"] .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pourcentage pour ajout de sous-action
    const pourcentageRange = document.getElementById('pourcentageRange');
    const pourcentageValue = document.getElementById('pourcentageValue');
    
    if (pourcentageRange && pourcentageValue) {
        pourcentageRange.addEventListener('input', function() {
            pourcentageValue.textContent = this.value + '%';
        });
    }
    
    // Pourcentage pour modification de plan
    const planPourcentageRange = document.getElementById('planPourcentageRange');
    const planPourcentageValue = document.getElementById('planPourcentageValue');
    
    if (planPourcentageRange && planPourcentageValue) {
        planPourcentageRange.addEventListener('input', function() {
            planPourcentageValue.textContent = this.value + '%';
        });
    }
    
    // Pourcentage pour modification de sous-actions
    const sousActionRanges = document.querySelectorAll('.sous-action-range');
    sousActionRanges.forEach(range => {
        const targetId = range.getAttribute('data-target');
        const targetElement = document.getElementById(targetId);
        
        if (range && targetElement) {
            range.addEventListener('input', function() {
                targetElement.textContent = this.value + '%';
            });
        }
    });
    
    // Focus sur le premier champ des modals quand ils s'ouvrent
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            const firstInput = this.querySelector('input:not([type=range]), textarea, select');
            if (firstInput) firstInput.focus();
        });
    });
});
</script>
{% endblock %}
