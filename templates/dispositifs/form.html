{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       STYLES SP√âCIFIQUES - FORMULAIRE DISPOSITIF
       HARMONIS√â AVEC DETAIL_RISQUE.HTML
       ============================================ */
    
    /* Variables de base */
    :root {
        --fk-navy: #0A1929;
        --fk-blue: #1A3C6B;
        --fk-accent: #0066CC;
        --fk-light-blue: #3B82F6;
        --fk-steel: #334155;
        --fk-platinum: #F8FAFC;
        --fk-success: #0D9488;
        --fk-warning: #F59E0B;
        --fk-error: #DC2626;
        --fk-gold: #D4AF37;
        
        --primary-gradient: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        --accent-gradient: linear-gradient(135deg, #0066CC 0%, #3B82F6 100%);
        
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
        --shadow-hard: 0 12px 50px rgba(0, 0, 0, 0.2);
        
        --radius-lg: 20px;
        --radius-md: 12px;
        --radius-sm: 8px;
        
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Variables s√©mantiques - mode clair */
    body {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #334155;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --card-bg: #ffffff;
        --hover-bg: #f1f5f9;
    }

    /* Mode sombre */
    [data-bs-theme="dark"] body {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #334155;
        --card-bg: #1e293b;
        --hover-bg: #334155;
    }

    /* Conteneur principal */
    .detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* En-t√™te de page */
    .page-header {
        background: var(--primary-gradient);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: rotate(25deg);
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: rotate(-15deg);
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        color: white;
    }

    .page-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Boutons dans l'en-t√™te */
    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Boutons modernes */
    .fk-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-smooth);
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
    }

    .fk-btn-primary {
        background: var(--accent-gradient);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .fk-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
    }

    .fk-btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .fk-btn-secondary:hover {
        background: var(--hover-bg);
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
    }

    .fk-btn-success {
        background: linear-gradient(135deg, var(--fk-success), #0f766e);
        color: white;
    }

    .fk-btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(13, 148, 136, 0.4);
    }

    .fk-btn-warning {
        background: linear-gradient(135deg, var(--fk-warning), #d97706);
        color: white;
    }

    .fk-btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
    }

    .fk-btn-info {
        background: linear-gradient(135deg, var(--fk-accent), var(--fk-light-blue));
        color: white;
    }

    .fk-btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
    }

    .fk-btn-outline {
        background: transparent;
        border: 2px solid var(--border-color);
        color: var(--text-primary);
    }

    .fk-btn-outline:hover {
        border-color: var(--fk-accent);
        color: var(--fk-accent);
        background: var(--hover-bg);
    }

    /* Cartes */
    .fk-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
        transition: var(--transition-smooth);
    }

    .fk-card:hover {
        box-shadow: var(--shadow-medium);
    }

    .fk-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .fk-card-header.primary {
        background: var(--primary-gradient);
        color: white;
    }

    .fk-card-header.info {
        background: linear-gradient(135deg, var(--fk-accent), var(--fk-light-blue));
        color: white;
    }

    .fk-card-header.light {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .fk-card-header h6 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .fk-card-header h6 i {
        color: inherit;
    }

    .fk-card-body {
        padding: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    /* Alertes */
    .fk-alert {
        border-radius: var(--radius-md);
        padding: 1rem 1.25rem;
        border: none;
        border-left: 4px solid;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .fk-alert.info {
        border-left-color: var(--fk-accent);
        background: rgba(0, 102, 204, 0.1);
    }

    .fk-alert.warning {
        border-left-color: var(--fk-warning);
        background: rgba(245, 158, 11, 0.1);
    }

    .fk-alert.success {
        border-left-color: var(--fk-success);
        background: rgba(13, 148, 136, 0.1);
    }

    .fk-alert.light {
        border-left-color: var(--border-color);
        background: var(--bg-tertiary);
    }

    /* Badges */
    .badge-modern {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid transparent;
    }

    .badge-success {
        background: var(--fk-success);
        color: white;
    }

    .badge-warning {
        background: var(--fk-warning);
        color: white;
    }

    .badge-danger {
        background: var(--fk-error);
        color: white;
    }

    .badge-info {
        background: var(--fk-accent);
        color: white;
    }

    .badge-secondary {
        background: var(--text-muted);
        color: white;
    }

    /* Formulaires */
    .fk-form-label {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .fk-form-control {
        width: 100%;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        transition: var(--transition-smooth);
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .fk-form-control:focus {
        border-color: var(--fk-accent);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        outline: none;
    }

    .fk-form-control.is-invalid {
        border-color: var(--fk-error);
    }

    .invalid-feedback {
        color: var(--fk-error);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    .form-text {
        color: var(--text-muted);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    /* Select */
    .fk-form-select {
        width: 100%;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
    }

    .fk-form-select:focus {
        border-color: var(--fk-accent);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    /* Guides */
    .guide-list {
        list-style: none;
        padding: 0;
    }

    .guide-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .guide-item:last-child {
        border-bottom: none;
    }

    .guide-badge {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--fk-accent);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        flex-shrink: 0;
        margin-top: 0.1rem;
    }

    .guide-badge.success { background: var(--fk-success); }
    .guide-badge.warning { background: var(--fk-warning); }
    .guide-badge.danger { background: var(--fk-error); }

    .guide-text {
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    .guide-text strong {
        color: var(--fk-accent);
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: slideIn 0.5s ease forwards;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .detail-container {
            padding: 1rem;
        }

        .page-header {
            padding: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .header-actions .fk-btn {
            width: 100%;
            justify-content: center;
        }

        .row > [class*="col-"] {
            margin-bottom: 1rem;
        }
    }
</style>

<div class="detail-container">
    <!-- En-t√™te de page -->
    <div class="page-header animate-in">
        <div class="page-header-content">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb" style="background: transparent; margin-bottom: 0.5rem;">
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_cartographies') }}" style="color: rgba(255,255,255,0.8);">Cartographies</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_cartographie', id=risque.cartographie_id) }}" style="color: rgba(255,255,255,0.8);">{{ risque.cartographie.nom }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_risque', id=risque.id) }}" style="color: rgba(255,255,255,0.8);">{{ risque.reference }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_dispositifs_risque', risque_id=risque.id) }}" style="color: rgba(255,255,255,0.8);">Dispositifs</a></li>
                            <li class="breadcrumb-item active" style="color: white;">
                                {{ 'Modifier' if action == 'modifier' else 'Nouveau' }} dispositif
                            </li>
                        </ol>
                    </nav>
                    
                    <h1 class="page-title">
                        <i class="fas fa-{{ 'edit' if action == 'modifier' else 'plus' }} me-2"></i>
                        {{ 'Modifier' if action == 'modifier' else 'Nouveau' }} Dispositif de Ma√Ætrise
                    </h1>
                    <p class="page-subtitle">Risque: {{ risque.reference }} - {{ risque.intitule }}</p>
                </div>
                
                <div class="col-auto">
                    <div class="header-actions">
                        <a href="{{ url_for('liste_dispositifs_risque', risque_id=risque.id) }}" class="fk-btn fk-btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Retour
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne principale - Formulaire -->
        <div class="col-md-8">
            <div class="fk-card animate-in">
                <div class="fk-card-header primary">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Risque associ√©: {{ risque.reference }} - {{ risque.intitule }}
                    </h6>
                </div>
                <div class="fk-card-body">
                    <form method="POST" id="dispositifForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Informations de base -->
                        <div class="mb-4">
                            <div class="fk-form-label">
                                <i class="fas fa-tag text-primary"></i>
                                {{ form.nom.label }}
                            </div>
                            {{ form.nom(class="fk-form-control", placeholder="Ex: Contr√¥le d'acc√®s physique, Revue mensuelle des transactions...") }}
                            {% if form.nom.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.nom.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <div class="fk-form-label">
                                <i class="fas fa-align-left text-primary"></i>
                                {{ form.description.label }}
                            </div>
                            {{ form.description(class="fk-form-control", rows="4", 
                                               placeholder="D√©crire pr√©cis√©ment le dispositif: objectif, modalit√©s de mise en ≈ìuvre, crit√®res d'efficacit√©...") }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <div class="fk-form-label">
                                        <i class="fas fa-tachometer-alt text-primary"></i>
                                        {{ form.type_dispositif.label }}
                                    </div>
                                    {{ form.type_dispositif(class="fk-form-select") }}
                                    {% if form.type_dispositif.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.type_dispositif.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">
                                        Pr√©ventif (√©vite), D√©tectif (d√©tecte), Correctif (corrige), Dirigeant (d√©cide)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <div class="fk-form-label">
                                        <i class="fas fa-leaf text-primary"></i>
                                        {{ form.nature.label }}
                                    </div>
                                    {{ form.nature(class="fk-form-select") }}
                                    {% if form.nature.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.nature.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <div class="fk-form-label">
                                        <i class="fas fa-clock text-primary"></i>
                                        {{ form.frequence.label }}
                                    </div>
                                    {{ form.frequence(class="fk-form-select") }}
                                    {% if form.frequence.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.frequence.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <div class="fk-form-label">
                                        <i class="fas fa-star text-primary"></i>
                                        {{ form.efficacite_attendue.label }}
                                    </div>
                                    {{ form.efficacite_attendue(class="fk-form-select") }}
                                    {% if form.efficacite_attendue.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.efficacite_attendue.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="fk-form-label">
                                <i class="fas fa-calendar-alt text-primary"></i>
                                {{ form.date_mise_en_place.label }}
                            </div>
                            {{ form.date_mise_en_place(class="fk-form-control", type="date") }}
                            {% if form.date_mise_en_place.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.date_mise_en_place.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Responsable et organisation -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <div class="fk-form-label">
                                        <i class="fas fa-user text-primary"></i>
                                        {{ form.responsable_id.label }}
                                    </div>
                                    {{ form.responsable_id(class="fk-form-select") }}
                                    {% if form.responsable_id.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.responsable_id.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-4">
                                    <div class="fk-form-label">
                                        <i class="fas fa-sitemap text-primary"></i>
                                        {{ form.direction_id.label }}
                                    </div>
                                    {{ form.direction_id(class="fk-form-select") }}
                                    {% if form.direction_id.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.direction_id.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-4">
                                    <div class="fk-form-label">
                                        <i class="fas fa-building text-primary"></i>
                                        {{ form.service_id.label }}
                                    </div>
                                    {{ form.service_id(class="fk-form-select") }}
                                    {% if form.service_id.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.service_id.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{{ url_for('liste_dispositifs_risque', risque_id=risque.id) }}" class="fk-btn fk-btn-secondary">
                                <i class="fas fa-times me-1"></i> Annuler
                            </a>
                            <button type="submit" class="fk-btn fk-btn-primary">
                                <i class="fas fa-{{ 'save' if action == 'modifier' else 'plus-circle' }} me-1"></i>
                                {{ 'Enregistrer' if action == 'modifier' else 'Cr√©er le dispositif' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Colonne droite - Guide de cr√©ation -->
        <div class="col-md-4">
            <div class="fk-card animate-in">
                <div class="fk-card-header info">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Guide de cr√©ation
                    </h6>
                </div>
                <div class="fk-card-body">
                    <h6 class="fw-bold mb-3">Types de dispositifs :</h6>
                    <div class="guide-list">
                        <div class="guide-item">
                            <div class="guide-badge success">P</div>
                            <div class="guide-text"><strong>Pr√©ventif :</strong> Emp√™che la survenance du risque</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge warning">D</div>
                            <div class="guide-text"><strong>D√©tectif :</strong> D√©tecte la survenance du risque</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge danger">C</div>
                            <div class="guide-text"><strong>Correctif :</strong> Corrige les cons√©quences du risque</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge info">R</div>
                            <div class="guide-text"><strong>Dirigeant :</strong> D√©cision de la direction</div>
                        </div>
                    </div>
                    
                    <h6 class="fw-bold mt-4 mb-3">Conseils :</h6>
                    <div class="guide-list">
                        <div class="guide-item">
                            <span class="guide-badge">1</span>
                            <div class="guide-text">Donnez un nom clair et explicite</div>
                        </div>
                        <div class="guide-item">
                            <span class="guide-badge">2</span>
                            <div class="guide-text">D√©crivez pr√©cis√©ment le fonctionnement</div>
                        </div>
                        <div class="guide-item">
                            <span class="guide-badge">3</span>
                            <div class="guide-text">Indiquez une efficacit√© attendue r√©aliste</div>
                        </div>
                        <div class="guide-item">
                            <span class="guide-badge">4</span>
                            <div class="guide-text">Associez un responsable clairement identifi√©</div>
                        </div>
                    </div>
                    
                    <div class="fk-alert warning mt-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <small>
                                Un dispositif bien d√©fini facilite son √©valuation et son suivi dans le temps.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù Formulaire dispositif charg√©');
    
    // ===========================
    // GESTION DE LA DATE
    // ===========================
    
    const dateField = document.getElementById('date_mise_en_place');
    if (dateField) {
        // S'assurer que le champ est de type date
        dateField.type = 'date';
        
        // Valeur par d√©faut si vide et en mode cr√©ation
        if (!dateField.value && '{{ action }}' === 'creer') {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateField.value = `${year}-${month}-${day}`;
        }
    }
    
    // ===========================
    // GESTION DYNAMIQUE DES SERVICES
    // ===========================
    
    const directionSelect = document.getElementById('direction_id');
    const serviceSelect = document.getElementById('service_id');
    
    if (directionSelect && serviceSelect) {
        directionSelect.addEventListener('change', function() {
            const directionId = this.value;
            
            if (directionId) {
                // D√©sactiver le select service pendant le chargement
                serviceSelect.disabled = true;
                serviceSelect.innerHTML = '<option value="">Chargement...</option>';
                
                // R√©cup√©rer les services pour cette direction
                fetch(`/api/directions/${directionId}/services`, {
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    let options = '<option value="">S√©lectionnez un service</option>';
                    if (data.services && data.services.length > 0) {
                        data.services.forEach(service => {
                            const selected = (service.id == '{{ form.service_id.data }}') ? 'selected' : '';
                            options += `<option value="${service.id}" ${selected}>${service.nom}</option>`;
                        });
                    }
                    serviceSelect.innerHTML = options;
                    serviceSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur chargement services:', error);
                    serviceSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                    serviceSelect.disabled = false;
                });
            } else {
                // R√©initialiser la liste des services
                serviceSelect.innerHTML = '<option value="">S√©lectionnez d\'abord une direction</option>';
            }
        });
    }
    
    // ===========================
    // VALIDATION DU FORMULAIRE
    // ===========================
    
    const form = document.getElementById('dispositifForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const nom = document.getElementById('nom');
            const type = document.getElementById('type_dispositif');
            const nature = document.getElementById('nature');
            const frequence = document.getElementById('frequence');
            
            if (!nom.value || nom.value.trim() === '') {
                e.preventDefault();
                alert('Veuillez saisir un nom pour le dispositif');
                nom.focus();
                return false;
            }
            
            if (!type.value || type.value === '') {
                e.preventDefault();
                alert('Veuillez s√©lectionner un type de dispositif');
                type.focus();
                return false;
            }
            
            if (!nature.value || nature.value === '') {
                e.preventDefault();
                alert('Veuillez s√©lectionner une nature de dispositif');
                nature.focus();
                return false;
            }
            
            if (!frequence.value || frequence.value === '') {
                e.preventDefault();
                alert('Veuillez s√©lectionner une fr√©quence');
                frequence.focus();
                return false;
            }
            
            return true;
        });
    }
    
    // D√©bogage
    console.log('Risque ID:', {{ risque.id }});
});
</script>
{% endblock %}
