{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       STYLES SPÉCIFIQUES - DÉTAIL DISPOSITIF
       HARMONISÉ AVEC DETAIL_RISQUE.HTML
       ============================================ */
    
    /* Variables de base */
    :root {
        --fk-navy: #0A1929;
        --fk-blue: #1A3C6B;
        --fk-accent: #0066CC;
        --fk-light-blue: #3B82F6;
        --fk-steel: #334155;
        --fk-platinum: #F8FAFC;
        --fk-success: #0D9488;
        --fk-warning: #F59E0B;
        --fk-error: #DC2626;
        --fk-gold: #D4AF37;
        
        --primary-gradient: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        --accent-gradient: linear-gradient(135deg, #0066CC 0%, #3B82F6 100%);
        
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
        --shadow-hard: 0 12px 50px rgba(0, 0, 0, 0.2);
        
        --radius-lg: 20px;
        --radius-md: 12px;
        --radius-sm: 8px;
        
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Variables sémantiques - mode clair */
    body {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #334155;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --card-bg: #ffffff;
        --hover-bg: #f1f5f9;
    }

    /* Mode sombre */
    [data-bs-theme="dark"] body {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #334155;
        --card-bg: #1e293b;
        --hover-bg: #334155;
    }

    /* Conteneur principal */
    .detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* En-tête de page */
    .page-header {
        background: var(--primary-gradient);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: rotate(25deg);
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: rotate(-15deg);
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        color: white;
    }

    .page-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Boutons dans l'en-tête */
    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Boutons modernes */
    .fk-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-smooth);
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
    }

    .fk-btn-primary {
        background: var(--accent-gradient);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .fk-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
    }

    .fk-btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .fk-btn-secondary:hover {
        background: var(--hover-bg);
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
    }

    .fk-btn-warning {
        background: linear-gradient(135deg, var(--fk-warning), #d97706);
        color: white;
    }

    .fk-btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
    }

    .fk-btn-outline-warning {
        background: transparent;
        border: 2px solid var(--fk-warning);
        color: var(--fk-warning);
    }

    .fk-btn-outline-warning:hover {
        background: var(--fk-warning);
        color: white;
        transform: translateY(-2px);
    }

    .fk-btn-outline-secondary {
        background: transparent;
        border: 2px solid var(--border-color);
        color: var(--text-primary);
    }

    .fk-btn-outline-secondary:hover {
        border-color: var(--fk-accent);
        color: var(--fk-accent);
        background: var(--hover-bg);
    }

    /* Dropdown personnalisé */
    .fk-dropdown-toggle {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-smooth);
        cursor: pointer;
        font-size: 0.9rem;
    }

    .fk-dropdown-toggle:hover {
        background: var(--hover-bg);
        border-color: var(--fk-accent);
    }

    .fk-dropdown-toggle::after {
        display: inline-block;
        margin-left: 0.5rem;
        vertical-align: middle;
        content: "";
        border-top: 0.3em solid;
        border-right: 0.3em solid transparent;
        border-bottom: 0;
        border-left: 0.3em solid transparent;
    }

    .fk-dropdown-menu {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-medium);
        padding: 0.5rem;
        min-width: 220px;
    }

    .fk-dropdown-item {
        padding: 0.6rem 1rem;
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        transition: var(--transition-smooth);
        cursor: pointer;
        text-decoration: none;
        display: block;
        font-size: 0.9rem;
    }

    .fk-dropdown-item:hover {
        background: var(--hover-bg);
        color: var(--fk-accent);
    }

    .fk-dropdown-item.text-warning:hover {
        background: var(--fk-warning);
        color: white;
    }

    .fk-dropdown-divider {
        margin: 0.5rem 0;
        border-top: 1px solid var(--border-color);
    }

    /* Cartes */
    .fk-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
        transition: var(--transition-smooth);
    }

    .fk-card:hover {
        box-shadow: var(--shadow-medium);
    }

    .fk-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .fk-card-header.primary {
        background: var(--primary-gradient);
        color: white;
    }

    .fk-card-header.warning {
        background: linear-gradient(135deg, var(--fk-warning), #d97706);
        color: white;
    }

    .fk-card-header.info {
        background: linear-gradient(135deg, var(--fk-accent), var(--fk-light-blue));
        color: white;
    }

    .fk-card-header.secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .fk-card-header.light {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .fk-card-header h6 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .fk-card-header h6 i {
        color: inherit;
    }

    .fk-card-body {
        padding: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    /* Tableaux */
    .fk-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .fk-table th {
        padding: 0.5rem;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .fk-table td {
        padding: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .fk-table tr:last-child td {
        border-bottom: none;
    }

    .fk-table-borderless th,
    .fk-table-borderless td {
        border: none;
    }

    /* Badges */
    .badge-modern {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid transparent;
    }

    .badge-success {
        background: var(--fk-success);
        color: white;
    }

    .badge-warning {
        background: var(--fk-warning);
        color: white;
    }

    .badge-danger {
        background: var(--fk-error);
        color: white;
    }

    .badge-info {
        background: var(--fk-accent);
        color: white;
    }

    .badge-secondary {
        background: var(--text-muted);
        color: white;
    }

    /* Barres de progression */
    .progress-modern {
        background: var(--border-color);
        border-radius: 50px;
        height: 25px;
        overflow: hidden;
        width: 100%;
    }

    .progress-modern-bar {
        height: 100%;
        border-radius: 50px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
    }

    .progress-modern-bar.success { background: var(--fk-success); }
    .progress-modern-bar.warning { background: var(--fk-warning); }
    .progress-modern-bar.danger { background: var(--fk-error); }
    .progress-modern-bar.info { background: var(--fk-accent); }

    /* Cartes de score */
    .score-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 1.25rem;
        text-align: center;
        transition: var(--transition-smooth);
        height: 100%;
    }

    .score-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
        background: var(--hover-bg);
    }

    .score-card.primary { border-top: 4px solid var(--fk-accent); }
    .score-card.success { border-top: 4px solid var(--fk-success); }
    .score-card.warning { border-top: 4px solid var(--fk-warning); }
    .score-card.info { border-top: 4px solid var(--fk-light-blue); }

    .score-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .score-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Boutons d'action */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .btn-action {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        transition: var(--transition-smooth);
        cursor: pointer;
        text-decoration: none;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
        background: var(--hover-bg);
    }

    .btn-action.secondary:hover { background: var(--fk-accent); color: white; border-color: var(--fk-accent); }
    .btn-action.danger:hover { background: var(--fk-error); color: white; border-color: var(--fk-error); }

    /* Liste de vérifications */
    .verification-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: var(--transition-smooth);
    }

    .verification-item:hover {
        background: var(--hover-bg);
        box-shadow: var(--shadow-soft);
    }

    /* Documents */
    .document-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        transition: var(--transition-smooth);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .document-item:hover {
        background: var(--hover-bg);
        box-shadow: var(--shadow-soft);
    }

    .document-item i {
        font-size: 1.2rem;
    }

    /* Alertes */
    .fk-alert {
        border-radius: var(--radius-md);
        padding: 1rem 1.25rem;
        border: none;
        border-left: 4px solid;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .fk-alert.warning {
        border-left-color: var(--fk-warning);
        background: rgba(245, 158, 11, 0.1);
    }

    .fk-alert.info {
        border-left-color: var(--fk-accent);
        background: rgba(0, 102, 204, 0.1);
    }

    .fk-alert.success {
        border-left-color: var(--fk-success);
        background: rgba(13, 148, 136, 0.1);
    }

    /* États vides */
    .empty-state {
        text-align: center;
        padding: 2rem;
    }

    .empty-icon {
        font-size: 3rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .empty-description {
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: slideIn 0.5s ease forwards;
    }

    /* Modals */
    .modal-content-modern {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .modal-header-modern {
        background: var(--primary-gradient);
        color: white;
        padding: 1.25rem 1.5rem;
        border: none;
    }

    .modal-header-modern .btn-close {
        filter: brightness(0) invert(1);
    }

    .modal-body-modern {
        padding: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    .modal-footer-modern {
        padding: 1.25rem 1.5rem;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
    }

    /* Accordéon */
    .accordion-item {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .accordion-button {
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 1rem 1.25rem;
    }

    .accordion-button:not(.collapsed) {
        background: var(--hover-bg);
        color: var(--fk-accent);
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: var(--fk-accent);
    }

    .accordion-body {
        background: var(--card-bg);
        color: var(--text-primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .detail-container {
            padding: 1rem;
        }

        .page-header {
            padding: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .header-actions .fk-btn,
        .header-actions .fk-dropdown-toggle {
            width: 100%;
            justify-content: center;
        }

        .row > [class*="col-"] {
            margin-bottom: 1rem;
        }
    }
</style>

<div class="detail-container">
    <!-- En-tête de page -->
    <div class="page-header animate-in">
        <div class="page-header-content">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb" style="background: transparent; margin-bottom: 0.5rem;">
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_cartographies') }}" style="color: rgba(255,255,255,0.8);">Cartographies</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_cartographie', id=dispositif.risque.cartographie_id) }}" style="color: rgba(255,255,255,0.8);">{{ dispositif.risque.cartographie.nom }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_risque', id=dispositif.risque_id) }}" style="color: rgba(255,255,255,0.8);">{{ dispositif.risque.reference }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_dispositifs_risque', risque_id=dispositif.risque_id) }}" style="color: rgba(255,255,255,0.8);">Dispositifs</a></li>
                            <li class="breadcrumb-item active" style="color: white;">{{ dispositif.reference }}</li>
                        </ol>
                    </nav>
                    
                    <h1 class="page-title">
                        <i class="fas fa-shield-alt me-2"></i>
                        {{ dispositif.reference }} - {{ dispositif.nom }}
                    </h1>
                    <p class="page-subtitle">{{ dispositif.description|truncate(100) if dispositif.description else 'Dispositif de maîtrise' }}</p>
                </div>
                
                <div class="col-auto">
                    <div class="header-actions">
                        <a href="{{ url_for('liste_dispositifs_risque', risque_id=dispositif.risque_id) }}" class="fk-btn fk-btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Retour
                        </a>
                        <a href="{{ url_for('evaluer_dispositif', dispositif_id=dispositif.id) }}" class="fk-btn fk-btn-warning">
                            <i class="fas fa-chart-bar me-1"></i> Évaluer
                        </a>
                        <a href="{{ url_for('modifier_dispositif', dispositif_id=dispositif.id) }}" class="fk-btn fk-btn-outline-warning">
                            <i class="fas fa-edit me-1"></i> Modifier
                        </a>
                        
                        <div class="dropdown">
                            <button class="fk-dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu fk-dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="fk-dropdown-item" href="#" onclick="ajouterVerification()">
                                        <i class="fas fa-clipboard-check me-2"></i>Ajouter vérification
                                    </a>
                                </li>
                                <li>
                                    <a class="fk-dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalUploadDocument">
                                        <i class="fas fa-file-upload me-2"></i>Ajouter document
                                    </a>
                                </li>
                                <li><hr class="fk-dropdown-divider"></li>
                                {% if not dispositif.plan_action_id %}
                                <li>
                                    <a class="fk-dropdown-item" href="#" onclick="lierPlanAction({{ dispositif.id }})">
                                        <i class="fas fa-link me-2"></i>Lier un plan d'action
                                    </a>
                                </li>
                                {% endif %}
                                {% if current_user.has_permission('can_archive_data') %}
                                <li><hr class="fk-dropdown-divider"></li>
                                <li>
                                    <form action="{{ url_for('archiver_dispositif', dispositif_id=dispositif.id) }}" method="POST" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="fk-dropdown-item text-warning w-100 text-start" 
                                                onclick="return confirm('Archiver ce dispositif ? Il ne sera plus visible dans les listes.')">
                                            <i class="fas fa-archive me-2"></i>Archiver
                                        </button>
                                    </form>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne gauche - Informations principales -->
        <div class="col-md-8">
            <!-- Carte informations -->
            <div class="fk-card animate-in">
                <div class="fk-card-header primary">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Informations générales
                    </h6>
                </div>
                <div class="fk-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="fk-table fk-table-borderless">
                                <tr>
                                    <th width="40%">Risque associé:</th>
                                    <td>
                                        <a href="{{ url_for('detail_risque', id=dispositif.risque_id) }}" class="text-decoration-none">
                                            {{ dispositif.risque.reference }} - {{ dispositif.risque.intitule|truncate(40) }}
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Type:</th>
                                    <td>
                                        {% if dispositif.type_dispositif == 'Préventif' %}
                                        <span class="badge-modern badge-success">{{ dispositif.type_dispositif }}</span>
                                        {% elif dispositif.type_dispositif == 'Détectif' %}
                                        <span class="badge-modern badge-warning">{{ dispositif.type_dispositif }}</span>
                                        {% elif dispositif.type_dispositif == 'Correctif' %}
                                        <span class="badge-modern badge-danger">{{ dispositif.type_dispositif }}</span>
                                        {% else %}
                                        <span class="badge-modern">{{ dispositif.type_dispositif }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Nature:</th>
                                    <td>{{ dispositif.nature or 'Non spécifiée' }}</td>
                                </tr>
                                <tr>
                                    <th>Fréquence:</th>
                                    <td>{{ dispositif.frequence or 'Non spécifiée' }}</td>
                                </tr>
                                <tr>
                                    <th>Responsable:</th>
                                    <td>
                                        {% if dispositif.responsable %}
                                        {{ dispositif.responsable.nom_complet if dispositif.responsable.nom_complet else dispositif.responsable.username }}
                                        {% else %}
                                        <span class="text-muted">Non assigné</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="fk-table fk-table-borderless">
                                <tr>
                                    <th width="40%">Direction:</th>
                                    <td>{{ dispositif.direction.nom if dispositif.direction else 'Non spécifiée' }}</td>
                                </tr>
                                <tr>
                                    <th>Service:</th>
                                    <td>{{ dispositif.service.nom if dispositif.service else 'Non spécifié' }}</td>
                                </tr>
                                <tr>
                                    <th>Date mise en place:</th>
                                    <td>
                                        {% if dispositif.date_mise_en_place %}
                                        {{ dispositif.date_mise_en_place.strftime('%d/%m/%Y') }}
                                        {% else %}
                                        <span class="text-muted">Non renseignée</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Statut:</th>
                                    <td>
                                        {% if dispositif.statut == 'actif' %}
                                        <span class="badge-modern badge-success">Actif</span>
                                        {% elif dispositif.statut == 'inactif' %}
                                        <span class="badge-modern">Inactif</span>
                                        {% elif dispositif.statut == 'en_cours' %}
                                        <span class="badge-modern badge-warning">En cours</span>
                                        {% else %}
                                        <span class="badge-modern badge-danger">Obsolète</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Plan d'action:</th>
                                    <td>
                                        {% if dispositif.plan_action %}
                                        <a href="{{ url_for('detail_plan_action_risque', plan_id=dispositif.plan_action.id) }}" 
                                           class="badge-modern badge-info text-decoration-none">
                                            {{ dispositif.plan_action.reference }}
                                        </a>
                                        {% else %}
                                        <button class="fk-btn fk-btn-outline-secondary btn-sm" 
                                                onclick="lierPlanAction({{ dispositif.id }})">
                                            <i class="fas fa-link me-1"></i> Lier un plan
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if dispositif.description %}
                    <div class="mt-3">
                        <h6 class="fw-bold mb-2">Description:</h6>
                        <div class="border rounded p-3 bg-light" style="background: var(--bg-secondary) !important;">
                            {{ dispositif.description|nl2br|safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Carte évaluation -->
            <div class="fk-card animate-in">
                <div class="fk-card-header warning">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Évaluation d'efficacité
                    </h6>
                </div>
                <div class="fk-card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="score-card primary">
                                <div class="score-value">{{ dispositif.efficacite_attendue or 'N/A' }}/5</div>
                                <div class="score-label">Efficacité attendue</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="score-card {% if dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 4 %}success
                                                  {% elif dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 3 %}warning
                                                  {% elif dispositif.efficacite_reelle %}danger
                                                  {% else %}info{% endif %}">
                                <div class="score-value">{{ dispositif.efficacite_reelle or 'N/A' }}/5</div>
                                <div class="score-label">Efficacité réelle</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="score-card info">
                                <div class="score-value">{{ dispositif.couverture or 'N/A' }}/5</div>
                                <div class="score-label">Couverture</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Indicateur visuel -->
                    {% if dispositif.efficacite_attendue and dispositif.efficacite_reelle %}
                    <div class="mt-4">
                        <h6 class="mb-2">Niveau d'efficacité: 
                            <span class="badge-modern {% if dispositif.efficacite_reelle >= dispositif.efficacite_attendue %}badge-success
                                                     {% elif dispositif.efficacite_attendue - dispositif.efficacite_reelle == 1 %}badge-warning
                                                     {% else %}badge-danger{% endif %}">
                                {{ dispositif.get_niveau_efficacite() if dispositif.get_niveau_efficacite else 'À déterminer' }}
                            </span>
                        </h6>
                        <div class="progress-modern">
                            <div class="progress-modern-bar success" style="width: {{ (dispositif.efficacite_reelle / 5) * 100 }}%">
                                Efficacité réelle: {{ dispositif.efficacite_reelle }}/5
                            </div>
                        </div>
                        <div class="mt-2 text-center">
                            <small class="text-muted">Attendu: {{ dispositif.efficacite_attendue }}/5</small>
                        </div>
                        
                        {% if dispositif.efficacite_reelle < dispositif.efficacite_attendue %}
                        <div class="fk-alert warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>L'efficacité réelle est inférieure à l'efficacité attendue.</strong>
                                {% if not dispositif.plan_action_id %}
                                <button onclick="creerPlanActionAutomatique({{ dispositif.id }})" class="fk-btn fk-btn-warning btn-sm ms-2">
                                    <i class="fas fa-magic me-1"></i> Créer un plan d'action automatique
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- COMMENTAIRE D'ÉVALUATION -->
                        {% if dispositif.commentaire_evaluation %}
                        <div class="fk-alert info mt-3">
                            <i class="fas fa-comment me-2"></i>
                            <div>
                                <h6 class="fw-bold mb-1">Commentaire d'évaluation :</h6>
                                <p class="mb-1">{{ dispositif.commentaire_evaluation|nl2br|safe }}</p>
                                <small class="text-muted">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Dernière évaluation : {{ dispositif.date_derniere_verification.strftime('%d/%m/%Y') if dispositif.date_derniere_verification else 'Non spécifiée' }}
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="fk-alert info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            Ce dispositif n'a pas encore été évalué.
                            <a href="{{ url_for('evaluer_dispositif', dispositif_id=dispositif.id) }}" class="alert-link ms-2">
                                Effectuer une première évaluation
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Vérifications -->
            <div class="fk-card animate-in">
                <div class="fk-card-header info">
                    <h6 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>Vérifications
                    </h6>
                    <button class="fk-btn fk-btn-secondary btn-sm" onclick="ajouterVerification()">
                        <i class="fas fa-plus me-1"></i> Nouvelle
                    </button>
                </div>
                <div class="fk-card-body">
                    {% if verifications %}
                    <div id="listeVerifications">
                        {% for verification in verifications %}
                        <div class="verification-item" id="verification-{{ verification.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="d-flex align-items-center mb-2">
                                        <strong class="me-2">{{ verification.date_verification.strftime('%d/%m/%Y') }}</strong>
                                        <span class="badge-modern 
                                            {% if verification.resultat == 'Conforme' %}badge-success
                                            {% elif verification.resultat == 'Non conforme' %}badge-danger
                                            {% else %}badge-warning{% endif %}">
                                            {{ verification.resultat }}
                                        </span>
                                    </div>
                                    <small class="text-muted">{{ verification.type_verification }}</small>
                                    
                                    {% if verification.commentaire %}
                                    <div class="mt-2 p-2 rounded" style="background: var(--bg-tertiary);" id="commentaire-{{ verification.id }}">
                                        <small>{{ verification.commentaire|nl2br|safe }}</small>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-user me-1"></i>Par {{ verification.verificateur.nom_complet if verification.verificateur and verification.verificateur.nom_complet else (verification.verificateur.username if verification.verificateur else 'Système') }}
                                        </small>
                                    </div>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn-action" onclick="modifierVerification({{ verification.id }})" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-action danger" onclick="supprimerVerification({{ verification.id }})" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="empty-title">Aucune vérification enregistrée</div>
                        <div class="empty-description">Ajoutez votre première vérification pour ce dispositif</div>
                        <button class="fk-btn fk-btn-primary" onclick="ajouterVerification()">
                            <i class="fas fa-plus me-1"></i>Ajouter la première vérification
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Colonne droite - Documents et métriques -->
        <div class="col-md-4">
            <!-- Documents -->
            <div class="fk-card animate-in">
                <div class="fk-card-header secondary">
                    <h6 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Documents associés
                    </h6>
                    <button class="fk-btn fk-btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalUploadDocument">
                        <i class="fas fa-upload"></i>
                    </button>
                </div>
                <div class="fk-card-body">
                    {% if documents %}
                    <div class="document-list">
                        {% for doc in documents %}
                        <div class="document-item">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file 
                                    {% if 'pdf' in doc.nom_fichier|lower %}text-danger
                                    {% elif 'doc' in doc.nom_fichier|lower %}text-primary
                                    {% elif 'xls' in doc.nom_fichier|lower %}text-success
                                    {% else %}text-secondary{% endif %} me-2">
                                </i>
                                <div>
                                    <a href="{{ url_for('telecharger_document_dispositif', doc_id=doc.id) }}" 
                                       class="text-decoration-none fw-bold" target="_blank">
                                        {{ doc.nom_fichier|truncate(25) }}
                                    </a>
                                    {% if doc.type_document %}
                                    <span class="badge-modern badge-info ms-2">{{ doc.type_document }}</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ (doc.taille / 1024)|round(1) }} Ko</small>
                                </div>
                            </div>
                            {% if doc.description %}
                            <div class="mt-1 small text-muted">
                                {{ doc.description|truncate(40) }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="empty-title">Aucun document associé</div>
                        <div class="empty-description">Ajoutez des documents pour enrichir ce dispositif</div>
                        <button class="fk-btn fk-btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalUploadDocument">
                            <i class="fas fa-upload me-1"></i>Ajouter un document
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Métriques temporelles -->
            <div class="fk-card animate-in">
                <div class="fk-card-header light">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Calendrier
                    </h6>
                </div>
                <div class="fk-card-body">
                    <table class="fk-table fk-table-borderless">
                        <tr>
                            <td><strong>Mise en place:</strong></td>
                            <td class="text-end">
                                {% if dispositif.date_mise_en_place %}
                                {{ dispositif.date_mise_en_place.strftime('%d/%m/%Y') }}
                                {% else %}
                                <span class="text-muted">Non renseignée</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Dernière vérif:</strong></td>
                            <td class="text-end">
                                {% if dispositif.date_derniere_verification %}
                                {{ dispositif.date_derniere_verification.strftime('%d/%m/%Y') }}
                                <span class="badge-modern badge-success ms-1">Effectuée</span>
                                {% else %}
                                <span class="badge-modern badge-warning">Jamais</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Prochaine vérif:</strong></td>
                            <td class="text-end">
                                {% if dispositif.prochaine_verification %}
                                {% set jours_restants = (dispositif.prochaine_verification - now().date()).days %}
                                {{ dispositif.prochaine_verification.strftime('%d/%m/%Y') }}
                                <br>
                                <span class="badge-modern {% if jours_restants <= 7 %}badge-danger
                                                        {% elif jours_restants <= 30 %}badge-warning
                                                        {% else %}badge-success{% endif %}">
                                    {% if jours_restants > 0 %}
                                    {{ jours_restants }} jour(s) restant(s)
                                    {% elif jours_restants == 0 %}
                                    <strong>Aujourd'hui!</strong>
                                    {% else %}
                                    <strong>En retard de {{ -jours_restants }} jour(s)</strong>
                                    {% endif %}
                                </span>
                                {% else %}
                                <span class="text-muted">Non planifiée</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Impact sur le risque - VERSION RÉALISTE -->
            <div class="fk-card animate-in">
                <div class="fk-card-header light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Impact sur le risque
                    </h6>
                </div>
                <div class="fk-card-body">
                    {% if dispositif.efficacite_reelle is not none and dispositif.couverture is not none %}
                        {% set details = dispositif.get_reduction_risque_detaille() %}
                        
                        <!-- Visualisation claire -->
                        <div class="text-center mb-4">
                            <div class="d-flex justify-content-center align-items-center mb-3">
                                <div class="text-center me-4">
                                    <div class="display-4 fw-bold 
                                        {% if details.reduction_finale >= details.reduction_max_type * 0.8 %}text-success
                                        {% elif details.reduction_finale >= details.reduction_max_type * 0.6 %}text-warning
                                        {% else %}text-danger{% endif %}">
                                        {{ "%.1f"|format(details.reduction_finale) }}%
                                    </div>
                                    <small class="text-muted">Réduction théorique</small>
                                </div>
                                <div class="vr mx-3"></div>
                                <div class="text-start">
                                    <div class="small">
                                        <span class="badge-modern {% if details.type == 'Préventif' %}badge-success
                                                                 {% elif details.type == 'Détectif' %}badge-warning
                                                                 {% elif details.type == 'Correctif' %}badge-info
                                                                 {% else %}badge-secondary{% endif %} mb-1">
                                            {{ details.type }}
                                        </span>
                                        <div>Max: <strong>{{ details.reduction_max_type }}%</strong></div>
                                        <div class="text-muted">Nature: {{ details.nature }}</div>
                                        <div class="text-muted">Fréquence: {{ details.frequence }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Barre de progression intuitive -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>0%</span>
                                    <span class="fw-bold">Réduction atteinte</span>
                                    <span>{{ details.reduction_max_type }}%</span>
                                </div>
                                <div class="progress-modern">
                                    <div class="progress-modern-bar 
                                        {% if details.reduction_finale >= details.reduction_max_type * 0.8 %}success
                                        {% elif details.reduction_finale >= details.reduction_max_type * 0.6 %}warning
                                        {% else %}danger{% endif %}"
                                         style="width: {{ (details.reduction_finale / details.reduction_max_type) * 100 }}%">
                                        <span class="fw-bold">{{ "%.1f"|format(details.reduction_finale) }}%</span>
                                    </div>
                                </div>
                                <div class="text-end small text-muted mt-1">
                                    {{ "%.0f"|format((details.reduction_finale / details.reduction_max_type) * 100) }}% du potentiel max
                                </div>
                            </div>
                        </div>
                        
                        <!-- Interprétation simple -->
                        <div class="fk-alert {% if details.reduction_finale >= details.reduction_max_type * 0.8 %}success
                                            {% elif details.reduction_finale >= details.reduction_max_type * 0.6 %}warning
                                            {% else %}danger{% endif %} mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-{% if details.reduction_finale >= details.reduction_max_type * 0.8 %}check-circle
                                                   {% elif details.reduction_finale >= details.reduction_max_type * 0.6 %}exclamation-triangle
                                                   {% else %}times-circle{% endif %} fa-2x"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="fw-bold">
                                        {% if details.reduction_finale >= details.reduction_max_type * 0.8 %}
                                        IMPACT ÉLEVÉ
                                        {% elif details.reduction_finale >= details.reduction_max_type * 0.6 %}
                                        IMPACT MODÉRÉ
                                        {% else %}
                                        IMPACT LIMITÉ
                                        {% endif %}
                                    </h6>
                                    <p class="mb-0">
                                        {% if details.type == 'Préventif' %}
                                        Ce dispositif préventif {{ 'est très efficace' if details.reduction_finale >= 60 else 'peut être amélioré' }}
                                        pour éviter la survenance du risque.
                                        {% elif details.type == 'Détectif' %}
                                        Ce dispositif détectif {{ 'permet une détection rapide' if details.reduction_finale >= 48 else 'nécessite des ajustements' }}
                                        pour limiter l'impact.
                                        {% elif details.type == 'Correctif' %}
                                        Ce dispositif correctif {{ 'est suffisamment réactif' if details.reduction_finale >= 36 else 'pourrait être plus rapide' }}
                                        pour contenir les conséquences.
                                        {% endif %}
                                    </p>
                                    {% if details.garantie_minimum %}
                                    <small class="text-muted mt-2 d-block">
                                        <i class="fas fa-star text-warning"></i> Dispositif parfait (5/5 + 5/5) - Impact optimal garanti
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Détails du calcul (optionnel) -->
                        <div class="accordion mt-3" id="accordionCalcul">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapseDetails">
                                        <i class="fas fa-calculator me-2"></i>
                                        Voir le calcul détaillé
                                    </button>
                                </h2>
                                <div id="collapseDetails" class="accordion-collapse collapse" 
                                     data-bs-parent="#accordionCalcul">
                                    <div class="accordion-body">
                                        <table class="fk-table">
                                            <tr>
                                                <td width="50%"><strong>Type:</strong></td>
                                                <td>{{ details.type }} (max théorique: {{ details.reduction_max_type }}%)</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Scores:</strong></td>
                                                <td>Efficacité: {{ details.efficacite }}/5, Couverture: {{ details.couverture }}/5</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Score pondéré:</strong></td>
                                                <td>({{ details.efficacite }}/5×60%) + ({{ details.couverture }}/5×40%) = {{ details.score_pondere|round(1) }}/100</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Base réduction:</strong></td>
                                                <td>{{ details.score_pondere|round(1) }}/100 × {{ details.reduction_max_type }}% = {{ details.reduction_calcul|round(1) }}%</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Facteurs:</strong></td>
                                                <td>
                                                    Nature ({{ details.nature }}): ×{{ details.facteur_nature }}<br>
                                                    Fréquence ({{ details.frequence }}): ×{{ details.facteur_frequence }}
                                                </td>
                                            </tr>
                                            {% if details.garantie_minimum %}
                                            <tr class="table-warning">
                                                <td><strong>Garantie minimum:</strong></td>
                                                <td>Dispositif parfait → minimum {{ details.reduction_max_type * 0.8 }}%</td>
                                            </tr>
                                            {% endif %}
                                            <tr class="fw-bold">
                                                <td><strong>RÉDUCTION FINALE:</strong></td>
                                                <td>{{ details.reduction_calcul|round(1) }}% × {{ details.facteur_nature }} × {{ details.facteur_frequence }}
                                                    = <span class="text-primary">{{ details.reduction_finale }}%</span>
                                                </td>
                                            </tr>
                                        </table>
                                        
                                        <div class="fk-alert info small mt-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <strong>Logique:</strong> Un dispositif <strong>parfait (5+5)</strong> donne ~90% de la réduction max du type,
                                            ajusté par sa nature et fréquence.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    {% else %}
                        <div class="fk-alert info text-center">
                            <i class="fas fa-chart-line fa-2x mb-3"></i>
                            <h6>Évaluation requise</h6>
                            <p class="small mb-3">Évaluez le dispositif pour calculer son impact théorique</p>
                            <a href="{{ url_for('evaluer_dispositif', dispositif_id=dispositif.id) }}" 
                               class="fk-btn fk-btn-primary btn-sm">
                                <i class="fas fa-chart-bar me-1"></i>Évaluer maintenant
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour upload de document -->
<div class="modal fade" id="modalUploadDocument" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content modal-content-modern">
            <div class="modal-header modal-header-modern">
                <h5 class="modal-title">
                    <i class="fas fa-file-upload me-2"></i> Ajouter un document
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('uploader_document_dispositif', dispositif_id=dispositif.id) }}" 
                  enctype="multipart/form-data" id="formUploadDocument">
                <div class="modal-body modal-body-modern">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fichier :</label>
                        <input type="file" class="form-control" name="fichier" id="fichierInput" required
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png">
                        <div class="form-text">
                            Formats acceptés : PDF, Word, Excel, PowerPoint, TXT, JPG, PNG (max 16MB)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Type de document :</label>
                        <select class="form-select" name="type_document" required>
                            <option value="">-- Sélectionner --</option>
                            <option value="Procédure">Procédure</option>
                            <option value="Mode opératoire">Mode opératoire</option>
                            <option value="Fiche de contrôle">Fiche de contrôle</option>
                            <option value="Rapport">Rapport</option>
                            <option value="Documentation">Documentation</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description :</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description du document..."></textarea>
                    </div>
                    
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress-modern">
                            <div class="progress-modern-bar info" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2" id="uploadStatus"></div>
                    </div>
                </div>
                <div class="modal-footer modal-footer-modern">
                    <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="fk-btn fk-btn-primary" id="btnUpload">
                        <i class="fas fa-upload me-1"></i>Uploader
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal générique -->
<div class="modal fade" id="genericModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-content-modern">
            <div class="modal-header modal-header-modern">
                <h5 class="modal-title" id="genericModalTitle">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modal-body-modern" id="genericModalBody">
                <!-- Le contenu sera injecté ici -->
            </div>
            <div class="modal-footer modal-footer-modern" id="genericModalFooter">
                <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables globales
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token() }}';
const dispositifId = {{ dispositif.id }};
const risqueId = {{ dispositif.risque_id }};

// ===========================
// FONCTIONS DE LIAISON
// ===========================

function lierPlanAction(dispositifId) {
    console.log('🔗 Liaison du dispositif:', dispositifId);
    
    const modal = new bootstrap.Modal(document.getElementById('genericModal'));
    document.getElementById('genericModalTitle').innerHTML = 'Lier à un plan d\'action';
    document.getElementById('genericModalBody').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement des plans d'action...</p>
        </div>
    `;
    document.getElementById('genericModalFooter').innerHTML = '';
    modal.show();
    
    fetch(`/api/plans-action/disponibles?risque_id=${risqueId}`, {
        headers: {
            'X-CSRFToken': csrfToken,
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data);
        
        if (data.success && data.plans && data.plans.length > 0) {
            let options = '<option value="">-- Choisir un plan d\'action --</option>';
            
            data.plans.forEach(plan => {
                if (!plan.dispositif_id || plan.dispositif_id == dispositifId) {
                    const statutEmoji = plan.statut === 'en_cours' ? '🟡' : 
                                      plan.statut === 'en_retard' ? '🔴' : 
                                      plan.statut === 'termine' ? '🟢' : '⚪';
                    
                    const alreadyLinked = plan.dispositif_id == dispositifId ? ' (déjà lié)' : '';
                    
                    options += `<option value="${plan.id}">
                        ${statutEmoji} ${plan.reference} - ${plan.nom}
                        ${plan.date_echeance ? `(échéance: ${plan.date_echeance})` : ''}
                        ${alreadyLinked}
                    </option>`;
                }
            });
            
            const html = `
                <form method="POST" action="/dispositif/${dispositifId}/lier-plan-action" id="formLiaison">
                    <input type="hidden" name="csrf_token" value="${csrfToken}">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Sélectionner un plan d'action :</label>
                        <select class="form-select" name="plan_action_id" required>
                            ${options}
                        </select>
                        <small class="text-muted">
                            Seuls les plans disponibles (non liés à d'autres dispositifs) sont affichés.
                        </small>
                    </div>
                    
                    <div class="fk-alert info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Information :</strong> Vous pouvez également 
                        <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=dispositif.risque_id) }}?dispositif_id=${dispositifId}" 
                           class="alert-link" target="_blank">
                            créer un nouveau plan d'action
                        </a>
                    </div>
                </form>
            `;
            
            document.getElementById('genericModalBody').innerHTML = html;
            document.getElementById('genericModalFooter').innerHTML = `
                <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" class="fk-btn fk-btn-primary" form="formLiaison">
                    Lier le plan
                </button>
            `;
            
        } else {
            const html = `
                <div class="fk-alert warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Aucun plan d'action disponible</strong>
                    <p class="mb-0 mt-2">Il n'y a pas de plan d'action disponible pour ce risque, ou tous les plans sont déjà liés à d'autres dispositifs.</p>
                </div>
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=dispositif.risque_id) }}?dispositif_id=${dispositifId}" 
                       class="fk-btn fk-btn-primary">
                        <i class="fas fa-plus me-1"></i> Créer un nouveau plan d'action
                    </a>
                </div>
            `;
            
            document.getElementById('genericModalBody').innerHTML = html;
            document.getElementById('genericModalFooter').innerHTML = `
                <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Fermer</button>
            `;
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        
        document.getElementById('genericModalBody').innerHTML = `
            <div class="fk-alert danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Erreur de chargement</strong>
                <p class="mb-0 mt-2">Impossible de charger la liste des plans d'action.</p>
                <small>${error.message}</small>
            </div>
            
            <div class="text-center mt-3">
                <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=dispositif.risque_id) }}?dispositif_id=${dispositifId}" 
                   class="fk-btn fk-btn-primary">
                    <i class="fas fa-plus me-1"></i> Créer un nouveau plan d'action
                </a>
            </div>
        `;
        document.getElementById('genericModalFooter').innerHTML = `
            <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Fermer</button>
        `;
    });
}

// ===========================
// FONCTIONS DE VÉRIFICATION
// ===========================

function ajouterVerification() {
    console.log('📝 Ajout de vérification');
    
    const modal = new bootstrap.Modal(document.getElementById('genericModal'));
    document.getElementById('genericModalTitle').innerHTML = 'Nouvelle vérification';
    document.getElementById('genericModalBody').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement du formulaire...</p>
        </div>
    `;
    document.getElementById('genericModalFooter').innerHTML = `
        <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Annuler</button>
    `;
    modal.show();
    
    fetch(`/dispositif/{{ dispositif.id }}/verification/formulaire`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            document.getElementById('genericModalBody').innerHTML = html;
            document.getElementById('genericModalFooter').innerHTML = `
                <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" class="fk-btn fk-btn-primary" form="formVerification">Enregistrer</button>
            `;
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('genericModalBody').innerHTML = `
                <div class="fk-alert danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Erreur de chargement</strong>
                    <p class="mb-0 mt-2">Impossible de charger le formulaire de vérification.</p>
                    <small>${error.message}</small>
                </div>
            `;
        });
}

function modifierVerification(verificationId) {
    console.log('📝 Modification vérification:', verificationId);
    
    const modal = new bootstrap.Modal(document.getElementById('genericModal'));
    document.getElementById('genericModalTitle').innerHTML = 'Modifier la vérification';
    
    const verificationElement = document.getElementById(`verification-${verificationId}`);
    const commentaireElement = document.getElementById(`commentaire-${verificationId}`);
    const badgeElement = verificationElement.querySelector('.badge-modern');
    
    const commentaire = commentaireElement ? commentaireElement.innerText.trim() : '';
    const resultat = badgeElement ? badgeElement.innerText.trim() : '';
    
    const html = `
        <form id="formModifVerification">
            <input type="hidden" name="csrf_token" value="${csrfToken}">
            <input type="hidden" name="verification_id" value="${verificationId}">
            
            <div class="mb-3">
                <label class="form-label fw-bold">Commentaire :</label>
                <textarea class="form-control" name="commentaire" rows="4">${commentaire}</textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Résultat :</label>
                <select class="form-select" name="resultat">
                    <option value="Conforme" ${resultat === 'Conforme' ? 'selected' : ''}>Conforme</option>
                    <option value="Non conforme" ${resultat === 'Non conforme' ? 'selected' : ''}>Non conforme</option>
                    <option value="À corriger" ${resultat === 'À corriger' ? 'selected' : ''}>À corriger</option>
                    <option value="À améliorer" ${resultat === 'À améliorer' ? 'selected' : ''}>À améliorer</option>
                </select>
            </div>
        </form>
    `;
    
    document.getElementById('genericModalBody').innerHTML = html;
    document.getElementById('genericModalFooter').innerHTML = `
        <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="fk-btn fk-btn-danger" onclick="supprimerVerification(${verificationId})">
            <i class="fas fa-trash me-1"></i> Supprimer
        </button>
        <button type="button" class="fk-btn fk-btn-primary" onclick="sauvegarderModification(${verificationId})">
            <i class="fas fa-save me-1"></i> Enregistrer
        </button>
    `;
    
    modal.show();
}

function sauvegarderModification(verificationId) {
    const form = document.getElementById('formModifVerification');
    const formData = new FormData(form);
    const data = {
        commentaire: formData.get('commentaire'),
        resultat: formData.get('resultat')
    };
    
    fetch(`/api/verification/${verificationId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur: ' + (data.error || 'Modification échouée'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la modification');
    });
}

function supprimerVerification(verificationId) {
    if (confirm('Supprimer cette vérification ? Cette action est irréversible.')) {
        fetch(`/api/verification/${verificationId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Supprimer l'élément de la liste
                const element = document.getElementById(`verification-${verificationId}`);
                if (element) {
                    element.remove();
                }
                
                // Fermer la modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('genericModal'));
                if (modal) modal.hide();
                
                // Vérifier s'il reste des vérifications
                const liste = document.getElementById('listeVerifications');
                if (liste && liste.children.length === 0) {
                    liste.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="empty-title">Aucune vérification enregistrée</div>
                            <div class="empty-description">Ajoutez votre première vérification pour ce dispositif</div>
                            <button class="fk-btn fk-btn-primary" onclick="ajouterVerification()">
                                <i class="fas fa-plus me-1"></i>Ajouter la première vérification
                            </button>
                        </div>
                    `;
                }
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression');
        });
    }
}

// ===========================
// PLAN D'ACTION AUTOMATIQUE
// ===========================

function creerPlanActionAutomatique(dispositifId) {
    if (confirm('Créer automatiquement un plan d\'action pour améliorer ce dispositif ?\n\nUn plan basique sera généré avec une échéance dans 30 jours.')) {
        fetch(`/api/dispositif/${dispositifId}/creer-plan-action`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la création du plan d\'action');
        });
    }
}

// ===========================
// UPLOAD DE DOCUMENT
// ===========================

document.addEventListener('DOMContentLoaded', function() {
    const formUpload = document.getElementById('formUploadDocument');
    const fichierInput = document.getElementById('fichierInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadStatus = document.getElementById('uploadStatus');
    const btnUpload = document.getElementById('btnUpload');
    
    if (formUpload) {
        formUpload.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const file = fichierInput.files[0];
            
            if (!file) {
                alert('Veuillez sélectionner un fichier');
                return;
            }
            
            // Vérifier la taille du fichier (max 16MB)
            if (file.size > 16 * 1024 * 1024) {
                alert('Le fichier est trop volumineux. Maximum 16MB.');
                return;
            }
            
            // Afficher la progression
            uploadProgress.style.display = 'block';
            uploadStatus.innerHTML = 'Upload en cours...';
            btnUpload.disabled = true;
            
            // Simulation de progression
            const progressBar = uploadProgress.querySelector('.progress-modern-bar');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                if (progress >= 90) clearInterval(interval);
            }, 100);
            
            // Envoi réel
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                clearInterval(interval);
                progressBar.style.width = '100%';
                
                if (response.redirected) {
                    uploadStatus.innerHTML = '<span class="text-success">Upload réussi ! Redirection...</span>';
                    setTimeout(() => {
                        window.location.href = response.url;
                    }, 1000);
                } else {
                    return response.text().then(text => {
                        try {
                            const data = JSON.parse(text);
                            if (data.success) {
                                uploadStatus.innerHTML = '<span class="text-success">' + data.message + '</span>';
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                throw new Error(data.error || 'Erreur inconnue');
                            }
                        } catch (e) {
                            uploadStatus.innerHTML = '<span class="text-danger">Erreur: ' + text + '</span>';
                            btnUpload.disabled = false;
                        }
                    });
                }
            })
            .catch(error => {
                clearInterval(interval);
                console.error('Upload error:', error);
                uploadStatus.innerHTML = '<span class="text-danger">Erreur: ' + error.message + '</span>';
                btnUpload.disabled = false;
            });
        });
    }
    
    // Débogage
    console.log('Dispositif ID:', dispositifId);
    console.log('Risque ID:', risqueId);
    
    // Exposer les fonctions pour débogage
    window.testLierPlanAction = lierPlanAction;
    window.testAjouterVerification = ajouterVerification;
});
</script>
{% endblock %}
