{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       STYLES SP√âCIFIQUES - STRESS TEST AVANC√â
       ============================================ */
    
    /* Variables de base */
    .stress-container {
        max-width: 1600px;
        margin: 0 auto;
    }

    /* ========== EN-T√äTE DE PAGE ========== */
    .page-header {
        background: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: visible !important;
        z-index: 1000;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: rotate(25deg);
        pointer-events: none;
        z-index: 0;
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: rotate(-15deg);
        pointer-events: none;
        z-index: 0;
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .page-subtitle {
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
    }

    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 1rem;
    }

    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .breadcrumb-item a:hover {
        color: white;
    }

    .breadcrumb-item.active {
        color: white;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
        position: relative;
        z-index: 1000;
    }

    .fk-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        z-index: 1000;
        position: relative;
    }

    .fk-btn-primary {
        background: linear-gradient(135deg, #0066CC, #3B82F6);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .fk-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
        color: white;
    }

    .fk-btn-secondary {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
    }

    .fk-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        color: white;
    }

    .fk-btn-info {
        background: linear-gradient(135deg, #3B82F6, #6366F1);
        color: white;
    }

    .fk-btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        color: white;
    }

    .fk-btn-warning {
        background: linear-gradient(135deg, #F59E0B, #FBBF24);
        color: white;
    }

    .fk-btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        color: white;
    }

    .fk-btn-outline-primary {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .fk-btn-outline-primary:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        color: white;
    }

    /* ========== CARTES ========== */
    .fk-card-modern {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .fk-card-modern:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    [data-bs-theme="dark"] .fk-card-modern {
        background: #1e293b;
        border-color: #334155;
    }

    .fk-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        background: #f8fafc;
        color: #0f172a;
    }

    .fk-card-header.primary {
        background: linear-gradient(135deg, #0066CC, #3B82F6);
        color: white;
        border-bottom: none;
    }

    .fk-card-header.warning {
        background: linear-gradient(135deg, #F59E0B, #FBBF24);
        color: white;
        border-bottom: none;
    }

    .fk-card-header.danger {
        background: linear-gradient(135deg, #DC2626, #EF4444);
        color: white;
        border-bottom: none;
    }

    .fk-card-header.success {
        background: linear-gradient(135deg, #0D9488, #14B8A6);
        color: white;
        border-bottom: none;
    }

    .fk-card-header.info {
        background: linear-gradient(135deg, #3B82F6, #6366F1);
        color: white;
        border-bottom: none;
    }

    .header-icon-sm {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
    }

    .fk-card-body {
        padding: 1.5rem;
        background: white;
        color: #0f172a;
    }

    [data-bs-theme="dark"] .fk-card-body {
        background: #1e293b;
        color: #f1f5f9;
    }

    /* ========== BADGES ========== */
    .badge-modern {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        border: 1px solid transparent;
    }

    .badge-primary { background: #0066CC; color: white; }
    .badge-success { background: #0D9488; color: white; }
    .badge-warning { background: #F59E0B; color: white; }
    .badge-danger { background: #DC2626; color: white; }
    .badge-info { background: #3B82F6; color: white; }
    .badge-secondary { background: #64748b; color: white; }

    /* ========== BADGES DE TYPE ========== */
    .badge-type {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-type.preventif {
        background: #0D9488;
        color: white;
    }

    .badge-type.detectif {
        background: #F59E0B;
        color: white;
    }

    .badge-type.correctif {
        background: #DC2626;
        color: white;
    }

    .badge-type.default {
        background: #64748b;
        color: white;
    }

    /* ========== CARTES DE SC√âNARIO ========== */
    .scenario-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .scenario-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .scenario-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    [data-bs-theme="dark"] .scenario-card {
        background: #1e293b;
        border-color: #334155;
    }

    .scenario-card.selected {
        border: 2px solid #0066CC;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.25);
    }

    .scenario-header {
        padding: 1rem;
        font-weight: 600;
        color: white;
    }

    .scenario-header.danger { background: linear-gradient(135deg, #DC2626, #EF4444); }
    .scenario-header.warning { background: linear-gradient(135deg, #F59E0B, #FBBF24); }
    .scenario-header.info { background: linear-gradient(135deg, #3B82F6, #6366F1); }
    .scenario-header.success { background: linear-gradient(135deg, #0D9488, #14B8A6); }
    .scenario-header.secondary { background: linear-gradient(135deg, #64748b, #94a3b8); }

    .scenario-body {
        padding: 1.25rem;
    }

    .scenario-option {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: #f8fafc;
        transition: all 0.2s ease;
    }

    .scenario-option:hover {
        background: #f1f5f9;
    }

    [data-bs-theme="dark"] .scenario-option {
        background: #0f172a;
    }

    [data-bs-theme="dark"] .scenario-option:hover {
        background: #1e293b;
    }

    .scenario-radio {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
    }

    .scenario-radio input[type="radio"] {
        margin-top: 0.2rem;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .scenario-label {
        font-weight: 600;
        color: #0f172a;
    }

    [data-bs-theme="dark"] .scenario-label {
        color: #f1f5f9;
    }

    .scenario-desc {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    /* ========== CARTES DE R√âSULTATS ========== */
    .result-kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .result-kpi-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .result-kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    [data-bs-theme="dark"] .result-kpi-card {
        background: #0f172a;
        border-color: #334155;
    }

    .result-kpi-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 0.25rem;
    }

    .result-kpi-label {
        font-size: 0.8rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ========== PROGRESS ========== */
    .progress-modern {
        background: #e2e8f0;
        border-radius: 50px;
        height: 8px;
        overflow: hidden;
        width: 100%;
    }

    [data-bs-theme="dark"] .progress-modern {
        background: #334155;
    }

    .progress-modern-bar {
        height: 100%;
        border-radius: 50px;
        transition: width 0.3s ease;
    }

    .progress-modern-bar.success { background: #0D9488; }
    .progress-modern-bar.warning { background: #F59E0B; }
    .progress-modern-bar.danger { background: #DC2626; }
    .progress-modern-bar.primary { background: #0066CC; }

    /* ========== ALERTES ========== */
    .fk-alert-modern {
        border-radius: 10px;
        padding: 1rem 1.25rem;
        border: none;
        border-left: 4px solid;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        color: #0f172a;
    }

    [data-bs-theme="dark"] .fk-alert-modern {
        color: #f1f5f9;
    }

    .fk-alert-modern.info {
        background: rgba(0, 102, 204, 0.1);
        border-left-color: #0066CC;
    }

    .fk-alert-modern.success {
        background: rgba(13, 148, 136, 0.1);
        border-left-color: #0D9488;
    }

    .fk-alert-modern.warning {
        background: rgba(245, 158, 11, 0.1);
        border-left-color: #F59E0B;
    }

    .fk-alert-modern.danger {
        background: rgba(220, 38, 38, 0.1);
        border-left-color: #DC2626;
    }

    /* ========== TABLEAUX ========== */
    .fk-table-detail {
        width: 100%;
        border-collapse: collapse;
    }

    .fk-table-detail tr {
        border-bottom: 1px solid #e2e8f0;
    }

    .fk-table-detail tr:last-child {
        border-bottom: none;
    }

    .fk-table-detail th {
        padding: 0.75rem 0.5rem 0.75rem 0;
        font-weight: 600;
        color: #64748b;
    }

    .fk-table-detail td {
        padding: 0.75rem 0;
        color: #0f172a;
    }

    [data-bs-theme="dark"] .fk-table-detail th {
        color: #94a3b8;
    }

    [data-bs-theme="dark"] .fk-table-detail td {
        color: #f1f5f9;
    }

    /* ========== RECOMMANDATIONS ========== */
    .reco-list {
        list-style: none;
        padding: 0;
    }

    .reco-list li {
        padding: 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .reco-list li:last-child {
        border-bottom: none;
    }

    .reco-list li i {
        width: 24px;
        font-size: 1.1rem;
    }

    .reco-list li.text-danger i { color: #DC2626; }
    .reco-list li.text-warning i { color: #F59E0B; }
    .reco-list li.text-success i { color: #0D9488; }

    /* ========== ANIMATIONS ========== */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .animate-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .header-actions .fk-btn {
            width: 100%;
            justify-content: center;
        }

        .scenario-grid {
            grid-template-columns: 1fr;
        }

        .result-kpi-grid {
            grid-template-columns: 1fr;
        }
    }
    /* ========== BADGES CORRIG√âS ========== */
.badge-modern {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    border: 1px solid transparent;
}

.badge-primary { 
    background: #0066CC; 
    color: white; 
}

.badge-success { 
    background: #0D9488; 
    color: white; 
}

.badge-warning { 
    background: #F59E0B; 
    color: white; 
}

.badge-danger { 
    background: #DC2626; 
    color: white; 
}

.badge-info { 
    background: #3B82F6; 
    color: white; 
}

.badge-secondary { 
    background: #64748b; 
    color: white; 
}

/* ========== BADGES DE STATUT ========== */
.badge-statut {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
}

.badge-statut.actif {
    background: #0D9488;
    color: white;
}

.badge-statut.inactif {
    background: #64748b;
    color: white;
}

.badge-statut.en_cours {
    background: #F59E0B;
    color: white;
}

.badge-statut.obsolete {
    background: #DC2626;
    color: white;
}

/* ========== BADGES DE TYPE ========== */
.badge-type {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-type.preventif {
    background: #0D9488;
    color: white;
}

.badge-type.detectif {
    background: #F59E0B;
    color: white;
}

.badge-type.correctif {
    background: #DC2626;
    color: white;
}

.badge-type.default {
    background: #64748b;
    color: white;
}
</style>

<div class="stress-container">
    <!-- En-t√™te de page -->
    <div class="page-header animate-in">
        <div class="page-header-content">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_cartographies') }}">Cartographies</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_cartographie', id=dispositif.risque.cartographie_id) }}">{{ dispositif.risque.cartographie.nom }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_risque', id=dispositif.risque_id) }}">{{ dispositif.risque.reference }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_dispositifs_risque', risque_id=dispositif.risque_id) }}">Dispositifs</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}">{{ dispositif.reference }}</a></li>
                            <li class="breadcrumb-item active">Stress Test</li>
                        </ol>
                    </nav>
                    
                    <div class="page-title">
                        <i class="fas fa-bolt text-warning me-2"></i>Stress Test Avanc√©
                        <span class="badge-statut 
                            {% if dispositif.statut == 'actif' %}actif
                            {% else %}inactif{% endif %}">
                            {{ dispositif.statut }}
                        </span>
                    </div>
                    
                    <p class="page-subtitle">{{ dispositif.reference }} - {{ dispositif.nom }}</p>
                </div>
                
                <div class="col-auto">
                    <div class="header-actions">
                        <a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" class="fk-btn fk-btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour
                        </a>
                        <a href="{{ url_for('benchmark_dispositifs') }}" class="fk-btn fk-btn-info">
                            <i class="fas fa-chart-line"></i> Pilotage
                        </a>
                        <button class="fk-btn fk-btn-outline-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informations du dispositif -->
    <!-- Version simplifi√©e sans classes complexes -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations g√©n√©rales</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <small class="text-muted d-block">R√©f√©rence</small>
                        <strong class="fs-5">{{ dispositif.reference }}</strong>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <small class="text-muted d-block">Type</small>
                        <span class="badge bg-{{ 'success' if dispositif.type_dispositif == 'Pr√©ventif' else 'warning' if dispositif.type_dispositif == 'D√©tectif' else 'danger' }}">
                            {{ dispositif.type_dispositif or 'Non sp√©cifi√©' }}
                        </span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <small class="text-muted d-block">Efficacit√©</small>
                        <span class="badge bg-{{ 'success' if dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 4 else 'warning' if dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 3 else 'danger' }}">
                            {{ dispositif.efficacite_reelle or 'N/A' }}/5
                        </span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <small class="text-muted d-block">Couverture</small>
                        <span class="badge bg-{{ 'success' if dispositif.couverture and dispositif.couverture >= 4 else 'warning' if dispositif.couverture and dispositif.couverture >= 3 else 'danger' }}">
                            {{ dispositif.couverture or 'N/A' }}/5
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration du test avec 15 sc√©narios -->
    <div class="fk-card-modern animate-in">
        <div class="fk-card-header warning">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-sm">
                    <i class="fas fa-sliders-h"></i>
                </div>
                <h5 class="mb-0">S√©lectionnez un sc√©nario de stress (15 sc√©narios disponibles)</h5>
            </div>
        </div>
        <div class="fk-card-body">
            <form method="POST" action="{{ url_for('stress_test_dispositif', dispositif_id=dispositif.id) }}" id="stressForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="scenario-grid">
                    <!-- CAT√âGORIE 1: CYBER S√âCURIT√â -->
                    <div class="scenario-card">
                        <div class="scenario-header danger">
                            <i class="fas fa-shield-alt me-2"></i>Cybers√©curit√©
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="cyber_ransomware" {% if scenario == 'cyber_ransomware' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üí£ Ransomware</span>
                                        <div class="scenario-desc">Chiffrement des donn√©es, syst√®mes bloqu√©s 7 jours</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="cyber_ddos" {% if scenario == 'cyber_ddos' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üåê DDoS</span>
                                        <div class="scenario-desc">Indisponibilit√© r√©seau 48h, perte de connectivit√©</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="cyber_phishing" {% if scenario == 'cyber_phishing' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üé£ Phishing cibl√©</span>
                                        <div class="scenario-desc">Compromission comptes utilisateurs, fuite donn√©es</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="cyber_physique" {% if scenario == 'cyber_physique' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üîå Intrusion physique</span>
                                        <div class="scenario-desc">Acc√®s non autoris√© aux serveurs, sabotage</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- CAT√âGORIE 2: RESSOURCES HUMAINES -->
                    <div class="scenario-card">
                        <div class="scenario-header warning">
                            <i class="fas fa-users me-2"></i>Ressources Humaines
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="humain_gr√®ve" {% if scenario == 'humain_gr√®ve' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">‚ö° Gr√®ve g√©n√©rale</span>
                                        <div class="scenario-desc">80% du personnel absent pendant 2 semaines</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="humain_pand√©mie" {% if scenario == 'humain_pand√©mie' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">ü¶† Pand√©mie</span>
                                        <div class="scenario-desc">50% d'absent√©isme, t√©l√©travail impos√© 1 mois</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="humain_d√©part_masse" {% if scenario == 'humain_d√©part_masse' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üèÉ D√©parts simultan√©s</span>
                                        <div class="scenario-desc">Perte des comp√©tences cl√©s, passation impossible</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="humain_erreur" {% if scenario == 'humain_erreur' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">‚ùå Erreur humaine majeure</span>
                                        <div class="scenario-desc">Manipulation erron√©e, perte de donn√©es</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- CAT√âGORIE 3: TECHNIQUE & INFRASTRUCTURE -->
                    <div class="scenario-card">
                        <div class="scenario-header info">
                            <i class="fas fa-server me-2"></i>Technique & Infrastructure
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="tech_panne_elec" {% if scenario == 'tech_panne_elec' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">‚ö° Panne √©lectrique</span>
                                        <div class="scenario-desc">Coupure g√©n√©rale 72h, groupes √©lectrog√®nes HS</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="tech_incendie" {% if scenario == 'tech_incendie' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üî• Incendie</span>
                                        <div class="scenario-desc">Destruction partielle datacenter, perte mat√©rielle</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="tech_panne_reseau" {% if scenario == 'tech_panne_reseau' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üåç Panne r√©seau</span>
                                        <div class="scenario-desc">Fibre optique coup√©e, indisponibilit√© 48h</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="tech_obsolescence" {% if scenario == 'tech_obsolescence' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üìâ Obsolescence</span>
                                        <div class="scenario-desc">Mat√©riel non support√©, vuln√©rabilit√©s critiques</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- CAT√âGORIE 4: NATUREL & ENVIRONNEMENT -->
                    <div class="scenario-card">
                        <div class="scenario-header secondary">
                            <i class="fas fa-cloud-rain me-2"></i>Catastrophes naturelles
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="naturel_inondation" {% if scenario == 'naturel_inondation' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üåä Inondation</span>
                                        <div class="scenario-desc">Locaux inaccessibles 3 semaines, mat√©riel d√©truit</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="naturel_seisme" {% if scenario == 'naturel_seisme' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üèöÔ∏è S√©isme</span>
                                        <div class="scenario-desc">B√¢timent endommag√©, infrastructure instable</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="naturel_tempete" {% if scenario == 'naturel_tempete' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üå™Ô∏è Temp√™te</span>
                                        <div class="scenario-desc">D√©g√¢ts toiture, lignes √©lectriques coup√©es</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- CAT√âGORIE 5: FINANCIER & √âCONOMIQUE -->
                    <div class="scenario-card">
                        <div class="scenario-header success">
                            <i class="fas fa-chart-line me-2"></i>Financier & √âconomique
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="finance_crise" {% if scenario == 'finance_crise' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üìâ Crise financi√®re</span>
                                        <div class="scenario-desc">Budget r√©duit 50%, gel des investissements</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="finance_fournisseur" {% if scenario == 'finance_fournisseur' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üè≠ Faillite fournisseur</span>
                                        <div class="scenario-desc">Fournisseur critique en cessation d'activit√©</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="finance_fraude" {% if scenario == 'finance_fraude' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üí∞ Fraude interne</span>
                                        <div class="scenario-desc">D√©tournement de fonds, contr√¥les contourn√©s</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- CAT√âGORIE 6: R√âGLEMENTAIRE & L√âGAL -->
                    <div class="scenario-card">
                        <div class="scenario-header danger">
                            <i class="fas fa-gavel me-2"></i>R√©glementaire & L√©gal
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="legal_conformite" {% if scenario == 'legal_conformite' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üìú Nouvelle r√©glementation</span>
                                        <div class="scenario-desc">Mise en conformit√© urgente 30 jours</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="legal_contentieux" {% if scenario == 'legal_contentieux' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">‚öñÔ∏è Contentieux majeur</span>
                                        <div class="scenario-desc">Proc√®s, gel des activit√©s, saisie</div>
                                    </div>
                                </label>
                            </div>
                            <div class="scenario-option">
                                <label class="scenario-radio">
                                    <input type="radio" name="scenario" value="legal_audit" {% if scenario == 'legal_audit' %}checked{% endif %}>
                                    <div>
                                        <span class="scenario-label">üîç Audit surprise</span>
                                        <div class="scenario-desc">Contr√¥le inopin√©, sanctions potentielles</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="fk-btn fk-btn-warning btn-lg pulse">
                        <i class="fas fa-play me-2"></i>Lancer le stress test
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- R√©sultats du stress test -->
    {% if resultats %}
    <div class="fk-card-modern animate-in">
        <div class="fk-card-header" style="background: {{ resultats.couleur_rgb }}; color: white;">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-sm">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h5 class="mb-0">R√©sultats - {{ resultats.scenario }}</h5>
            </div>
        </div>
        <div class="fk-card-body">
            <!-- Description du sc√©nario -->
            <div class="fk-alert-modern info">
                <i class="fas fa-info-circle fa-lg"></i>
                <div>
                    <strong>Sc√©nario:</strong> {{ resultats.description_scenario }}<br>
                    <strong>Dur√©e estim√©e:</strong> {{ resultats.duree }}
                </div>
            </div>

            <!-- Indicateurs cl√©s -->
            <div class="result-kpi-grid">
                <div class="result-kpi-card">
                    <div class="result-kpi-value text-success">{{ "%.1f"|format(resultats.efficacite_normale) }}/5</div>
                    <div class="result-kpi-label">Efficacit√© normale</div>
                </div>
                <div class="result-kpi-card">
                    <div class="result-kpi-value text-{{ resultats.couleur }}">{{ resultats.efficacite_stress }}/5</div>
                    <div class="result-kpi-label">Sous stress</div>
                </div>
                <div class="result-kpi-card">
                    <div class="result-kpi-value text-warning">{{ "%.1f"|format(resultats.perte) }}%</div>
                    <div class="result-kpi-label">Perte d'efficacit√©</div>
                </div>
                <div class="result-kpi-card">
                    <div class="result-kpi-value text-info">{{ "%.2f"|format(resultats.facteur_global) }}</div>
                    <div class="result-kpi-label">Facteur de r√©sistance</div>
                </div>
            </div>

            <!-- Analyse d√©taill√©e -->
            <div class="row">
                <div class="col-md-6">
                    <div class="fk-card-modern mb-3" style="margin-bottom: 1rem;">
                        <div class="fk-card-header" style="background: #f8fafc;">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analyse de l'impact</h6>
                        </div>
                        <div class="fk-card-body">
                            <table class="fk-table-detail">
                                <tr>
                                    <th>Efficacit√© avant:</th>
                                    <td>{{ "%.1f"|format(resultats.efficacite_normale) }}/5</td>
                                    <td style="width: 40%;">
                                        <div class="progress-modern">
                                            <div class="progress-modern-bar success" style="width: {{ (resultats.efficacite_normale / 5) * 100 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Efficacit√© apr√®s:</th>
                                    <td>{{ resultats.efficacite_stress }}/5</td>
                                    <td>
                                        <div class="progress-modern">
                                            <div class="progress-modern-bar {% if resultats.efficacite_stress >= 4 %}success{% elif resultats.efficacite_stress >= 3 %}warning{% else %}danger{% endif %}" style="width: {{ (resultats.efficacite_stress / 5) * 100 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>R√©duction risque:</th>
                                    <td>{{ resultats.reduction_stress }}%</td>
                                    <td>
                                        <div class="progress-modern">
                                            <div class="progress-modern-bar primary" style="width: {{ resultats.reduction_stress }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="fk-card-modern mb-3" style="margin-bottom: 1rem;">
                        <div class="fk-card-header" style="background: #f8fafc;">
                            <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>√âvaluation de la r√©silience</h6>
                        </div>
                        <div class="fk-card-body">
                            <div class="fk-alert-modern {{ resultats.couleur }}">
                                <i class="fas {% if resultats.resilience == 'Excellente' %}fa-check-circle{% elif resultats.resilience == 'Bonne' %}fa-check-circle{% elif resultats.resilience == 'Moyenne' %}fa-exclamation-triangle{% else %}fa-times-circle{% endif %} fa-lg"></i>
                                <div>
                                    <h6 class="mb-1">{{ resultats.resilience }}</h6>
                                    <p class="mb-0 small">{{ resultats.conseil }}</p>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <strong>Risque r√©siduel estim√©:</strong>
                                <span class="badge-modern 
                                    {% if resultats.risque_residuel <= 2 %}badge-success
                                    {% elif resultats.risque_residuel <= 3 %}badge-warning
                                    {% else %}badge-danger{% endif %} ms-2">
                                    Niveau {{ resultats.risque_residuel }}/5
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommandations sp√©cifiques -->
            <div class="fk-card-modern">
                <div class="fk-card-header" style="background: #f8fafc;">
                    <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Plan d'action recommand√©</h6>
                </div>
                <div class="fk-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Actions imm√©diates:</h6>
                            <ul class="reco-list">
                                {% if resultats.perte > 50 %}
                                <li class="text-danger">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span>üî¥ Mettre en place une redondance imm√©diate</span>
                                </li>
                                <li class="text-danger">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span>üî¥ Cr√©er un plan de continuit√© d'activit√©</span>
                                </li>
                                <li class="text-danger">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span>üî¥ Former du personnel suppl√©mentaire</span>
                                </li>
                                {% elif resultats.perte > 30 %}
                                <li class="text-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>üü† Renforcer les proc√©dures de secours</span>
                                </li>
                                <li class="text-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>üü† Augmenter la fr√©quence des tests</span>
                                </li>
                                <li class="text-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>üü† Documenter les points de d√©faillance</span>
                                </li>
                                {% else %}
                                <li class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    <span>üü¢ Maintenir la surveillance normale</span>
                                </li>
                                <li class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    <span>üü¢ Planifier prochain test dans 6 mois</span>
                                </li>
                                <li class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    <span>üü¢ Partager les bonnes pratiques</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Recommandations strat√©giques:</h6>
                            <ul class="reco-list">
                                <li>
                                    <i class="fas fa-chart-line text-info"></i>
                                    <span>üìå √âvaluer le co√ªt des am√©liorations n√©cessaires</span>
                                </li>
                                <li>
                                    <i class="fas fa-file-alt text-info"></i>
                                    <span>üìå Int√©grer ce sc√©nario dans le PCA</span>
                                </li>
                                <li>
                                    <i class="fas fa-users text-info"></i>
                                    <span>üìå Sensibiliser les √©quipes concern√©es</span>
                                </li>
                                <li>
                                    <i class="fas fa-exclamation-triangle text-info"></i>
                                    <span>üìå R√©viser la criticit√© du dispositif</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Radar comparatif -->
    <div class="fk-card-modern animate-in">
        <div class="fk-card-header" style="background: #f8fafc;">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-sm" style="background: #334155;">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <h6 class="mb-0">Comparaison tous sc√©narios</h6>
            </div>
        </div>
        <div class="fk-card-body">
            <canvas id="chartStress" height="400"></canvas>
        </div>
    </div>
    {% endif %}
</div>

<!-- Token CSRF pour les requ√™tes AJAX -->
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block scripts %}
{% if resultats %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ============================================
// GRAPHIQUE RADAR - STRESS TEST
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page stress test charg√©e');
    
    const ctx = document.getElementById('chartStress');
    if (!ctx) return;
    
    // R√©cup√©rer tous les sc√©narios de stress test
    const stressTests = {{ dispositif.stress_test_avance()|tojson }};
    
    // Organiser les donn√©es pour le radar
    const labels = [];
    const data = [];
    const colors = [];
    
    // Sc√©narios par ordre logique
    const orderedTests = [
        'cyber_ransomware', 'cyber_ddos', 'cyber_phishing', 'cyber_physique',
        'humain_gr√®ve', 'humain_pand√©mie', 'humain_d√©part_masse', 'humain_erreur',
        'tech_panne_elec', 'tech_incendie', 'tech_panne_reseau', 'tech_obsolescence',
        'naturel_inondation', 'naturel_seisme', 'naturel_tempete',
        'finance_crise', 'finance_fournisseur', 'finance_fraude',
        'legal_conformite', 'legal_contentieux', 'legal_audit'
    ];
    
    orderedTests.forEach(key => {
        if (stressTests[key]) {
            const test = stressTests[key];
            // Extraire le nom court du sc√©nario
            let shortName = '';
            if (key.includes('cyber')) shortName = 'üíª ' + key.split('_')[1];
            else if (key.includes('humain')) shortName = 'üë• ' + key.split('_')[1];
            else if (key.includes('tech')) shortName = 'üîß ' + key.split('_')[1];
            else if (key.includes('naturel')) shortName = 'üåç ' + key.split('_')[1];
            else if (key.includes('finance')) shortName = 'üí∞ ' + key.split('_')[1];
            else if (key.includes('legal')) shortName = '‚öñÔ∏è ' + key.split('_')[1];
            else shortName = test.scenario.substring(0, 10);
            
            labels.push(shortName);
            data.push(test.efficacite);
            
            if (test.efficacite >= 4) colors.push('#0D9488');
            else if (test.efficacite >= 3) colors.push('#F59E0B');
            else if (test.efficacite >= 2) colors.push('#F97316');
            else colors.push('#DC2626');
        }
    });
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Efficacit√© sous stress',
                data: data,
                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                borderColor: '#F59E0B',
                borderWidth: 2,
                pointBackgroundColor: colors,
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#F59E0B',
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return value + '/5';
                        },
                        color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#94a3b8' : '#64748b'
                    },
                    grid: {
                        color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#334155' : '#e2e8f0'
                    },
                    pointLabels: {
                        color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#f1f5f9' : '#0f172a',
                        font: {
                            size: 11
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Efficacit√©: ${context.raw}/5`;
                        }
                    }
                }
            }
        }
    });
    
    // Mise √† jour des couleurs si changement de th√®me
    const themeObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'data-bs-theme') {
                location.reload();
            }
        });
    });
    
    themeObserver.observe(document.documentElement, { attributes: true });
});

// ============================================
// FONCTIONS UTILITAIRES
// ============================================
function imprimerPage() {
    window.print();
}

// Fonction de test pour la console
window.testStress = function() {
    console.log('‚ö° Donn√©es stress test:');
    console.log('Dispositif:', {{ dispositif.id }});
    console.log('Efficacit√©:', {{ dispositif.efficacite_reelle or 0 }});
    console.log('Couverture:', {{ dispositif.couverture or 0 }});
};
</script>
{% endif %}
{% endblock %}
