{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-bolt text-warning"></i> 
            Stress Test Avanc√© - {{ dispositif.reference }}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
            <a href="{{ url_for('benchmark_dispositifs') }}" class="btn btn-info me-2">
                <i class="fas fa-chart-line"></i> Pilotage
            </a>
            <button class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Imprimer
            </button>
        </div>
    </div>

    <!-- Informations du dispositif -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Dispositif test√©</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <strong>R√©f√©rence:</strong><br>
                            {{ dispositif.reference }}
                        </div>
                        <div class="col-md-3">
                            <strong>Nom:</strong><br>
                            {{ dispositif.nom }}
                        </div>
                        <div class="col-md-2">
                            <strong>Type:</strong><br>
                            <span class="badge bg-{{ 'success' if dispositif.type_dispositif == 'Pr√©ventif' else 'warning' if dispositif.type_dispositif == 'D√©tectif' else 'info' }}">
                                {{ dispositif.type_dispositif }}
                            </span>
                        </div>
                        <div class="col-md-2">
                            <strong>Nature:</strong><br>
                            {{ dispositif.nature or 'Non sp√©cifi√©e' }}
                        </div>
                        <div class="col-md-1">
                            <strong>Efficacit√©:</strong><br>
                            <span class="badge bg-success">{{ dispositif.efficacite_reelle or 'N/A' }}/5</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Couverture:</strong><br>
                            <span class="badge bg-info">{{ dispositif.couverture or 'N/A' }}/5</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration du test avec 15 sc√©narios -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-warning">
                    <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>S√©lectionnez un sc√©nario de stress (15 sc√©narios disponibles)</h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('stress_test_dispositif', dispositif_id=dispositif.id) }}" id="stressForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="row">
                            <!-- CAT√âGORIE 1: CYBER S√âCURIT√â -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <i class="fas fa-shield-alt me-2"></i>Cybers√©curit√©
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="cyber1" value="cyber_ransomware" {% if scenario == 'cyber_ransomware' %}checked{% endif %}>
                                            <label class="form-check-label" for="cyber1">
                                                <strong>üí£ Ransomware</strong><br>
                                                <small>Chiffrement des donn√©es, syst√®mes bloqu√©s 7 jours</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="cyber2" value="cyber_ddos" {% if scenario == 'cyber_ddos' %}checked{% endif %}>
                                            <label class="form-check-label" for="cyber2">
                                                <strong>üåê DDoS</strong><br>
                                                <small>Indisponibilit√© r√©seau 48h, perte de connectivit√©</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="cyber3" value="cyber_phishing" {% if scenario == 'cyber_phishing' %}checked{% endif %}>
                                            <label class="form-check-label" for="cyber3">
                                                <strong>üé£ Phishing cibl√©</strong><br>
                                                <small>Compromission comptes utilisateurs, fuite donn√©es</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="cyber4" value="cyber_physique" {% if scenario == 'cyber_physique' %}checked{% endif %}>
                                            <label class="form-check-label" for="cyber4">
                                                <strong>üîå Intrusion physique</strong><br>
                                                <small>Acc√®s non autoris√© aux serveurs, sabotage</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CAT√âGORIE 2: RESSOURCES HUMAINES -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-warning">
                                    <div class="card-header bg-warning">
                                        <i class="fas fa-users me-2"></i>Ressources Humaines
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="humain1" value="humain_gr√®ve" {% if scenario == 'humain_gr√®ve' %}checked{% endif %}>
                                            <label class="form-check-label" for="humain1">
                                                <strong>‚ö° Gr√®ve g√©n√©rale</strong><br>
                                                <small>80% du personnel absent pendant 2 semaines</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="humain2" value="humain_pand√©mie" {% if scenario == 'humain_pand√©mie' %}checked{% endif %}>
                                            <label class="form-check-label" for="humain2">
                                                <strong>ü¶† Pand√©mie</strong><br>
                                                <small>50% d'absent√©isme, t√©l√©travail impos√© 1 mois</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="humain3" value="humain_d√©part_masse" {% if scenario == 'humain_d√©part_masse' %}checked{% endif %}>
                                            <label class="form-check-label" for="humain3">
                                                <strong>üèÉ D√©parts simultan√©s</strong><br>
                                                <small>Perte des comp√©tences cl√©s, passation impossible</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="humain4" value="humain_erreur" {% if scenario == 'humain_erreur' %}checked{% endif %}>
                                            <label class="form-check-label" for="humain4">
                                                <strong>‚ùå Erreur humaine majeure</strong><br>
                                                <small>Manipulation erron√©e, perte de donn√©es</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CAT√âGORIE 3: TECHNIQUE & INFRASTRUCTURE -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-server me-2"></i>Technique & Infrastructure
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="tech1" value="tech_panne_elec" {% if scenario == 'tech_panne_elec' %}checked{% endif %}>
                                            <label class="form-check-label" for="tech1">
                                                <strong>‚ö° Panne √©lectrique</strong><br>
                                                <small>Coupure g√©n√©rale 72h, groupes √©lectrog√®nes HS</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="tech2" value="tech_incendie" {% if scenario == 'tech_incendie' %}checked{% endif %}>
                                            <label class="form-check-label" for="tech2">
                                                <strong>üî• Incendie</strong><br>
                                                <small>Destruction partielle datacenter, perte mat√©rielle</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="tech3" value="tech_panne_reseau" {% if scenario == 'tech_panne_reseau' %}checked{% endif %}>
                                            <label class="form-check-label" for="tech3">
                                                <strong>üåç Panne r√©seau</strong><br>
                                                <small>Fibre optique coup√©e, indisponibilit√© 48h</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="tech4" value="tech_obsolescence" {% if scenario == 'tech_obsolescence' %}checked{% endif %}>
                                            <label class="form-check-label" for="tech4">
                                                <strong>üìâ Obsolescence</strong><br>
                                                <small>Mat√©riel non support√©, vuln√©rabilit√©s critiques</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- CAT√âGORIE 4: NATUREL & ENVIRONNEMENT -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <i class="fas fa-cloud-rain me-2"></i>Catastrophes naturelles
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="naturel1" value="naturel_inondation" {% if scenario == 'naturel_inondation' %}checked{% endif %}>
                                            <label class="form-check-label" for="naturel1">
                                                <strong>üåä Inondation</strong><br>
                                                <small>Locaux inaccessibles 3 semaines, mat√©riel d√©truit</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="naturel2" value="naturel_seisme" {% if scenario == 'naturel_seisme' %}checked{% endif %}>
                                            <label class="form-check-label" for="naturel2">
                                                <strong>üèöÔ∏è S√©isme</strong><br>
                                                <small>B√¢timent endommag√©, infrastructure instable</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="naturel3" value="naturel_tempete" {% if scenario == 'naturel_tempete' %}checked{% endif %}>
                                            <label class="form-check-label" for="naturel3">
                                                <strong>üå™Ô∏è Temp√™te</strong><br>
                                                <small>D√©g√¢ts toiture, lignes √©lectriques coup√©es</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CAT√âGORIE 5: FINANCIER & √âCONOMIQUE -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-success">
                                    <div class="card-header bg-success text-white">
                                        <i class="fas fa-chart-line me-2"></i>Financier & √âconomique
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="finance1" value="finance_crise" {% if scenario == 'finance_crise' %}checked{% endif %}>
                                            <label class="form-check-label" for="finance1">
                                                <strong>üìâ Crise financi√®re</strong><br>
                                                <small>Budget r√©duit 50%, gel des investissements</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="finance2" value="finance_fournisseur" {% if scenario == 'finance_fournisseur' %}checked{% endif %}>
                                            <label class="form-check-label" for="finance2">
                                                <strong>üè≠ Faillite fournisseur</strong><br>
                                                <small>Fournisseur critique en cessation d'activit√©</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="finance3" value="finance_fraude" {% if scenario == 'finance_fraude' %}checked{% endif %}>
                                            <label class="form-check-label" for="finance3">
                                                <strong>üí∞ Fraude interne</strong><br>
                                                <small>D√©tournement de fonds, contr√¥les contourn√©s</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CAT√âGORIE 6: R√âGLEMENTAIRE & L√âGAL -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <i class="fas fa-gavel me-2"></i>R√©glementaire & L√©gal
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="legal1" value="legal_conformite" {% if scenario == 'legal_conformite' %}checked{% endif %}>
                                            <label class="form-check-label" for="legal1">
                                                <strong>üìú Nouvelle r√©glementation</strong><br>
                                                <small>Mise en conformit√© urgente 30 jours</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="legal2" value="legal_contentieux" {% if scenario == 'legal_contentieux' %}checked{% endif %}>
                                            <label class="form-check-label" for="legal2">
                                                <strong>‚öñÔ∏è Contentieux majeur</strong><br>
                                                <small>Proc√®s, gel des activit√©s, saisie</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scenario" id="legal3" value="legal_audit" {% if scenario == 'legal_audit' %}checked{% endif %}>
                                            <label class="form-check-label" for="legal3">
                                                <strong>üîç Audit surprise</strong><br>
                                                <small>Contr√¥le inopin√©, sanctions potentielles</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="fas fa-play me-2"></i>Lancer le stress test
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- R√©sultats du stress test -->
    {% if resultats %}
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow mb-4">
                <div class="card-header bg-{{ resultats.couleur }} text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>R√©sultats - {{ resultats.scenario }}</h6>
                </div>
                <div class="card-body">
                    <!-- Description du sc√©nario -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Sc√©nario:</strong> {{ resultats.description_scenario }}<br>
                        <i class="fas fa-clock me-2"></i>
                        <strong>Dur√©e estim√©e:</strong> {{ resultats.duree }}
                    </div>

                    <!-- Indicateurs cl√©s -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h1 class="text-success">{{ "%.1f"|format(resultats.efficacite_normale) }}/5</h1>
                                    <small>Efficacit√© normale</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h1 class="text-{{ resultats.couleur }}">{{ resultats.efficacite_stress }}/5</h1>
                                    <small>Sous stress</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h1 class="text-warning">{{ "%.1f"|format(resultats.perte) }}%</h1>
                                    <small>Perte d'efficacit√©</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h1 class="text-info">{{ "%.2f"|format(resultats.facteur_global) }}</h1>
                                    <small>Facteur de r√©sistance</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analyse d√©taill√©e -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">üìä Analyse de l'impact</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Efficacit√© avant:</th>
                                            <td>{{ "%.1f"|format(resultats.efficacite_normale) }}/5</td>
                                            <td>
                                                <div class="progress">
                                                    <div class="progress-bar bg-success" style="width: {{ (resultats.efficacite_normale / 5) * 100 }}%"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Efficacit√© apr√®s:</th>
                                            <td>{{ resultats.efficacite_stress }}/5</td>
                                            <td>
                                                <div class="progress">
                                                    <div class="progress-bar bg-{{ resultats.couleur }}" style="width: {{ (resultats.efficacite_stress / 5) * 100 }}%"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>R√©duction risque:</th>
                                            <td>{{ resultats.reduction_stress }}%</td>
                                            <td>
                                                <div class="progress">
                                                    <div class="progress-bar bg-info" style="width: {{ resultats.reduction_stress }}%"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">üõ°Ô∏è √âvaluation de la r√©silience</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-{{ resultats.couleur }}">
                                        <h5>{{ resultats.resilience }}</h5>
                                        <p>{{ resultats.conseil }}</p>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <strong>Risque r√©siduel estim√©:</strong>
                                        <span class="badge bg-{{ 'success' if resultats.risque_residuel <= 2 else 'warning' if resultats.risque_residuel <= 3 else 'danger' }}">
                                            Niveau {{ resultats.risque_residuel }}/5
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommandations sp√©cifiques -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Plan d'action recommand√©</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Actions imm√©diates:</h6>
                                    <ul>
                                        {% if resultats.perte > 50 %}
                                        <li class="text-danger">üî¥ Mettre en place une redondance imm√©diate</li>
                                        <li class="text-danger">üî¥ Cr√©er un plan de continuit√© d'activit√©</li>
                                        <li class="text-danger">üî¥ Former du personnel suppl√©mentaire</li>
                                        {% elif resultats.perte > 30 %}
                                        <li class="text-warning">üü† Renforcer les proc√©dures de secours</li>
                                        <li class="text-warning">üü† Augmenter la fr√©quence des tests</li>
                                        <li class="text-warning">üü† Documenter les points de d√©faillance</li>
                                        {% else %}
                                        <li class="text-success">üü¢ Maintenir la surveillance normale</li>
                                        <li class="text-success">üü¢ Planifier prochain test dans 6 mois</li>
                                        <li class="text-success">üü¢ Partager les bonnes pratiques</li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Recommandations strat√©giques:</h6>
                                    <ul>
                                        <li>üìå √âvaluer le co√ªt des am√©liorations n√©cessaires</li>
                                        <li>üìå Int√©grer ce sc√©nario dans le PCA</li>
                                        <li>üìå Sensibiliser les √©quipes concern√©es</li>
                                        <li>üìå R√©viser la criticit√© du dispositif</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Radar comparatif -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Comparaison tous sc√©narios</h6>
                </div>
                <div class="card-body">
                    <canvas id="chartStress" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if resultats %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('chartStress').getContext('2d');
    
    // R√©cup√©rer tous les sc√©narios de stress test
    const stressTests = {{ dispositif.stress_test_avance()|tojson }};
    
    // Organiser par cat√©gorie pour le radar
    const categories = {
        'Cybers√©curit√©': ['üíª Ransomware', 'üåê DDoS', 'üé£ Phishing', 'üîå Intrusion'],
        'Ressources Humaines': ['‚ö° Gr√®ve', 'ü¶† Pand√©mie', 'üèÉ D√©parts', '‚ùå Erreur'],
        'Technique': ['‚ö° Panne √©lec', 'üî• Incendie', 'üåç R√©seau', 'üìâ Obsolescence'],
        'Naturel': ['üåä Inondation', 'üèöÔ∏è S√©isme', 'üå™Ô∏è Temp√™te'],
        'Financier': ['üìâ Crise', 'üè≠ Fournisseur', 'üí∞ Fraude'],
        'R√©glementaire': ['üìú Conformit√©', '‚öñÔ∏è Contentieux', 'üîç Audit']
    };
    
    const labels = [];
    const data = [];
    const colors = [];
    
    for (const [key, test] of Object.entries(stressTests)) {
        labels.push(test.scenario.split(' ')[1] || test.scenario);
        data.push(test.efficacite);
        
        if (test.efficacite >= 4) colors.push('#28a745');
        else if (test.efficacite >= 3) colors.push('#ffc107');
        else if (test.efficacite >= 2) colors.push('#fd7e14');
        else colors.push('#dc3545');
    }
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Efficacit√© sous stress',
                data: data,
                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                borderColor: '#ffc107',
                pointBackgroundColor: colors,
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#ffc107',
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return value + '/5';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Efficacit√©: ${context.raw}/5`;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}
