{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       STYLES SP√âCIFIQUES - √âVALUATION DISPOSITIF
       HARMONIS√â AVEC DETAIL_RISQUE.HTML
       ============================================ */
    
    /* Variables de base */
    :root {
        --fk-navy: #0A1929;
        --fk-blue: #1A3C6B;
        --fk-accent: #0066CC;
        --fk-light-blue: #3B82F6;
        --fk-steel: #334155;
        --fk-platinum: #F8FAFC;
        --fk-success: #0D9488;
        --fk-warning: #F59E0B;
        --fk-error: #DC2626;
        --fk-gold: #D4AF37;
        
        --primary-gradient: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        --accent-gradient: linear-gradient(135deg, #0066CC 0%, #3B82F6 100%);
        
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
        --shadow-hard: 0 12px 50px rgba(0, 0, 0, 0.2);
        
        --radius-lg: 20px;
        --radius-md: 12px;
        --radius-sm: 8px;
        
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Variables s√©mantiques - mode clair */
    body {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #334155;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --card-bg: #ffffff;
        --hover-bg: #f1f5f9;
    }

    /* Mode sombre */
    [data-bs-theme="dark"] body {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #334155;
        --card-bg: #1e293b;
        --hover-bg: #334155;
    }

    /* Conteneur principal */
    .detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* En-t√™te de page */
    .page-header {
        background: var(--primary-gradient);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: rotate(25deg);
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: rotate(-15deg);
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        color: white;
    }

    .page-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Boutons dans l'en-t√™te */
    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Boutons modernes */
    .fk-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-smooth);
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
    }

    .fk-btn-primary {
        background: var(--accent-gradient);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .fk-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
    }

    .fk-btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .fk-btn-secondary:hover {
        background: var(--hover-bg);
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
    }

    .fk-btn-success {
        background: linear-gradient(135deg, var(--fk-success), #0f766e);
        color: white;
    }

    .fk-btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(13, 148, 136, 0.4);
    }

    .fk-btn-warning {
        background: linear-gradient(135deg, var(--fk-warning), #d97706);
        color: white;
    }

    .fk-btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
    }

    .fk-btn-info {
        background: linear-gradient(135deg, var(--fk-accent), var(--fk-light-blue));
        color: white;
    }

    .fk-btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
    }

    .fk-btn-outline {
        background: transparent;
        border: 2px solid var(--border-color);
        color: var(--text-primary);
    }

    .fk-btn-outline:hover {
        border-color: var(--fk-accent);
        color: var(--fk-accent);
        background: var(--hover-bg);
    }

    /* Cartes */
    .fk-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
        transition: var(--transition-smooth);
    }

    .fk-card:hover {
        box-shadow: var(--shadow-medium);
    }

    .fk-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .fk-card-header.warning {
        background: linear-gradient(135deg, var(--fk-warning), #d97706);
        color: white;
    }

    .fk-card-header.info {
        background: linear-gradient(135deg, var(--fk-accent), var(--fk-light-blue));
        color: white;
    }

    .fk-card-header.light {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .fk-card-header h6 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .fk-card-header h6 i {
        color: inherit;
    }

    .fk-card-body {
        padding: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    /* Alertes */
    .fk-alert {
        border-radius: var(--radius-md);
        padding: 1rem 1.25rem;
        border: none;
        border-left: 4px solid;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .fk-alert.info {
        border-left-color: var(--fk-accent);
        background: rgba(0, 102, 204, 0.1);
    }

    .fk-alert.warning {
        border-left-color: var(--fk-warning);
        background: rgba(245, 158, 11, 0.1);
    }

    .fk-alert.success {
        border-left-color: var(--fk-success);
        background: rgba(13, 148, 136, 0.1);
    }

    .fk-alert.light {
        border-left-color: var(--border-color);
        background: var(--bg-tertiary);
    }

    /* Badges */
    .badge-modern {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid transparent;
    }

    .badge-success {
        background: var(--fk-success);
        color: white;
    }

    .badge-warning {
        background: var(--fk-warning);
        color: white;
    }

    .badge-danger {
        background: var(--fk-error);
        color: white;
    }

    .badge-info {
        background: var(--fk-accent);
        color: white;
    }

    .badge-secondary {
        background: var(--text-muted);
        color: white;
    }

    /* Barres de progression */
    .progress-modern {
        background: var(--border-color);
        border-radius: 50px;
        height: 10px;
        overflow: hidden;
        width: 100%;
    }

    .progress-modern-bar {
        height: 100%;
        border-radius: 50px;
        transition: width 0.3s ease;
    }

    .progress-modern-bar.success { background: var(--fk-success); }
    .progress-modern-bar.warning { background: var(--fk-warning); }
    .progress-modern-bar.danger { background: var(--fk-error); }
    .progress-modern-bar.info { background: var(--fk-accent); }

    /* Cartes de s√©lection d'√©valuation */
    .evaluation-card {
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--card-bg);
        transition: var(--transition-smooth);
        cursor: pointer;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .evaluation-card:hover {
        border-color: var(--fk-accent);
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
    }

    .evaluation-card.selected {
        border-color: var(--fk-accent);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.25);
    }

    .evaluation-card.below-target {
        border-color: var(--fk-error);
        background: rgba(220, 38, 38, 0.05);
    }

    .evaluation-card .card-body {
        padding: 1.25rem;
        text-align: center;
    }

    .evaluation-value {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.8rem;
        margin: 0 auto 1rem auto;
    }

    .evaluation-value.success { background: var(--fk-success); color: white; }
    .evaluation-value.warning { background: var(--fk-warning); color: white; }
    .evaluation-value.danger { background: var(--fk-error); color: white; }

    .evaluation-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .evaluation-desc {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    /* Guide d'√©valuation */
    .guide-list {
        list-style: none;
        padding: 0;
    }

    .guide-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .guide-item:last-child {
        border-bottom: none;
    }

    .guide-badge {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
        flex-shrink: 0;
    }

    .guide-badge.success { background: var(--fk-success); color: white; }
    .guide-badge.warning { background: var(--fk-warning); color: white; }
    .guide-badge.danger { background: var(--fk-error); color: white; }

    .guide-text {
        font-size: 0.85rem;
        color: var(--text-primary);
    }

    /* Historique */
    .historique-item {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        transition: var(--transition-smooth);
    }

    .historique-item:hover {
        background: var(--hover-bg);
    }

    .historique-item:last-child {
        border-bottom: none;
    }

    .historique-date {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .historique-type {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Formulaires */
    .fk-form-label {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .fk-form-control {
        width: 100%;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        transition: var(--transition-smooth);
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .fk-form-control:focus {
        border-color: var(--fk-accent);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        outline: none;
    }

    .fk-form-control.is-invalid {
        border-color: var(--fk-error);
    }

    .invalid-feedback {
        color: var(--fk-error);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    .form-text {
        color: var(--text-muted);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    /* Checkbox personnalis√© */
    .fk-form-check {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .fk-form-check input[type="checkbox"] {
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
        accent-color: var(--fk-accent);
    }

    /* √âtats vides */
    .empty-state {
        text-align: center;
        padding: 2rem;
    }

    .empty-icon {
        font-size: 2.5rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .empty-description {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: slideIn 0.5s ease forwards;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .detail-container {
            padding: 1rem;
        }

        .page-header {
            padding: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .header-actions .fk-btn {
            width: 100%;
            justify-content: center;
        }

        .row > [class*="col-"] {
            margin-bottom: 1rem;
        }

        .evaluation-value {
            width: 45px;
            height: 45px;
            font-size: 1.4rem;
        }
    }
</style>

<div class="detail-container">
    <!-- En-t√™te de page -->
    <div class="page-header animate-in">
        <div class="page-header-content">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb" style="background: transparent; margin-bottom: 0.5rem;">
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_cartographies') }}" style="color: rgba(255,255,255,0.8);">Cartographies</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_cartographie', id=dispositif.risque.cartographie_id) }}" style="color: rgba(255,255,255,0.8);">{{ dispositif.risque.cartographie.nom }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_risque', id=dispositif.risque_id) }}" style="color: rgba(255,255,255,0.8);">{{ dispositif.risque.reference }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_dispositifs_risque', risque_id=dispositif.risque_id) }}" style="color: rgba(255,255,255,0.8);">Dispositifs</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" style="color: rgba(255,255,255,0.8);">{{ dispositif.reference }}</a></li>
                            <li class="breadcrumb-item active" style="color: white;">√âvaluation</li>
                        </ol>
                    </nav>
                    
                    <h1 class="page-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        √âvaluer le dispositif
                    </h1>
                    <p class="page-subtitle">{{ dispositif.reference }} - {{ dispositif.nom }}</p>
                </div>
                
                <div class="col-auto">
                    <div class="header-actions">
                        <a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" class="fk-btn fk-btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Retour
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne principale - Formulaire -->
        <div class="col-md-8">
            <div class="fk-card animate-in">
                <div class="fk-card-header warning">
                    <h6 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>√âvaluation du dispositif
                    </h6>
                </div>
                <div class="fk-card-body">
                    <!-- Informations du dispositif -->
                    <div class="fk-alert info mb-4">
                        <i class="fas fa-shield-alt fa-2x me-3"></i>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1">{{ dispositif.reference }} - {{ dispositif.nom }}</h6>
                            <p class="mb-1 small">{{ dispositif.description|truncate(200) if dispositif.description else 'Aucune description' }}</p>
                            <div class="d-flex align-items-center gap-2 mt-2">
                                <span class="badge-modern {% if dispositif.type_dispositif == 'Pr√©ventif' %}badge-success
                                                        {% elif dispositif.type_dispositif == 'D√©tectif' %}badge-warning
                                                        {% elif dispositif.type_dispositif == 'Correctif' %}badge-danger
                                                        {% else %}badge-secondary{% endif %}">
                                    {{ dispositif.type_dispositif }}
                                </span>
                                <small class="text-muted">{{ dispositif.nature }} - {{ dispositif.frequence }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- √âvaluation actuelle -->
                    {% if dispositif.efficacite_reelle %}
                    <div class="fk-alert light mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-2">√âvaluation actuelle :</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <strong>Efficacit√© r√©elle :</strong>
                                        <span class="badge-modern {% if dispositif.efficacite_reelle >= 4 %}badge-success
                                                                  {% elif dispositif.efficacite_reelle >= 3 %}badge-warning
                                                                  {% else %}badge-danger{% endif %}">
                                            {{ dispositif.efficacite_reelle }}/5
                                        </span>
                                    </div>
                                    <div class="progress-modern">
                                        <div class="progress-modern-bar {% if dispositif.efficacite_reelle >= 4 %}success
                                                                         {% elif dispositif.efficacite_reelle >= 3 %}warning
                                                                         {% else %}danger{% endif %}"
                                             style="width: {{ (dispositif.efficacite_reelle / 5) * 100 }}%">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <strong>Couverture :</strong>
                                        <span class="badge-modern {% if dispositif.couverture >= 4 %}badge-success
                                                                   {% elif dispositif.couverture >= 3 %}badge-warning
                                                                   {% else %}badge-danger{% endif %}">
                                            {{ dispositif.couverture }}/5
                                        </span>
                                    </div>
                                    <div class="progress-modern">
                                        <div class="progress-modern-bar {% if dispositif.couverture >= 4 %}success
                                                                         {% elif dispositif.couverture >= 3 %}warning
                                                                         {% else %}danger{% endif %}"
                                             style="width: {{ (dispositif.couverture / 5) * 100 }}%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if dispositif.efficacite_attendue %}
                            <div class="mt-2">
                                <strong>Efficacit√© attendue :</strong> {{ dispositif.efficacite_attendue }}/5
                                {% set ecart = dispositif.efficacite_attendue - dispositif.efficacite_reelle %}
                                {% if ecart > 0 %}
                                <span class="badge-modern badge-danger ms-2">-{{ ecart }} points</span>
                                {% elif ecart < 0 %}
                                <span class="badge-modern badge-success ms-2">+{{ -ecart }} points</span>
                                {% else %}
                                <span class="badge-modern badge-success ms-2">Objectif atteint</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Formulaire d'√©valuation -->
                    <form method="POST" id="evaluationForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Efficacit√© r√©elle -->
                        <div class="mb-4">
                            <div class="fk-form-label">
                                <i class="fas fa-star text-warning"></i>
                                {{ form.efficacite_reelle.label }}
                                {% if dispositif.efficacite_attendue %}
                                <span class="badge-modern badge-info ms-2">Objectif : {{ dispositif.efficacite_attendue }}/5</span>
                                {% endif %}
                            </div>
                            
                            <div class="row g-3">
                                {% for value, label in form.efficacite_reelle.choices %}
                                {% if value > 0 %}
                                {% set label_parts = label.split(' - ') %}
                                <div class="col-4 col-md-2">
                                    <div class="evaluation-card {% if value == form.efficacite_reelle.data %}selected{% endif %}
                                                                {% if dispositif.efficacite_attendue and value < dispositif.efficacite_attendue %}below-target{% endif %}">
                                        <label class="card-body" style="cursor: pointer;">
                                            <input type="radio" name="efficacite_reelle" value="{{ value }}" 
                                                   class="d-none" 
                                                   {% if value == form.efficacite_reelle.data %}checked{% endif %}>
                                            <div class="evaluation-value {% if value >= 4 %}success
                                                                        {% elif value >= 3 %}warning
                                                                        {% else %}danger{% endif %}">
                                                {{ value }}
                                            </div>
                                            <div class="evaluation-label">{{ label_parts[0]|trim }}</div>
                                            <div class="evaluation-desc">{{ label_parts[1] if label_parts|length > 1 else '' }}</div>
                                        </label>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            
                            <div class="form-text mt-3">
                                <i class="fas fa-info-circle me-1"></i> 
                                √âvaluez l'efficacit√© r√©elle du dispositif dans la ma√Ætrise du risque
                            </div>
                            
                            {% if form.efficacite_reelle.errors %}
                            <div class="invalid-feedback d-block mt-2">
                                {% for error in form.efficacite_reelle.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Couverture -->
                        <div class="mb-4">
                            <div class="fk-form-label">
                                <i class="fas fa-expand-arrows-alt text-info"></i>
                                {{ form.couverture.label }}
                            </div>
                            
                            <div class="row g-3">
                                {% for value, label in form.couverture.choices %}
                                {% if value > 0 %}
                                {% set label_parts = label.split(' - ') %}
                                <div class="col-4 col-md-2">
                                    <div class="evaluation-card {% if value == form.couverture.data %}selected{% endif %}">
                                        <label class="card-body" style="cursor: pointer;">
                                            <input type="radio" name="couverture" value="{{ value }}" 
                                                   class="d-none" 
                                                   {% if value == form.couverture.data %}checked{% endif %}>
                                            <div class="evaluation-value {% if value >= 4 %}success
                                                                        {% elif value >= 3 %}warning
                                                                        {% else %}danger{% endif %}">
                                                {{ value }}
                                            </div>
                                            <div class="evaluation-label">{{ label_parts[0]|trim }}</div>
                                            <div class="evaluation-desc">{{ label_parts[1] if label_parts|length > 1 else '' }}</div>
                                        </label>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            
                            <div class="form-text mt-3">
                                <i class="fas fa-info-circle me-1"></i> 
                                √âvaluez la couverture du dispositif (√©tendue, p√©rim√®tre, fr√©quence)
                            </div>
                            
                            {% if form.couverture.errors %}
                            <div class="invalid-feedback d-block mt-2">
                                {% for error in form.couverture.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Prochaine v√©rification -->
                        <div class="mb-4">
                            <div class="fk-form-label">
                                <i class="fas fa-calendar-alt text-info"></i>
                                {{ form.prochaine_verification.label }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.prochaine_verification(class="fk-form-control", type="date") }}
                                </div>
                                <div class="col-md-6">
                                    <div class="fk-alert light p-3">
                                        <small>
                                            <i class="fas fa-calendar-check me-1"></i>
                                            {% if dispositif.date_derniere_verification %}
                                            Derni√®re v√©rification : {{ dispositif.date_derniere_verification.strftime('%d/%m/%Y') }}
                                            {% else %}
                                            Aucune v√©rification ant√©rieure
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i> 
                                Planifiez la prochaine v√©rification du dispositif
                            </div>
                            
                            {% if form.prochaine_verification.errors %}
                            <div class="invalid-feedback d-block mt-2">
                                {% for error in form.prochaine_verification.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Commentaire -->
                        <div class="mb-4">
                            <div class="fk-form-label">
                                <i class="fas fa-comment text-info"></i>
                                {{ form.commentaire.label }}
                            </div>
                            
                            {{ form.commentaire(class="fk-form-control", rows="4", 
                                              placeholder="D√©crivez les observations, les points forts, les √©carts constat√©s, les √©l√©ments probants...") }}
                            
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i> 
                                Documentez les √©l√©ments d'appr√©ciation de l'√©valuation
                            </div>
                            
                            {% if form.commentaire.errors %}
                            <div class="invalid-feedback d-block mt-2">
                                {% for error in form.commentaire.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Analyse d'impact -->
                        {% if dispositif.efficacite_attendue and form.efficacite_reelle.data and form.efficacite_reelle.data > 0 %}
                        <div class="fk-card mb-4" id="impactAnalysis">
                            <div class="fk-card-header light">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Analyse d'impact
                                </h6>
                            </div>
                            <div class="fk-card-body">
                                {% set ecart = dispositif.efficacite_attendue - form.efficacite_reelle.data %}
                                {% if ecart > 0 %}
                                <div class="fk-alert warning">
                                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                    <div>
                                        <h6 class="fw-bold">Dispositif sous-performant</h6>
                                        <p class="mb-1">
                                            L'efficacit√© r√©elle ({{ form.efficacite_reelle.data }}/5) est inf√©rieure √† l'efficacit√© attendue ({{ dispositif.efficacite_attendue }}/5).
                                        </p>
                                        <small>√âcart : -{{ ecart }} point(s)</small>
                                    </div>
                                </div>
                                
                                <div class="fk-form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="creerPlanAction">
                                    <label class="form-check-label fw-bold" for="creerPlanAction">
                                        Cr√©er automatiquement un plan d'action d'am√©lioration
                                    </label>
                                </div>
                                <small class="form-text d-block">
                                    Un plan d'action sera cr√©√© avec comme responsable {{ dispositif.responsable.nom_complet if dispositif.responsable and dispositif.responsable.nom_complet else (dispositif.responsable.username if dispositif.responsable else 'le cr√©ateur du dispositif') }}
                                </small>
                                
                                {% elif ecart < 0 %}
                                <div class="fk-alert success">
                                    <i class="fas fa-check-circle fa-2x me-3"></i>
                                    <div>
                                        <h6 class="fw-bold">Dispositif performant</h6>
                                        <p class="mb-1">
                                            L'efficacit√© r√©elle ({{ form.efficacite_reelle.data }}/5) d√©passe l'efficacit√© attendue ({{ dispositif.efficacite_attendue }}/5).
                                        </p>
                                        <small>Surperformance : +{{ -ecart }} point(s)</small>
                                    </div>
                                </div>
                                {% else %}
                                <div class="fk-alert info">
                                    <i class="fas fa-check fa-2x me-3"></i>
                                    <div>
                                        <h6 class="fw-bold">Objectif atteint</h6>
                                        <p class="mb-0">
                                            L'efficacit√© r√©elle ({{ form.efficacite_reelle.data }}/5) correspond exactement √† l'efficacit√© attendue ({{ dispositif.efficacite_attendue }}/5).
                                        </p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" class="fk-btn fk-btn-secondary">
                                <i class="fas fa-times me-1"></i> Annuler
                            </a>
                            <button type="submit" class="fk-btn fk-btn-primary">
                                <i class="fas fa-save me-1"></i> Enregistrer l'√©valuation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Colonne droite - Guides et historique -->
        <div class="col-md-4">
            <!-- Guide d'√©valuation -->
            <div class="fk-card animate-in">
                <div class="fk-card-header info">
                    <h6 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>Guide d'√©valuation
                    </h6>
                </div>
                <div class="fk-card-body">
                    <h6 class="fw-bold mb-3">√âchelle d'efficacit√© :</h6>
                    <div class="guide-list">
                        <div class="guide-item">
                            <div class="guide-badge success">5</div>
                            <div class="guide-text"><strong>Excellente :</strong> Le dispositif est totalement efficace</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge success">4</div>
                            <div class="guide-text"><strong>Bonne :</strong> Le dispositif est efficace avec de l√©g√®res am√©liorations possibles</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge warning">3</div>
                            <div class="guide-text"><strong>Moyenne :</strong> Le dispositif est partiellement efficace</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge danger">2</div>
                            <div class="guide-text"><strong>Faible :</strong> Le dispositif pr√©sente des lacunes importantes</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge danger">1</div>
                            <div class="guide-text"><strong>Tr√®s faible :</strong> Le dispositif est inefficace</div>
                        </div>
                    </div>
                    
                    <h6 class="fw-bold mt-4 mb-3">√âchelle de couverture :</h6>
                    <div class="guide-list">
                        <div class="guide-item">
                            <div class="guide-badge success">5</div>
                            <div class="guide-text"><strong>Totale :</strong> Couvre l'ensemble du p√©rim√®tre √† risque</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge success">4</div>
                            <div class="guide-text"><strong>Bonne :</strong> Couvre la majorit√© du p√©rim√®tre</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge warning">3</div>
                            <div class="guide-text"><strong>Partielle :</strong> Couvre une partie significative</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge danger">2</div>
                            <div class="guide-text"><strong>Limit√©e :</strong> Couverture insuffisante</div>
                        </div>
                        <div class="guide-item">
                            <div class="guide-badge danger">1</div>
                            <div class="guide-text"><strong>Tr√®s limit√©e :</strong> Couverture tr√®s r√©duite</div>
                        </div>
                    </div>
                    
                    <div class="fk-alert warning mt-4">
                        <i class="fas fa-lightbulb me-2"></i>
                        <div>
                            <strong>Conseil :</strong>
                            <p class="mb-0 small">Basez votre √©valuation sur des √©l√©ments probants (tests, observations, documents)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Historique des √©valuations -->
            <div class="fk-card animate-in">
                <div class="fk-card-header light">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Derni√®res √©valuations
                    </h6>
                </div>
                <div class="fk-card-body" style="max-height: 300px; overflow-y: auto;">
                    {% if dispositif.verifications %}
                    {% set sorted_verifications = dispositif.verifications|sort(attribute='date_verification', reverse=true) %}
                    {% for verification in sorted_verifications[:5] %}
                    <div class="historique-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="historique-date">{{ verification.date_verification.strftime('%d/%m/%Y') }}</div>
                                <div class="historique-type">{{ verification.type_verification }}</div>
                            </div>
                            <span class="badge-modern {% if verification.resultat == 'Conforme' %}badge-success
                                                    {% elif verification.resultat == 'Non conforme' %}badge-danger
                                                    {% else %}badge-warning{% endif %}">
                                {{ verification.resultat }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="empty-title">Aucune √©valuation ant√©rieure</div>
                        <div class="empty-description">Ce dispositif n'a pas encore √©t√© √©valu√©</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù Formulaire d\'√©valuation charg√©');
    
    // ===========================
    // GESTION DES CARTES DE S√âLECTION
    // ===========================
    
    // Efficacit√©
    document.querySelectorAll('input[name="efficacite_reelle"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // D√©s√©lectionner toutes les cartes
            document.querySelectorAll('.evaluation-card').forEach(card => {
                if (card.querySelector('input[name="efficacite_reelle"]')) {
                    card.classList.remove('selected');
                }
            });
            // S√©lectionner la carte correspondante
            const card = this.closest('.evaluation-card');
            if (card) {
                card.classList.add('selected');
            }
            // Mettre √† jour l'analyse d'impact
            updateImpactAnalysis();
        });
    });
    
    // Couverture
    document.querySelectorAll('input[name="couverture"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // D√©s√©lectionner toutes les cartes
            document.querySelectorAll('.evaluation-card').forEach(card => {
                if (card.querySelector('input[name="couverture"]')) {
                    card.classList.remove('selected');
                }
            });
            // S√©lectionner la carte correspondante
            const card = this.closest('.evaluation-card');
            if (card) {
                card.classList.add('selected');
            }
        });
    });
    
    // ===========================
    // MISE √Ä JOUR DE L'ANALYSE D'IMPACT
    // ===========================
    
    function updateImpactAnalysis() {
        const efficaciteInput = document.querySelector('input[name="efficacite_reelle"]:checked');
        if (efficaciteInput) {
            const efficaciteValue = parseInt(efficaciteInput.value);
            const efficaciteAttendue = {{ dispositif.efficacite_attendue or 0 }};
            
            if (efficaciteAttendue > 0) {
                const impactAnalysis = document.getElementById('impactAnalysis');
                if (impactAnalysis) {
                    impactAnalysis.style.display = 'block';
                    
                    // Mettre √† jour le message en fonction de l'√©cart
                    const ecart = efficaciteAttendue - efficaciteValue;
                    const alertDiv = impactAnalysis.querySelector('.fk-alert');
                    
                    if (ecart > 0) {
                        alertDiv.className = 'fk-alert warning';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <h6 class="fw-bold">Dispositif sous-performant</h6>
                                <p class="mb-1">
                                    L'efficacit√© r√©elle (${efficaciteValue}/5) est inf√©rieure √† l'efficacit√© attendue (${efficaciteAttendue}/5).
                                </p>
                                <small>√âcart : -${ecart} point(s)</small>
                            </div>
                        `;
                    } else if (ecart < 0) {
                        alertDiv.className = 'fk-alert success';
                        alertDiv.innerHTML = `
                            <i class="fas fa-check-circle fa-2x me-3"></i>
                            <div>
                                <h6 class="fw-bold">Dispositif performant</h6>
                                <p class="mb-1">
                                    L'efficacit√© r√©elle (${efficaciteValue}/5) d√©passe l'efficacit√© attendue (${efficaciteAttendue}/5).
                                </p>
                                <small>Surperformance : +${-ecart} point(s)</small>
                            </div>
                        `;
                    } else {
                        alertDiv.className = 'fk-alert info';
                        alertDiv.innerHTML = `
                            <i class="fas fa-check fa-2x me-3"></i>
                            <div>
                                <h6 class="fw-bold">Objectif atteint</h6>
                                <p class="mb-0">
                                    L'efficacit√© r√©elle (${efficaciteValue}/5) correspond exactement √† l'efficacit√© attendue (${efficaciteAttendue}/5).
                                </p>
                            </div>
                        `;
                    }
                }
            }
        }
    }
    
    // ===========================
    // VALIDATION DU FORMULAIRE
    // ===========================
    
    const form = document.getElementById('evaluationForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const efficacite = document.querySelector('input[name="efficacite_reelle"]:checked');
            const couverture = document.querySelector('input[name="couverture"]:checked');
            
            if (!efficacite) {
                e.preventDefault();
                alert('Veuillez s√©lectionner une efficacit√© r√©elle');
                return false;
            }
            
            if (!couverture) {
                e.preventDefault();
                alert('Veuillez s√©lectionner une couverture');
                return false;
            }
            
            // V√©rifier si on doit cr√©er un plan d'action
            const creerPlanCheckbox = document.getElementById('creerPlanAction');
            if (creerPlanCheckbox && creerPlanCheckbox.checked) {
                const efficaciteValue = parseInt(efficacite.value);
                const efficaciteAttendue = {{ dispositif.efficacite_attendue or 0 }};
                
                if (efficaciteValue < efficaciteAttendue) {
                    if (!confirm('Un plan d\'action d\'am√©lioration sera cr√©√© automatiquement. Confirmez-vous ?')) {
                        e.preventDefault();
                        return false;
                    }
                }
            }
            
            return true;
        });
    }
    
    // Initialiser l'analyse d'impact
    updateImpactAnalysis();
    
    // D√©bogage
    console.log('Dispositif ID:', {{ dispositif.id }});
    console.log('Risque ID:', {{ dispositif.risque_id }});
});
</script>
{% endblock %}
