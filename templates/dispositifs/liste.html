{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       STYLES SP√âCIFIQUES - LISTE DISPOSITIFS
       ============================================ */
    
    /* Variables de base */
    .list-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* ========== EN-T√äTE DE PAGE ========== */
    .page-header {
        background: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: rotate(25deg);
        pointer-events: none;
        z-index: 0;
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: rotate(-15deg);
        pointer-events: none;
        z-index: 0;
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 1rem;
    }

    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .breadcrumb-item a:hover {
        color: white;
    }

    .breadcrumb-item.active {
        color: white;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
        position: relative;
        z-index: 10;
    }

    .fk-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        z-index: 10;
        position: relative;
    }

    .fk-btn-primary {
        background: linear-gradient(135deg, #0066CC, #3B82F6);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .fk-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
        color: white;
    }

    .fk-btn-secondary {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
    }

    .fk-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        color: white;
    }

    .fk-btn-success {
        background: linear-gradient(135deg, #0D9488, #14B8A6);
        color: white;
    }

    .fk-btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(13, 148, 136, 0.4);
        color: white;
    }

    .fk-btn-warning {
        background: linear-gradient(135deg, #F59E0B, #FBBF24);
        color: white;
    }

    .fk-btn-outline-light {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .fk-btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        color: white;
    }

    /* ========== STATISTIQUES ========== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    [data-bs-theme="dark"] .stat-card {
        background: #1e293b;
        border-color: #334155;
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
    }

    .stat-icon.primary { background: linear-gradient(135deg, #0066CC, #3B82F6); }
    .stat-icon.success { background: linear-gradient(135deg, #0D9488, #14B8A6); }
    .stat-icon.warning { background: linear-gradient(135deg, #F59E0B, #FBBF24); }
    .stat-icon.info { background: linear-gradient(135deg, #3B82F6, #6366F1); }
    .stat-icon.danger { background: linear-gradient(135deg, #DC2626, #EF4444); }

    .stat-content {
        flex: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        margin-bottom: 0.25rem;
    }

    [data-bs-theme="dark"] .stat-label {
        color: #94a3b8;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #0f172a;
        line-height: 1.2;
    }

    [data-bs-theme="dark"] .stat-value {
        color: #f1f5f9;
    }

    .stat-trend {
        font-size: 0.8rem;
        color: #0D9488;
        margin-top: 0.25rem;
    }

    /* ========== FILTRES ========== */
    .filters-section {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    [data-bs-theme="dark"] .filters-section {
        background: #1e293b;
        border-color: #334155;
    }

    .filter-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 30px;
        font-size: 0.85rem;
        font-weight: 500;
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .filter-btn:hover {
        background: #e2e8f0;
    }

    .filter-btn.active {
        background: #0066CC;
        color: white;
        border-color: #0066CC;
    }

    [data-bs-theme="dark"] .filter-btn {
        background: #0f172a;
        border-color: #334155;
        color: #94a3b8;
    }

    [data-bs-theme="dark"] .filter-btn:hover {
        background: #1e293b;
    }

    [data-bs-theme="dark"] .filter-btn.active {
        background: #3B82F6;
        color: white;
    }

    /* ========== TABLEAU ========== */
    .fk-card-modern {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .fk-card-modern:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    [data-bs-theme="dark"] .fk-card-modern {
        background: #1e293b;
        border-color: #334155;
    }

    .fk-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        background: #f8fafc;
        color: #0f172a;
    }

    .fk-card-header.primary {
        background: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        color: white;
        border-bottom: none;
    }

    .fk-card-header.success {
        background: linear-gradient(135deg, #0D9488, #14B8A6);
        color: white;
        border-bottom: none;
    }

    .header-icon-sm {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
    }

    .badge-modern {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        border: 1px solid transparent;
    }

    .badge-primary { background: #0066CC; color: white; }
    .badge-success { background: #0D9488; color: white; }
    .badge-warning { background: #F59E0B; color: white; }
    .badge-danger { background: #DC2626; color: white; }
    .badge-info { background: #3B82F6; color: white; }
    .badge-secondary { background: #64748b; color: white; }

    .fk-table-modern {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .fk-table-modern thead th {
        padding: 0.75rem 1rem;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        border-bottom: 2px solid #e2e8f0;
        background: #f8fafc;
        white-space: nowrap;
    }

    .fk-table-modern tbody td {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        color: #0f172a;
        vertical-align: middle;
    }

    .fk-table-modern tbody tr:hover {
        background: #f1f5f9;
    }

    .fk-table-modern tbody tr {
        transition: all 0.2s ease;
    }

    [data-bs-theme="dark"] .fk-table-modern thead th {
        color: #94a3b8;
        border-bottom-color: #334155;
        background: #0f172a;
    }

    [data-bs-theme="dark"] .fk-table-modern tbody td {
        border-bottom-color: #334155;
        color: #f1f5f9;
    }

    [data-bs-theme="dark"] .fk-table-modern tbody tr:hover {
        background: #1e293b;
    }

    /* Barres de progression */
    .progress-modern {
        background: #e2e8f0;
        border-radius: 50px;
        height: 8px;
        overflow: hidden;
        width: 100%;
    }

    [data-bs-theme="dark"] .progress-modern {
        background: #334155;
    }

    .progress-modern-bar {
        height: 100%;
        border-radius: 50px;
        transition: width 0.3s ease;
    }

    .progress-modern-bar.success { background: #0D9488; }
    .progress-modern-bar.warning { background: #F59E0B; }
    .progress-modern-bar.danger { background: #DC2626; }
    .progress-modern-bar.primary { background: #0066CC; }

    /* Boutons d'action */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    .btn-action {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        color: #64748b;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        z-index: 10;
        position: relative;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: #ffffff;
        text-decoration: none;
    }

    [data-bs-theme="dark"] .btn-action {
        background: #1e293b;
        border-color: #334155;
        color: #94a3b8;
    }

    [data-bs-theme="dark"] .btn-action:hover {
        background: #0f172a;
    }

    .btn-action.primary:hover { background: #0066CC; color: white; border-color: #0066CC; }
    .btn-action.success:hover { background: #0D9488; color: white; border-color: #0D9488; }
    .btn-action.warning:hover { background: #F59E0B; color: white; border-color: #F59E0B; }
    .btn-action.danger:hover { background: #DC2626; color: white; border-color: #DC2626; }
    .btn-action.info:hover { background: #3B82F6; color: white; border-color: #3B82F6; }

    /* ========== BADGES STATUT ========== */
    .badge-statut {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
    }

    .badge-statut.actif {
        background: rgba(13, 148, 136, 0.15);
        color: #0D9488;
        border: 1px solid rgba(13, 148, 136, 0.3);
    }

    .badge-statut.inactif {
        background: rgba(100, 116, 139, 0.15);
        color: #64748b;
        border: 1px solid rgba(100, 116, 139, 0.3);
    }

    .badge-statut.en_cours {
        background: rgba(245, 158, 11, 0.15);
        color: #F59E0B;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .badge-statut.obsolete {
        background: rgba(220, 38, 38, 0.15);
        color: #DC2626;
        border: 1px solid rgba(220, 38, 38, 0.3);
    }

    [data-bs-theme="dark"] .badge-statut.actif {
        background: rgba(13, 148, 136, 0.25);
        color: #2dd4bf;
    }

    /* ========== BADGES TYPE ========== */
    .badge-type {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-type.preventif {
        background: #0D9488;
        color: white;
    }

    .badge-type.detectif {
        background: #F59E0B;
        color: white;
    }

    .badge-type.correctif {
        background: #DC2626;
        color: white;
    }

    .badge-type.default {
        background: #64748b;
        color: white;
    }

    /* ========== VIDE ========== */
    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
    }

    [data-bs-theme="dark"] .empty-state {
        background: #1e293b;
        border-color: #334155;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: #f1f5f9;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #64748b;
        margin: 0 auto 1.5rem;
    }

    [data-bs-theme="dark"] .empty-icon {
        background: #0f172a;
        color: #94a3b8;
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 0.5rem;
    }

    .empty-text {
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    /* ========== GRAPHIQUES ========== */
    .charts-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .chart-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    [data-bs-theme="dark"] .chart-card {
        background: #1e293b;
        border-color: #334155;
    }

    .chart-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    [data-bs-theme="dark"] .chart-title {
        color: #f1f5f9;
    }

    /* ========== MODAL ========== */
    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        border-bottom: 1px solid #e2e8f0;
        padding: 1.25rem 1.5rem;
    }

    .modal-header.bg-warning {
        background: linear-gradient(135deg, #F59E0B, #FBBF24) !important;
        color: white;
    }

    .modal-header.bg-warning .btn-close {
        filter: brightness(0) invert(1);
    }

    .modal-footer {
        border-top: 1px solid #e2e8f0;
        padding: 1.25rem 1.5rem;
    }

    /* ========== ANIMATIONS ========== */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    /* ========== NOTIFICATIONS ========== */
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .notification-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        padding: 12px 20px;
        animation: slideIn 0.3s ease;
    }

    .notification-toast.alert-success {
        background: linear-gradient(135deg, #0D9488, #14B8A6);
        color: white;
        border: none;
    }

    .notification-toast.alert-danger {
        background: linear-gradient(135deg, #DC2626, #EF4444);
        color: white;
        border: none;
    }

    .notification-toast.alert-warning {
        background: linear-gradient(135deg, #F59E0B, #FBBF24);
        color: white;
        border: none;
    }

    .notification-toast.alert-info {
        background: linear-gradient(135deg, #3B82F6, #6366F1);
        color: white;
        border: none;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .header-actions .fk-btn {
            width: 100%;
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .fk-table-modern {
            display: block;
            overflow-x: auto;
        }

        .action-buttons {
            flex-wrap: wrap;
            justify-content: center;
        }

        .filters-section {
            flex-direction: column;
            align-items: flex-start;
        }

        .filter-group {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .filter-btn {
            white-space: nowrap;
        }
    }
</style>

<!-- Anti-cache headers -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<div class="list-container">
    <!-- En-t√™te de page -->
    <div class="page-header animate-in">
        <div class="page-header-content">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_cartographies') }}">Cartographies</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_cartographie', id=risque.cartographie_id) }}">{{ risque.cartographie.nom }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_risque', id=risque.id) }}">{{ risque.reference }}</a></li>
                            <li class="breadcrumb-item active">Dispositifs de ma√Ætrise</li>
                        </ol>
                    </nav>
                    
                    <div class="page-title">
                        <i class="fas fa-shield-alt me-2"></i>Dispositifs de ma√Ætrise
                    </div>
                    
                    <p class="text-white-50 mb-0">{{ risque.reference }} - {{ risque.intitule }}</p>
                </div>
                
                <div class="col-auto">
                    <div class="header-actions">
                        <a href="{{ url_for('detail_risque', id=risque.id) }}" class="fk-btn fk-btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour au risque
                        </a>
                        <a href="{{ url_for('nouveau_dispositif', risque_id=risque.id) }}" class="fk-btn fk-btn-success">
                            <i class="fas fa-plus"></i> Nouveau dispositif
                        </a>
                        <a href="{{ url_for('dispositifs_archives') }}?retour={{ url_for('liste_dispositifs_risque', risque_id=risque.id) }}" class="fk-btn fk-btn-outline-light">
                            <i class="fas fa-archive"></i> Archives
                            {% if nb_archives > 0 %}
                            <span class="badge-modern badge-secondary ms-1">{{ nb_archives }}</span>
                            {% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="stats-grid">
        <div class="stat-card animate-in">
            <div class="stat-icon primary">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Total dispositifs</div>
                <div class="stat-value">{{ stats.total }}</div>
            </div>
        </div>

        <div class="stat-card animate-in">
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Efficaces (‚â•4/5)</div>
                <div class="stat-value">{{ stats.efficaces }}</div>
                <div class="stat-trend">
                    {{ ((stats.efficaces / stats.total) * 100 if stats.total > 0 else 0)|round|int }}% des dispositifs
                </div>
            </div>
        </div>

        <div class="stat-card animate-in">
            <div class="stat-icon warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">√Ä √©valuer</div>
                <div class="stat-value">{{ stats.non_evalues }}</div>
            </div>
        </div>

        <div class="stat-card animate-in">
            <div class="stat-icon info">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Avec plans d'action</div>
                <div class="stat-value">{{ stats.avec_plan }}</div>
            </div>
        </div>
    </div>

    <!-- Section des filtres -->
    <div class="filters-section animate-in">
        <div class="filter-group">
            <button class="filter-btn active" onclick="filtrerTableau('tous')">
                <i class="fas fa-list me-1"></i>Tous
            </button>
            <button class="filter-btn" onclick="filtrerTableau('preventif')">
                <span class="badge-type preventif me-1">P</span>Pr√©ventifs
            </button>
            <button class="filter-btn" onclick="filtrerTableau('detectif')">
                <span class="badge-type detectif me-1">D</span>D√©tectifs
            </button>
            <button class="filter-btn" onclick="filtrerTableau('correctif')">
                <span class="badge-type correctif me-1">C</span>Correctifs
            </button>
        </div>
        <div class="filter-group">
            <button class="filter-btn" onclick="filtrerTableau('efficace')">
                <i class="fas fa-star text-success me-1"></i>Efficaces
            </button>
            <button class="filter-btn" onclick="filtrerTableau('non_efficace')">
                <i class="fas fa-exclamation-triangle text-warning me-1"></i>√Ä am√©liorer
            </button>
        </div>
    </div>

    <!-- Tableau des dispositifs -->
    <div class="fk-card-modern animate-in">
        <div class="fk-card-header primary">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-sm">
                    <i class="fas fa-list"></i>
                </div>
                <h5 class="mb-0">Liste des dispositifs de ma√Ætrise</h5>
            </div>
            <span class="badge-modern badge-secondary">{{ dispositifs|length }}</span>
        </div>

        <div class="fk-card-body p-0">
            {% if dispositifs %}
            <div class="table-responsive">
                <table class="fk-table-modern" id="tableDispositifs">
                    <thead>
                        <tr>
                            <th>R√©f√©rence</th>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>Efficacit√©</th>
                            <th>Statut</th>
                            <th>Derni√®re v√©rif.</th>
                            <th>Plans d'action</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dispositif in dispositifs %}
                        <tr data-type="{{ dispositif.type_dispositif|lower }}"
                            data-efficacite="{{ dispositif.efficacite_reelle or 0 }}">
                            <td>
                                <strong>{{ dispositif.reference }}</strong>
                            </td>
                            <td>
                                <div class="fw-bold">{{ dispositif.nom|truncate(40) }}</div>
                                {% if dispositif.description %}
                                <small class="text-muted">{{ dispositif.description|truncate(60) }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if dispositif.type_dispositif == 'Pr√©ventif' %}
                                <span class="badge-type preventif">{{ dispositif.type_dispositif }}</span>
                                {% elif dispositif.type_dispositif == 'D√©tectif' %}
                                <span class="badge-type detectif">{{ dispositif.type_dispositif }}</span>
                                {% elif dispositif.type_dispositif == 'Correctif' %}
                                <span class="badge-type correctif">{{ dispositif.type_dispositif }}</span>
                                {% else %}
                                <span class="badge-type default">{{ dispositif.type_dispositif }}</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ dispositif.nature }}</small>
                            </td>
                            <td style="min-width: 150px;">
                                {% if dispositif.efficacite_reelle %}
                                <div class="d-flex align-items-center">
                                    <div class="progress-modern flex-grow-1 me-2">
                                        <div class="progress-modern-bar 
                                            {% if dispositif.efficacite_reelle >= 4 %}success
                                            {% elif dispositif.efficacite_reelle >= 3 %}warning
                                            {% else %}danger{% endif %}" 
                                            style="width: {{ (dispositif.efficacite_reelle / 5) * 100 }}%">
                                        </div>
                                    </div>
                                    <span class="fw-bold">{{ dispositif.efficacite_reelle }}/5</span>
                                </div>
                                {% if dispositif.efficacite_attendue %}
                                <small class="text-muted">Attendu: {{ dispositif.efficacite_attendue }}/5</small>
                                {% endif %}
                                {% else %}
                                <span class="badge-statut inactif">Non √©valu√©</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dispositif.statut == 'actif' %}
                                <span class="badge-statut actif">Actif</span>
                                {% elif dispositif.statut == 'inactif' %}
                                <span class="badge-statut inactif">Inactif</span>
                                {% elif dispositif.statut == 'en_cours' %}
                                <span class="badge-statut en_cours">En cours</span>
                                {% else %}
                                <span class="badge-statut obsolete">Obsol√®te</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dispositif.date_derniere_verification %}
                                <i class="fas fa-calendar-check text-success me-1"></i>
                                {{ dispositif.date_derniere_verification.strftime('%d/%m/%Y') }}
                                {% else %}
                                <span class="badge-statut en_cours">Jamais</span>
                                {% endif %}
                                {% if dispositif.prochaine_verification %}
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>Prochaine: {{ dispositif.prochaine_verification.strftime('%d/%m/%Y') }}
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                {# CORRECTION : Utilisation de plans_action (relation plusieurs-√†-plusieurs) #}
                                {% if dispositif.plans_action and dispositif.plans_action.count() > 0 %}
                                    <div class="d-flex flex-column gap-1">
                                        {% for plan in dispositif.plans_action[:2] %}
                                        <a href="{{ url_for('detail_plan_action_risque', plan_id=plan.id) }}" 
                                           class="badge-modern badge-info text-decoration-none">
                                            <i class="fas fa-tasks me-1"></i>{{ plan.reference }}
                                            <span class="badge bg-{{ plan.couleur_statut }} ms-1">{{ plan.pourcentage_realisation }}%</span>
                                        </a>
                                        {% endfor %}
                                        {% if dispositif.plans_action.count() > 2 %}
                                        <small class="text-muted">+{{ dispositif.plans_action.count() - 2 }} autre(s)</small>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <button class="btn-action primary" 
                                            onclick="lierPlanAction({{ dispositif.id }})"
                                            title="Lier un plan d'action">
                                        <i class="fas fa-link"></i>
                                    </button>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" 
                                       class="btn-action info" title="D√©tails">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('evaluer_dispositif', dispositif_id=dispositif.id) }}" 
                                       class="btn-action warning" title="√âvaluer">
                                        <i class="fas fa-chart-bar"></i>
                                    </a>
                                    <a href="{{ url_for('modifier_dispositif', dispositif_id=dispositif.id) }}" 
                                       class="btn-action primary" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if current_user.has_permission('can_archive_data') %}
                                    <button type="button" 
                                            class="btn-action danger" 
                                            title="Archiver"
                                            onclick="archiverDispositif({{ dispositif.id }}, '{{ dispositif.reference }}')">
                                        <i class="fas fa-archive"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- √âtat vide -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h4 class="empty-title">Aucun dispositif de ma√Ætrise</h4>
                <p class="empty-text">Cr√©ez votre premier dispositif pour renforcer la ma√Ætrise de ce risque</p>
                <a href="{{ url_for('nouveau_dispositif', risque_id=risque.id) }}" class="fk-btn fk-btn-primary">
                    <i class="fas fa-plus me-2"></i>Cr√©er le premier dispositif
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Vue synth√®se - Graphiques -->
    <div class="charts-row">
        <div class="chart-card animate-in">
            <div class="chart-title">
                <i class="fas fa-chart-pie text-primary"></i>
                R√©partition par type
            </div>
            <canvas id="chartTypeDispositif" height="200"></canvas>
        </div>

        <div class="chart-card animate-in">
            <div class="chart-title">
                <i class="fas fa-chart-bar text-success"></i>
                Efficacit√© des dispositifs
            </div>
            <canvas id="chartEfficacite" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Modal g√©n√©rique pour lier un plan d'action -->
<div class="modal fade" id="genericModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="genericModalTitle">
                    <i class="fas fa-link me-2"></i>Lier un plan d'action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="genericModalBody">
                <!-- Contenu charg√© dynamiquement -->
            </div>
            <div class="modal-footer" id="genericModalFooter">
                <!-- Pied charg√© dynamiquement -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation d'archivage -->
<div class="modal fade" id="modalArchiver" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-archive me-2"></i>
                    Confirmer l'archivage
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir archiver le dispositif <strong id="modalDispositifNom"></strong> ?</p>
                <p class="text-muted small">Le dispositif ne sera plus visible dans les listes actives.</p>
            </div>
            <div class="modal-footer">
                <form method="POST" action="" id="formArchiver">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="button" class="fk-btn fk-btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="fk-btn fk-btn-warning">
                        <i class="fas fa-archive me-1"></i>Archiver
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Token CSRF pour les requ√™tes -->
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ============================================
// VARIABLES GLOBALES
// ============================================
const risqueId = {{ risque.id }};
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token() }}';

// ============================================
// FONCTIONS DE FILTRAGE
// ============================================
function filtrerTableau(filtre) {
    const lignes = document.querySelectorAll('#tableDispositifs tbody tr');
    const filtres = document.querySelectorAll('.filter-btn');
    
    filtres.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase().includes(filtre) || 
            (filtre === 'tous' && btn.textContent.trim() === 'Tous')) {
            btn.classList.add('active');
        }
    });
    
    lignes.forEach(ligne => {
        const type = ligne.getAttribute('data-type');
        const efficacite = parseFloat(ligne.getAttribute('data-efficacite'));
        let afficher = true;
        
        switch(filtre) {
            case 'preventif':
                afficher = type === 'pr√©ventif' || type === 'preventif';
                break;
            case 'detectif':
                afficher = type === 'd√©tectif' || type === 'detectif';
                break;
            case 'correctif':
                afficher = type === 'correctif';
                break;
            case 'efficace':
                afficher = efficacite >= 4;
                break;
            case 'non_efficace':
                afficher = efficacite < 4 && efficacite > 0;
                break;
            case 'tous':
                afficher = true;
                break;
        }
        
        ligne.style.display = afficher ? '' : 'none';
    });
}

// ============================================
// FONCTION POUR LIER UN PLAN D'ACTION
// ============================================
function lierPlanAction(dispositifId) {
    const modal = new bootstrap.Modal(document.getElementById('genericModal'));
    
    document.getElementById('genericModalTitle').innerHTML = '<i class="fas fa-link me-2"></i>Lier √† un plan d\'action';
    document.getElementById('genericModalBody').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement des plans d'action...</p>
        </div>
    `;
    document.getElementById('genericModalFooter').innerHTML = '';
    modal.show();
    
    fetch(`/api/plans-action/disponibles?risque_id=${risqueId}&dispositif_id=${dispositifId}`, {
        headers: {
            'X-CSRFToken': csrfToken,
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data);
        
        if (data.success && data.plans && data.plans.length > 0) {
            let options = '<option value="">-- Choisir un plan d\'action --</option>';
            
            data.plans.forEach(plan => {
                if (!plan.dispositif_id || plan.dispositif_id == dispositifId) {
                    const statutIcon = plan.statut === 'en_cours' ? 'üü°' : 
                                      plan.statut === 'en_retard' ? 'üî¥' : 
                                      plan.statut === 'termine' ? 'üü¢' : '‚ö™';
                    
                    const alreadyLinked = plan.dispositif_id == dispositifId ? ' (d√©j√† li√©)' : '';
                    
                    options += `<option value="${plan.id}">
                        ${statutIcon} ${plan.reference} - ${plan.nom}
                        ${plan.date_echeance ? `(√©ch√©ance: ${plan.date_echeance})` : ''}
                        ${alreadyLinked}
                    </option>`;
                }
            });
            
            const html = `
                <form method="POST" action="/dispositif/${dispositifId}/lier-plan-action" id="formLiaison">
                    <input type="hidden" name="csrf_token" value="${csrfToken}">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">S√©lectionner un plan d'action :</label>
                        <select class="fk-form-control" name="plan_action_id" required>
                            ${options}
                        </select>
                        <small class="text-muted">Seuls les plans disponibles sont affich√©s.</small>
                    </div>
                    
                    <div class="fk-alert-modern info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Information :</strong> Vous pouvez √©galement 
                        <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=risque.id) }}?dispositif_id=${dispositifId}" 
                           class="alert-link" target="_blank">
                            cr√©er un nouveau plan d'action
                        </a>
                    </div>
                </form>
            `;
            
            document.getElementById('genericModalBody').innerHTML = html;
            document.getElementById('genericModalFooter').innerHTML = `
                <button type="button" class="fk-btn fk-btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" class="fk-btn fk-btn-primary" form="formLiaison">
                    Lier le plan
                </button>
            `;
            
            document.getElementById('formLiaison').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        afficherNotification('‚úÖ Plan li√© avec succ√®s', 'success');
                        
                        // Notifier les autres pages
                        localStorage.setItem('dispositif_updated', Date.now().toString());
                        
                        bootstrap.Modal.getInstance(document.getElementById('genericModal')).hide();
                        
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        afficherNotification('‚ùå Erreur: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    afficherNotification('‚ùå Erreur: ' + error.message, 'danger');
                });
            });
            
        } else {
            const html = `
                <div class="fk-alert-modern warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Aucun plan d'action disponible</strong>
                    <p class="mb-0 mt-2">Il n'y a pas de plan d'action disponible pour ce risque.</p>
                </div>
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=risque.id) }}?dispositif_id=${dispositifId}" 
                       class="fk-btn fk-btn-primary">
                        <i class="fas fa-plus me-1"></i> Cr√©er un nouveau plan d'action
                    </a>
                </div>
            `;
            
            document.getElementById('genericModalBody').innerHTML = html;
            document.getElementById('genericModalFooter').innerHTML = `
                <button type="button" class="fk-btn fk-btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
            `;
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        document.getElementById('genericModalBody').innerHTML = `
            <div class="fk-alert-modern danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Erreur de chargement</strong>
                <p class="mb-0 mt-2">${error.message}</p>
            </div>
            
            <div class="text-center mt-3">
                <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=risque.id) }}?dispositif_id=${dispositifId}" 
                   class="fk-btn fk-btn-primary">
                    <i class="fas fa-plus me-1"></i> Cr√©er un nouveau plan d'action
                </a>
            </div>
        `;
        document.getElementById('genericModalFooter').innerHTML = `
            <button type="button" class="fk-btn fk-btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
        `;
    });
}

// ============================================
// FONCTION D'ARCHIVAGE
// ============================================
function archiverDispositif(dispositifId, dispositifRef) {
    console.log('üì¶ Tentative archivage:', dispositifId, dispositifRef);
    
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap non charg√©');
        alert('Erreur technique: Bootstrap non charg√©. Rechargez la page.');
        return;
    }
    
    const modalElement = document.getElementById('modalArchiver');
    if (!modalElement) {
        console.error('‚ùå Modal non trouv√©');
        alert('Erreur technique: Modal non trouv√©');
        return;
    }
    
    const nomElement = document.getElementById('modalDispositifNom');
    if (nomElement) {
        nomElement.textContent = dispositifRef;
    }
    
    const form = document.getElementById('formArchiver');
    if (form) {
        form.action = `/dispositif/${dispositifId}/archiver`;
        console.log('‚úÖ Action du formulaire mise √† jour:', form.action);
    }
    
    try {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } catch (error) {
        console.error('‚ùå Erreur affichage modal:', error);
    }
}

// ============================================
// FONCTION D'AFFICHAGE DES NOTIFICATIONS
// ============================================
function afficherNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        padding: 12px 20px;
    `;
    notification.innerHTML = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ============================================
// SYNCHRONISATION AUTOMATIQUE
// ============================================
// UN SEUL √âCOUTEUR pour storage
window.addEventListener('storage', function(e) {
    if (e.key === 'dispositif_updated') {
        console.log('üîÑ Changement d√©tect√©, rechargement...');
        location.reload();
    }
});

// V√©rifier au retour sur la page
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        console.log('üìÑ Page restaur√©e depuis le cache, rechargement...');
        location.reload();
    }
});

// Optionnel : Rechargement p√©riodique (d√©sactiv√© car trop agressif)
// setInterval(function() {
//     console.log('‚è∞ Rechargement p√©riodique...');
//     location.reload();
// }, 30000);

// ============================================
// GRAPHIQUES
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ Page dispositifs charg√©e');
    console.log('Risque ID:', risqueId);
    console.log('Nombre de dispositifs:', {{ dispositifs|length }});
    
    const statsType = {{ stats.par_type|tojson }};
    const efficaces = {{ stats.efficaces }};
    const nonEfficaces = {{ stats.non_efficaces }};
    const nonEvalues = {{ stats.non_evalues }};
    
    // Graphique par type
    const ctxType = document.getElementById('chartTypeDispositif');
    if (ctxType) {
        new Chart(ctxType, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statsType),
                datasets: [{
                    data: Object.values(statsType),
                    backgroundColor: ['#0D9488', '#F59E0B', '#DC2626', '#64748b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#f1f5f9' : '#0f172a'
                        }
                    }
                }
            }
        });
    }
    
    // Graphique d'efficacit√©
    const ctxEff = document.getElementById('chartEfficacite');
    if (ctxEff) {
        new Chart(ctxEff, {
            type: 'bar',
            data: {
                labels: ['Efficaces (‚â•4/5)', 'Non efficaces', 'Non √©valu√©s'],
                datasets: [{
                    data: [efficaces, nonEfficaces, nonEvalues],
                    backgroundColor: ['#0D9488', '#DC2626', '#64748b'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
});

// ============================================
// INITIALISATION DU FORMULAIRE D'ARCHIVAGE
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formArchiver');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üì§ Formulaire soumis:', this.action);
        });
    }
});
</script>
{% endblock %}