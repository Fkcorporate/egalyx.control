<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rapport des dispositifs - {{ date.strftime('%d/%m/%Y') }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
            @frame footer {
                -pdf-frame-content: footerContent;
                bottom: 0cm;
                margin-left: 2cm;
                margin-right: 2cm;
                height: 1cm;
            }
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
        }
        
        h1 {
            color: #0056b3;
            font-size: 24px;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #444;
            font-size: 18px;
            margin-top: 20px;
            background: #f8f9fa;
            padding: 8px;
            border-left: 4px solid #0056b3;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .date {
            color: #666;
            font-size: 12px;
            text-align: right;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .kpi-card {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: #0056b3;
        }
        
        .kpi-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 10px;
        }
        
        th {
            background: #0056b3;
            color: white;
            padding: 8px;
            text-align: left;
        }
        
        td {
            padding: 6px 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .badge {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .section {
            margin: 30px 0;
            page-break-inside: avoid;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            text-align: center;
            font-size: 9px;
            color: #666;
            border-top: 1px solid #dee2e6;
            padding-top: 5px;
        }
        
        .summary-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
        }
        
        .text-success { color: #28a745; }
        .text-warning { color: #ffc107; }
        .text-danger { color: #dc3545; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä RAPPORT DES DISPOSITIFS DE MA√éTRISE</h1>
        <div class="date">G√©n√©r√© le {{ date.strftime('%d/%m/%Y √† %H:%M') }}</div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-value">{{ stats.total }}</div>
            <div class="kpi-label">Total dispositifs</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ stats.efficacite_moyenne }}/5</div>
            <div class="kpi-label">Efficacit√© moyenne</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ stats.reduction_moyenne }}%</div>
            <div class="kpi-label">R√©duction moyenne</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ stats.top_performers|length }}</div>
            <div class="kpi-label">Top performers</div>
        </div>
    </div>

    <!-- R√©sum√© ex√©cutif -->
    <div class="section">
        <h2>üìã R√âSUM√â EX√âCUTIF</h2>
        <div class="summary-box">
            <p><strong>Synth√®se de l'√©tat des dispositifs :</strong></p>
            <ul>
                <li><span class="text-success">‚úì {{ stats.top_performers|length }} dispositifs performants</span> (efficacit√© ‚â• 4/5)</li>
                <li><span class="text-warning">‚ö† {{ stats.a_ameliorer|length }} dispositifs √† am√©liorer</span> (efficacit√© < 3/5)</li>
                <li><span class="text-danger">‚úó {{ stats.sans_evaluation|length }} dispositifs non √©valu√©s</span></li>
            </ul>
            
            <p><strong>R√©partition par type :</strong></p>
            <ul>
                {% for type, count in stats.par_type.items() %}
                <li>{{ type }} : {{ count }} ({{ ((count/stats.total)*100)|round }}%)</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Top Performers -->
    {% if stats.top_performers %}
    <div class="section">
        <h2>üèÜ TOP PERFORMERS</h2>
        <table>
            <thead>
                <tr>
                    <th>R√©f√©rence</th>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Efficacit√©</th>
                    <th>R√©duction</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for perf in stats.top_performers %}
                <tr>
                    <td><strong>{{ perf.reference }}</strong></td>
                    <td>{{ perf.nom|truncate(30) }}</td>
                    <td>
                        <span class="badge badge-info">{{ perf.type }}</span>
                    </td>
                    <td>
                        <span class="badge badge-success">{{ perf.efficacite }}/5</span>
                    </td>
                    <td>{{ perf.reduction }}%</td>
                    <td>{{ perf.statut }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Dispositifs √† am√©liorer -->
    {% if stats.a_ameliorer %}
    <div class="section">
        <h2>‚ö†Ô∏è DISPOSITIFS √Ä AM√âLIORER</h2>
        <table>
            <thead>
                <tr>
                    <th>R√©f√©rence</th>
                    <th>Nom</th>
                    <th>Efficacit√©</th>
                    <th>Attendu</th>
                    <th>√âcart</th>
                    <th>Responsable</th>
                </tr>
            </thead>
            <tbody>
                {% for item in stats.a_ameliorer %}
                <tr>
                    <td>{{ item.reference }}</td>
                    <td>{{ item.nom|truncate(30) }}</td>
                    <td>
                        <span class="badge badge-danger">{{ item.efficacite }}/5</span>
                    </td>
                    <td>{{ item.attendu }}/5</td>
                    <td><strong class="text-danger">{{ item.ecart }}</strong></td>
                    <td>{{ item.responsable or 'Non assign√©' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Liste compl√®te -->
    <div class="section">
        <h2>üìã LISTE COMPL√àTE DES DISPOSITIFS</h2>
        <table>
            <thead>
                <tr>
                    <th>R√©f</th>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Efficacit√©</th>
                    <th>Couverture</th>
                    <th>R√©duction</th>
                    <th>Derni√®re v√©rif</th>
                </tr>
            </thead>
            <tbody>
                {% for d in dispositifs %}
                <tr>
                    <td>{{ d.reference }}</td>
                    <td>{{ d.nom|truncate(25) }}</td>
                    <td>{{ d.type_dispositif }}</td>
                    <td>
                        {% if d.efficacite_reelle %}
                        <span class="badge {% if d.efficacite_reelle >= 4 %}badge-success{% elif d.efficacite_reelle >= 3 %}badge-warning{% else %}badge-danger{% endif %}">
                            {{ d.efficacite_reelle }}/5
                        </span>
                        {% else %}
                        <span class="badge badge-warning">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ d.couverture or 'N/A' }}/5</td>
                    <td>
                        {% if d.efficacite_reelle %}
                        {{ d.get_reduction_risque_detaille().reduction_finale }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td>{{ d.date_derniere_verification.strftime('%d/%m/%Y') if d.date_derniere_verification else 'Jamais' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Statistiques d√©taill√©es -->
    <div class="section">
        <h2>üìä STATISTIQUES D√âTAILL√âES</h2>
        <table>
            <tr>
                <th>M√©trique</th>
                <th>Valeur</th>
            </tr>
            <tr>
                <td>Total dispositifs</td>
                <td>{{ stats.total }}</td>
            </tr>
            <tr>
                <td>Efficacit√© moyenne</td>
                <td>{{ stats.efficacite_moyenne }}/5</td>
            </tr>
            <tr>
                <td>Couverture moyenne</td>
                <td>{{ stats.couverture_moyenne }}/5</td>
            </tr>
            <tr>
                <td>R√©duction moyenne</td>
                <td>{{ stats.reduction_moyenne }}%</td>
            </tr>
            <tr>
                <td>Dispositifs actifs</td>
                <td>{{ dispositifs|selectattr('statut', '==', 'actif')|list|length }}</td>
            </tr>
            <tr>
                <td>Dispositifs avec plan d'action</td>
                <td>{{ dispositifs|selectattr('plan_action_id')|list|length }}</td>
            </tr>
        </table>
    </div>

    <!-- Footer -->
    <div id="footerContent" class="footer">
        Rapport g√©n√©r√© automatiquement - Page <pdf:pagenumber> / <pdf:pagecount>
    </div>
</body>
</html>