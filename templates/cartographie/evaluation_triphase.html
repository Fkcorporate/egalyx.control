{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       STYLES SPÉCIFIQUES - ÉVALUATION TRIPHASÉE
       HARMONISÉ AVEC DETAIL_RISQUE.HTML
       ============================================ */
    
    /* Variables de base - reprises de detail_risque.html */
    :root {
        --fk-navy: #0A1929;
        --fk-blue: #1A3C6B;
        --fk-accent: #0066CC;
        --fk-light-blue: #3B82F6;
        --fk-steel: #334155;
        --fk-platinum: #F8FAFC;
        --fk-success: #0D9488;
        --fk-warning: #F59E0B;
        --fk-error: #DC2626;
        --fk-gold: #D4AF37;
        
        --primary-gradient: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        --accent-gradient: linear-gradient(135deg, #0066CC 0%, #3B82F6 100%);
        
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
        --shadow-hard: 0 12px 50px rgba(0, 0, 0, 0.2);
        
        --radius-lg: 20px;
        --radius-md: 12px;
        --radius-sm: 8px;
        
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Variables sémantiques - mode clair */
    body {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #334155;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --card-bg: #ffffff;
        --hover-bg: #f1f5f9;
    }

    /* Mode sombre */
    [data-bs-theme="dark"] body {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #334155;
        --card-bg: #1e293b;
        --hover-bg: #334155;
    }

    /* Conteneur principal */
    .detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* En-tête de page */
    .page-header {
        background: var(--primary-gradient);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: rotate(25deg);
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: rotate(-15deg);
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        color: white;
    }

    .page-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Boutons dans l'en-tête */
    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Boutons modernes */
    .fk-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-smooth);
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
    }

    .fk-btn-primary {
        background: var(--accent-gradient);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .fk-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
    }

    .fk-btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .fk-btn-secondary:hover {
        background: var(--hover-bg);
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
    }

    .fk-btn-success {
        background: linear-gradient(135deg, var(--fk-success), #0f766e);
        color: white;
    }

    .fk-btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(13, 148, 136, 0.4);
    }

    .fk-btn-warning {
        background: linear-gradient(135deg, var(--fk-warning), #d97706);
        color: white;
    }

    .fk-btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
    }

    .fk-btn-info {
        background: linear-gradient(135deg, var(--fk-accent), var(--fk-light-blue));
        color: white;
    }

    .fk-btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 102, 204, 0.4);
    }

    .fk-btn-outline {
        background: transparent;
        border: 2px solid var(--border-color);
        color: var(--text-primary);
    }

    .fk-btn-outline:hover {
        border-color: var(--fk-accent);
        color: var(--fk-accent);
        background: var(--hover-bg);
    }

    /* Cartes modernes */
    .fk-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
        transition: var(--transition-smooth);
    }

    .fk-card:hover {
        box-shadow: var(--shadow-medium);
    }

    .fk-card-header {
        background: var(--bg-secondary);
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .fk-card-header h6 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .fk-card-header i {
        color: var(--fk-accent);
    }

    .fk-card-body {
        padding: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    /* Onglets */
    .nav-pills-modern {
        gap: 0.5rem;
    }

    .nav-pills-modern .nav-link {
        border-radius: var(--radius-sm);
        padding: 1rem;
        margin: 0;
        transition: var(--transition-smooth);
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-weight: 500;
        border: 1px solid var(--border-color);
    }

    .nav-pills-modern .nav-link:hover {
        background: var(--hover-bg);
        transform: translateY(-2px);
    }

    .nav-pills-modern .nav-link.active {
        background: var(--accent-gradient);
        color: white;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .nav-pills-modern .nav-link small {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    /* Baromètre horizontal avec cotations */
    .barometre-container {
        padding: 1rem 0;
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        height: 100%;
    }

    .barometre-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        margin-bottom: 1rem;
    }

    .barometre-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .barometre-title h6 {
        margin: 0;
        font-weight: 600;
        color: var(--text-primary);
    }

    .barometre-value {
        font-size: 1.1rem;
        font-weight: 700;
        padding: 0.25rem 0.75rem;
        background: var(--card-bg);
        border-radius: 50px;
        border: 1px solid var(--border-color);
    }

    .barometre-echelles-horizontal {
        display: flex;
        justify-content: space-between;
        gap: 0.25rem;
        padding: 0 1rem;
        margin-bottom: 0.5rem;
    }

    .echelle-item-horizontal {
        flex: 1;
        text-align: center;
        cursor: pointer;
        transition: var(--transition-smooth);
        padding: 0.5rem 0.25rem;
        border-radius: var(--radius-sm);
        background: var(--card-bg);
        border: 1px solid transparent;
    }

    .echelle-item-horizontal:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
        border-color: var(--fk-accent);
    }

    .echelle-item-horizontal.active {
        background: linear-gradient(135deg, var(--fk-accent), var(--fk-light-blue));
        color: white;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }

    .echelle-niveau-horizontal {
        width: 100%;
        height: 24px;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        transition: var(--transition-smooth);
    }

    .echelle-item-horizontal.active .echelle-niveau-horizontal {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .echelle-label-horizontal {
        font-size: 1rem;
        font-weight: 700;
        color: inherit;
    }

    .echelle-item-horizontal.active .echelle-label-horizontal {
        color: white;
    }

    .barometre-legende {
        display: flex;
        justify-content: space-between;
        padding: 0 1rem;
        margin-bottom: 0.75rem;
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    .barometre-description {
        padding: 0.75rem 1rem;
        margin: 0.5rem 1rem 0;
        background: var(--card-bg);
        border-radius: var(--radius-sm);
        font-size: 0.85rem;
        color: var(--text-primary);
        border-left: 3px solid var(--fk-accent);
    }

    /* Badges */
    .badge-modern {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid transparent;
    }

    .badge-success {
        background: var(--fk-success);
        color: white;
    }

    .badge-warning {
        background: var(--fk-warning);
        color: white;
    }

    .badge-danger {
        background: var(--fk-error);
        color: white;
    }

    .badge-info {
        background: var(--fk-accent);
        color: white;
    }

    .badge-secondary {
        background: var(--text-muted);
        color: white;
    }

    /* Barres de progression */
    .progress-modern {
        background: var(--border-color);
        border-radius: 50px;
        height: 8px;
        overflow: hidden;
        width: 100%;
    }

    .progress-modern-bar {
        height: 100%;
        border-radius: 50px;
        transition: width 0.3s ease;
    }

    .progress-modern-bar.success { background: var(--fk-success); }
    .progress-modern-bar.warning { background: var(--fk-warning); }
    .progress-modern-bar.danger { background: var(--fk-error); }

    /* Cartes de dispositifs */
    .dispositif-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        transition: var(--transition-smooth);
        height: 100%;
    }

    .dispositif-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
        border-color: var(--fk-accent);
    }

    .dispositif-card.border-success { border-left: 4px solid var(--fk-success); }
    .dispositif-card.border-warning { border-left: 4px solid var(--fk-warning); }
    .dispositif-card.border-danger { border-left: 4px solid var(--fk-error); }

    /* Mini matrice */
    #matriceCanvas {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        max-width: 100%;
        height: auto;
    }

    /* Formulaires */
    .fk-form-control {
        width: 100%;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        transition: var(--transition-smooth);
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .fk-form-control:focus {
        border-color: var(--fk-accent);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        outline: none;
    }

    .fk-form-select {
        width: 100%;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
    }

    .fk-form-select:focus {
        border-color: var(--fk-accent);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    /* Alertes */
    .fk-alert {
        border-radius: var(--radius-sm);
        padding: 1rem 1.25rem;
        border: none;
        border-left: 4px solid;
        margin-bottom: 1rem;
    }

    .fk-alert-info {
        background: rgba(0, 102, 204, 0.1);
        border-left-color: var(--fk-accent);
        color: var(--text-primary);
    }

    .fk-alert-warning {
        background: rgba(245, 158, 11, 0.1);
        border-left-color: var(--fk-warning);
        color: var(--text-primary);
    }

    .fk-alert-success {
        background: rgba(13, 148, 136, 0.1);
        border-left-color: var(--fk-success);
        color: var(--text-primary);
    }

    /* Guide modal */
    .guide-section {
        margin-bottom: 2rem;
    }

    .echelle-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
    }

    .echelle-niveau {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 0.75rem;
    }

    .echelle-label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .echelle-description {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-left: 2.75rem;
        margin-top: -0.25rem;
        margin-bottom: 0.5rem;
    }

    /* Breadcrumb */
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 0.5rem;
    }

    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: var(--transition-smooth);
    }

    .breadcrumb-item a:hover {
        color: white;
    }

    .breadcrumb-item.active {
        color: white;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }

    /* Dropdown */
    .fk-dropdown-toggle {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-smooth);
        cursor: pointer;
        font-size: 0.9rem;
    }

    .fk-dropdown-toggle:hover {
        background: var(--hover-bg);
        border-color: var(--fk-accent);
    }

    .fk-dropdown-toggle::after {
        display: inline-block;
        margin-left: 0.5rem;
        vertical-align: middle;
        content: "";
        border-top: 0.3em solid;
        border-right: 0.3em solid transparent;
        border-bottom: 0;
        border-left: 0.3em solid transparent;
    }

    .fk-dropdown-menu {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-medium);
        padding: 0.5rem;
        min-width: 200px;
    }

    .fk-dropdown-item {
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        transition: var(--transition-smooth);
        cursor: pointer;
        text-decoration: none;
        display: block;
    }

    .fk-dropdown-item:hover {
        background: var(--hover-bg);
        color: var(--fk-accent);
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: slideIn 0.5s ease forwards;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .detail-container {
            padding: 1rem;
        }

        .page-header {
            padding: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .barometre-echelles-horizontal {
            flex-wrap: wrap;
        }

        .echelle-item-horizontal {
            min-width: 18%;
        }

        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .header-actions .fk-btn {
            width: 100%;
            justify-content: center;
        }

        .nav-pills-modern {
            flex-direction: column;
        }
    }
</style>

<div class="detail-container">
    <!-- En-tête de page -->
    <div class="page-header animate-in">
        <div class="page-header-content">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_cartographie', id=risque.cartographie_id) }}">{{ risque.cartographie.nom }}</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_risque', id=risque.id) }}">{{ risque.reference }}</a></li>
                            <li class="breadcrumb-item active">Évaluation Triphasée</li>
                        </ol>
                    </nav>
                    
                    <h1 class="page-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        Évaluation Triphasée
                    </h1>
                    <p class="page-subtitle">{{ risque.reference }} - {{ risque.intitule }}</p>
                </div>
                
                <div class="col-auto">
                    <div class="header-actions">
                        <a href="{{ url_for('detail_risque', id=risque.id) }}" class="fk-btn fk-btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Retour
                        </a>
                        
                        <div class="dropdown">
                            <button class="fk-dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-download me-1"></i> Exporter
                            </button>
                            <ul class="dropdown-menu fk-dropdown-menu">
                                <li>
                                    <a class="fk-dropdown-item" href="{{ url_for('export_evaluations_triphase_excel') }}">
                                        <i class="fas fa-file-excel me-2 text-success"></i> Excel Complet
                                    </a>
                                </li>
                                <li>
                                    <a class="fk-dropdown-item" href="#" onclick="exporterEvaluationCourante()">
                                        <i class="fas fa-file-pdf me-2 text-danger"></i> PDF Évaluation
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <button type="button" class="fk-btn fk-btn-info" data-bs-toggle="modal" data-bs-target="#guideModal">
                            <i class="fas fa-question-circle me-1"></i> Guide
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sélecteur de risque -->
    <div class="fk-card animate-in">
        <div class="fk-card-body py-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label class="form-label fw-bold mb-1">Risque à évaluer</label>
                    <select class="fk-form-select" id="selectRisque" onchange="changerRisque()">
                        {% for r in risques_cartographie %}
                        <option value="{{ r.id }}" {% if r.id == risque.id %}selected{% endif %} 
                            data-archived="{{ r.is_archived|default(false) }}">
                            {{ r.reference }} - {{ r.intitule }}
                            {% if r.is_archived %}(Archivé){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-8">
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="badge-modern">{{ risque.categorie }}</span>
                        <span class="badge-modern badge-info">{{ risque.type_risque or 'Type non défini' }}</span>
                        {% if risque.processus_concerne %}
                        <span class="badge-modern">{{ risque.processus_concerne }}</span>
                        {% endif %}
                        {% if risque.is_archived %}
                        <span class="badge-modern badge-warning">Archivé</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne principale - Processus d'évaluation -->
        <div class="col-lg-8">
            <div class="fk-card animate-in">
                <div class="fk-card-header">
                    <ul class="nav nav-pills-modern nav-fill w-100" id="evaluationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="phase1-tab" data-bs-toggle="pill" data-bs-target="#phase1" type="button" role="tab">
                                <i class="fas fa-search me-2"></i>Phase 1<br>
                                <small>Pré-évaluation</small>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="phase2-tab" data-bs-toggle="pill" data-bs-target="#phase2" type="button" role="tab">
                                <i class="fas fa-check-circle me-2"></i>Phase 2<br>
                                <small>Validation</small>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="phase3-tab" data-bs-toggle="pill" data-bs-target="#phase3" type="button" role="tab">
                                <i class="fas fa-flag me-2"></i>Phase 3<br>
                                <small>Confirmation</small>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="fk-card-body">
                    <div class="tab-content" id="evaluationTabsContent">
                        <!-- PHASE 1 - Pré-évaluation avec baromètres alignés et cotations -->
                        <div class="tab-pane fade show active" id="phase1" role="tabpanel">
                            <form method="POST" id="phase1Form">
                                {{ form.csrf_token }}
                                <input type="hidden" name="phase" value="1">

                                <!-- Baromètres alignés horizontalement avec cotations -->
                                <div class="row mb-4">
                                    <!-- Impact Potentiel -->
                                    <div class="col-md-4">
                                        <div class="barometre-container">
                                            <div class="barometre-header">
                                                <div class="barometre-title">
                                                    <i class="fas fa-bullseye" style="color: #0066CC;"></i>
                                                    <h6>Impact Potentiel</h6>
                                                </div>
                                                <span class="barometre-value" id="impactValue">
                                                    {% if evaluation_en_cours and evaluation_en_cours.impact_pre %}
                                                        {{ evaluation_en_cours.impact_pre }}/5
                                                    {% else %}
                                                        -/5
                                                    {% endif %}
                                                </span>
                                            </div>
                                            
                                            <!-- Barre horizontale avec les 5 niveaux -->
                                            <div class="barometre-echelles-horizontal">
                                                {% for i in range(1, 6) %}
                                                <div class="echelle-item-horizontal {% if evaluation_en_cours and evaluation_en_cours.impact_pre == i %}active{% endif %}" 
                                                     data-value="{{ i }}" data-type="impact">
                                                    <div class="echelle-niveau-horizontal" 
                                                         style="background-color: {{ get_niveau_couleur('impact', i) }};"></div>
                                                    <div class="echelle-label-horizontal">
                                                        {{ i }}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            
                                            <!-- Légende des cotations -->
                                            <div class="barometre-legende">
                                                <span>Très faible</span>
                                                <span>Faible</span>
                                                <span>Modéré</span>
                                                <span>Élevé</span>
                                                <span>Critique</span>
                                            </div>
                                            
                                            <input type="hidden" name="impact_pre" id="impactInput" 
                                                   value="{{ evaluation_en_cours.impact_pre if evaluation_en_cours }}">
                                            
                                            <div class="barometre-description" id="impactDescription">
                                                {% if evaluation_en_cours and evaluation_en_cours.impact_pre %}
                                                    {{ get_niveau_description('impact', evaluation_en_cours.impact_pre) }}
                                                {% else %}
                                                    Sélectionnez le niveau d'impact
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Probabilité -->
                                    <div class="col-md-4">
                                        <div class="barometre-container">
                                            <div class="barometre-header">
                                                <div class="barometre-title">
                                                    <i class="fas fa-chart-line" style="color: #F59E0B;"></i>
                                                    <h6>Probabilité</h6>
                                                </div>
                                                <span class="barometre-value" id="probabiliteValue">
                                                    {% if evaluation_en_cours and evaluation_en_cours.probabilite_pre %}
                                                        {{ evaluation_en_cours.probabilite_pre }}/5
                                                    {% else %}
                                                        -/5
                                                    {% endif %}
                                                </span>
                                            </div>
                                            
                                            <!-- Barre horizontale avec les 5 niveaux -->
                                            <div class="barometre-echelles-horizontal">
                                                {% for i in range(1, 6) %}
                                                <div class="echelle-item-horizontal {% if evaluation_en_cours and evaluation_en_cours.probabilite_pre == i %}active{% endif %}" 
                                                     data-value="{{ i }}" data-type="probabilite">
                                                    <div class="echelle-niveau-horizontal" 
                                                         style="background-color: {{ get_niveau_couleur('probabilite', i) }};"></div>
                                                    <div class="echelle-label-horizontal">
                                                        {{ i }}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            
                                            <!-- Légende des cotations -->
                                            <div class="barometre-legende">
                                                <span>Très rare</span>
                                                <span>Rare</span>
                                                <span>Possible</span>
                                                <span>Probable</span>
                                                <span>Très probable</span>
                                            </div>
                                            
                                            <input type="hidden" name="probabilite_pre" id="probabiliteInput" 
                                                   value="{{ evaluation_en_cours.probabilite_pre if evaluation_en_cours }}">
                                            
                                            <div class="barometre-description" id="probabiliteDescription">
                                                {% if evaluation_en_cours and evaluation_en_cours.probabilite_pre %}
                                                    {{ get_niveau_description('probabilite', evaluation_en_cours.probabilite_pre) }}
                                                {% else %}
                                                    Sélectionnez la probabilité
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Niveau de Maîtrise -->
                                    <div class="col-md-4">
                                        <div class="barometre-container">
                                            <div class="barometre-header">
                                                <div class="barometre-title">
                                                    <i class="fas fa-shield-alt" style="color: #0D9488;"></i>
                                                    <h6>Niveau de Maîtrise</h6>
                                                </div>
                                                <span class="barometre-value" id="maitriseValue">
                                                    {% if evaluation_en_cours and evaluation_en_cours.niveau_maitrise_pre %}
                                                        {{ evaluation_en_cours.niveau_maitrise_pre }}/5
                                                    {% else %}
                                                        -/5
                                                    {% endif %}
                                                </span>
                                            </div>
                                            
                                            <!-- Barre horizontale avec les 5 niveaux (ordre inversé car 1 = meilleure maîtrise) -->
                                            <div class="barometre-echelles-horizontal">
                                                {% for i in range(1, 6) %}
                                                {% set maitrise_order = 6 - i if get_parametres_evaluation().get('maitrise_inverse', True) else i %}
                                                <div class="echelle-item-horizontal {% if evaluation_en_cours and evaluation_en_cours.niveau_maitrise_pre == i %}active{% endif %}" 
                                                     data-value="{{ i }}" data-type="maitrise">
                                                    <div class="echelle-niveau-horizontal" 
                                                         style="background-color: {{ get_niveau_couleur('maitrise', maitrise_order) }};"></div>
                                                    <div class="echelle-label-horizontal">
                                                        {{ i }}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            
                                            <!-- Légende des cotations (inversée car 1 = optimal) -->
                                            <div class="barometre-legende">
                                                <span>Optimale</span>
                                                <span>Forte</span>
                                                <span>Moyenne</span>
                                                <span>Faible</span>
                                                <span>Inexistante</span>
                                            </div>
                                            
                                            <input type="hidden" name="niveau_maitrise_pre" id="maitriseInput" 
                                                   value="{{ evaluation_en_cours.niveau_maitrise_pre if evaluation_en_cours and evaluation_en_cours.niveau_maitrise_pre else 3 }}">
                                            
                                            <div class="barometre-description" id="maitriseDescription">
                                                {% if evaluation_en_cours and evaluation_en_cours.niveau_maitrise_pre %}
                                                    {{ get_niveau_description('maitrise', evaluation_en_cours.niveau_maitrise_pre) }}
                                                {% else %}
                                                    Niveau de contrôle existant
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Référent Pré-évaluation</label>
                                            <select class="fk-form-select" name="referent_pre_evaluation_id">
                                                <option value="0">Sélectionnez un référent...</option>
                                                {% for user in referents %}
                                                <option value="{{ user.id }}" {% if evaluation_en_cours and evaluation_en_cours.referent_pre_evaluation_id == user.id %}selected{% endif %}>
                                                    {{ user.nom_complet if user.nom_complet else user.username }} - {{ user.role }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Score Calculé</label>
                                            <div class="bg-light p-3 rounded text-center">
                                                <div class="h2 mb-1" id="scoreAffiche">
                                                    {% if evaluation_en_cours and evaluation_en_cours.impact_pre and evaluation_en_cours.probabilite_pre %}
                                                        {{ evaluation_en_cours.impact_pre * evaluation_en_cours.probabilite_pre }}
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </div>
                                                <span class="badge-modern" id="niveauAffiche">
                                                    {% if evaluation_en_cours and evaluation_en_cours.niveau_risque %}
                                                        {{ evaluation_en_cours.niveau_risque }}
                                                    {% else %}
                                                        Non évalué
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Commentaire Pré-évaluation</label>
                                    <textarea class="fk-form-control" name="commentaire_pre_evaluation" rows="3" placeholder="Observations, justifications, éléments contextuels...">{{ evaluation_en_cours.commentaire_pre_evaluation if evaluation_en_cours }}</textarea>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    {% if evaluation_en_cours and evaluation_en_cours.date_pre_evaluation %}
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ evaluation_en_cours.date_pre_evaluation.strftime('%d/%m/%Y à %H:%M') }}
                                        {% if evaluation_en_cours.referent_pre_evaluation %}
                                        par {{ evaluation_en_cours.referent_pre_evaluation.nom_complet if evaluation_en_cours.referent_pre_evaluation.nom_complet else evaluation_en_cours.referent_pre_evaluation.username }}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                    <button type="submit" name="submit_phase" value="phase1" class="fk-btn fk-btn-primary">
                                        <i class="fas fa-save me-2"></i>Enregistrer la Pré-évaluation
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- PHASE 2 - Validation -->
                        <div class="tab-pane fade" id="phase2" role="tabpanel">
                            <form method="POST" id="phase2Form">
                                {{ form.csrf_token }}
                                <input type="hidden" name="phase" value="2">
                                
                                {% if evaluation_en_cours and evaluation_en_cours.date_pre_evaluation %}
                                <div class="fk-alert fk-alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Pré-évaluation réalisée le {{ evaluation_en_cours.date_pre_evaluation.strftime('%d/%m/%Y') }}
                                    {% if evaluation_en_cours.referent_pre_evaluation %}
                                    par {{ evaluation_en_cours.referent_pre_evaluation.nom_complet if evaluation_en_cours.referent_pre_evaluation.nom_complet else evaluation_en_cours.referent_pre_evaluation.username }}
                                    {% endif %}
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="fk-card">
                                            <div class="fk-card-header bg-secondary">
                                                <h6 class="mb-0">Pré-évaluation</h6>
                                            </div>
                                            <div class="fk-card-body text-center">
                                                <div class="row">
                                                    <div class="col-4">
                                                        <small class="text-muted">Impact</small>
                                                        <div class="h5">{{ evaluation_en_cours.impact_pre }}/5</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">Probabilité</small>
                                                        <div class="h5">{{ evaluation_en_cours.probabilite_pre }}/5</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">Score</small>
                                                        <div class="h5">{{ evaluation_en_cours.impact_pre * evaluation_en_cours.probabilite_pre }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="fk-card">
                                            <div class="fk-card-header bg-secondary">
                                                <h6 class="mb-0">Validation</h6>
                                            </div>
                                            <div class="fk-card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">Impact ajusté</label>
                                                        <select class="fk-form-select" name="impact_val" onchange="calculerScorePhase2()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.impact_val == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">Probabilité ajustée</label>
                                                        <select class="fk-form-select" name="probabilite_val" onchange="calculerScorePhase2()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.probabilite_val == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Niveau de Maîtrise ajusté</label>
                                            <select class="fk-form-select" name="niveau_maitrise_val">
                                                <option value="0">Identique</option>
                                                {% for i in range(1, 6) %}
                                                <option value="{{ i }}" {% if evaluation_en_cours.niveau_maitrise_val == i %}selected{% endif %}>{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Statut de Validation</label>
                                            <select class="fk-form-select" name="statut_validation" required>
                                                <option value="en_attente" {% if evaluation_en_cours.statut_validation == 'en_attente' %}selected{% endif %}>En attente</option>
                                                <option value="valide" {% if evaluation_en_cours.statut_validation == 'valide' %}selected{% endif %}>Validé</option>
                                                <option value="a_revoir" {% if evaluation_en_cours.statut_validation == 'a_revoir' %}selected{% endif %}>À revoir</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Commentaire Validation</label>
                                    <textarea class="fk-form-control" name="commentaire_validation" rows="3" placeholder="Justification des ajustements, analyse complémentaire...">{{ evaluation_en_cours.commentaire_validation if evaluation_en_cours }}</textarea>
                                </div>

                                <!-- Résultat Phase 2 -->
                                <div class="fk-card border-warning mb-4" id="resultatPhase2">
                                    <div class="fk-card-header bg-warning text-white">
                                        <h6 class="mb-0">Résultat de Validation</h6>
                                    </div>
                                    <div class="fk-card-body text-center">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <small class="text-muted">Impact Final</small>
                                                <div class="h4" id="impactFinal2">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Probabilité Finale</small>
                                                <div class="h4" id="probabiliteFinale2">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Score Final</small>
                                                <div class="h4" id="scoreFinal2">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Niveau</small>
                                                <div class="h4"><span class="badge-modern" id="niveauFinal2">-</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    {% if evaluation_en_cours and evaluation_en_cours.date_validation %}
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ evaluation_en_cours.date_validation.strftime('%d/%m/%Y à %H:%M') }}
                                        {% if evaluation_en_cours.validateur %}
                                        par {{ evaluation_en_cours.validateur.nom_complet if evaluation_en_cours.validateur.nom_complet else evaluation_en_cours.validateur.username }}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                    <button type="submit" name="submit_phase" value="phase2" class="fk-btn fk-btn-warning">
                                        <i class="fas fa-check-double me-2"></i>Valider l'Évaluation
                                    </button>
                                </div>

                                {% else %}
                                <div class="fk-alert fk-alert-warning text-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    La Phase 1 (Pré-évaluation) doit être complétée avant de pouvoir valider.
                                </div>
                                {% endif %}
                            </form>
                        </div>

                        <!-- PHASE 3 - Confirmation -->
                        <div class="tab-pane fade" id="phase3" role="tabpanel">
                            <form method="POST" id="phase3Form">
                                {{ form.csrf_token }}
                                <input type="hidden" name="phase" value="3">
                                
                                {% if evaluation_en_cours and evaluation_en_cours.date_validation %}
                                <div class="fk-alert fk-alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Évaluation validée le {{ evaluation_en_cours.date_validation.strftime('%d/%m/%Y') }}
                                    {% if evaluation_en_cours.validateur %}
                                    par {{ evaluation_en_cours.validateur.nom_complet if evaluation_en_cours.validateur.nom_complet else evaluation_en_cours.validateur.username }}
                                    {% endif %}
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="fk-card">
                                            <div class="fk-card-header bg-secondary">
                                                <h6 class="mb-0">Pré-évaluation</h6>
                                            </div>
                                            <div class="fk-card-body text-center">
                                                <div class="h6">{{ evaluation_en_cours.impact_pre }} × {{ evaluation_en_cours.probabilite_pre }}</div>
                                                <small class="text-muted">Score: {{ evaluation_en_cours.impact_pre * evaluation_en_cours.probabilite_pre }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="fk-card">
                                            <div class="fk-card-header bg-warning">
                                                <h6 class="mb-0 text-white">Validation</h6>
                                            </div>
                                            <div class="fk-card-body text-center">
                                                {% set impact_val = evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre %}
                                                {% set prob_val = evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre %}
                                                <div class="h6">{{ impact_val }} × {{ prob_val }}</div>
                                                <small class="text-muted">Score: {{ impact_val * prob_val }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="fk-card border-primary">
                                            <div class="fk-card-header bg-primary text-white">
                                                <h6 class="mb-0">Confirmation Finale</h6>
                                            </div>
                                            <div class="fk-card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">Impact</label>
                                                        <select class="fk-form-select" name="impact_conf" onchange="calculerScorePhase3()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.impact_conf == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">Probabilité</label>
                                                        <select class="fk-form-select" name="probabilite_conf" onchange="calculerScorePhase3()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.probabilite_conf == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Niveau de Maîtrise final</label>
                                            <select class="fk-form-select" name="niveau_maitrise_conf">
                                                <option value="0">Identique</option>
                                                {% for i in range(1, 6) %}
                                                <option value="{{ i }}" {% if evaluation_en_cours.niveau_maitrise_conf == i %}selected{% endif %}>{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Campagne d'évaluation</label>
                                            <input type="text" class="fk-form-control" name="campagne_nom" value="{{ evaluation_en_cours.campagne_nom or '' }}" placeholder="Nom de la campagne...">
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Date de début</label>
                                        <input type="date" class="fk-form-control" name="campagne_date_debut" value="{{ evaluation_en_cours.campagne_date_debut or '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Date de fin</label>
                                        <input type="date" class="fk-form-control" name="campagne_date_fin" value="{{ evaluation_en_cours.campagne_date_fin or '' }}">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Objectif de la campagne</label>
                                    <textarea class="fk-form-control" name="campagne_objectif" rows="2" placeholder="Objectifs spécifiques, périmètre...">{{ evaluation_en_cours.campagne_objectif or '' }}</textarea>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Commentaire Final</label>
                                    <textarea class="fk-form-control" name="commentaire_confirmation" rows="3" placeholder="Synthèse et recommandations finales...">{{ evaluation_en_cours.commentaire_confirmation if evaluation_en_cours }}</textarea>
                                </div>

                                <!-- Résultat Final -->
                                <div class="fk-card border-primary mb-4" id="resultatPhase3">
                                    <div class="fk-card-header bg-primary text-white">
                                        <h5 class="mb-0">Résultat Final de l'Évaluation</h5>
                                    </div>
                                    <div class="fk-card-body text-center">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <small class="text-muted">Impact</small>
                                                <div class="h3 text-primary" id="impactFinal3">-</div>
                                            </div>
                                            <div class="col-md-2">
                                                <small class="text-muted">Probabilité</small>
                                                <div class="h3 text-primary" id="probabiliteFinale3">-</div>
                                            </div>
                                            <div class="col-md-2">
                                                <small class="text-muted">Score</small>
                                                <div class="h3 text-primary" id="scoreFinal3">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Niveau de Risque</small>
                                                <div class="h3"><span class="badge-modern" id="niveauFinal3">-</span></div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Position</small>
                                                <div class="h5" id="positionFinale">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    {% if evaluation_en_cours and evaluation_en_cours.date_confirmation %}
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ evaluation_en_cours.date_confirmation.strftime('%d/%m/%Y à %H:%M') }}
                                        {% if evaluation_en_cours.evaluateur_final %}
                                        par {{ evaluation_en_cours.evaluateur_final.nom_complet if evaluation_en_cours.evaluateur_final.nom_complet else evaluation_en_cours.evaluateur_final.username }}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                    <button type="submit" name="submit_phase" value="phase3" class="fk-btn fk-btn-success">
                                        <i class="fas fa-flag-checkered me-2"></i>Confirmer l'Évaluation Finale
                                    </button>
                                </div>

                                {% else %}
                                <div class="fk-alert fk-alert-warning text-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    La Phase 2 (Validation) doit être complétée avant confirmation finale.
                                </div>
                                {% endif %}
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dispositifs de maîtrise existants -->
            {% set dispositifs_risque = risque.dispositifs_maitrise|selectattr('is_archived', 'equalto', false)|list %}
            {% if dispositifs_risque %}
            <div class="fk-card animate-in mt-4">
                <div class="fk-card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Dispositifs de Maîtrise Existants
                        <span class="badge-modern ms-2">{{ dispositifs_risque|length }}</span>
                    </h6>
                </div>
                <div class="fk-card-body">
                    <div class="fk-alert fk-alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Les dispositifs de maîtrise ci-dessous peuvent influencer l'évaluation du risque.
                        Consultez leur efficacité pour affiner votre jugement.
                    </div>
                    
                    <div class="row g-3">
                        {% for dispositif in dispositifs_risque %}
                        <div class="col-md-6">
                            <div class="dispositif-card 
                                {% if dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 4 %}border-success
                                {% elif dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 3 %}border-warning
                                {% elif dispositif.efficacite_reelle %}border-danger
                                {% else %}border-secondary{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" 
                                               class="text-decoration-none fw-bold">
                                                {{ dispositif.reference }}
                                            </a>
                                        </h6>
                                        <p class="mb-2 small text-muted">{{ dispositif.nom|truncate(60) }}</p>
                                    </div>
                                    <div>
                                        {% if dispositif.type_dispositif == 'Préventif' %}
                                        <span class="badge-modern badge-success">P</span>
                                        {% elif dispositif.type_dispositif == 'Détectif' %}
                                        <span class="badge-modern badge-warning">D</span>
                                        {% else %}
                                        <span class="badge-modern badge-danger">C</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Informations d'évaluation -->
                                <div class="mt-3">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">Efficacité</small>
                                            <div class="fw-bold 
                                                {% if dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 4 %}text-success
                                                {% elif dispositif.efficacite_reelle and dispositif.efficacite_reelle >= 3 %}text-warning
                                                {% elif dispositif.efficacite_reelle %}text-danger
                                                {% else %}text-muted{% endif %}">
                                                {{ dispositif.efficacite_reelle or 'N/A' }}/5
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Couverture</small>
                                            <div class="fw-bold 
                                                {% if dispositif.couverture and dispositif.couverture >= 4 %}text-success
                                                {% elif dispositif.couverture and dispositif.couverture >= 3 %}text-warning
                                                {% elif dispositif.couverture %}text-danger
                                                {% else %}text-muted{% endif %}">
                                                {{ dispositif.couverture or 'N/A' }}/5
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Statut</small>
                                            <div>
                                                {% if dispositif.statut == 'actif' %}
                                                <span class="badge-modern badge-success">Actif</span>
                                                {% else %}
                                                <span class="badge-modern">{{ dispositif.statut }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Barre de progression -->
                                    {% if dispositif.efficacite_reelle %}
                                    <div class="mt-2">
                                        <small class="text-muted">Efficacité réelle</small>
                                        <div class="progress-modern">
                                            <div class="progress-modern-bar 
                                                {% if dispositif.efficacite_reelle >= 4 %}success
                                                {% elif dispositif.efficacite_reelle >= 3 %}warning
                                                {% else %}danger{% endif %}" 
                                                style="width: {{ (dispositif.efficacite_reelle / 5) * 100 }}%">
                                            </div>
                                        </div>
                                        {% if dispositif.efficacite_attendue %}
                                        <small class="text-muted">Attendu: {{ dispositif.efficacite_attendue }}/5</small>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Actions rapides -->
                                    <div class="mt-3 pt-2 border-top">
                                        <div class="d-flex gap-2">
                                            <a href="{{ url_for('detail_dispositif', dispositif_id=dispositif.id) }}" 
                                               class="btn-action info" title="Voir détails">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('evaluer_dispositif', dispositif_id=dispositif.id) }}" 
                                               class="btn-action warning" title="Évaluer">
                                                <i class="fas fa-chart-bar"></i>
                                            </a>
                                            {% if not dispositif.plan_action_id %}
                                            <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=risque.id) }}?dispositif_id={{ dispositif.id }}" 
                                               class="btn-action primary" title="Créer un plan">
                                                <i class="fas fa-tasks"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Synthèse des dispositifs -->
                    {% set efficacite_moyenne = dispositifs_risque|map(attribute='efficacite_reelle')|select|list|average %}
                    {% if efficacite_moyenne is not none %}
                    <div class="fk-alert mt-4 
                        {% if efficacite_moyenne >= 4 %}fk-alert-success
                        {% elif efficacite_moyenne >= 3 %}fk-alert-warning
                        {% else %}fk-alert-danger{% endif %}">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line fa-2x me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Synthèse des dispositifs</h6>
                                <p class="mb-0">
                                    <strong>Efficacité moyenne : {{ "%.1f"|format(efficacite_moyenne) }}/5</strong>
                                    <br>
                                    <small>Ces indicateurs peuvent vous aider à estimer le niveau de maîtrise du risque.</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Colonne latérale - Informations et visualisations -->
        <div class="col-lg-4">
            <!-- Fiche du risque -->
            <div class="fk-card animate-in">
                <div class="fk-card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Fiche du Risque</h6>
                </div>
                <div class="fk-card-body">
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Référence</strong>
                        <span class="h6">{{ risque.reference }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Intitulé</strong>
                        <span>{{ risque.intitule }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Catégorie</strong>
                        <span class="badge-modern">{{ risque.categorie }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Processus</strong>
                        <span>{{ risque.processus_concerne or 'Non spécifié' }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Cartographie</strong>
                        <span>{{ risque.cartographie.nom }}</span>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Statut Évaluation</strong>
                        {% if phase_actuelle == 'termine' %}
                        <span class="badge-modern badge-success">Terminée</span>
                        {% elif phase_actuelle == 'phase3' %}
                        <span class="badge-modern badge-warning">En confirmation</span>
                        {% elif phase_actuelle == 'phase2' %}
                        <span class="badge-modern badge-info">En validation</span>
                        {% else %}
                        <span class="badge-modern badge-secondary">En pré-évaluation</span>
                        {% endif %}
                    </div>

                    {% if evaluation_en_cours and evaluation_en_cours.niveau_risque %}
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Niveau Actuel</strong>
                        {% set niveau = evaluation_en_cours.niveau_risque %}
                        <span class="badge-modern badge-{{ 'danger' if niveau == 'Critique' else 'warning' if niveau == 'Élevé' else 'info' if niveau == 'Moyen' else 'success' }}">
                            {{ niveau }}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Visualisation Matrice -->
            <div class="fk-card animate-in">
                <div class="fk-card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-network me-2"></i>Position Matrice</h6>
                </div>
                <div class="fk-card-body text-center">
                    {% if evaluation_en_cours %}
                        {% set impact_final = evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre %}
                        {% set probabilite_final = evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre %}
                        {% set score_final = impact_final * probabilite_final if impact_final and probabilite_final else 0 %}
                        
                        <div id="miniMatrice" class="mb-3">
                            <canvas id="matriceCanvas" width="200" height="200" style="max-width: 100%;"></canvas>
                        </div>
                        <div class="small text-muted">
                            Score: <strong id="positionScore">{{ score_final }}</strong> | 
                            Impact: <strong id="positionImpact">{{ impact_final }}</strong> | 
                            Probabilité: <strong id="positionProbabilite">{{ probabilite_final }}</strong>
                            {% if evaluation_en_cours.impact_conf or evaluation_en_cours.probabilite_conf %}
                            <br><span class="text-success">✓ Résultat final confirmé</span>
                            {% elif evaluation_en_cours.impact_val or evaluation_en_cours.probabilite_val %}
                            <br><span class="text-warning">↳ Résultat validé</span>
                            {% else %}
                            <br><span class="text-info">↲ Pré-évaluation</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-muted">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <p class="mb-0">Complétez l'évaluation pour voir la position dans la matrice</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- KRI Associé -->
            <div class="fk-card animate-in">
                <div class="fk-card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>KRI Associé</h6>
                </div>
                <div class="fk-card-body">
                    {% if risque.kri %}
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Indicateur</strong>
                        <span>{{ risque.kri.nom }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Dernière mesure</strong>
                        {% if risque.kri.mesures %}
                        {% set derniere_mesure = risque.kri.mesures|sort(attribute='date_mesure', reverse=true)|first %}
                        <span class="h5">{{ derniere_mesure.valeur }} {{ risque.kri.unite_mesure }}</span>
                        <small class="text-muted d-block">{{ derniere_mesure.date_mesure.strftime('%d/%m/%Y') }}</small>
                        {% else %}
                        <span class="text-muted">Aucune mesure</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('liste_kri') }}" class="fk-btn fk-btn-outline w-100">
                        <i class="fas fa-external-link-alt me-1"></i>Voir le KRI
                    </a>
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <p class="mb-3">Aucun KRI associé à ce risque</p>
                        <a href="{{ url_for('nouveau_kri', risque_id=risque.id) }}" class="fk-btn fk-btn-primary w-100">
                            <i class="fas fa-plus me-1"></i>Créer un KRI
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Guide Élargi -->
<div class="modal fade" id="guideModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book me-2"></i>Guide d'Évaluation Triphasée - Référentiel Complet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Phases d'évaluation -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="fk-card border-primary">
                            <div class="fk-card-header bg-primary text-white">
                                <h6 class="mb-0">Phase 1 - Pré-évaluation</h6>
                            </div>
                            <div class="fk-card-body">
                                <p><strong>Objectif:</strong> Identification initiale du risque</p>
                                <p><strong>Acteur:</strong> Référent métier</p>
                                <p><strong>Livrable:</strong> Score préliminaire</p>
                                <p><strong>Critères:</strong> 
                                    <br>• Impact potentiel
                                    <br>• Probabilité d'occurrence  
                                    <br>• Niveau de maîtrise existant
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="fk-card border-warning">
                            <div class="fk-card-header bg-warning text-white">
                                <h6 class="mb-0">Phase 2 - Validation</h6>
                            </div>
                            <div class="fk-card-body">
                                <p><strong>Objectif:</strong> Validation et ajustement</p>
                                <p><strong>Acteur:</strong> Comité de validation</p>
                                <p><strong>Livrable:</strong> Score validé</p>
                                <p><strong>Vérifications:</strong>
                                    <br>• Cohérence des évaluations
                                    <br>• Justification des écarts
                                    <br>• Validation collégiale
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="fk-card border-success">
                            <div class="fk-card-header bg-success text-white">
                                <h6 class="mb-0">Phase 3 - Confirmation</h6>
                            </div>
                            <div class="fk-card-body">
                                <p><strong>Objectif:</strong> Finalisation et reporting</p>
                                <p><strong>Acteur:</strong> Évaluateur final</p>
                                <p><strong>Livrable:</strong> Score définitif</p>
                                <p><strong>Éléments:</strong>
                                    <br>• Consolidation finale
                                    <br>• Documentation complète
                                    <br>• Intégration reporting
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Guide détaillé des échelles d'évaluation -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">Échelles d'Évaluation Détaillées</h6>
                    </div>
                    
                    <!-- Échelle d'Impact -->
                    <div class="col-md-4">
                        <div class="fk-card h-100">
                            <div class="fk-card-header bg-primary text-white py-2">
                                <h6 class="mb-0">Impact Potentiel</h6>
                            </div>
                            <div class="fk-card-body">
                                {% for i in range(1, 6) %}
                                <div class="echelle-item">
                                    <div class="echelle-niveau" style="background-color: {{ get_niveau_couleur('impact', i) }};"></div>
                                    <div class="echelle-label">{{ i }} - {{ get_niveau_nom_court('impact', i) }}</div>
                                </div>
                                <div class="echelle-description">
                                    {{ get_niveau_description('impact', i) }}
                                </div>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Échelle de Probabilité -->
                    <div class="col-md-4">
                        <div class="fk-card h-100">
                            <div class="fk-card-header bg-warning text-white py-2">
                                <h6 class="mb-0">Probabilité d'Occurrence</h6>
                            </div>
                            <div class="fk-card-body">
                                {% for i in range(1, 6) %}
                                <div class="echelle-item">
                                    <div class="echelle-niveau" style="background-color: {{ get_niveau_couleur('probabilite', i) }};"></div>
                                    <div class="echelle-label">{{ i }} - {{ get_niveau_nom_court('probabilite', i) }}</div>
                                </div>
                                <div class="echelle-description">
                                    {{ get_niveau_description('probabilite', i) }}
                                </div>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Échelle de Maîtrise -->
                    <div class="col-md-4">
                        <div class="fk-card h-100">
                            <div class="fk-card-header bg-success text-white py-2">
                                <h6 class="mb-0">Niveau de Maîtrise</h6>
                            </div>
                            <div class="fk-card-body">
                                {% for i in range(1, 6) %}
                                <div class="echelle-item">
                                    <div class="echelle-niveau" style="background-color: {{ get_niveau_couleur('maitrise', i) }};"></div>
                                    <div class="echelle-label">{{ i }} - {{ get_niveau_nom_court('maitrise', i) }}</div>
                                </div>
                                <div class="echelle-description">
                                    {{ get_niveau_description('maitrise', i) }}
                                </div>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Matrice des risques -->
                <h6 class="mt-4 border-bottom pb-2">Matrice des Risques - Interprétation des Scores</h6>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="bg-light">
                            <tr>
                                <th>Score</th>
                                <th>Niveau</th>
                                <th>Couleur</th>
                                <th>Interprétation</th>
                                <th>Actions Recommandées</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1-4</td>
                                <td>Faible</td>
                                <td><span class="badge-modern badge-success">Vert</span></td>
                                <td>Risque acceptable - Impact limité</td>
                                <td>Surveillance standard - Documentation</td>
                            </tr>
                            <tr>
                                <td>5-10</td>
                                <td>Moyen</td>
                                <td><span class="badge-modern badge-warning">Jaune</span></td>
                                <td>Risque modéré - Surveillance nécessaire</td>
                                <td>Surveillance renforcée - Plan d'action recommandé</td>
                            </tr>
                            <tr>
                                <td>11-16</td>
                                <td>Élevé</td>
                                <td><span class="badge-modern" style="background-color: #ff8c00;">Orange</span></td>
                                <td>Risque significatif - Action corrective requise</td>
                                <td>Actions correctives immédiates - Plan de traitement</td>
                            </tr>
                            <tr>
                                <td>17-25</td>
                                <td>Critique</td>
                                <td><span class="badge-modern badge-danger">Rouge</span></td>
                                <td>Risque inacceptable - Traitement urgent</td>
                                <td>Actions immédiates - Escalade direction - Plan d'urgence</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="fk-btn fk-btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="fk-btn fk-btn-primary" onclick="imprimerGuide()">
                    <i class="fas fa-print me-2"></i>Imprimer le Guide
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Données des descriptions détaillées - CHARGÉES DYNAMIQUEMENT
    const impactDescriptions = {
        {% for i in range(1, 6) %}
        {{ i }}: "{{ get_niveau_description('impact', i)|replace('"', '\\"')|safe }}",
        {% endfor %}
    };

    const probabiliteDescriptions = {
        {% for i in range(1, 6) %}
        {{ i }}: "{{ get_niveau_description('probabilite', i)|replace('"', '\\"')|safe }}",
        {% endfor %}
    };

    const maitriseDescriptions = {
        {% for i in range(1, 6) %}
        {{ i }}: "{{ get_niveau_description('maitrise', i)|replace('"', '\\"')|safe }}",
        {% endfor %}
    };

    // ===========================
    // INITIALISATION
    // ===========================
    
    document.addEventListener('DOMContentLoaded', function() {
        initialiserBarometre();
        
        // Forcer le recalcul avec les valeurs finales
        setTimeout(() => {
            forcerRecalculAvecValeursFinales();
            dessinerMiniMatrice();
        }, 100);
        
        // Restaurer l'onglet actif
        restaurerOngletActif();
    });

    function restaurerOngletActif() {
        const activeTabId = localStorage.getItem('activeEvaluationTab');
        if (activeTabId) {
            const activeTab = document.getElementById(activeTabId);
            if (activeTab) {
                const tab = new bootstrap.Tab(activeTab);
                tab.show();
            }
        }
    }

    // ===========================
    // BAROMÈTRE
    // ===========================
    
    function initialiserBarometre() {
        document.querySelectorAll('.barometre-echelles-horizontal').forEach(barometre => {
            barometre.addEventListener('click', function(e) {
                const echelleItem = e.target.closest('.echelle-item-horizontal');
                if (echelleItem) {
                    const valeur = echelleItem.getAttribute('data-value');
                    const type = echelleItem.getAttribute('data-type');
                    
                    selectionnerEchelle(type, valeur, echelleItem);
                    calculerScorePhase1();
                }
            });
        });
        
        // Restaurer les valeurs existantes
        restaurerValeursBarometre();
    }

    function selectionnerEchelle(type, valeur, element) {
        const parent = element.closest('.barometre-echelles-horizontal');
        const elements = parent.querySelectorAll(`.echelle-item-horizontal[data-type="${type}"]`);
        elements.forEach(el => el.classList.remove('active'));
        
        element.classList.add('active');
        
        const inputId = `${type}Input`;
        document.getElementById(inputId).value = valeur;
        
        // Mettre à jour la valeur affichée
        document.getElementById(`${type}Value`).textContent = `${valeur}/5`;
        
        const descriptionId = `${type}Description`;
        let description = '';
        
        switch(type) {
            case 'impact':
                description = impactDescriptions[valeur] || '';
                break;
            case 'probabilite':
                description = probabiliteDescriptions[valeur] || '';
                break;
            case 'maitrise':
                description = maitriseDescriptions[valeur] || '';
                break;
        }
        
        document.getElementById(descriptionId).textContent = description;
    }

    function restaurerValeursBarometre() {
        const types = ['impact', 'probabilite', 'maitrise'];
        
        types.forEach(type => {
            const input = document.getElementById(`${type}Input`);
            if (input && input.value) {
                const element = document.querySelector(`.echelle-item-horizontal[data-type="${type}"][data-value="${input.value}"]`);
                if (element) {
                    selectionnerEchelle(type, input.value, element);
                }
            }
        });
    }

    // ===========================
    // CALCUL DES SCORES
    // ===========================
    
    function calculerScorePhase1() {
        const impactFinal = parseInt(document.getElementById('impactInput').value) || 0;
        const probabiliteFinale = parseInt(document.getElementById('probabiliteInput').value) || 0;
        
        if (impactFinal > 0 && probabiliteFinale > 0) {
            const score = impactFinal * probabiliteFinale;
            const niveau = calculerNiveauRisque(score);
            
            document.getElementById('scoreAffiche').textContent = score;
            document.getElementById('niveauAffiche').textContent = niveau.nom;
            document.getElementById('niveauAffiche').className = `badge-modern badge-${niveau.couleur}`;
            
            dessinerMiniMatrice(impactFinal, probabiliteFinale, score);
            
            document.getElementById('positionScore').textContent = score;
            document.getElementById('positionImpact').textContent = impactFinal;
            document.getElementById('positionProbabilite').textContent = probabiliteFinale;
        }
    }

    function calculerScorePhase2() {
        {% if evaluation_en_cours %}
            const impactFinal = {{ evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre or 0 }};
            const probabiliteFinale = {{ evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre or 0 }};
        {% else %}
            const impactFinal = 0;
            const probabiliteFinale = 0;
        {% endif %}
        
        if (impactFinal > 0 && probabiliteFinale > 0) {
            const score = impactFinal * probabiliteFinale;
            const niveau = calculerNiveauRisque(score);
            
            document.getElementById('impactFinal2').textContent = impactFinal;
            document.getElementById('probabiliteFinale2').textContent = probabiliteFinale;
            document.getElementById('scoreFinal2').textContent = score;
            document.getElementById('niveauFinal2').textContent = niveau.nom;
            document.getElementById('niveauFinal2').className = `badge-modern badge-${niveau.couleur}`;
            
            dessinerMiniMatrice(impactFinal, probabiliteFinale, score);
        }
    }

    function calculerScorePhase3() {
        {% if evaluation_en_cours %}
            const impactFinal = {{ evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre or 0 }};
            const probabiliteFinale = {{ evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre or 0 }};
        {% else %}
            const impactFinal = 0;
            const probabiliteFinale = 0;
        {% endif %}
        
        if (impactFinal > 0 && probabiliteFinale > 0) {
            const score = impactFinal * probabiliteFinale;
            const niveau = calculerNiveauRisque(score);
            
            document.getElementById('impactFinal3').textContent = impactFinal;
            document.getElementById('probabiliteFinale3').textContent = probabiliteFinale;
            document.getElementById('scoreFinal3').textContent = score;
            document.getElementById('niveauFinal3').textContent = niveau.nom;
            document.getElementById('niveauFinal3').className = `badge-modern badge-${niveau.couleur}`;
            document.getElementById('positionFinale').textContent = `Impact ${impactFinal} / Probabilité ${probabiliteFinale}`;
            
            dessinerMiniMatrice(impactFinal, probabiliteFinale, score);
        }
    }

    function calculerNiveauRisque(score) {
        if (score <= 4) return { nom: 'Faible', couleur: 'success' };
        if (score <= 10) return { nom: 'Moyen', couleur: 'warning' };
        if (score <= 16) return { nom: 'Élevé', couleur: 'danger' };
        return { nom: 'Critique', couleur: 'dark' };
    }

    function forcerRecalculAvecValeursFinales() {
        {% if evaluation_en_cours %}
            const impactFinal = {{ evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre or 0 }};
            const probabiliteFinale = {{ evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre or 0 }};
            
            if (impactFinal > 0 && probabiliteFinale > 0) {
                document.getElementById('impactInput').value = impactFinal;
                document.getElementById('probabiliteInput').value = probabiliteFinale;
                document.getElementById('maitriseInput').value = {{ evaluation_en_cours.niveau_maitrise_pre or 3 }};
                
                const types = ['impact', 'probabilite', 'maitrise'];
                const valeurs = {
                    'impact': impactFinal,
                    'probabilite': probabiliteFinale,
                    'maitrise': {{ evaluation_en_cours.niveau_maitrise_pre or 3 }}
                };
                
                types.forEach(type => {
                    const valeur = valeurs[type];
                    const element = document.querySelector(`.echelle-item-horizontal[data-type="${type}"][data-value="${valeur}"]`);
                    if (element) {
                        const parent = element.closest('.barometre-echelles-horizontal');
                        const elements = parent.querySelectorAll(`.echelle-item-horizontal[data-type="${type}"]`);
                        elements.forEach(el => el.classList.remove('active'));
                        element.classList.add('active');
                        document.getElementById(`${type}Value`).textContent = `${valeur}/5`;
                        
                        let description = '';
                        if (type === 'impact') description = impactDescriptions[valeur] || '';
                        if (type === 'probabilite') description = probabiliteDescriptions[valeur] || '';
                        if (type === 'maitrise') description = maitriseDescriptions[valeur] || '';
                        document.getElementById(`${type}Description`).textContent = description;
                    }
                });
                
                calculerScorePhase1();
                dessinerMiniMatrice(impactFinal, probabiliteFinale, impactFinal * probabiliteFinale);
            }
        {% endif %}
    }

    // ===========================
    // MATRICE
    // ===========================
    
    function dessinerMiniMatrice(impact = 0, probabilite = 0, score = 0) {
        const canvas = document.getElementById('matriceCanvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const size = 200;
        const cellSize = size / 5;
        
        canvas.width = size;
        canvas.height = size;
        
        ctx.clearRect(0, 0, size, size);
        
        // Dessiner la grille de la matrice
        for (let i = 0; i < 5; i++) {
            for (let j = 0; j < 5; j++) {
                const scoreCell = (5 - i) * (j + 1);
                const couleur = getCouleurCellule(scoreCell);
                
                ctx.fillStyle = couleur;
                ctx.fillRect(j * cellSize, i * cellSize, cellSize, cellSize);
                
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.strokeRect(j * cellSize, i * cellSize, cellSize, cellSize);
                
                ctx.fillStyle = scoreCell > 12 ? 'white' : 'black';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(
                    scoreCell.toString(), 
                    j * cellSize + cellSize / 2, 
                    i * cellSize + cellSize / 2
                );
            }
        }
        
        // Positionner le risque sur la matrice
        if (impact > 0 && probabilite > 0) {
            const x = (probabilite - 1) * cellSize + cellSize / 2;
            const y = (5 - impact) * cellSize + cellSize / 2;
            
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    }

    function getCouleurCellule(score) {
        {% set couleurs_matrise = session.get('couleurs_personnalisees', {}) %}
        if (score <= 4) return '{{ couleurs_matrise.get("matrice_faible", "#28a745") }}';
        if (score <= 10) return '{{ couleurs_matrise.get("matrice_moyen", "#ffc107") }}';  
        if (score <= 16) return '{{ couleurs_matrise.get("matrice_eleve", "#ff8c00") }}';
        return '{{ couleurs_matrise.get("matrice_critique", "#dc3545") }}';
    }

    // ===========================
    // ACTIONS
    // ===========================
    
    function changerRisque() {
        const select = document.getElementById('selectRisque');
        const selectedOption = select.options[select.selectedIndex];
        const risqueId = select.value;
        const isArchived = selectedOption.getAttribute('data-archived') === 'true';
        
        if (!isArchived) {
            window.location.href = `/risque/${risqueId}/evaluation-triphase`;
        } else {
            alert('Ce risque est archivé. Veuillez sélectionner un risque actif.');
            select.value = '{{ risque.id }}';
        }
    }

    function exporterEvaluationCourante() {
        const risqueRef = "{{ risque.reference }}";
        const risqueIntitule = "{{ risque.intitule }}";
        const dateExport = new Date().toLocaleDateString('fr-FR');
        
        const content = `
            <html>
            <head>
                <title>Évaluation ${risqueRef}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                    .section { margin-bottom: 20px; }
                    .badge { padding: 5px 10px; border-radius: 4px; color: white; font-weight: bold; }
                    .badge-faible { background: #27ae60; }
                    .badge-moyen { background: #f39c12; }
                    .badge-eleve { background: #ff8c00; }
                    .badge-critique { background: #e74c3c; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>ÉVALUATION TRIPHASÉE DU RISQUE</h1>
                    <h2>${risqueRef} - ${risqueIntitule}</h2>
                    <p>Export généré le ${dateExport}</p>
                </div>
                
                <div class="section">
                    <h3>Résultat de l'Évaluation</h3>
                    <p>Impact: ${document.getElementById('positionImpact')?.textContent || 'N/A'}</p>
                    <p>Probabilité: ${document.getElementById('positionProbabilite')?.textContent || 'N/A'}</p>
                    <p>Score: ${document.getElementById('positionScore')?.textContent || 'N/A'}</p>
                </div>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.print();
    }

    function imprimerGuide() {
        const modal = document.getElementById('guideModal');
        const modalContent = modal.querySelector('.modal-content').cloneNode(true);
        
        const footer = modalContent.querySelector('.modal-footer');
        if (footer) footer.remove();
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Guide d'Évaluation Triphasée</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .card { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; }
                    .card-header { padding: 10px; font-weight: bold; }
                    .table { width: 100%; margin-top: 15px; }
                    .echelle-item { display: flex; align-items: center; margin-bottom: 8px; }
                    .echelle-niveau { width: 20px; height: 20px; border-radius: 3px; margin-right: 10px; }
                    @media print {
                        .card { break-inside: avoid; }
                    }
                </style>
            </head>
            <body>
                <h1>Guide d'Évaluation Triphasée - Référentiel Complet</h1>
                ${modalContent.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // Sauvegarder l'onglet actif
    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('activeEvaluationTab', event.target.id);
        });
    });

    // Validation des formulaires
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Traitement...';
            }
        });
    });
</script>
{% endblock %}
