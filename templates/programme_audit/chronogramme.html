{% extends "base.html" %}

{% block title %}Chronogramme - {{ programme.nom }} - Programme d'Audit - Egalyx{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- ========== EN-T√äTE ========== -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-5">
        <div class="mb-3 mb-lg-0">
            <div class="d-flex align-items-center gap-2 mb-3">
                <a href="{{ url_for('liste_programmes_audit') }}" class="text-decoration-none" style="color: #64748b;">
                    <i class="fas fa-arrow-left me-1"></i>
                    <span class="small">{{ t("Programmes") }}</span>
                </a>
                <span class="small" style="color: #94a3b8;">/</span>
                <a href="{{ url_for('detail_programme_audit', id=programme.id) }}" class="text-decoration-none" style="color: #64748b;">
                    <span class="small">{{ programme.nom|truncate(30) }}</span>
                </a>
                <span class="small" style="color: #94a3b8;">/</span>
                <span class="small" style="color: #2563eb;">{{ t("Chronogramme") }}</span>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="p-3 rounded-2" style="background: #2563eb;">
                    <i class="fas fa-calendar-alt text-white fa-lg"></i>
                </div>
                <div>
                    <h1 class="fw-bold mt-1 mb-0" style="color: #0f172a; font-size: 2rem;">
                        {{ t("Chronogramme interactif") }}
                    </h1>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <span class="badge px-3 py-2 fw-normal" style="background: #f8fafc; color: #2563eb; border: 1px solid #e2e8f0; border-radius: 20px;">
                            <i class="fas fa-hashtag me-1" style="color: #2563eb;"></i>{{ programme.reference }}
                        </span>
                        <span class="small" style="color: #64748b;">
                            <i class="far fa-calendar me-1" style="color: #2563eb;"></i>{{ programme.annee_debut }} - {{ programme.annee_fin }}
                        </span>
                        <span class="badge px-3 py-2 fw-normal" 
                              style="background: {% if programme.statut == 'actif' %}#059669; color: white; border: 1px solid #bbf7d0;
                                     {% elif programme.statut == 'en_elaboration' %}#7c3aed; color: white; border: 1px solid #ddd6fe;
                                     {% else %}#64748b; color: white; border: 1px solid #e2e8f0;{% endif %}; border-radius: 20px;">
                            <i class="fas fa-{{ 'play-circle' if programme.statut == 'actif' else 'pen' if programme.statut == 'en_elaboration' else 'stop-circle' }} me-1"></i>
                            {{ programme.statut|replace('_', ' ')|title }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="mt-3" style="height: 3px; width: 80px; background: #2563eb; border-radius: 2px;"></div>
        </div>
        
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn px-4 py-2 dropdown-toggle d-flex align-items-center gap-2" 
                        data-bs-toggle="dropdown"
                        style="border-radius: 10px; background: white; color: #2563eb; border: 1px solid #e2e8f0;">
                    <i class="fas fa-tools" style="color: #2563eb;"></i>
                    <span class="d-none d-md-inline">{{ t("Manipuler") }}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm" style="border-radius: 12px; padding: 8px;">
                    <li>
                        <a class="dropdown-item py-2" href="#" onclick="repartirAuto(); return false;">
                            <i class="fas fa-robot me-2" style="color: #2563eb;"></i>{{ t("R√©partir automatiquement") }}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-2" href="#" onclick="equilibrerCharge(); return false;">
                            <i class="fas fa-balance-scale me-2" style="color: #b45309;"></i>{{ t("√âquilibrer la charge") }}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-2" href="#" onclick="exporterCSV(); return false;">
                            <i class="fas fa-file-csv me-2" style="color: #059669;"></i>{{ t("Exporter CSV") }}
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item py-2" href="#" onclick="resetVue(); return false;">
                            <i class="fas fa-undo-alt me-2" style="color: #64748b;"></i>{{ t("R√©initialiser") }}
                        </a>
                    </li>
                </ul>
            </div>
            
            <a href="{{ url_for('detail_programme_audit', id=programme.id) }}" 
               class="btn px-4 py-2 d-flex align-items-center gap-2"
               style="border-radius: 10px; background: white; color: #334155; border: 1px solid #e2e8f0;">
                <i class="fas fa-arrow-left" style="color: #64748b;"></i>
                <span class="d-none d-md-inline">{{ t("Retour") }}</span>
            </a>
            <button class="btn px-4 py-2 d-flex align-items-center gap-2" onclick="window.print()"
                    style="border-radius: 10px; background: white; color: #334155; border: 1px solid #e2e8f0;">
                <i class="fas fa-print" style="color: #64748b;"></i>
                <span class="d-none d-md-inline">{{ t("Imprimer") }}</span>
            </button>
        </div>
    </div>

    <!-- ========== STATISTIQUES ========== -->
    <div class="row g-4 mb-5">
        <div class="col-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("MISSIONS") }}</span>
                            <h2 class="fw-bold mb-0" style="color: #0f172a; font-size: 2rem;">{{ programme.nb_missions }}</h2>
                            <div class="mt-2">
                                <small style="color: #64748b;">
                                    <span style="color: #059669;">{{ programme.nb_missions_realisees }}</span> {{ t("termin√©es") }}
                                </small>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #e2e8f0; width: 64px; height: 64px;">
                            <i class="fas fa-clipboard-list fa-2x" style="color: #2563eb;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("CHARGE TOTALE") }}</span>
                            <h2 class="fw-bold mb-0" style="color: #0f172a; font-size: 2rem;">{{ programme.jours_audit_planifies }}j</h2>
                            <div class="mt-2">
                                <small style="color: #64748b;">{{ programme.jours_audit_realises }}j {{ t("r√©alis√©s") }}</small>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #dbeafe; width: 64px; height: 64px;">
                            <i class="fas fa-clock fa-2x" style="color: #2563eb;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("PROGRESSION") }}</span>
                            <h2 class="fw-bold mb-0" style="color: #0f172a; font-size: 2rem;">{{ programme.progression }}%</h2>
                            <div class="progress mt-2" style="height: 6px; background: #e2e8f0; border-radius: 3px; width: 80%;">
                                <div class="progress-bar" style="width: {{ programme.progression }}%; background: #059669; border-radius: 3px;"></div>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #dcfce7; width: 64px; height: 64px;">
                            <i class="fas fa-chart-line fa-2x" style="color: #059669;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("PRIORIT√âS") }}</span>
                            <div class="d-flex align-items-center gap-2 mt-2">
                                <span class="badge px-3 py-2" style="background: #b91c1c; color: white; border-radius: 20px;" title="{{ t("Critique") }}">{{ programme.missions_par_priorite.critique }}</span>
                                <span class="badge px-3 py-2" style="background: #b45309; color: white; border-radius: 20px;" title="{{ t("√âlev√©e") }}">{{ programme.missions_par_priorite.elevee }}</span>
                                <span class="badge px-3 py-2" style="background: #2563eb; color: white; border-radius: 20px;" title="{{ t("Moyenne") }}">{{ programme.missions_par_priorite.moyenne }}</span>
                                <span class="badge px-3 py-2" style="background: #64748b; color: white; border-radius: 20px;" title="{{ t("Faible") }}">{{ programme.missions_par_priorite.faible }}</span>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #fee2e2; width: 64px; height: 64px;">
                            <i class="fas fa-flag fa-2x" style="color: #b91c1c;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== CHRONOGRAMME INTERACTIF ========== -->
    <div class="row">
        <div class="col-12">
            {% if missions_par_annee %}
                {% for annee, trimestres in missions_par_annee.items()|sort %}
                <div class="card border-0 shadow-sm mb-4 chronogramme-annee" data-annee="{{ annee }}" style="border-radius: 16px; overflow: hidden;">
                    <div class="card-header bg-transparent d-flex flex-wrap justify-content-between align-items-center p-4" style="border-bottom: 1px solid #e2e8f0;">
                        <h5 class="fw-semibold mb-0" style="color: #0f172a;">
                            <i class="fas fa-calendar-alt me-2" style="color: #2563eb;"></i>{{ t("Ann√©e") }} {{ annee }}
                        </h5>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge px-3 py-2" style="background: #2563eb; color: white; border-radius: 20px;">
                                <i class="fas fa-clock me-1"></i>{{ ressources_par_periode[annee].values()|sum }} {{ t("jours") }}
                            </span>
                            <span class="badge px-3 py-2" style="background: #0891b2; color: white; border-radius: 20px;">
                                <i class="fas fa-tasks me-1"></i>{{ trimestres.values()|map('length')|sum }} {{ t("missions") }}
                            </span>
                            <button class="btn btn-sm px-3 py-2" onclick="ajouterMissionRapide({{ annee }})"
                                    style="border-radius: 8px; background: #2563eb; color: white; border: none;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="row g-4">
                            {% for trimestre in range(1, 5) %}
                                {% set missions_trimestre = trimestres.get(trimestre, []) %}
                                {% set charge_trimestre = ressources_par_periode[annee].get(trimestre, 0) %}
                                
                                <div class="col-12 col-md-6 col-lg-3">
                                    <div class="card h-100 border-0 chronogramme-trimestre"
                                         data-annee="{{ annee }}"
                                         data-trimestre="{{ trimestre }}"
                                         style="background: #f8fafc; border-radius: 12px;">
                                        
                                        <div class="card-header bg-transparent border-0 pt-3 pb-0">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0 fw-bold">
                                                    <span class="badge px-3 py-2" 
                                                          style="background: {% if trimestre == 1 %}#2563eb{% elif trimestre == 2 %}#059669{% elif trimestre == 3 %}#b45309{% else %}#0891b2{% endif %}; color: white; border-radius: 20px;">
                                                        T{{ trimestre }}
                                                    </span>
                                                </h6>
                                                <small style="color: #64748b;">
                                                    <i class="fas fa-clock me-1" style="color: #2563eb;"></i>{{ charge_trimestre }}j
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <div class="card-body pt-2 mission-dropzone" 
                                             style="min-height: 250px; max-height: 350px; overflow-y: auto; padding: 8px;"
                                             ondrop="drop(event)"
                                             ondragover="allowDrop(event)">
                                             
                                            {% if missions_trimestre %}
                                                {% for mission in missions_trimestre %}
                                                <div class="mission-item mb-2 p-3 rounded-2 border-start border-3" 
                                                     style="border-left-color: {% if mission.priorite == 'critique' %}#b91c1c{% elif mission.priorite == 'elevee' %}#b45309{% elif mission.priorite == 'moyenne' %}#2563eb{% else %}#64748b{% endif %}; background: white; cursor: {% if mission.statut == 'planifie' %}grab{% else %}default{% endif %};"
                                                     draggable="{{ 'true' if mission.statut == 'planifie' else 'false' }}"
                                                     ondragstart="drag(event)"
                                                     data-mission-id="{{ mission.id }}"
                                                     data-mission-ref="{{ mission.reference }}"
                                                     data-mission-priorite="{{ mission.priorite }}"
                                                     data-mission-statut="{{ mission.statut }}"
                                                     data-mission-responsable="{{ mission.responsable.id if mission.responsable else '' }}">
                                                    
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-center gap-2 mb-1">
                                                                {% if mission.statut == 'planifie' %}
                                                                <i class="fas fa-grip-vertical" style="color: #94a3b8; cursor: grab;"></i>
                                                                {% endif %}
                                                                <span class="fw-bold small" style="color: #0f172a;">{{ mission.reference }}</span>
                                                                <span class="badge px-2 py-1" 
                                                                      style="background: {% if mission.priorite == 'critique' %}#b91c1c{% elif mission.priorite == 'elevee' %}#b45309{% elif mission.priorite == 'moyenne' %}#2563eb{% else %}#64748b{% endif %}; color: white; font-size: 0.7rem; border-radius: 12px;">
                                                                    {{ mission.priorite[:3]|upper }}
                                                                </span>
                                                            </div>
                                                            
                                                            <small class="d-block text-truncate" style="color: #64748b; max-width: 180px;">
                                                                {{ mission.titre|truncate(30) }}
                                                            </small>
                                                            
                                                            <div class="d-flex align-items-center gap-2 mt-2">
                                                                <span class="badge px-2 py-1" 
                                                                      style="background: {% if mission.statut == 'planifie' %}#64748b{% elif mission.statut == 'en_cours' %}#2563eb{% elif mission.statut == 'termine' %}#059669{% else %}#b45309{% endif %}; color: white; font-size: 0.65rem; border-radius: 12px;">
                                                                    <i class="fas {{ 'fa-clock' if mission.statut == 'planifie' else 'fa-play-circle' if mission.statut == 'en_cours' else 'fa-check-circle' if mission.statut == 'termine' else 'fa-calendar-times' }} me-1"></i>
                                                                    {{ mission.statut[:4]|upper }}
                                                                </span>
                                                                
                                                                <small style="color: #64748b;" title="{{ t("Dur√©e estim√©e") }}">
                                                                    <i class="fas fa-hourglass-half" style="color: #64748b;"></i> {{ mission.duree_estimee }}j
                                                                </small>
                                                                
                                                                {% if mission.responsable %}
                                                                <span class="badge px-2 py-1" 
                                                                      style="background: #2563eb; color: white; font-size: 0.65rem; border-radius: 12px; cursor: pointer;"
                                                                      onclick="assignerResponsable({{ mission.id }})"
                                                                      title="{{ t("Responsable") }}: {{ mission.responsable.username }} - {{ t("Cliquer pour changer") }}">
                                                                    <i class="fas fa-user-check me-1"></i>
                                                                    {{ mission.responsable.username|truncate(10) }}
                                                                </span>
                                                                {% else %}
                                                                <span class="badge px-2 py-1" 
                                                                      style="background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; font-size: 0.65rem; border-radius: 12px; cursor: pointer;"
                                                                      onclick="assignerResponsable({{ mission.id }})"
                                                                      title="{{ t("Aucun responsable - Cliquer pour assigner") }}">
                                                                    <i class="fas fa-user-plus me-1"></i>
                                                                    {{ t("Assigner") }}
                                                                </span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="dropdown ms-2">
                                                            <button class="btn btn-sm p-0" data-bs-toggle="dropdown" style="color: #94a3b8;">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm" style="border-radius: 12px; padding: 8px;">
                                                                <li>
                                                                    <a class="dropdown-item py-2" href="#" onclick="changerDuree({{ mission.id }}); return false;">
                                                                        <i class="fas fa-clock me-2" style="color: #b45309;"></i>{{ t("Changer dur√©e") }}
                                                                    </a>
                                                                </li>
                                                                <li>
                                                                    <a class="dropdown-item py-2" href="#" onclick="assignerResponsable({{ mission.id }}); return false;">
                                                                        <i class="fas fa-user-tie me-2" style="color: #2563eb;"></i>{{ t("Assigner responsable") }}
                                                                    </a>
                                                                </li>
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li>
                                                                    <a class="dropdown-item py-2" href="#" onclick="changerStatut({{ mission.id }}, 'en_cours'); return false;">
                                                                        <i class="fas fa-play-circle me-2" style="color: #2563eb;"></i>{{ t("D√©marrer") }}
                                                                    </a>
                                                                </li>
                                                                <li>
                                                                    <a class="dropdown-item py-2" href="#" onclick="changerStatut({{ mission.id }}, 'termine'); return false;">
                                                                        <i class="fas fa-check-circle me-2" style="color: #059669;"></i>{{ t("Terminer") }}
                                                                    </a>
                                                                </li>
                                                                <li>
                                                                    <a class="dropdown-item py-2" href="#" onclick="changerStatut({{ mission.id }}, 'reporte'); return false;">
                                                                        <i class="fas fa-calendar-times me-2" style="color: #b45309;"></i>{{ t("Reporter") }}
                                                                    </a>
                                                                </li>
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li>
                                                                    <a class="dropdown-item py-2 text-danger" href="#" onclick="supprimerMission({{ mission.id }}); return false;">
                                                                        <i class="fas fa-trash me-2" style="color: #b91c1c;"></i>{{ t("Supprimer") }}
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center py-4">
                                                    <i class="fas fa-calendar-plus fa-2x mb-2" style="color: #cbd5e1;"></i>
                                                    <p class="small mb-2" style="color: #94a3b8;">{{ t("Aucune mission") }}</p>
                                                    <button class="btn btn-sm px-3 py-2" onclick="ajouterMissionRapide({{ annee }}, {{ trimestre }})"
                                                            style="border-radius: 8px; background: #2563eb; color: white; border: none;">
                                                        <i class="fas fa-plus me-1"></i>{{ t("Ajouter") }}
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="card border-0 shadow-sm p-5 text-center" style="border-radius: 16px;">
                    <div class="mb-3">
                        <i class="fas fa-calendar-alt fa-3x" style="color: #cbd5e1;"></i>
                    </div>
                    <h5 class="fw-semibold mb-2" style="color: #0f172a;">{{ t("Aucune mission planifi√©e") }}</h5>
                    <p class="mb-4" style="color: #64748b;">{{ t("Commencez par ajouter des missions ou g√©n√©rer automatiquement.") }}</p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{{ url_for('generer_missions_auto_programme', id=programme.id) }}" 
                           class="btn px-4 py-2"
                           style="border-radius: 10px; background: #7c3aed; color: white; border: none; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
                            <i class="fas fa-robot me-2"></i>{{ t("G√©n√©rer auto") }}
                        </a>
                        <button class="btn px-4 py-2" onclick="ajouterMissionRapide({{ programme.annee_debut }})"
                                style="border-radius: 10px; background: #2563eb; color: white; border: none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
                            <i class="fas fa-plus me-2"></i>{{ t("Ajouter") }}
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ========== GRAPHIQUE ========== -->
    {% if missions_par_annee %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                <div class="card-header bg-transparent p-4" style="border-bottom: 1px solid #e2e8f0;">
                    <h5 class="fw-semibold mb-0" style="color: #0f172a;">
                        <i class="fas fa-chart-bar me-2" style="color: #2563eb;"></i>
                        {{ t("Charge de travail par p√©riode") }}
                    </h5>
                </div>
                <div class="card-body p-4">
                    <canvas id="chargeChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- ========== MODAL S√âLECTION RESPONSABLE ========== -->
<div class="modal fade" id="responsableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #2563eb; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-user-tie fa-lg" style="color: #2563eb;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("S√©lectionner un responsable") }}</h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <div class="modal-body p-4">
                <!-- Barre de recherche -->
                <div class="mb-4">
                    <div class="input-group">
                        <span class="input-group-text border-0 bg-light" style="border-radius: 12px 0 0 12px;">
                            <i class="fas fa-search" style="color: #64748b;"></i>
                        </span>
                        <input type="text" class="form-control border-0 bg-light px-4 py-3" id="searchResponsable" 
                               placeholder="{{ t("Rechercher par nom, email ou d√©partement...") }}" style="border-radius: 0 12px 12px 0;">
                    </div>
                </div>
                
                <!-- Liste des utilisateurs avec loading -->
                <div id="responsableLoading" class="text-center py-4">
                    <div class="spinner-border" style="color: #2563eb;" role="status">
                        <span class="visually-hidden">{{ t("Chargement...") }}</span>
                    </div>
                    <p class="mt-2" style="color: #64748b;">{{ t("Chargement des utilisateurs...") }}</p>
                </div>
                
                <!-- Liste des r√©sultats -->
                <div id="responsableList" style="display: none;">
                    <div class="alert d-none" id="noResults" style="background: #fee2e2; color: #b91c1c; border-radius: 12px;">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ t("Aucun utilisateur trouv√©") }}
                    </div>
                    <div class="list-group" id="responsableItems" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                
                <!-- L'utilisateur actuellement s√©lectionn√© -->
                <div id="selectedResponsableInfo" class="mt-4 p-3 rounded-2" style="background: #f8fafc; display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-uppercase small fw-semibold d-block mb-2" style="color: #64748b;">{{ t("Responsable actuel") }}</small>
                            <div class="d-flex align-items-center gap-2">
                                <div class="rounded-circle p-2" style="background: #2563eb;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <span class="fw-semibold d-block" style="color: #0f172a;" id="currentResponsableName">-</span>
                                    <small style="color: #64748b;" id="currentResponsableDetail">-</small>
                                </div>
                            </div>
                        </div>
                        <button class="btn px-3 py-2" onclick="retirerResponsable()"
                                style="border-radius: 8px; background: white; color: #b91c1c; border: 1px solid #e2e8f0;">
                            <i class="fas fa-user-slash me-1"></i>{{ t("Retirer") }}
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn w-100 py-2" data-bs-dismiss="modal"
                        style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                    <i class="fas fa-times me-2"></i>{{ t("Fermer") }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ========== CONFIGURATION ==========
const API_BASE = '/api/chronogramme/v2';
let currentMissionForResponsable = null;
let responsablesList = [];

// ========== DRAG & DROP ==========
function allowDrop(e) {
    e.preventDefault();
}

function drag(e) {
    const item = e.target.closest('.mission-item');
    if (item) {
        e.dataTransfer.setData('text/plain', item.dataset.missionId);
    }
}

function drop(e) {
    e.preventDefault();
    
    const zone = e.target.closest('.mission-dropzone');
    if (!zone) return;
    
    const missionId = e.dataTransfer.getData('text/plain');
    const card = zone.closest('.chronogramme-trimestre');
    if (!card || !missionId) return;
    
    const annee = parseInt(card.dataset.annee);
    const trimestre = parseInt(card.dataset.trimestre);
    
    fetch(`${API_BASE}/mission/${missionId}/deplacer`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            annee: annee, 
            trimestre: trimestre 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ {{ t("Mission d√©plac√©e") }}', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('‚ùå ' + data.message, 'danger');
        }
    })
    .catch(() => showNotification('‚ùå {{ t("Erreur r√©seau") }}', 'danger'));
}

// ========== ACTIONS SUR LES MISSIONS ==========
function changerDuree(missionId) {
    const duree = prompt('{{ t("Nouvelle dur√©e estim√©e (en jours)") }}:', '5');
    if (!duree) return;
    
    const dureeInt = parseInt(duree);
    if (isNaN(dureeInt) || dureeInt < 1) {
        showNotification('‚ùå {{ t("Dur√©e invalide") }}', 'danger');
        return;
    }
    
    fetch(`${API_BASE}/mission/${missionId}/duree`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ duree: dureeInt })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ {{ t("Dur√©e modifi√©e") }}', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('‚ùå ' + data.message, 'danger');
        }
    })
    .catch(() => showNotification('‚ùå {{ t("Erreur r√©seau") }}', 'danger'));
}

function changerStatut(missionId, statut) {
    const confirmMessages = {
        'en_cours': '{{ t("D√©marrer la mission ?") }}',
        'termine': '{{ t("Terminer la mission ?") }}',
        'reporte': '{{ t("Reporter la mission ?") }}'
    };
    
    if (!confirm(confirmMessages[statut] || `{{ t("Changer le statut en") }} ${statut} ?`)) return;
    
    fetch(`${API_BASE}/mission/${missionId}/statut`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ statut: statut })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`‚úÖ {{ t("Mission") }} ${statut}`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('‚ùå ' + data.message, 'danger');
        }
    })
    .catch(() => showNotification('‚ùå {{ t("Erreur r√©seau") }}', 'danger'));
}

// ========== GESTION DES RESPONSABLES ==========
function chargerUtilisateurs() {
    const loading = document.getElementById('responsableLoading');
    const list = document.getElementById('responsableList');
    
    fetch('/api/chronogramme/v2/utilisateurs')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success && data.utilisateurs) {
                responsablesList = data.utilisateurs;
                afficherUtilisateurs(responsablesList);
                list.style.display = 'block';
            } else {
                list.style.display = 'block';
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('noResults').innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {{ t("Erreur") }}: ${data.message || '{{ t("Impossible de charger les utilisateurs") }}'}
                `;
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            list.style.display = 'block';
            document.getElementById('noResults').style.display = 'block';
            document.getElementById('noResults').innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ t("Erreur r√©seau") }}: ${error.message}
            `;
        });
}

function afficherUtilisateurs(utilisateurs) {
    const container = document.getElementById('responsableItems');
    const noResults = document.getElementById('noResults');
    
    if (!utilisateurs || utilisateurs.length === 0) {
        container.innerHTML = '';
        noResults.style.display = 'block';
        return;
    }
    
    noResults.style.display = 'none';
    
    let html = '';
    utilisateurs.forEach(user => {
        let roleBadge = '';
        let icon = 'fa-user';
        
        switch(user.role) {
            case 'admin':
                roleBadge = '<span class="badge ms-2" style="background: #b91c1c; color: white; border-radius: 12px;">Admin</span>';
                icon = 'fa-user-cog';
                break;
            case 'manager':
                roleBadge = '<span class="badge ms-2" style="background: #b45309; color: white; border-radius: 12px;">Manager</span>';
                icon = 'fa-user-tie';
                break;
            case 'auditeur':
                roleBadge = '<span class="badge ms-2" style="background: #2563eb; color: white; border-radius: 12px;">Auditeur</span>';
                icon = 'fa-user-check';
                break;
            case 'compliance':
                roleBadge = '<span class="badge ms-2" style="background: #059669; color: white; border-radius: 12px;">Conformit√©</span>';
                icon = 'fa-user-shield';
                break;
            default:
                roleBadge = '<span class="badge ms-2" style="background: #64748b; color: white; border-radius: 12px;">Utilisateur</span>';
        }
        
        const dept = user.department ? `<small class="d-block" style="color: #64748b;"><i class="fas fa-building me-1"></i>${user.department}</small>` : '';
        const email = user.email ? `<small style="color: #64748b;"><i class="fas fa-envelope me-1"></i>${user.email}</small>` : '';
        
        html += `
            <a href="#" class="list-group-item list-group-item-action border-0 p-3 mb-2" style="border-radius: 12px; background: #f8fafc;" onclick="selectionnerResponsable(${user.id}); return false;">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rounded-circle p-2" style="background: #2563eb;">
                            <i class="fas ${icon} text-white"></i>
                        </div>
                        <div>
                            <div class="d-flex align-items-center">
                                <span class="fw-semibold" style="color: #0f172a;">${user.display_name}</span>
                                ${roleBadge}
                            </div>
                            <small class="d-block" style="color: #64748b;">${user.username}</small>
                            ${email}
                            ${dept}
                        </div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #94a3b8;"></i>
                </div>
            </a>
        `;
    });
    
    container.innerHTML = html;
}

function initRechercheResponsable() {
    const searchInput = document.getElementById('searchResponsable');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (!searchTerm) {
            afficherUtilisateurs(responsablesList);
            return;
        }
        
        const filtered = responsablesList.filter(user => {
            return user.display_name.toLowerCase().includes(searchTerm) ||
                   user.username.toLowerCase().includes(searchTerm) ||
                   (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                   (user.department && user.department.toLowerCase().includes(searchTerm));
        });
        
        afficherUtilisateurs(filtered);
    });
}

function assignerResponsable(missionId) {
    currentMissionForResponsable = missionId;
    
    // R√©cup√©rer les infos actuelles
    const missionItem = document.querySelector(`[data-mission-id="${missionId}"]`);
    if (missionItem) {
        const responsableSpan = missionItem.querySelector('.badge[style*="background: #2563eb"]');
        if (responsableSpan) {
            const respName = responsableSpan.textContent.replace('üë§', '').trim();
            document.getElementById('currentResponsableName').textContent = respName;
            document.getElementById('selectedResponsableInfo').style.display = 'block';
        } else {
            document.getElementById('selectedResponsableInfo').style.display = 'none';
        }
    }
    
    const modal = new bootstrap.Modal(document.getElementById('responsableModal'));
    modal.show();
    
    if (responsablesList.length === 0) {
        chargerUtilisateurs();
    } else {
        document.getElementById('responsableLoading').style.display = 'none';
        document.getElementById('responsableList').style.display = 'block';
        afficherUtilisateurs(responsablesList);
    }
}

function selectionnerResponsable(userId) {
    if (!currentMissionForResponsable) return;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('responsableModal'));
    const user = responsablesList.find(u => u.id === userId);
    if (!user) return;
    
    if (!confirm(`{{ t("Assigner") }} ${user.display_name} {{ t("comme responsable ?") }}`)) return;
    
    fetch(`${API_BASE}/mission/${currentMissionForResponsable}/assigner`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ responsable_id: userId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('‚ùå ' + data.message, 'danger');
        }
    })
    .catch(() => showNotification('‚ùå {{ t("Erreur r√©seau") }}', 'danger'));
}

function retirerResponsable() {
    if (!currentMissionForResponsable) return;
    
    if (!confirm('{{ t("Retirer le responsable de cette mission ?") }}')) return;
    
    fetch(`${API_BASE}/mission/${currentMissionForResponsable}/assigner`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ responsable_id: null })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('responsableModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('‚ùå ' + data.message, 'danger');
        }
    })
    .catch(() => showNotification('‚ùå {{ t("Erreur r√©seau") }}', 'danger'));
}

// ========== ACTIONS GLOBALES ==========
function ajouterMissionRapide(annee, trimestre) {
    let url = `/programme-audit/{{ programme.id }}/mission/ajouter?annee=${annee}&redirect=chronogramme`;
    if (trimestre) url += `&trimestre=${trimestre}`;
    window.location.href = url;
}

function repartirAuto() {
    if (!confirm('{{ t("R√©partir automatiquement toutes les missions planifi√©es ?") }}')) return;
    
    fetch(`${API_BASE}/programme/{{ programme.id }}/repartition-auto`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.success ? 'success' : 'danger');
        if (data.success) setTimeout(() => location.reload(), 1500);
    })
    .catch(() => showNotification('‚ùå {{ t("Erreur r√©seau") }}', 'danger'));
}

function equilibrerCharge() {
    showNotification('‚öñÔ∏è {{ t("√âquilibrage en cours...") }}', 'info');
    repartirAuto();
}

function resetVue() {
    window.location.href = window.location.pathname;
}

function exporterCSV() {
    window.location.href = `/programme-audit/{{ programme.id }}/exporter?format=csv`;
}

function supprimerMission(missionId) {
    if (confirm('‚ö†Ô∏è {{ t("√ätes-vous s√ªr de vouloir supprimer d√©finitivement cette mission ?") }}')) {
        fetch(`/mission-audit/${missionId}/supprimer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'raison={{ t("Suppression depuis chronogramme")|urlencode }}'
        })
        .then(response => {
            if (response.ok) {
                showNotification('‚úÖ {{ t("Mission supprim√©e") }}', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                response.json().then(data => {
                    showNotification('‚ùå ' + (data.message || '{{ t("Erreur") }}'), 'danger');
                });
            }
        })
        .catch(() => showNotification('‚ùå {{ t("Erreur r√©seau") }}', 'danger'));
    }
}

// ========== GRAPHIQUE ==========
function initChart() {
    const ctx = document.getElementById('chargeChart');
    if (!ctx) return;
    
    const labels = [];
    const data = [];
    
    {% for annee in missions_par_annee.keys()|sort %}
        {% for trimestre in range(1, 5) %}
            labels.push('T{{ trimestre }} {{ annee }}');
            data.push({{ ressources_par_periode.get(annee, {}).get(trimestre, 0) }});
        {% endfor %}
    {% endfor %}
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '{{ t("Jours de mission") }}',
                data: data,
                backgroundColor: '#2563eb',
                borderColor: '#2563eb',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true,
                    grid: { color: '#e2e8f0' },
                    title: {
                        display: true,
                        text: '{{ t("Jours") }}',
                        color: '#64748b'
                    }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                tooltip: {
                    backgroundColor: '#0f172a',
                    titleColor: '#f1f5f9',
                    bodyColor: '#e2e8f0',
                    callbacks: {
                        label: function(context) {
                            return `${context.raw} {{ t("jours") }}`;
                        }
                    }
                }
            }
        }
    });
}

// ========== NOTIFICATIONS ==========
function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow`;
    notif.style.zIndex = 9999;
    notif.style.minWidth = '300px';
    notif.style.animation = 'slideIn 0.3s ease-out';
    notif.style.borderRadius = '12px';
    notif.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 4000);
}

// ========== INITIALISATION ==========
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser le graphique
    initChart();
    
    // Initialiser la recherche responsable
    initRechercheResponsable();
    
    // R√©initialiser quand le modal se ferme
    const modal = document.getElementById('responsableModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            currentMissionForResponsable = null;
            document.getElementById('searchResponsable').value = '';
            if (responsablesList.length > 0) {
                afficherUtilisateurs(responsablesList);
            }
        });
    }
    
    // V√©rifier que l'API est accessible
    fetch(`${API_BASE}/test`)
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ API Chronogramme V2 OK -', data.count, 'routes');
        })
        .catch(error => {
            console.error('‚ùå API Chronogramme V2 indisponible:', error);
        });
    
    // Tooltips Bootstrap
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        try {
            new bootstrap.Tooltip(el);
        } catch(e) {}
    });
});

// ========== STYLES DYNAMIQUES ==========
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    .mission-item {
        background: white;
        transition: all 0.2s;
        border-left-width: 4px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .mission-item:hover {
        background: #f8fafc !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transform: translateY(-2px);
    }
    .mission-dropzone {
        transition: background-color 0.2s;
    }
    .mission-dropzone:hover {
        background: #f1f5f9;
    }
    .list-group-item-action {
        transition: all 0.2s;
        cursor: pointer;
    }
    .list-group-item-action:hover {
        background: #f1f5f9 !important;
        transform: translateX(5px);
    }
    #searchResponsable:focus {
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        outline: none;
    }
    .chronogramme-trimestre .card-body::-webkit-scrollbar {
        width: 6px;
    }
    .chronogramme-trimestre .card-body::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    .chronogramme-trimestre .card-body::-webkit-scrollbar-thumb {
        background: #2563eb;
        border-radius: 3px;
    }
    
    [data-bs-theme="dark"] {
        color-scheme: dark;
    }
    
    [data-bs-theme="dark"] body {
        background: #0f172a;
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .card {
        background: #1e293b !important;
        border-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] h1, 
    [data-bs-theme="dark"] h2, 
    [data-bs-theme="dark"] h3, 
    [data-bs-theme="dark"] h4, 
    [data-bs-theme="dark"] h5, 
    [data-bs-theme="dark"] h6 {
        color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .text-muted,
    [data-bs-theme="dark"] small:not(.text-white) {
        color: #94a3b8 !important;
    }
    
    [data-bs-theme="dark"] .bg-light {
        background: #334155 !important;
    }
    
    [data-bs-theme="dark"] .mission-item {
        background: #1e293b;
        border-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] .mission-item:hover {
        background: #334155 !important;
    }
    
    [data-bs-theme="dark"] .dropdown-menu {
        background: #1e293b;
    }
    
    [data-bs-theme="dark"] .dropdown-item {
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .dropdown-item:hover {
        background: #334155;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
