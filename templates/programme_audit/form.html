{% extends "base.html" %}

{% block title %}{{ title }} - Programme d'Audit - Egalyx{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- ========== EN-TÊTE ========== -->
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <div class="d-flex align-items-center gap-3 mb-2">
                        <div class="p-3 rounded-2" style="background: #2563eb;">
                            <i class="fas fa-calendar-alt text-white fa-lg"></i>
                        </div>
                        <div>
                            <h1 class="fw-bold mt-1 mb-0" style="color: #0f172a; font-size: 2rem;">
                                {{ title }}
                            </h1>
                            <p class="mt-1 mb-0" style="color: #64748b;">
                                <i class="fas fa-info-circle me-1" style="color: #2563eb;"></i>
                                {{ t("Configuration du programme d'audit") }}
                            </p>
                        </div>
                    </div>
                    <div class="mt-3" style="height: 3px; width: 80px; background: #2563eb; border-radius: 2px;"></div>
                </div>
                
                <div>
                    <a href="{{ url_for('liste_programmes_audit') }}" class="btn px-4 py-2 d-flex align-items-center gap-2"
                       style="border-radius: 10px; background: white; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-arrow-left" style="color: #64748b;"></i>
                        <span class="d-none d-md-inline">{{ t("Retour") }}</span>
                    </a>
                </div>
            </div>

            <!-- ========== FORMULAIRE ========== -->
            <div class="card border-0 shadow-sm" style="border-radius: 16px; overflow: hidden;">
                <div class="card-header bg-transparent p-4" style="border-bottom: 1px solid #e2e8f0;">
                    <h5 class="fw-semibold mb-0" style="color: #0f172a;">
                        <i class="fas fa-edit me-2" style="color: #2563eb;"></i>
                        {{ t("Formulaire de configuration") }}
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for(request.endpoint, id=programme.id if programme else None) }}">
                        {{ form.hidden_tag() }}
                        
                        <!-- Section 1: Informations générales -->
                        <div class="mb-5">
                            <h5 class="fw-semibold mb-3 pb-2" style="color: #0f172a; border-bottom: 1px solid #e2e8f0;">
                                <i class="fas fa-info-circle me-2" style="color: #2563eb;"></i>
                                {{ t("Informations générales") }}
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.nom.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.nom(class="form-control border-0 bg-light px-4 py-3" + (" is-invalid" if form.nom.errors else ""), style="border-radius: 12px;") }}
                                    {% if form.nom.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.nom.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.periode.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.periode(class="form-select border-0 bg-light px-4 py-3" + (" is-invalid" if form.periode.errors else ""), style="border-radius: 12px;") }}
                                    {% if form.periode.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.periode.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.annee_debut.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.annee_debut(class="form-select border-0 bg-light px-4 py-3" + (" is-invalid" if form.annee_debut.errors else ""), style="border-radius: 12px;") }}
                                    {% if form.annee_debut.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.annee_debut.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.annee_fin.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.annee_fin(class="form-select border-0 bg-light px-4 py-3" + (" is-invalid" if form.annee_fin.errors else ""), style="border-radius: 12px;") }}
                                    {% if form.annee_fin.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.annee_fin.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <small class="d-block mt-2" style="color: #64748b;">
                                        <i class="fas fa-info-circle me-1" style="color: #2563eb;"></i>
                                        {{ t("Pour un programme triennal, sélectionnez l'année de fin = année début + 2") }}
                                    </small>
                                </div>
                                
                                <div class="col-12">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.description.label.text }}
                                    </label>
                                    {{ form.description(class="form-control border-0 bg-light px-4 py-3", rows="3", style="border-radius: 12px;") }}
                                    <small class="d-block mt-2" style="color: #64748b;">
                                        <i class="fas fa-info-circle me-1" style="color: #2563eb;"></i>
                                        {{ t("Décrivez les objectifs stratégiques de ce programme d'audit") }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 2: Méthode de génération -->
                        <div class="mb-5">
                            <h5 class="fw-semibold mb-3 pb-2" style="color: #0f172a; border-bottom: 1px solid #e2e8f0;">
                                <i class="fas fa-cogs me-2" style="color: #2563eb;"></i>
                                {{ t("Méthode de génération") }}
                            </h5>
                            
                            <div class="mb-4">
                                <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                    {{ form.methode_generation.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ form.methode_generation(class="form-select border-0 bg-light px-4 py-3" + (" is-invalid" if form.methode_generation.errors else ""), style="border-radius: 12px;") }}
                                {% if form.methode_generation.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.methode_generation.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Panel pour la génération automatique -->
                            <div id="panel-auto" class="card border-0 shadow-sm" style="border-radius: 12px; display: none;">
                                <div class="card-header bg-transparent p-3" style="border-bottom: 1px solid #e2e8f0;">
                                    <h6 class="fw-semibold mb-0" style="color: #0f172a;">
                                        <i class="fas fa-robot me-2" style="color: #2563eb;"></i>
                                        {{ t("Paramètres de génération automatique") }}
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                {{ form.seuil_critique(class="form-check-input", style="cursor: pointer;") }}
                                                <label class="form-check-label fw-medium" style="color: #334155;">{{ form.seuil_critique.label.text }}</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                {{ form.seuil_eleve(class="form-check-input", style="cursor: pointer;") }}
                                                <label class="form-check-label fw-medium" style="color: #334155;">{{ form.seuil_eleve.label.text }}</label>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                {{ form.inclure_risques_moyens(class="form-check-input", style="cursor: pointer;") }}
                                                <label class="form-check-label fw-medium" style="color: #334155;">{{ form.inclure_risques_moyens.label.text }}</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                {{ form.prioriser_processus_critiques(class="form-check-input", style="cursor: pointer;") }}
                                                <label class="form-check-label fw-medium" style="color: #334155;">{{ form.prioriser_processus_critiques.label.text }}</label>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12">
                                            <label class="form-label fw-semibold small text-uppercase mt-2" style="color: #64748b;">
                                                {{ form.frequence_audit_risque.label.text }}
                                            </label>
                                            {{ form.frequence_audit_risque(class="form-select border-0 bg-light px-4 py-3", style="border-radius: 12px;") }}
                                            <small class="d-block mt-2" style="color: #64748b;">
                                                <i class="fas fa-info-circle me-1" style="color: #2563eb;"></i>
                                                {{ t("Détermine la fréquence d'audit en fonction du niveau de risque") }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 3: Configuration -->
                        <div class="mb-5">
                            <h5 class="fw-semibold mb-3 pb-2" style="color: #0f172a; border-bottom: 1px solid #e2e8f0;">
                                <i class="fas fa-sliders-h me-2" style="color: #2563eb;"></i>
                                {{ t("Configuration") }}
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.frequence_audit.label.text }}
                                    </label>
                                    {{ form.frequence_audit(class="form-select border-0 bg-light px-4 py-3", style="border-radius: 12px;") }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.duree_moyenne_mission.label.text }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.duree_moyenne_mission(class="form-control border-0 bg-light px-4 py-3", style="border-radius: 12px 0 0 12px;") }}
                                        <span class="input-group-text border-0 bg-light" style="border-radius: 0 12px 12px 0;">{{ t("jours") }}</span>
                                    </div>
                                    <small class="d-block mt-2" style="color: #64748b;">
                                        <i class="fas fa-info-circle me-1" style="color: #2563eb;"></i>
                                        {{ t("Durée moyenne estimée d'une mission d'audit") }}
                                    </small>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                        {{ form.ressources_disponibles.label.text }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.ressources_disponibles(class="form-control border-0 bg-light px-4 py-3", style="border-radius: 12px 0 0 12px;") }}
                                        <span class="input-group-text border-0 bg-light" style="border-radius: 0 12px 12px 0;">{{ t("jours/homme/an") }}</span>
                                    </div>
                                    <small class="d-block mt-2" style="color: #64748b;">
                                        <i class="fas fa-info-circle me-1" style="color: #2563eb;"></i>
                                        {{ t("Capacité d'audit annuelle disponible") }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{{ url_for('liste_programmes_audit') }}" class="btn px-4 py-2 d-flex align-items-center gap-2"
                                   style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                                    <i class="fas fa-times" style="color: #64748b;"></i>
                                    {{ t("Annuler") }}
                                </a>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn px-4 py-2 d-flex align-items-center gap-2" 
                                        data-bs-toggle="modal" data-bs-target="#previewModal"
                                        style="border-radius: 10px; background: white; color: #2563eb; border: 1px solid #e2e8f0;">
                                    <i class="fas fa-eye" style="color: #2563eb;"></i>
                                    {{ t("Prévisualiser") }}
                                </button>
                                {{ form.submit(class="btn px-4 py-2 d-flex align-items-center gap-2", style="border-radius: 10px; background: #2563eb; color: white; border: none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ========== AIDE ========== -->
            <div class="card border-0 shadow-sm mt-4" style="border-radius: 16px; overflow: hidden;">
                <div class="card-header bg-transparent p-4" style="border-bottom: 1px solid #e2e8f0;">
                    <h6 class="fw-semibold mb-0" style="color: #0f172a;">
                        <i class="fas fa-question-circle me-2" style="color: #2563eb;"></i>
                        {{ t("Conseils de configuration") }}
                    </h6>
                </div>
                <div class="card-body p-4">
                    <ul class="mb-0" style="color: #334155;">
                        <li class="mb-2"><span class="fw-semibold" style="color: #2563eb;">{{ t("Génération manuelle") }}</span> : {{ t("Vous créerez chaque mission individuellement") }}</li>
                        <li class="mb-2"><span class="fw-semibold" style="color: #2563eb;">{{ t("Génération automatique") }}</span> : {{ t("Les missions seront créées automatiquement en fonction des risques identifiés") }}</li>
                        <li class="mb-2"><span class="fw-semibold" style="color: #2563eb;">{{ t("Hybride") }}</span> : {{ t("Génération automatique suivie d'ajustements manuels") }}</li>
                        <li class="mb-2">{{ t("Pour un programme triennal, planifiez les risques critiques en année 1, élevés en année 2, etc.") }}</li>
                        <li>{{ t("Adaptez les ressources disponibles à votre capacité réelle d'audit") }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== MODAL DE PRÉVISUALISATION ========== -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #2563eb; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-eye fa-lg" style="color: #2563eb;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Prévisualisation du programme") }}</h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <div class="modal-body p-4">
                <div class="d-flex align-items-start gap-3 p-3 mb-4 rounded-2" style="background: #dbeafe;">
                    <i class="fas fa-info-circle mt-1" style="color: #2563eb;"></i>
                    <div>
                        <p class="mb-0" style="color: #334155;">{{ t("Cette prévisualisation est basée sur les paramètres actuels") }}</p>
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card border-0" style="background: #f8fafc; border-radius: 12px;">
                            <div class="card-body p-3">
                                <h6 class="fw-semibold mb-3" style="color: #0f172a;">{{ t("Configuration estimée") }}</h6>
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td style="color: #64748b;">{{ t("Période") }} :</td>
                                        <td class="fw-semibold" style="color: #0f172a;" id="preview-periode">-</td>
                                    </tr>
                                    <tr>
                                        <td style="color: #64748b;">{{ t("Méthode") }} :</td>
                                        <td class="fw-semibold" style="color: #0f172a;" id="preview-methode">-</td>
                                    </tr>
                                    <tr>
                                        <td style="color: #64748b;">{{ t("Ressources") }} :</td>
                                        <td class="fw-semibold" style="color: #0f172a;" id="preview-ressources">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-0" style="background: #f8fafc; border-radius: 12px;">
                            <div class="card-body p-3">
                                <h6 class="fw-semibold mb-3" style="color: #0f172a;">{{ t("Estimation missions") }}</h6>
                                <p id="preview-estimation" class="mb-0" style="color: #64748b;">
                                    {{ t("Estimation basée sur les paramètres sélectionnés...") }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex align-items-start gap-3 mt-4 p-3 rounded-2" style="background: #fff3e0;">
                    <i class="fas fa-exclamation-triangle mt-1" style="color: #b45309;"></i>
                    <div>
                        <p class="mb-0" style="color: #334155;">{{ t("Cette estimation est indicative. La génération réelle dépendra de votre cartographie des risques.") }}</p>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn w-100 py-2" data-bs-dismiss="modal"
                        style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                    <i class="fas fa-times me-2"></i>{{ t("Fermer") }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // ========== GESTION DE L'AFFICHAGE DYNAMIQUE ==========
        function toggleAutoPanel() {
            const method = $('#methode_generation').val();
            if (method === 'auto_risques' || method === 'hybride') {
                $('#panel-auto').slideDown(300);
            } else {
                $('#panel-auto').slideUp(300);
            }
        }
        
        // Initialiser
        toggleAutoPanel();
        
        // Écouter les changements
        $('#methode_generation').change(toggleAutoPanel);
        
        // ========== PRÉVISUALISATION ==========
        $('#previewModal').on('show.bs.modal', function() {
            // Récupérer les valeurs
            const periode = $('#periode').val() === 'triennal' ? 'Triennal (3 ans)' : 'Annuel';
            const methode = $('#methode_generation option:selected').text();
            const ressources = $('#ressources_disponibles').val() || 0;
            
            // Mettre à jour la prévisualisation
            $('#preview-periode').text(periode);
            $('#preview-methode').text(methode);
            $('#preview-ressources').text(ressources);
            
            // Estimation du nombre de missions
            const dureeMoyenne = $('#duree_moyenne_mission').val() || 5;
            const annees = periode === 'Triennal (3 ans)' ? 3 : 1;
            const missionsEstimees = Math.floor((ressources * annees) / dureeMoyenne);
            
            $('#preview-estimation').html(`
                <span class="fw-semibold" style="color: #0f172a;">${missionsEstimees}</span> {{ t("missions estimées") }}<br>
                <small class="text-muted">{{ t("Basé sur") }} ${ressources} {{ t("jours/an") }} × ${annees} {{ t("an(s)") }} ÷ ${dureeMoyenne} {{ t("jours/mission") }}</small>
            `);
        });
        
        // ========== VALIDATION DES DATES ==========
        $('#annee_debut, #annee_fin').change(function() {
            const debut = parseInt($('#annee_debut').val()) || 0;
            const fin = parseInt($('#annee_fin').val()) || 0;
            const periode = $('#periode').val();
            
            if (debut && fin) {
                if (periode === 'triennal') {
                    const dureeAttendue = 2; // 3 ans = début + 2
                    if (fin - debut !== dureeAttendue) {
                        showNotification(`⚠️ {{ t("Pour un programme triennal, la durée doit être de") }} ${dureeAttendue} {{ t("ans") }} (${debut} - ${debut + dureeAttendue})`, 'warning');
                    }
                }
            }
        });

        // ========== NOTIFICATIONS ==========
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow`;
            notif.style.zIndex = 9999;
            notif.style.minWidth = '300px';
            notif.style.animation = 'slideIn 0.3s ease-out';
            notif.style.borderRadius = '12px';
            notif.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }
    });

    // ========== STYLES DYNAMIQUES ==========
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .btn, .card {
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
        }
        
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            border-color: #2563eb;
            outline: none;
        }
        
        .form-switch .form-check-input:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        
        [data-bs-theme="dark"] {
            color-scheme: dark;
        }
        
        [data-bs-theme="dark"] body {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        [data-bs-theme="dark"] .card {
            background: #1e293b !important;
            border-color: #334155 !important;
        }
        
        [data-bs-theme="dark"] h1, 
        [data-bs-theme="dark"] h5, 
        [data-bs-theme="dark"] h6 {
            color: #f1f5f9 !important;
        }
        
        [data-bs-theme="dark"] .text-muted,
        [data-bs-theme="dark"] small:not(.text-white) {
            color: #94a3b8 !important;
        }
        
        [data-bs-theme="dark"] .bg-light {
            background: #334155 !important;
        }
        
        [data-bs-theme="dark"] [style*="background: #f8fafc"] {
            background: #334155 !important;
        }
        
        [data-bs-theme="dark"] [style*="color: #0f172a"] {
            color: #f1f5f9 !important;
        }
        
        [data-bs-theme="dark"] [style*="color: #334155"] {
            color: #e2e8f0 !important;
        }
        
        [data-bs-theme="dark"] [style*="color: #64748b"] {
            color: #94a3b8 !important;
        }
        
        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select {
            background: #334155 !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }
        
        [data-bs-theme="dark"] .form-control::placeholder {
            color: #94a3b8;
        }
        
        [data-bs-theme="dark"] .input-group-text {
            background: #334155 !important;
            border-color: #475569 !important;
            color: #94a3b8 !important;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
