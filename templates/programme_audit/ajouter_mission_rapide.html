{% extends "base.html" %}

{% block title %}Ajouter une mission - {{ programme.nom }} - Egalyx{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('liste_programmes_audit') }}">Programmes</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('detail_programme_audit', id=programme.id) }}">{{ programme.nom }}</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('chronogramme_programme', id=programme.id) }}">Chronogramme</a>
                    </li>
                    <li class="breadcrumb-item active">Ajouter mission</li>
                </ol>
            </nav>
            <h1 class="h2 mb-0">
                <i class="fas fa-plus-circle text-primary me-2"></i>
                Ajouter une mission
            </h1>
            <p class="text-muted mb-0">{{ programme.nom }} - Année {{ annee }}{% if trimestre %} T{{ trimestre }}{% endif %}</p>
        </div>
        <a href="{{ url_for('chronogramme_programme', id=programme.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour
        </a>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Informations de la mission</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('ajouter_mission_programme', programme_id=programme.id) }}">
                        <input type="hidden" name="annee_prevue" value="{{ annee }}">
                        {% if trimestre %}
                        <input type="hidden" name="trimestre_prevue" value="{{ trimestre }}">
                        {% endif %}
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label fw-semibold">Titre de la mission *</label>
                                <input type="text" class="form-control" name="titre" placeholder="Ex: Audit des processus financiers" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Priorité *</label>
                                <select class="form-select" name="priorite" required>
                                    <option value="critique">Critique</option>
                                    <option value="elevee" selected>Élevée</option>
                                    <option value="moyenne">Moyenne</option>
                                    <option value="faible">Faible</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Description détaillée de la mission..."></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Durée estimée (jours)</label>
                                <input type="number" class="form-control" name="duree_estimee" value="{{ programme.duree_moyenne_mission or 5 }}" min="1" max="60">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Risque associé</label>
                                <select class="form-select" name="risque_id">
                                    <option value="">Aucun</option>
                                    {% for risque in risques_disponibles %}
                                    <option value="{{ risque.id }}">
                                        {{ risque.reference }} - {{ risque.intitule|truncate(40) }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Responsable</label>
                                <select class="form-select" name="responsable_id">
                                    <option value="">Non assigné</option>
                                    {% for user in utilisateurs %}
                                    <option value="{{ user.id }}">
                                        {{ user.nom or user.username }} {{ user.prenom or '' }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Mission planifiée en <strong>{{ annee }}</strong>{% if trimestre %} - <strong>T{{ trimestre }}</strong>{% endif %}
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('chronogramme_programme', id=programme.id) }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Créer la mission
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}