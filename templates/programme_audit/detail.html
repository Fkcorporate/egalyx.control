{% extends "base.html" %}

{% block title %}{{ programme.nom }} - Programme d'Audit - Egalyx{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- ============================================ -->
    <!-- EN-TÊTE ET ACTIONS DU PROGRAMME -->
    <!-- ============================================ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Breadcrumb et titre -->
        <div>
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('liste_programmes_audit') }}"><i class="fas fa-list"></i> Programmes</a></li>
                    <li class="breadcrumb-item active text-primary">{{ programme.nom }}</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center gap-3">
                <div class="bg-primary bg-opacity-10 p-3 rounded-3">
                    <i class="fas fa-calendar-alt fa-2x text-primary"></i>
                </div>
                <div>
                    <h1 class="h2 mb-1 fw-bold">{{ programme.nom }}</h1>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-light text-dark border">
                            <i class="fas fa-hashtag me-1"></i>{{ programme.reference }}
                        </span>
                        <span class="text-muted">
                            <i class="far fa-calendar me-1"></i>{{ programme.annee_debut }} - {{ programme.annee_fin }}
                        </span>
                        <span class="badge bg-{% if programme.statut == 'actif' %}success{% elif programme.statut == 'en_elaboration' %}warning{% else %}secondary{% endif %}">
                            {{ programme.statut|replace('_', ' ')|title }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions principales -->
        <div class="d-flex gap-2">
            <!-- Chronogramme -->
            <a href="{{ url_for('chronogramme_programme', id=programme.id) }}" 
               class="btn btn-outline-primary d-flex align-items-center gap-2">
                <i class="fas fa-calendar-week"></i>
                <span class="d-none d-md-inline">Chronogramme</span>
            </a>
            
            <!-- Export -->
            <div class="dropdown">
                <button class="btn btn-outline-success dropdown-toggle d-flex align-items-center gap-2" 
                        type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-download"></i>
                    <span class="d-none d-md-inline">Exporter</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a class="dropdown-item" href="{{ url_for('exporter_programme', id=programme.id, format='excel') }}">
                            <i class="fas fa-file-excel text-success me-2"></i>
                            Excel (.xlsx)
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('exporter_programme', id=programme.id, format='csv') }}">
                            <i class="fas fa-file-csv text-primary me-2"></i>
                            CSV
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('exporter_programme', id=programme.id, format='pdf') }}">
                            <i class="fas fa-file-pdf text-danger me-2"></i>
                            PDF
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Plan de repli -->
            <a href="{{ url_for('plan_pluie_programme', programme_id=programme.id) }}" 
               class="btn btn-outline-warning d-flex align-items-center gap-2">
                <i class="fas fa-umbrella"></i>
                <span class="d-none d-md-inline">Plan de repli</span>
            </a>
            
            <!-- Régénération automatique -->
            {% if programme.methode_generation in ['auto_risques', 'hybride'] %}
            <button class="btn btn-outline-primary d-flex align-items-center gap-2" 
                    onclick="regenererMissions({{ programme.id }}); return false;">
                <i class="fas fa-robot"></i>
                <span class="d-none d-md-inline">Régénérer</span>
            </button>
            {% endif %}
            
            <!-- Menu Actions principales -->
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle d-flex align-items-center gap-2" 
                        type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i>
                    <span class="d-none d-md-inline">Actions</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <!-- Ajouter mission -->
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" 
                           href="#" data-bs-toggle="modal" data-bs-target="#addMissionModal">
                            <i class="fas fa-plus-circle text-primary"></i>
                            Ajouter une mission
                        </a>
                    </li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <!-- Modifier -->
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" 
                           href="#" onclick="openEditModal({{ programme.id }}); return false;">
                            <i class="fas fa-edit text-primary"></i>
                            Modifier le programme
                        </a>
                    </li>
                    
                    <!-- Dupliquer -->
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" 
                           href="#" onclick="dupliquerProgramme({{ programme.id }}); return false;">
                            <i class="fas fa-copy text-info"></i>
                            Dupliquer
                        </a>
                    </li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <!-- Approuver / Désapprouver -->
                    {% if programme.statut == 'en_elaboration' %}
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2 text-success" 
                           href="#" onclick="openApproveModal({{ programme.id }}); return false;">
                            <i class="fas fa-check-circle"></i>
                            Approuver le programme
                        </a>
                    </li>
                    {% elif programme.statut == 'actif' %}
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2 text-warning" 
                           href="#" onclick="openDesapprouverModal({{ programme.id }}); return false;">
                            <i class="fas fa-ban"></i>
                            Désapprouver
                        </a>
                    </li>
                    {% endif %}
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <!-- Archiver -->
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2 text-danger" 
                           href="#" onclick="openArchiveModal({{ programme.id }}); return false;">
                            <i class="fas fa-archive"></i>
                            Archiver
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- STATISTIQUES DU PROGRAMME -->
    <!-- ============================================ -->
    <div class="row g-4 mb-4">
        <!-- Missions -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-primary border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Missions</h6>
                            <h2 class="mb-0 fw-bold">{{ programme.nb_missions }}</h2>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-check-circle text-success me-1"></i>
                                    {{ programme.nb_missions_realisees }} terminées
                                </small>
                            </div>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-clipboard-list fa-2x text-primary"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 6px;">
                        {% set progression_pourcentage = 0 %}
                        {% if programme.nb_missions > 0 %}
                            {% set progression_pourcentage = ((programme.nb_missions_realisees / programme.nb_missions) * 100)|round %}
                        {% endif %}
                        <div class="progress-bar bg-primary" style="width: {{ progression_pourcentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progression -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-success border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Progression globale</h6>
                            <h2 class="mb-0 fw-bold">{{ programme.progression }}%</h2>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-chart-line text-success me-1"></i>
                                    {{ programme.nb_missions_realisees }}/{{ programme.nb_missions }} missions
                                </small>
                            </div>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-chart-line fa-2x text-success"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: {{ programme.progression }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ressources -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-warning border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Ressources planifiées</h6>
                            <h2 class="mb-0 fw-bold">{{ programme.jours_audit_planifies }}j</h2>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock text-warning me-1"></i>
                                    {{ programme.jours_audit_realises }} jours réalisés
                                </small>
                            </div>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 6px;">
                        {% set ressources_pourcentage = 0 %}
                        {% if programme.jours_audit_planifies > 0 %}
                            {% set ressources_pourcentage = ((programme.jours_audit_realises / programme.jours_audit_planifies) * 100)|round %}
                        {% endif %}
                        <div class="progress-bar bg-warning" style="width: {{ ressources_pourcentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Méthode -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-info border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Méthode de génération</h6>
                            <h3 class="mb-0 fw-bold">
                                {{ programme.methode_generation|replace('_', ' ')|title }}
                            </h3>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-cogs text-info me-1"></i>
                                    {{ programme.periode|capitalize }}
                                </small>
                            </div>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-cogs fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- INFORMATIONS DÉTAILLÉES ET GRAPHIQUES -->
    <!-- ============================================ -->
    <div class="row g-4 mb-4">
        <!-- Description et informations -->
        <div class="col-xl-8">
            <div class="card h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Informations du programme
                    </h5>
                    <span class="badge bg-primary">
                        {{ programme.methode_generation|replace('_', ' ')|title }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Description -->
                            <div class="mb-4">
                                <h6 class="text-muted mb-2"><i class="fas fa-align-left me-2"></i>Description</h6>
                                <div class="p-3 bg-light rounded">
                                    {% if programme.description %}
                                    <p class="mb-0">{{ programme.description|nl2br }}</p>
                                    {% else %}
                                    <p class="mb-0 text-muted fst-italic">
                                        <i class="fas fa-info-circle me-2"></i>Aucune description fournie
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Configuration -->
                            <h6 class="text-muted mb-3"><i class="fas fa-cogs me-2"></i>Configuration</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless">
                                    <tbody>
                                        <tr>
                                            <td class="text-muted">Période :</td>
                                            <td class="fw-semibold">{{ programme.periode|capitalize }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Fréquence d'audit :</td>
                                            <td class="fw-semibold">{{ programme.frequence_audit|capitalize if programme.frequence_audit else 'Non spécifiée' }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Durée moyenne :</td>
                                            <td class="fw-semibold">{{ programme.duree_moyenne_mission or 'N/A' }} jours</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Ressources :</td>
                                            <td class="fw-semibold">{{ programme.ressources_disponibles or 'N/A' }} jours/homme/an</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Création -->
                            <h6 class="text-muted mb-3"><i class="fas fa-user-circle me-2"></i>Création</h6>
                            <div class="d-flex align-items-center gap-3 mb-4 p-3 bg-light rounded">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-primary"></i>
                                </div>
                                <div>
                                    <p class="mb-1 fw-semibold">{{ programme.createur.username }}</p>
                                    <p class="mb-0 text-muted small">
                                        <i class="far fa-calendar me-1"></i>
                                        Créé le {{ programme.created_at.strftime('%d/%m/%Y à %H:%M') }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Critères de génération -->
                            {% if programme.criteres_generation %}
                            <h6 class="text-muted mb-3"><i class="fas fa-filter me-2"></i>Critères de génération</h6>
                            <div class="p-3 bg-light rounded">
                                {% set criteres = programme.criteres_generation or {} %}
                                <div class="row">
                                    {% if criteres.get('seuil_critique') %}
                                    <div class="col-6 mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <small>Risques critiques</small>
                                    </div>
                                    {% endif %}
                                    {% if criteres.get('seuil_eleve') %}
                                    <div class="col-6 mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <small>Risques élevés</small>
                                    </div>
                                    {% endif %}
                                    {% if criteres.get('inclure_risques_moyens') %}
                                    <div class="col-6 mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <small>Risques moyens</small>
                                    </div>
                                    {% endif %}
                                    {% if criteres.get('prioriser_processus_critiques') %}
                                    <div class="col-6 mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <small>Processus critiques</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Répartition par priorité -->
        <div class="col-xl-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        Répartition par priorité
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-center mb-4">
                        <canvas id="prioriteChart" style="max-width: 250px; max-height: 250px;"></canvas>
                    </div>
                    
                    <div class="row g-2">
                        {% set priorites_dict = {
                            'critique': {'color': 'danger', 'icon': 'fire', 'text': 'Critique'},
                            'elevee': {'color': 'warning', 'icon': 'exclamation-triangle', 'text': 'Élevée'},
                            'moyenne': {'color': 'info', 'icon': 'minus-circle', 'text': 'Moyenne'},
                            'faible': {'color': 'secondary', 'icon': 'info-circle', 'text': 'Faible'}
                        } %}
                        
                        {% set missions_count = {'critique': 0, 'elevee': 0, 'moyenne': 0, 'faible': 0} %}
                        {% for mission in missions_data %}
                            {% if mission.priorite in missions_count %}
                                {% set _ = missions_count.update({mission.priorite: missions_count[mission.priorite] + 1}) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% for priorite_key, priorite_info in priorites_dict.items() %}
                            {% set count = missions_count[priorite_key] %}
                            {% if count > 0 %}
                            <div class="col-6">
                                <div class="p-3 rounded border border-{{ priorite_info.color }} border-2 bg-{{ priorite_info.color }} bg-opacity-5">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <div class="bg-{{ priorite_info.color }} bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-{{ priorite_info.icon }} text-{{ priorite_info.color }}"></i>
                                        </div>
                                        <div>
                                            <h4 class="mb-0 fw-bold">{{ count }}</h4>
                                            <small class="text-muted">{{ priorite_info.text }}</small>
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 4px;">
                                        {% set pourcentage = 0 %}
                                        {% if programme.nb_missions > 0 %}
                                            {% set pourcentage = (count / programme.nb_missions * 100)|round %}
                                        {% endif %}
                                        <div class="progress-bar bg-{{ priorite_info.color }}" style="width: {{ pourcentage }}%"></div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ========== BARRE DE SÉLECTION ========== -->
    <div id="selectionBar" class="alert alert-primary d-flex justify-content-between align-items-center mb-3" style="display: none;">
        <div>
            <i class="fas fa-check-circle me-2"></i>
            <span id="selectedCount">0</span> mission(s) sélectionnée(s)
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-danger" id="deleteSelectedBtn" onclick="preparerSuppressionBloc()">
                <i class="fas fa-trash me-1"></i>Supprimer la sélection
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                <i class="fas fa-times me-1"></i>Désélectionner tout
            </button>
        </div>
    </div>
    <!-- ============================================ -->
    <!-- LISTE DES MISSIONS D'AUDIT -->
    <!-- ============================================ -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">
                    <i class="fas fa-tasks text-primary me-2"></i>
                    Missions d'audit
                </h5>
                <small class="text-muted">{{ missions_data|length }} mission(s) programmée(s)</small>
                <!-- Badge pour filtre actif -->
                {% if request.args.get('statut') or request.args.get('priorite') %}
                <span class="badge bg-info ms-2" id="filterBadge">
                    Filtre: 
                    {% if request.args.get('statut') %}
                        Statut: {{ {'planifie': 'Planifiées', 'en_cours': 'En cours', 'termine': 'Terminées'}.get(request.args.get('statut'), request.args.get('statut')) }}
                    {% endif %}
                    {% if request.args.get('priorite') %}
                        {% if request.args.get('statut') %} + {% endif %}
                        Priorité: {{ {'critique': 'Critique', 'elevee': 'Élevée', 'moyenne': 'Moyenne', 'faible': 'Faible'}.get(request.args.get('priorite'), request.args.get('priorite')) }}
                    {% endif %}
                </span>
                {% endif %}
            </div>
            
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle d-flex align-items-center gap-1" 
                            type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-filter"></i>
                        <span class="d-none d-md-inline">Filtrer</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="?">Toutes les missions</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Par statut</h6></li>
                        <li><a class="dropdown-item" href="?statut=planifie">Planifiées</a></li>
                        <li><a class="dropdown-item" href="?statut=en_cours">En cours</a></li>
                        <li><a class="dropdown-item" href="?statut=termine">Terminées</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Par priorité</h6></li>
                        <li><a class="dropdown-item" href="?priorite=critique">Critique</a></li>
                        <li><a class="dropdown-item" href="?priorite=elevee">Élevée</a></li>
                        <li><a class="dropdown-item" href="?priorite=moyenne">Moyenne</a></li>
                        <li><a class="dropdown-item" href="?priorite=faible">Faible</a></li>
                    </ul>
                </div>
                
                {% if missions_data|length == 0 %}
                <button class="btn btn-primary btn-sm d-flex align-items-center gap-1" 
                        data-bs-toggle="modal" data-bs-target="#addMissionModal">
                    <i class="fas fa-plus"></i>
                    <span class="d-none d-md-inline">Ajouter</span>
                </button>
                {% endif %}
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if missions_data %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAllMissions" onchange="toggleAllMissions()">
                            </th>
                            <th width="120">Référence</th>
                            <th>Titre & Description</th>
                            <th width="120">Priorité</th>
                            <th width="140">Planification</th>
                            <th width="120">Statut</th>
                            <th width="180">Risque associé</th>
                            <th width="120">Responsable</th>
                            <th width="100" class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mission in missions_data %}
                        <tr class="{% if mission.est_en_retard %}table-warning{% endif %} align-middle">
                            <!-- COLONNE 1 : CHECKBOX -->
                            <td>
                                <input type="checkbox" class="mission-checkbox" value="{{ mission.id }}" 
                                       onchange="toggleMissionSelection({{ mission.id }}, this)">
                            </td>
                            
                            <!-- COLONNE 2 : RÉFÉRENCE -->
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-light text-dark border fw-semibold">
                                        {{ mission.reference }}
                                    </span>
                                    {% if mission.est_en_retard %}
                                    <span class="badge bg-danger" data-bs-toggle="tooltip" 
                                          title="Mission en retard">
                                        <i class="fas fa-exclamation"></i>
                                    </span>
                                    {% endif %}
                                    {% if mission.audit_id %}
                                    <span class="badge bg-info" data-bs-toggle="tooltip" 
                                          title="Audit associé">
                                        <i class="fas fa-link"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- COLONNE 3 : TITRE ET DESCRIPTION -->
                            <td>
                                <div>
                                    <a href="#" class="text-decoration-none fw-semibold" 
                                       data-bs-toggle="modal" data-bs-target="#missionModal{{ mission.id }}">
                                        {{ mission.titre }}
                                    </a>
                                    {% if mission.description %}
                                    <p class="mb-0 text-muted small" style="max-width: 300px;">
                                        {{ mission.description|truncate(80) }}
                                    </p>
                                    {% endif %}
                                    {% if mission.responsable %}
                                    <div class="d-flex align-items-center gap-1 mt-1">
                                        <i class="fas fa-user text-muted small"></i>
                                        <small class="text-muted">{{ mission.responsable.username }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- COLONNE 4 : PRIORITÉ -->
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="priority-indicator bg-{% if mission.priorite == 'critique' %}danger{% elif mission.priorite == 'elevee' %}warning{% elif mission.priorite == 'moyenne' %}info{% else %}secondary{% endif %} rounded-circle" style="width: 10px; height: 10px;"></div>
                                    <span class="badge bg-{% if mission.priorite == 'critique' %}danger{% elif mission.priorite == 'elevee' %}warning{% elif mission.priorite == 'moyenne' %}info{% else %}secondary{% endif %}">
                                        {{ mission.priorite|capitalize if mission.priorite else 'Non défini' }}
                                    </span>
                                </div>
                                {% if mission.niveau_risque_associe %}
                                <small class="text-muted d-block">
                                    Risque: {{ mission.niveau_risque_associe }}
                                </small>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 5 : PLANIFICATION -->
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold">
                                        {{ mission.annee_prevue }}
                                        {% if mission.trimestre_prevue %}
                                        - T{{ mission.trimestre_prevue }}
                                        {% endif %}
                                    </span>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>{{ mission.duree_estimee or 0 }} jours
                                    </small>
                                    {% if mission.jours_restants > 0 %}
                                    <small class="text-success">
                                        <i class="far fa-calendar me-1"></i>{{ mission.jours_restants }}j restants
                                    </small>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- COLONNE 6 : STATUT -->
                            <td>
                                <span class="badge bg-{% if mission.statut == 'planifie' %}secondary{% elif mission.statut == 'en_cours' %}primary{% elif mission.statut == 'termine' %}success{% else %}warning{% endif %} py-1 px-2">
                                    {{ mission.statut|replace('_', ' ')|title if mission.statut else 'Non défini' }}
                                </span>
                                {% if mission.date_debut_reelle %}
                                <small class="text-muted d-block">
                                    {% if mission.date_debut_reelle is string %}
                                        Début: {{ mission.date_debut_reelle.split('-')[2] }}/{{ mission.date_debut_reelle.split('-')[1] }}
                                    {% else %}
                                        Début: {{ mission.date_debut_reelle }}
                                    {% endif %}
                                </small>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 7 : RISQUE ASSOCIÉ -->
                            <td>
                                {% if mission.risque %}
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-light rounded p-1">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    </div>
                                    <div>
                                        <a href="{{ url_for('detail_risque', id=mission.risque.id) }}" 
                                           class="text-decoration-none d-block">
                                            {{ mission.risque.reference if mission.risque.reference else 'N/A' }}
                                        </a>
                                        <small class="text-muted d-block" style="max-width: 150px;">
                                            {{ mission.risque.intitule|truncate(30) if mission.risque.intitule else 'Pas de titre' }}
                                        </small>
                                    </div>
                                </div>
                                {% else %}
                                <span class="text-muted fst-italic">Aucun risque</span>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 8 : RESPONSABLE -->
                            <td>
                                {% if mission.responsable %}
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fas fa-user-circle text-primary"></i>
                                    <span>{{ mission.responsable.username }}</span>
                                </div>
                                {% else %}
                                <span class="text-muted fst-italic">Non assigné</span>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 9 : ACTIONS -->
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" 
                                            data-bs-toggle="modal" data-bs-target="#missionModal{{ mission.id }}"
                                            title="Détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle" 
                                                type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            {% if not mission.audit_id and mission.statut == 'planifie' %}
                                            <li>
                                                <a class="dropdown-item text-success" 
                                                   href="{{ url_for('convertir_mission_audit', id=mission.id) }}">
                                                    <i class="fas fa-play me-2"></i>Convertir en audit
                                                </a>
                                            </li>
                                            {% elif mission.audit_id %}
                                            <li>
                                                <a class="dropdown-item text-primary" 
                                                   href="{{ url_for('detail_audit', id=mission.audit_id) }}">
                                                    <i class="fas fa-external-link-alt me-2"></i>Voir l'audit
                                                </a>
                                            </li>
                                            {% endif %}
                                            <li>
                                                <a class="dropdown-item" href="#" 
                                                   data-bs-toggle="modal" data-bs-target="#editMissionModal{{ mission.id }}">
                                                    <i class="fas fa-edit me-2"></i>Modifier
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" 
                                                   data-bs-toggle="modal" data-bs-target="#reprogrammerMissionModal{{ mission.id }}">
                                                    <i class="fas fa-calendar-alt me-2"></i>Reprogrammer
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('plan_pluie_programme', programme_id=programme.id) }}">
                                                    <i class="fas fa-umbrella me-2"></i>Plan de repli
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#" 
                                                   onclick="openSupprimerMissionModal({{ mission.id }}); return false;">
                                                    <i class="fas fa-trash me-2"></i>Supprimer
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Message d'information sur le filtre -->
            {% if request.args.get('statut') or request.args.get('priorite') %}
            <div class="alert alert-info mt-2 mb-0 mx-3" id="filterInfo">
                <i class="fas fa-filter me-2"></i>
                <span id="filterInfoText">
                    {{ visible_rows_count if visible_rows_count else missions_data|rejectattr('hidden', 'defined')|list|length }} mission(s) sur {{ missions_data|length }} affichée(s)
                </span>
                <a href="?" class="alert-link ms-2">Réinitialiser les filtres</a>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-clipboard-list fa-4x text-muted opacity-25"></i>
                </div>
                <h5 class="text-muted mb-3">Aucune mission d'audit</h5>
                <p class="text-muted mb-4">
                    Ce programme ne contient pas encore de missions d'audit.
                </p>
                <div class="d-flex justify-content-center gap-2">
                    {% if programme.methode_generation == 'auto_risques' %}
                    <a href="{{ url_for('generer_missions_auto_programme', id=programme.id) }}" 
                       class="btn btn-primary d-flex align-items-center gap-2">
                        <i class="fas fa-robot"></i>
                        Générer automatiquement
                    </a>
                    {% endif %}
                    <button class="btn btn-outline-primary d-flex align-items-center gap-2" 
                            data-bs-toggle="modal" data-bs-target="#addMissionModal">
                        <i class="fas fa-plus"></i>
                        Ajouter manuellement
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODALS - GESTION DU PROGRAMME -->
<!-- ============================================ -->

<!-- Modal de modification du programme -->
<div class="modal fade" id="editProgrammeModal{{ programme.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Modifier le programme
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('modifier_programme_audit', id=programme.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label fw-semibold">Nom du programme *</label>
                            <input type="text" class="form-control" name="nom" 
                                   value="{{ programme.nom }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Période *</label>
                            <select class="form-select" name="periode" required>
                                <option value="annuel" {% if programme.periode == 'annuel' %}selected{% endif %}>Annuel</option>
                                <option value="triennal" {% if programme.periode == 'triennal' %}selected{% endif %}>Triennal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea class="form-control" name="description" rows="3">{{ programme.description or '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Année début *</label>
                            <input type="number" class="form-control" name="annee_debut" 
                                   value="{{ programme.annee_debut }}" min="{{ now().year }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Année fin *</label>
                            <input type="number" class="form-control" name="annee_fin" 
                                   value="{{ programme.annee_fin }}" min="{{ programme.annee_debut }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Méthode de génération</label>
                            <select class="form-select" name="methode_generation">
                                <option value="manuel" {% if programme.methode_generation == 'manuel' %}selected{% endif %}>Manuel</option>
                                <option value="auto_risques" {% if programme.methode_generation == 'auto_risques' %}selected{% endif %}>Automatique</option>
                                <option value="hybride" {% if programme.methode_generation == 'hybride' %}selected{% endif %}>Hybride</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Fréquence d'audit</label>
                            <select class="form-select" name="frequence_audit">
                                <option value="">Non spécifiée</option>
                                <option value="annuelle" {% if programme.frequence_audit == 'annuelle' %}selected{% endif %}>Annuelle</option>
                                <option value="semestrielle" {% if programme.frequence_audit == 'semestrielle' %}selected{% endif %}>Semestrielle</option>
                                <option value="trimestrielle" {% if programme.frequence_audit == 'trimestrielle' %}selected{% endif %}>Trimestrielle</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Durée moyenne (jours)</label>
                            <input type="number" class="form-control" name="duree_moyenne_mission" 
                                   value="{{ programme.duree_moyenne_mission or 5 }}" min="1" max="30">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Ressources (jours/homme/an)</label>
                            <input type="number" class="form-control" name="ressources_disponibles" 
                                   value="{{ programme.ressources_disponibles or 100 }}" min="10" max="1000">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'approbation du programme -->
<div class="modal fade" id="approuverModal{{ programme.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>
                    Approuver le programme
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('approuver_programme_audit', id=programme.id) }}">
                <div class="modal-body">
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle me-2"></i>
                        Êtes-vous sûr de vouloir approuver le programme <strong>{{ programme.nom }}</strong> ?
                    </div>
                    <p>Une fois approuvé, le programme passera au statut "Actif" et les missions pourront commencer.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Date d'approbation</label>
                        <input type="date" class="form-control" name="date_approbation" 
                            value="{{ now().strftime('%Y-%m-%d') }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Commentaires</label>
                        <textarea class="form-control" name="commentaires" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle me-2"></i>Approuver
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de désapprobation du programme -->
<div class="modal fade" id="desapprouverModal{{ programme.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-ban me-2"></i>
                    Désapprouver le programme
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('desapprouver_programme_audit', id=programme.id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fs-4 me-3"></i>
                        <div>
                            <strong>{{ programme.nom }}</strong>
                            <br>
                            <small>Le programme repassera en statut "En élaboration"</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Raison de la désapprobation *</label>
                        <select class="form-select" name="raison" required>
                            <option value="">Sélectionnez une raison...</option>
                            <option value="Informations incomplètes">📋 Informations incomplètes</option>
                            <option value="Risques non évalués">⚠️ Risques non évalués</option>
                            <option value="Ressources insuffisantes">👥 Ressources insuffisantes</option>
                            <option value="Changement de priorité">🎯 Changement de priorité</option>
                            <option value="Autre">📌 Autre</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Commentaires</label>
                        <textarea class="form-control" name="commentaires" rows="2" 
                                  placeholder="Détaillez la raison de la désapprobation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-ban me-2"></i>Désapprouver
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'archivage du programme -->
<div class="modal fade" id="archiverModal{{ programme.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-archive me-2"></i>
                    Archiver le programme
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('archiver_programme_audit', id=programme.id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Êtes-vous sûr de vouloir archiver le programme <strong>{{ programme.nom }}</strong> ?
                    </div>
                    <p>Le programme sera déplacé vers les archives et n'apparaîtra plus dans la liste active.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Raison de l'archivage *</label>
                        <select class="form-select" name="raison" required>
                            <option value="">Sélectionnez une raison...</option>
                            <option value="Programme terminé">Programme terminé</option>
                            <option value="Période expirée">Période expirée</option>
                            <option value="Remplacement">Remplacé par un nouveau programme</option>
                            <option value="Annulation">Programme annulé</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Commentaires</label>
                        <textarea class="form-control" name="commentaire" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-archive me-2"></i>Confirmer l'archivage
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODALS - GESTION DES MISSIONS -->
<!-- ============================================ -->

<!-- Modal d'ajout de mission -->
<div class="modal fade" id="addMissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Ajouter une mission d'audit
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('ajouter_mission_programme', programme_id=programme.id) }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-semibold">Titre de la mission *</label>
                            <input type="text" class="form-control" name="titre" 
                                   placeholder="Ex: Audit des processus financiers" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Priorité *</label>
                            <select class="form-select" name="priorite" required>
                                <option value="">Sélectionnez...</option>
                                <option value="critique">Critique</option>
                                <option value="elevee">Élevée</option>
                                <option value="moyenne">Moyenne</option>
                                <option value="faible">Faible</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">Description</label>
                            <textarea class="form-control" name="description" rows="3" 
                                      placeholder="Description détaillée de la mission..."></textarea>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Année prévue *</label>
                            <select class="form-select" name="annee_prevue" required>
                                {% for annee in range(programme.annee_debut, programme.annee_fin + 1) %}
                                <option value="{{ annee }}" {% if annee == programme.annee_debut %}selected{% endif %}>
                                    {{ annee }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Trimestre</label>
                            <select class="form-select" name="trimestre_prevue">
                                <option value="">Non spécifié</option>
                                <option value="1">1er trimestre</option>
                                <option value="2">2ème trimestre</option>
                                <option value="3">3ème trimestre</option>
                                <option value="4">4ème trimestre</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Durée estimée (jours)</label>
                            <input type="number" class="form-control" name="duree_estimee" 
                                   value="{{ programme.duree_moyenne_mission or 5 }}" 
                                   min="1" max="60">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                Risque associé
                            </label>
                            <select class="form-select" name="risque_id">
                                <option value="">Aucun risque associé</option>
                                {% for risque in risques_disponibles %}
                                <option value="{{ risque.id }}">
                                    {{ risque.reference if risque.reference else risque.id }} - {{ risque.intitule|truncate(40) if risque.intitule else 'Pas de titre' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-user text-primary me-1"></i>
                                Responsable
                            </label>
                            <select class="form-select" name="responsable_id">
                                <option value="">Non assigné</option>
                                {% for user in utilisateurs %}
                                <option value="{{ user.id }}">
                                    {{ user.nom if user.nom else user.username }} {{ user.prenom if user.prenom else '' }} ({{ user.role if user.role else 'Utilisateur' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Créer la mission
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals de détail des missions -->
{% for mission in missions_data %}
<div class="modal fade" id="missionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-{% if mission.priorite == 'critique' %}danger{% elif mission.priorite == 'elevee' %}warning{% elif mission.priorite == 'moyenne' %}info{% else %}secondary{% endif %} bg-opacity-10 p-2 rounded">
                        <i class="fas fa-clipboard-check text-{% if mission.priorite == 'critique' %}danger{% elif mission.priorite == 'elevee' %}warning{% elif mission.priorite == 'moyenne' %}info{% else %}secondary{% endif %}"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0">{{ mission.reference }}</h5>
                        <p class="mb-0 text-muted small">{{ mission.titre }}</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="border-bottom pb-2 mb-3">Description</h6>
                        <div class="p-3 bg-light rounded mb-4">
                            {{ mission.description or 'Aucune description fournie'|nl2br }}
                        </div>
                        
                        {% if mission.risque %}
                        <h6 class="border-bottom pb-2 mb-3">Risque associé</h6>
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                            {{ mission.risque.reference }} - {{ mission.risque.intitule }}
                                        </h6>
                                        <p class="text-muted small mb-2">{{ mission.risque.description|truncate(200) if mission.risque.description else 'Pas de description' }}</p>
                                    </div>
                                    <a href="{{ url_for('detail_risque', id=mission.risque.id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>Voir
                                    </a>
                                </div>
                                <div class="d-flex gap-3">
                                    {% if mission.risque.categorie %}
                                    <small class="text-muted">
                                        <i class="fas fa-tag me-1"></i>
                                        {{ mission.risque.categorie }}
                                    </small>
                                    {% endif %}
                                    {% if mission.niveau_risque_associe %}
                                    <small class="text-muted">
                                        <i class="fas fa-bolt me-1"></i>
                                        {{ mission.niveau_risque_associe }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <h6 class="border-bottom pb-2 mb-3">Informations</h6>
                        
                        <div class="mb-4">
                            <label class="text-muted small d-block mb-1">Priorité</label>
                            <span class="badge bg-{% if mission.priorite == 'critique' %}danger{% elif mission.priorite == 'elevee' %}warning{% elif mission.priorite == 'moyenne' %}info{% else %}secondary{% endif %} py-2 px-3 fs-6">
                                {{ mission.priorite|upper if mission.priorite else 'N/A' }}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-muted small d-block mb-1">Statut</label>
                            <span class="badge bg-{% if mission.statut == 'planifie' %}secondary{% elif mission.statut == 'en_cours' %}primary{% elif mission.statut == 'termine' %}success{% else %}warning{% endif %} py-2 px-3">
                                {{ mission.statut|replace('_', ' ')|title if mission.statut else 'Non défini' }}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-muted small d-block mb-1">Planification</label>
                            <div class="d-flex flex-column">
                                <span class="fw-semibold">
                                    {{ mission.annee_prevue }}
                                    {% if mission.trimestre_prevue %}
                                    - Trimestre {{ mission.trimestre_prevue }}
                                    {% endif %}
                                </span>
                                <small class="text-muted">
                                    Durée: {{ mission.duree_estimee or 0 }} jours
                                </small>
                                {% if mission.date_debut_prevue %}
                                <small class="text-muted">
                                    Début prévu: 
                                    {% if mission.date_debut_prevue is string %}
                                        {{ mission.date_debut_prevue.split('-')[2] }}/{{ mission.date_debut_prevue.split('-')[1] }}/{{ mission.date_debut_prevue.split('-')[0] }}
                                    {% else %}
                                        {{ mission.date_debut_prevue }}
                                    {% endif %}
                                </small>
                                {% endif %}
                                {% if mission.jours_restants > 0 %}
                                <small class="text-success">
                                    <i class="fas fa-clock me-1"></i>{{ mission.jours_restants }} jours restants
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if mission.responsable %}
                        <div class="mb-4">
                            <label class="text-muted small d-block mb-1">Responsable</label>
                            <div class="d-flex align-items-center gap-2">
                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-primary small"></i>
                                </div>
                                <div>
                                    <span class="d-block fw-semibold">{{ mission.responsable.username }}</span>
                                    <small class="text-muted">{{ mission.responsable.role }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if mission.audit_id %}
                        <div class="alert alert-info mb-0">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-link fa-lg"></i>
                                <div>
                                    <strong>Audit associé</strong>
                                    <div>
                                        <a href="{{ url_for('detail_audit', id=mission.audit_id) }}" 
                                           class="text-decoration-none">
                                            {% if mission.audit %}
                                                {{ mission.audit.reference }}
                                            {% else %}
                                                Audit #{{ mission.audit_id }}
                                            {% endif %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fermer
                </button>
                {% if not mission.audit_id and mission.statut == 'planifie' %}
                <a href="{{ url_for('convertir_mission_audit', id=mission.id) }}" 
                   class="btn btn-success">
                    <i class="fas fa-play me-1"></i>Convertir en audit
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal de modification de mission -->
{% for mission in missions_data %}
<div class="modal fade" id="editMissionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Modifier la mission {{ mission.reference }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('modifier_mission_audit', mission_id=mission.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label fw-semibold">Titre de la mission *</label>
                            <input type="text" class="form-control" name="titre" 
                                   value="{{ mission.titre }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Priorité *</label>
                            <select class="form-select" name="priorite" required>
                                <option value="critique" {% if mission.priorite == 'critique' %}selected{% endif %}>Critique</option>
                                <option value="elevee" {% if mission.priorite == 'elevee' %}selected{% endif %}>Élevée</option>
                                <option value="moyenne" {% if mission.priorite == 'moyenne' %}selected{% endif %}>Moyenne</option>
                                <option value="faible" {% if mission.priorite == 'faible' %}selected{% endif %}>Faible</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea class="form-control" name="description" rows="3">{{ mission.description or '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Année prévue *</label>
                            <select class="form-select" name="annee_prevue" required>
                                {% for annee in range(programme.annee_debut, programme.annee_fin + 1) %}
                                <option value="{{ annee }}" {% if annee == mission.annee_prevue %}selected{% endif %}>
                                    {{ annee }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Trimestre</label>
                            <select class="form-select" name="trimestre_prevue">
                                <option value="">Non spécifié</option>
                                <option value="1" {% if mission.trimestre_prevue == 1 %}selected{% endif %}>1er trimestre</option>
                                <option value="2" {% if mission.trimestre_prevue == 2 %}selected{% endif %}>2ème trimestre</option>
                                <option value="3" {% if mission.trimestre_prevue == 3 %}selected{% endif %}>3ème trimestre</option>
                                <option value="4" {% if mission.trimestre_prevue == 4 %}selected{% endif %}>4ème trimestre</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Durée estimée (jours)</label>
                            <input type="number" class="form-control" name="duree_estimee" 
                                   value="{{ mission.duree_estimee or 5 }}" min="1" max="60">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Risque associé</label>
                            <select class="form-select" name="risque_id">
                                <option value="">Aucun risque</option>
                                {% for risque in risques_disponibles %}
                                <option value="{{ risque.id }}" {% if mission.risque and mission.risque.id == risque.id %}selected{% endif %}>
                                    {{ risque.reference }} - {{ risque.intitule|truncate(40) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Responsable</label>
                            <select class="form-select" name="responsable_id">
                                <option value="">Non assigné</option>
                                {% for user in utilisateurs %}
                                <option value="{{ user.id }}" {% if mission.responsable and mission.responsable.id == user.id %}selected{% endif %}>
                                    {{ user.nom or user.username }} {{ user.prenom or '' }} ({{ user.role or 'Utilisateur' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Statut</label>
                            <select class="form-select" name="statut">
                                <option value="planifie" {% if mission.statut == 'planifie' %}selected{% endif %}>Planifiée</option>
                                <option value="en_cours" {% if mission.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                                <option value="termine" {% if mission.statut == 'termine' %}selected{% endif %}>Terminée</option>
                                <option value="reporte" {% if mission.statut == 'reporte' %}selected{% endif %}>Reportée</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de reprogrammation de mission -->
<div class="modal fade" id="reprogrammerMissionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>Reprogrammer {{ mission.reference }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('reprogrammer_mission_audit', mission_id=mission.id) }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Modifiez les dates prévues pour cette mission.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Nouvelle année</label>
                            <select class="form-select" name="nouvelle_annee">
                                <option value="">Non modifié</option>
                                {% for annee in range(programme.annee_debut, programme.annee_fin + 1) %}
                                <option value="{{ annee }}" {% if annee == mission.annee_prevue %}selected{% endif %}>
                                    {{ annee }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Nouveau trimestre</label>
                            <select class="form-select" name="nouveau_trimestre">
                                <option value="">Non modifié</option>
                                <option value="1" {% if mission.trimestre_prevue == 1 %}selected{% endif %}>1er trimestre</option>
                                <option value="2" {% if mission.trimestre_prevue == 2 %}selected{% endif %}>2ème trimestre</option>
                                <option value="3" {% if mission.trimestre_prevue == 3 %}selected{% endif %}>3ème trimestre</option>
                                <option value="4" {% if mission.trimestre_prevue == 4 %}selected{% endif %}>4ème trimestre</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Nouvelle date de début</label>
                            <input type="date" class="form-control" name="nouvelle_date_debut" 
                                   value="{{ mission.date_debut_prevue.strftime('%Y-%m-%d') if mission.date_debut_prevue else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Nouvelle date de fin</label>
                            <input type="date" class="form-control" name="nouvelle_date_fin" 
                                   value="{{ mission.date_fin_prevue.strftime('%Y-%m-%d') if mission.date_fin_prevue else '' }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Raison de la reprogrammation</label>
                        <textarea class="form-control" name="raison" rows="2" 
                                  placeholder="Expliquez pourquoi cette mission est reprogrammée..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-calendar-check me-2"></i>Reprogrammer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- ========== MODAL SUPPRESSION EN BLOC ========== -->
<div class="modal fade" id="supprimerBlocModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i>
                    Supprimer les missions sélectionnées
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <strong>Attention !</strong>
                        <p class="mb-0" id="selectedCountMessage">0 mission(s) sélectionnée(s)</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">Raison de la suppression *</label>
                    <select class="form-select" id="blocRaison" required>
                        <option value="Missions annulées">Missions annulées</option>
                        <option value="Changement de planning">Changement de planning</option>
                        <option value="Risques obsolètes">Risques obsolètes</option>
                        <option value="Doublons">Missions en doublon</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                
                <div class="mb-3" id="autreRaisonContainer" style="display: none;">
                    <label class="form-label fw-semibold">Précisez la raison</label>
                    <input type="text" class="form-control" id="autreRaison" placeholder="Raison de la suppression...">
                </div>

                <div class="mt-3 p-3 bg-light rounded" id="missionsListe">
                    <!-- La liste des missions sélectionnées sera injectée ici -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger" id="confirmBlocDelete">
                    <i class="fas fa-trash me-2"></i>Supprimer définitivement
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de suppression de mission -->
<div class="modal fade" id="supprimerMissionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash me-2"></i>Supprimer la mission
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('supprimer_mission_audit', mission_id=mission.id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <h6 class="alert-heading">Confirmation de suppression</h6>
                            <p class="mb-0">
                                Êtes-vous sûr de vouloir supprimer la mission <strong>{{ mission.reference }}</strong> ?
                                Cette action est irréversible.
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Raison de la suppression</label>
                        <select class="form-select" name="raison" required>
                            <option value="">Sélectionnez une raison...</option>
                            <option value="mission_annulee">Mission annulée</option>
                            <option value="plan_change">Planification modifiée</option>
                            <option value="doublon">Mission en doublon</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Commentaires</label>
                        <textarea class="form-control" name="commentaires" rows="2" 
                                  placeholder="Détaillez la raison de la suppression..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Confirmer la suppression
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ========== FONCTIONS DE GESTION DES MODALS ==========
    function cleanupModals() {
        // Supprimer tous les backdrops
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        // Enlever la classe modal-open du body
        document.body.classList.remove('modal-open');
        // Enlever les styles ajoutés
        document.body.style.removeProperty('padding-right');
        document.body.style.removeProperty('overflow');
    }

    function openApproveModal(programmeId) {
        cleanupModals();
        const modalElement = document.getElementById('approuverModal' + programmeId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement, { 
                backdrop: 'static', 
                keyboard: true 
            });
            modal.show();
            modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
        }
    }

    function openDesapprouverModal(programmeId) {
        cleanupModals();
        const modalElement = document.getElementById('desapprouverModal' + programmeId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement, { 
                backdrop: 'static', 
                keyboard: true 
            });
            modal.show();
            modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
        }
    }

    function openArchiveModal(programmeId) {
        cleanupModals();
        const modalElement = document.getElementById('archiverModal' + programmeId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement, { 
                backdrop: 'static', 
                keyboard: true 
            });
            modal.show();
            modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
        }
    }

    function openEditModal(programmeId) {
        cleanupModals();
        const modalElement = document.getElementById('editProgrammeModal' + programmeId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement, { 
                backdrop: 'static', 
                keyboard: true 
            });
            modal.show();
            modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
        }
    }

    function dupliquerProgramme(programmeId) {
        if (confirm('Voulez-vous dupliquer ce programme ?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/programme-audit/${programmeId}/dupliquer`;
            document.body.appendChild(form);
            form.submit();
        }
    }

    function regenererMissions(programmeId) {
        if (confirm('Voulez-vous regénérer automatiquement les missions ?')) {
            window.location.href = `/programme-audit/${programmeId}/generer-auto`;
        }
    }

    // ========== FONCTION D'OUVERTURE DU MODAL DE SUPPRESSION ==========
    function openSupprimerMissionModal(missionId) {
        cleanupModals();
        const modalElement = document.getElementById('supprimerMissionModal' + missionId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement, { 
                backdrop: 'static', 
                keyboard: true 
            });
            modal.show();
            modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
        }
    }

    // ========== FONCTION DE FILTRAGE CORRIGÉE ==========
    function filterMissions() {
        const statut = document.getElementById('filterStatut')?.value;
        const priorite = document.getElementById('filterPriorite')?.value;
        
        let url = window.location.pathname;
        const params = new URLSearchParams();
        
        if (statut && statut !== '') params.append('statut', statut);
        if (priorite && priorite !== '') params.append('priorite', priorite);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        window.location.href = url;
    }

    // ========== INITIALISATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Nettoyage initial
        cleanupModals();
        
        // Initialiser les tooltips Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Nettoyage après fermeture de modal
        $(document).on('hidden.bs.modal', '.modal', cleanupModals);
        
        // ========== GRAPHIQUE DE RÉPARTITION PAR PRIORITÉ ==========
        const prioriteCtx = document.getElementById('prioriteChart');
        if (prioriteCtx) {
            const counts = {
                'critique': 0,
                'elevee': 0,
                'moyenne': 0,
                'faible': 0
            };
            
            document.querySelectorAll('.priority-indicator').forEach(indicator => {
                if (indicator.classList.contains('bg-danger')) counts.critique++;
                else if (indicator.classList.contains('bg-warning')) counts.elevee++;
                else if (indicator.classList.contains('bg-info')) counts.moyenne++;
                else if (indicator.classList.contains('bg-secondary')) counts.faible++;
            });
            
            const hasData = Object.values(counts).some(count => count > 0);
            
            if (hasData) {
                const labels = [];
                const data = [];
                const backgroundColors = {
                    'critique': '#dc3545',
                    'elevee': '#ffc107',
                    'moyenne': '#0dcaf0',
                    'faible': '#6c757d'
                };
                const backgroundColorsArray = [];
                
                Object.entries(counts).forEach(([priorite, count]) => {
                    if (count > 0) {
                        labels.push(priorite.charAt(0).toUpperCase() + priorite.slice(1));
                        data.push(count);
                        backgroundColorsArray.push(backgroundColors[priorite]);
                    }
                });
                
                new Chart(prioriteCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColorsArray,
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value} mission${value > 1 ? 's' : ''} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });
            } else {
                prioriteCtx.style.display = 'none';
                const parentCard = prioriteCtx.closest('.card-body');
                if (parentCard) {
                    const message = document.createElement('div');
                    message.className = 'text-center text-muted py-4';
                    message.innerHTML = '<i class="fas fa-chart-pie fa-3x mb-3 opacity-25"></i><p>Aucune mission pour générer le graphique</p>';
                    parentCard.insertBefore(message, parentCard.querySelector('.row'));
                }
            }
        }
        
        // ========== GESTION DES FILTRES PAR URL - CORRIGÉ ==========
        const urlParams = new URLSearchParams(window.location.search);
        const statutFilter = urlParams.get('statut');
        const prioriteFilter = urlParams.get('priorite');
        
        if (statutFilter || prioriteFilter) {
            // Afficher le badge de filtre (déjà fait en backend)
            
            // Filtrer les lignes du tableau
            document.querySelectorAll('tbody tr').forEach(row => {
                let show = true;
                
                if (statutFilter) {
                    const statutCell = row.querySelector('td:nth-child(5) .badge');
                    if (statutCell) {
                        const rowStatut = statutCell.textContent.trim().toLowerCase().replace(/\s+/g, '_');
                        show = show && (rowStatut.includes(statutFilter.toLowerCase()) || 
                                       statutFilter.toLowerCase().includes(rowStatut));
                    }
                }
                
                if (prioriteFilter && show) {
                    const prioriteCell = row.querySelector('td:nth-child(3) .badge');
                    if (prioriteCell) {
                        const rowPriorite = prioriteCell.textContent.trim().toLowerCase();
                        // Mapping des priorités
                        const prioriteMap = {
                            'critique': ['critique', 'critique'],
                            'elevee': ['élevée', 'elevee', 'elevée'],
                            'moyenne': ['moyenne'],
                            'faible': ['faible']
                        };
                        
                        let match = false;
                        const filterValue = prioriteFilter.toLowerCase();
                        Object.keys(prioriteMap).forEach(key => {
                            if (filterValue.includes(key) || key.includes(filterValue)) {
                                if (prioriteMap[key].some(p => rowPriorite.includes(p))) {
                                    match = true;
                                }
                            }
                        });
                        show = show && match;
                    }
                }
                
                row.style.display = show ? '' : 'none';
            });
            
            // Afficher le compteur de résultats
            const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])').length;
            const totalRows = document.querySelectorAll('tbody tr').length;
            
            // Mettre à jour le texte du message d'information
            const filterInfoText = document.getElementById('filterInfoText');
            if (filterInfoText) {
                filterInfoText.textContent = `${visibleRows} mission(s) sur ${totalRows} affichée(s)`;
            }
            
            // Créer le message d'information s'il n'existe pas
            if (!document.getElementById('filterInfo')) {
                const filterInfo = document.createElement('div');
                filterInfo.id = 'filterInfo';
                filterInfo.className = 'alert alert-info mt-2 mb-0 mx-3';
                
                let filterText = [];
                if (statutFilter) {
                    const statutDisplay = statutFilter === 'planifie' ? 'Planifiées' : 
                                         statutFilter === 'en_cours' ? 'En cours' : 
                                         statutFilter === 'termine' ? 'Terminées' : statutFilter;
                    filterText.push('Statut: ' + statutDisplay);
                }
                if (prioriteFilter) {
                    const prioriteDisplay = prioriteFilter === 'critique' ? 'Critique' : 
                                           prioriteFilter === 'elevee' ? 'Élevée' : 
                                           prioriteFilter === 'moyenne' ? 'Moyenne' : 
                                           prioriteFilter === 'faible' ? 'Faible' : prioriteFilter;
                    filterText.push('Priorité: ' + prioriteDisplay);
                }
                
                filterInfo.innerHTML = `<i class="fas fa-filter me-2"></i>
                                        Filtré par: ${filterText.join(' + ')} (${visibleRows} mission(s) sur ${totalRows} affichée(s))
                                        <a href="?" class="alert-link ms-2">Réinitialiser</a>`;
                
                const tableContainer = document.querySelector('.table-responsive');
                if (tableContainer) {
                    tableContainer.parentNode.insertBefore(filterInfo, tableContainer.nextSibling);
                }
            }
        }
    });
    // ========== VARIABLES GLOBALES ==========
// ========== VARIABLES GLOBALES ==========
let selectedMissions = new Set();
let missionsData = {{ missions_data|tojson|safe }};

// ========== GESTION DES CHECKBOX ==========
function toggleMissionSelection(missionId, checkbox) {
    if (checkbox.checked) {
        selectedMissions.add(missionId);
    } else {
        selectedMissions.delete(missionId);
    }
    updateSelectionUI();
}

function toggleAllMissions() {
    const selectAllCheckbox = document.getElementById('selectAllMissions');
    const checkboxes = document.querySelectorAll('.mission-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        const missionId = parseInt(checkbox.value);
        if (selectAllCheckbox.checked) {
            selectedMissions.add(missionId);
        } else {
            selectedMissions.delete(missionId);
        }
    });
    
    updateSelectionUI();
}

function updateSelectionUI() {
    const count = selectedMissions.size;
    const selectionBar = document.getElementById('selectionBar');
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    if (count > 0) {
        selectionBar.style.display = 'flex';
        selectedCount.textContent = count;
        deleteSelectedBtn.disabled = false;
    } else {
        selectionBar.style.display = 'none';
    }
    
    const selectAllCheckbox = document.getElementById('selectAllMissions');
    if (selectAllCheckbox) {
        const totalCheckboxes = document.querySelectorAll('.mission-checkbox').length;
        selectAllCheckbox.checked = (count === totalCheckboxes && totalCheckboxes > 0);
        selectAllCheckbox.indeterminate = (count > 0 && count < totalCheckboxes);
    }
}

function deselectAll() {
    document.querySelectorAll('.mission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllMissions').checked = false;
    selectedMissions.clear();
    updateSelectionUI();
}

// ========== PRÉPARATION DE LA SUPPRESSION EN BLOC ==========
function preparerSuppressionBloc() {
    if (selectedMissions.size === 0) return;
    
    const modal = new bootstrap.Modal(document.getElementById('supprimerBlocModal'));
    const message = document.getElementById('selectedCountMessage');
    message.textContent = `${selectedMissions.size} mission(s) sélectionnée(s)`;
    
    // Afficher la liste des missions sélectionnées
    const missionsListe = document.getElementById('missionsListe');
    const missionsHtml = [];
    
    selectedMissions.forEach(id => {
        const mission = missionsData.find(m => m.id === id);
        if (mission) {
            missionsHtml.push(`
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="fas fa-times-circle text-danger"></i>
                    <span><strong>${mission.reference}</strong> - ${mission.titre}</span>
                </div>
            `);
        }
    });
    
    missionsListe.innerHTML = missionsHtml.join('');
    
    modal.show();
}

// ========== GESTION DE LA RAISON ==========
document.getElementById('blocRaison')?.addEventListener('change', function() {
    const autreContainer = document.getElementById('autreRaisonContainer');
    autreContainer.style.display = this.value === 'Autre' ? 'block' : 'none';
});

// ========== CONFIRMATION SUPPRESSION EN BLOC ==========
document.getElementById('confirmBlocDelete')?.addEventListener('click', function() {
    const raisonSelect = document.getElementById('blocRaison');
    let raison = raisonSelect.value;
    
    if (raison === 'Autre') {
        raison = document.getElementById('autreRaison').value;
        if (!raison) {
            alert('Veuillez préciser la raison de la suppression');
            return;
        }
    }
    
    const missionIds = Array.from(selectedMissions);
    
    fetch(`/programme-audit/{{ programme.id }}/missions/supprimer-bloc`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            mission_ids: missionIds,
            raison: raison
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('✅ ' + data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('supprimerBlocModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('❌ ' + data.message, 'danger');
        }
    })
    .catch(() => showNotification('❌ Erreur réseau', 'danger'));
});

// ========== CORRECTION DE LA SUPPRESSION INDIVIDUELLE ==========
function supprimerMission(missionId) {
    // Récupérer la mission pour afficher son nom
    const mission = missionsData.find(m => m.id === missionId);
    const missionRef = mission ? mission.reference : 'cette mission';
    
    if (confirm(`⚠️ Êtes-vous sûr de vouloir supprimer ${missionRef} ?`)) {
        fetch(`/mission-audit/${missionId}/supprimer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'raison=Suppression depuis détail'
        })
        .then(response => {
            if (response.ok) {
                showNotification('✅ Mission supprimée', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                response.json().then(data => {
                    showNotification('❌ ' + (data.message || 'Erreur'), 'danger');
                });
            }
        })
        .catch(() => showNotification('❌ Erreur réseau', 'danger'));
    }
}function deselectAll() {
    document.querySelectorAll('.mission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllMissions').checked = false;
    selectedMissions.clear();
    updateSelectionUI();
}// ========== NOTIFICATIONS ==========
function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow`;
    notif.style.zIndex = 9999;
    notif.style.minWidth = '300px';
    notif.style.animation = 'slideIn 0.3s ease-out';
    notif.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 4000);
}

// Ajouter le style pour l'animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}