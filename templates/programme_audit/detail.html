{% extends "base.html" %}

{% block title %}{{ programme.nom }} - Programme d'Audit - Egalyx{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- ============================================ -->
    <!-- EN-TÊTE ET ACTIONS DU PROGRAMME -->
    <!-- ============================================ -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <!-- Breadcrumb et titre -->
        <div>
            <div class="d-flex align-items-center gap-2 mb-3">
                <a href="{{ url_for('liste_programmes_audit') }}" class="text-decoration-none" style="color: #64748b;">
                    <i class="fas fa-arrow-left me-1"></i>
                    <span class="small">{{ t("Programmes") }}</span>
                </a>
                <span class="small" style="color: #94a3b8;">/</span>
                <span class="small" style="color: #2563eb;">{{ programme.nom }}</span>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="p-3 rounded-2" style="background: #2563eb;">
                    <i class="fas fa-calendar-alt text-white fa-lg"></i>
                </div>
                <div>
                    <h1 class="fw-bold mt-1 mb-0" style="color: #0f172a; font-size: 2rem;">
                        {{ programme.nom }}
                    </h1>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <span class="badge px-3 py-2 fw-normal" style="background: #f8fafc; color: #2563eb; border: 1px solid #e2e8f0; border-radius: 20px;">
                            <i class="fas fa-hashtag me-1" style="color: #2563eb;"></i>{{ programme.reference }}
                        </span>
                        <span class="small" style="color: #64748b;">
                            <i class="far fa-calendar me-1" style="color: #2563eb;"></i>{{ programme.annee_debut }} - {{ programme.annee_fin }}
                        </span>
                        <span class="badge px-3 py-2 fw-normal" 
                              style="background: {% if programme.statut == 'actif' %}#059669; color: white; border: 1px solid #bbf7d0;
                                     {% elif programme.statut == 'en_elaboration' %}#7c3aed; color: white; border: 1px solid #ddd6fe;
                                     {% else %}#64748b; color: white; border: 1px solid #e2e8f0;{% endif %}; border-radius: 20px;">
                            <i class="fas fa-{{ 'play-circle' if programme.statut == 'actif' else 'pen' if programme.statut == 'en_elaboration' else 'stop-circle' }} me-1"></i>
                            {{ programme.statut|replace('_', ' ')|title }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="mt-3" style="height: 3px; width: 80px; background: #2563eb; border-radius: 2px;"></div>
        </div>
        
        <!-- Actions principales -->
        <div class="d-flex gap-2">
            <!-- Chronogramme -->
            <a href="{{ url_for('chronogramme_programme', id=programme.id) }}" 
               class="btn px-4 py-2 d-flex align-items-center gap-2"
               style="border-radius: 10px; background: white; color: #2563eb; border: 1px solid #e2e8f0;">
                <i class="fas fa-calendar-week" style="color: #2563eb;"></i>
                <span class="d-none d-md-inline">{{ t("Chronogramme") }}</span>
            </a>
            
            <!-- Export -->
            <div class="dropdown">
                <button class="btn px-4 py-2 dropdown-toggle d-flex align-items-center gap-2" 
                        type="button" data-bs-toggle="dropdown"
                        style="border-radius: 10px; background: white; color: #059669; border: 1px solid #e2e8f0;">
                    <i class="fas fa-download" style="color: #059669;"></i>
                    <span class="d-none d-md-inline">{{ t("Exporter") }}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm" style="border-radius: 12px; padding: 8px;">
                    <li>
                        <a class="dropdown-item py-2" href="{{ url_for('exporter_programme', id=programme.id, format='excel') }}">
                            <i class="fas fa-file-excel me-2" style="color: #059669;"></i>
                            {{ t("Excel") }} (.xlsx)
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-2" href="{{ url_for('exporter_programme', id=programme.id, format='csv') }}">
                            <i class="fas fa-file-csv me-2" style="color: #2563eb;"></i>
                            {{ t("CSV") }}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-2" href="{{ url_for('exporter_programme', id=programme.id, format='pdf') }}">
                            <i class="fas fa-file-pdf me-2" style="color: #b91c1c;"></i>
                            {{ t("PDF") }}
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Plan de repli -->
            <a href="{{ url_for('plan_pluie_programme', programme_id=programme.id) }}" 
               class="btn px-4 py-2 d-flex align-items-center gap-2"
               style="border-radius: 10px; background: white; color: #b45309; border: 1px solid #e2e8f0;">
                <i class="fas fa-umbrella" style="color: #b45309;"></i>
                <span class="d-none d-md-inline">{{ t("Plan de repli") }}</span>
            </a>
            
            <!-- Régénération automatique -->
            {% if programme.methode_generation in ['auto_risques', 'hybride'] %}
            <button class="btn px-4 py-2 d-flex align-items-center gap-2" 
                    onclick="regenererMissions({{ programme.id }}); return false;"
                    style="border-radius: 10px; background: white; color: #7c3aed; border: 1px solid #e2e8f0;">
                <i class="fas fa-robot" style="color: #7c3aed;"></i>
                <span class="d-none d-md-inline">{{ t("Régénérer") }}</span>
            </button>
            {% endif %}
            
            <!-- Menu Actions principales -->
            <div class="dropdown">
                <button class="btn px-4 py-2 dropdown-toggle d-flex align-items-center gap-2" 
                        type="button" data-bs-toggle="dropdown"
                        style="border-radius: 10px; background: #2563eb; color: white; border: none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
                    <i class="fas fa-cog"></i>
                    <span class="d-none d-md-inline">{{ t("Actions") }}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm" style="border-radius: 12px; padding: 8px;">
                    <!-- Ajouter mission -->
                    <li>
                        <a class="dropdown-item py-2 d-flex align-items-center gap-2" 
                           href="#" data-bs-toggle="modal" data-bs-target="#addMissionModal">
                            <i class="fas fa-plus-circle" style="color: #2563eb; width: 20px;"></i>
                            {{ t("Ajouter une mission") }}
                        </a>
                    </li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <!-- Modifier -->
                    <li>
                        <a class="dropdown-item py-2 d-flex align-items-center gap-2" 
                           href="#" onclick="openEditModal({{ programme.id }}); return false;">
                            <i class="fas fa-edit" style="color: #2563eb; width: 20px;"></i>
                            {{ t("Modifier le programme") }}
                        </a>
                    </li>
                    
                    <!-- Dupliquer -->
                    <li>
                        <a class="dropdown-item py-2 d-flex align-items-center gap-2" 
                           href="#" onclick="dupliquerProgramme({{ programme.id }}); return false;">
                            <i class="fas fa-copy" style="color: #0891b2; width: 20px;"></i>
                            {{ t("Dupliquer") }}
                        </a>
                    </li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <!-- Approuver / Désapprouver -->
                    {% if programme.statut == 'en_elaboration' %}
                    <li>
                        <a class="dropdown-item py-2 d-flex align-items-center gap-2 text-success" 
                           href="#" onclick="openApproveModal({{ programme.id }}); return false;">
                            <i class="fas fa-check-circle" style="color: #059669; width: 20px;"></i>
                            {{ t("Approuver le programme") }}
                        </a>
                    </li>
                    {% elif programme.statut == 'actif' %}
                    <li>
                        <a class="dropdown-item py-2 d-flex align-items-center gap-2 text-warning" 
                           href="#" onclick="openDesapprouverModal({{ programme.id }}); return false;">
                            <i class="fas fa-ban" style="color: #b45309; width: 20px;"></i>
                            {{ t("Désapprouver") }}
                        </a>
                    </li>
                    {% endif %}
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <!-- Archiver -->
                    <li>
                        <a class="dropdown-item py-2 d-flex align-items-center gap-2 text-danger" 
                           href="#" onclick="openArchiveModal({{ programme.id }}); return false;">
                            <i class="fas fa-archive" style="color: #b91c1c; width: 20px;"></i>
                            {{ t("Archiver") }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- STATISTIQUES DU PROGRAMME -->
    <!-- ============================================ -->
    <div class="row g-4 mb-5">
        <!-- Missions -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("MISSIONS") }}</span>
                            <h2 class="fw-bold mb-0" style="color: #0f172a; font-size: 2rem;">{{ programme.nb_missions }}</h2>
                            <div class="mt-2">
                                <small style="color: #64748b;">
                                    <i class="fas fa-check-circle me-1" style="color: #059669;"></i>
                                    {{ programme.nb_missions_realisees }} {{ t("terminées") }}
                                </small>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #e2e8f0; width: 64px; height: 64px;">
                            <i class="fas fa-clipboard-list fa-2x" style="color: #2563eb;"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 6px; background: #e2e8f0; border-radius: 3px;">
                        {% set progression_pourcentage = 0 %}
                        {% if programme.nb_missions > 0 %}
                            {% set progression_pourcentage = ((programme.nb_missions_realisees / programme.nb_missions) * 100)|round %}
                        {% endif %}
                        <div class="progress-bar" style="width: {{ progression_pourcentage }}%; background: #2563eb; border-radius: 3px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progression -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("PROGRESSION") }}</span>
                            <h2 class="fw-bold mb-0" style="color: #0f172a; font-size: 2rem;">{{ programme.progression }}%</h2>
                            <div class="mt-2">
                                <small style="color: #64748b;">
                                    <i class="fas fa-chart-line me-1" style="color: #059669;"></i>
                                    {{ programme.nb_missions_realisees }}/{{ programme.nb_missions }} {{ t("missions") }}
                                </small>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #dcfce7; width: 64px; height: 64px;">
                            <i class="fas fa-chart-line fa-2x" style="color: #059669;"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 6px; background: #e2e8f0; border-radius: 3px;">
                        <div class="progress-bar" style="width: {{ programme.progression }}%; background: #059669; border-radius: 3px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ressources -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("RESSOURCES") }}</span>
                            <h2 class="fw-bold mb-0" style="color: #0f172a; font-size: 2rem;">{{ programme.jours_audit_planifies }}j</h2>
                            <div class="mt-2">
                                <small style="color: #64748b;">
                                    <i class="fas fa-clock me-1" style="color: #b45309;"></i>
                                    {{ programme.jours_audit_realises }} {{ t("jours réalisés") }}
                                </small>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #fed7aa; width: 64px; height: 64px;">
                            <i class="fas fa-clock fa-2x" style="color: #b45309;"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 6px; background: #e2e8f0; border-radius: 3px;">
                        {% set ressources_pourcentage = 0 %}
                        {% if programme.jours_audit_planifies > 0 %}
                            {% set ressources_pourcentage = ((programme.jours_audit_realises / programme.jours_audit_planifies) * 100)|round %}
                        {% endif %}
                        <div class="progress-bar" style="width: {{ ressources_pourcentage }}%; background: #b45309; border-radius: 3px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Méthode -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("MÉTHODE") }}</span>
                            <h3 class="fw-bold mb-0" style="color: #0f172a; font-size: 1.5rem;">
                                {{ programme.methode_generation|replace('_', ' ')|title }}
                            </h3>
                            <div class="mt-2">
                                <small style="color: #64748b;">
                                    <i class="fas fa-cogs me-1" style="color: #7c3aed;"></i>
                                    {{ programme.periode|capitalize }}
                                </small>
                            </div>
                        </div>
                        <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" 
                             style="background: #ede9fe; width: 64px; height: 64px;">
                            <i class="fas fa-cogs fa-2x" style="color: #7c3aed;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- INFORMATIONS DÉTAILLÉES ET GRAPHIQUES -->
    <!-- ============================================ -->
    <div class="row g-4 mb-5">
        <!-- Description et informations -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center p-4" style="border-bottom: 1px solid #e2e8f0;">
                    <h5 class="fw-semibold mb-0" style="color: #0f172a;">
                        <i class="fas fa-info-circle me-2" style="color: #2563eb;"></i>
                        {{ t("Informations du programme") }}
                    </h5>
                    <span class="badge px-3 py-2 fw-normal" style="background: #f8fafc; color: #2563eb; border: 1px solid #e2e8f0; border-radius: 20px;">
                        {{ programme.methode_generation|replace('_', ' ')|title }}
                    </span>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Description -->
                            <div class="mb-4">
                                <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("DESCRIPTION") }}</span>
                                <div class="p-3 rounded-2" style="background: #f8fafc;">
                                    {% if programme.description %}
                                    <p class="mb-0" style="color: #334155;">{{ programme.description|nl2br }}</p>
                                    {% else %}
                                    <p class="mb-0 text-muted fst-italic">
                                        <i class="fas fa-info-circle me-2" style="color: #94a3b8;"></i>{{ t("Aucune description fournie") }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Configuration -->
                            <span class="text-uppercase small fw-semibold mb-3 d-block" style="color: #64748b;">{{ t("CONFIGURATION") }}</span>
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless">
                                    <tbody>
                                        <tr>
                                            <td class="text-muted">{{ t("Période") }} :</td>
                                            <td class="fw-semibold" style="color: #0f172a;">{{ programme.periode|capitalize }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">{{ t("Fréquence d'audit") }} :</td>
                                            <td class="fw-semibold" style="color: #0f172a;">{{ programme.frequence_audit|capitalize if programme.frequence_audit else 'Non spécifiée' }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">{{ t("Durée moyenne") }} :</td>
                                            <td class="fw-semibold" style="color: #0f172a;">{{ programme.duree_moyenne_mission or 'N/A' }} {{ t("jours") }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">{{ t("Ressources") }} :</td>
                                            <td class="fw-semibold" style="color: #0f172a;">{{ programme.ressources_disponibles or 'N/A' }} {{ t("jours/homme/an") }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Création -->
                            <span class="text-uppercase small fw-semibold mb-3 d-block" style="color: #64748b;">{{ t("CRÉATION") }}</span>
                            <div class="d-flex align-items-center gap-3 mb-4 p-3 rounded-2" style="background: #f8fafc;">
                                <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 48px; height: 48px; background: #2563eb;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <p class="mb-1 fw-semibold" style="color: #0f172a;">{{ programme.createur.username }}</p>
                                    <p class="mb-0 small" style="color: #64748b;">
                                        <i class="far fa-calendar me-1" style="color: #2563eb;"></i>
                                        {{ t("Créé le") }} {{ programme.created_at.strftime('%d/%m/%Y à %H:%M') }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Critères de génération -->
                            {% if programme.criteres_generation %}
                            <span class="text-uppercase small fw-semibold mb-3 d-block" style="color: #64748b;">{{ t("CRITÈRES DE GÉNÉRATION") }}</span>
                            <div class="p-3 rounded-2" style="background: #f8fafc;">
                                {% set criteres = programme.criteres_generation or {} %}
                                <div class="row g-2">
                                    {% if criteres.get('seuil_critique') %}
                                    <div class="col-6">
                                        <span class="badge px-3 py-2 fw-normal" style="background: #dcfce7; color: #059669; border: 1px solid #bbf7d0; border-radius: 20px;">
                                            <i class="fas fa-check-circle me-1"></i>{{ t("Risques critiques") }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if criteres.get('seuil_eleve') %}
                                    <div class="col-6">
                                        <span class="badge px-3 py-2 fw-normal" style="background: #fff3e0; color: #b45309; border: 1px solid #fed7aa; border-radius: 20px;">
                                            <i class="fas fa-check-circle me-1"></i>{{ t("Risques élevés") }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if criteres.get('inclure_risques_moyens') %}
                                    <div class="col-6">
                                        <span class="badge px-3 py-2 fw-normal" style="background: #dbeafe; color: #2563eb; border: 1px solid #bfdbfe; border-radius: 20px;">
                                            <i class="fas fa-check-circle me-1"></i>{{ t("Risques moyens") }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if criteres.get('prioriser_processus_critiques') %}
                                    <div class="col-6">
                                        <span class="badge px-3 py-2 fw-normal" style="background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; border-radius: 20px;">
                                            <i class="fas fa-check-circle me-1"></i>{{ t("Processus critiques") }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Répartition par priorité -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; background: white;">
                <div class="card-header bg-transparent p-4" style="border-bottom: 1px solid #e2e8f0;">
                    <h5 class="fw-semibold mb-0" style="color: #0f172a;">
                        <i class="fas fa-chart-pie me-2" style="color: #2563eb;"></i>
                        {{ t("Répartition par priorité") }}
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-center mb-4">
                        <canvas id="prioriteChart" style="max-width: 250px; max-height: 250px;"></canvas>
                    </div>
                    
                    <div class="row g-3">
                        {% set priorites_dict = {
                            'critique': {'color': '#b91c1c', 'bg': '#fee2e2', 'icon': 'fire', 'text': 'Critique'},
                            'elevee': {'color': '#b45309', 'bg': '#fed7aa', 'icon': 'exclamation-triangle', 'text': 'Élevée'},
                            'moyenne': {'color': '#2563eb', 'bg': '#dbeafe', 'icon': 'minus-circle', 'text': 'Moyenne'},
                            'faible': {'color': '#64748b', 'bg': '#f1f5f9', 'icon': 'info-circle', 'text': 'Faible'}
                        } %}
                        
                        {% set missions_count = {'critique': 0, 'elevee': 0, 'moyenne': 0, 'faible': 0} %}
                        {% for mission in missions_data %}
                            {% if mission.priorite in missions_count %}
                                {% set _ = missions_count.update({mission.priorite: missions_count[mission.priorite] + 1}) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% for priorite_key, priorite_info in priorites_dict.items() %}
                            {% set count = missions_count[priorite_key] %}
                            {% if count > 0 %}
                            <div class="col-6">
                                <div class="p-3 rounded-2" style="background: {{ priorite_info.bg }};">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center p-2" 
                                             style="background: {{ priorite_info.color }}20; width: 36px; height: 36px;">
                                            <i class="fas fa-{{ priorite_info.icon }}" style="color: {{ priorite_info.color }};"></i>
                                        </div>
                                        <div>
                                            <h4 class="mb-0 fw-bold" style="color: {{ priorite_info.color }};">{{ count }}</h4>
                                            <small style="color: #64748b;">{{ priorite_info.text }}</small>
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 4px; background: #e2e8f0; border-radius: 2px;">
                                        {% set pourcentage = 0 %}
                                        {% if programme.nb_missions > 0 %}
                                            {% set pourcentage = (count / programme.nb_missions * 100)|round %}
                                        {% endif %}
                                        <div class="progress-bar" style="width: {{ pourcentage }}%; background: {{ priorite_info.color }}; border-radius: 2px;"></div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ========== BARRE DE SÉLECTION ========== -->
    <div id="selectionBar" class="d-none justify-content-between align-items-center mb-3 p-3 rounded-2" style="background: #dbeafe;">
        <div>
            <i class="fas fa-check-circle me-2" style="color: #2563eb;"></i>
            <span id="selectedCount" class="fw-semibold" style="color: #0f172a;">0</span> {{ t("mission(s) sélectionnée(s)") }}
        </div>
        <div class="d-flex gap-2">
            <button class="btn px-4 py-2 d-flex align-items-center gap-2" id="deleteSelectedBtn" onclick="preparerSuppressionBloc()"
                    style="border-radius: 10px; background: white; color: #b91c1c; border: 1px solid #e2e8f0;">
                <i class="fas fa-trash"></i>{{ t("Supprimer la sélection") }}
            </button>
            <button class="btn px-4 py-2 d-flex align-items-center gap-2" onclick="deselectAll()"
                    style="border-radius: 10px; background: white; color: #334155; border: 1px solid #e2e8f0;">
                <i class="fas fa-times"></i>{{ t("Désélectionner tout") }}
            </button>
        </div>
    </div>
    
    <!-- ============================================ -->
    <!-- LISTE DES MISSIONS D'AUDIT -->
    <!-- ============================================ -->
    <div class="card border-0 shadow-sm" style="border-radius: 16px; overflow: hidden; background: white;">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center p-4" style="border-bottom: 1px solid #e2e8f0;">
            <div>
                <h5 class="fw-semibold mb-1" style="color: #0f172a;">
                    <i class="fas fa-tasks me-2" style="color: #2563eb;"></i>
                    {{ t("Missions d'audit") }}
                </h5>
                <small style="color: #64748b;">{{ missions_data|length }} {{ t("mission(s) programmée(s)") }}</small>
                <!-- Badge pour filtre actif -->
                {% if request.args.get('statut') or request.args.get('priorite') %}
                <span class="badge ms-2 px-3 py-2" style="background: #2563eb; color: white; border-radius: 20px;" id="filterBadge">
                    <i class="fas fa-filter me-1"></i>
                    {% if request.args.get('statut') %}
                        {{ t("Statut") }}: {{ {'planifie': 'Planifiées', 'en_cours': 'En cours', 'termine': 'Terminées'}.get(request.args.get('statut'), request.args.get('statut')) }}
                    {% endif %}
                    {% if request.args.get('priorite') %}
                        {% if request.args.get('statut') %} + {% endif %}
                        {{ t("Priorité") }}: {{ {'critique': 'Critique', 'elevee': 'Élevée', 'moyenne': 'Moyenne', 'faible': 'Faible'}.get(request.args.get('priorite'), request.args.get('priorite')) }}
                    {% endif %}
                </span>
                {% endif %}
            </div>
            
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn px-4 py-2 dropdown-toggle d-flex align-items-center gap-2" 
                            type="button" data-bs-toggle="dropdown"
                            style="border-radius: 10px; background: white; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-filter" style="color: #64748b;"></i>
                        <span class="d-none d-md-inline">{{ t("Filtrer") }}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm" style="border-radius: 12px; padding: 8px;">
                        <li><a class="dropdown-item py-2" href="?"><i class="fas fa-list-ul me-2" style="color: #2563eb;"></i>{{ t("Toutes les missions") }}</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header" style="color: #64748b;">{{ t("Par statut") }}</h6></li>
                        <li><a class="dropdown-item py-2" href="?statut=planifie"><i class="fas fa-clock me-2" style="color: #64748b;"></i>{{ t("Planifiées") }}</a></li>
                        <li><a class="dropdown-item py-2" href="?statut=en_cours"><i class="fas fa-play-circle me-2" style="color: #2563eb;"></i>{{ t("En cours") }}</a></li>
                        <li><a class="dropdown-item py-2" href="?statut=termine"><i class="fas fa-check-circle me-2" style="color: #059669;"></i>{{ t("Terminées") }}</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header" style="color: #64748b;">{{ t("Par priorité") }}</h6></li>
                        <li><a class="dropdown-item py-2" href="?priorite=critique"><i class="fas fa-fire me-2" style="color: #b91c1c;"></i>{{ t("Critique") }}</a></li>
                        <li><a class="dropdown-item py-2" href="?priorite=elevee"><i class="fas fa-exclamation-triangle me-2" style="color: #b45309;"></i>{{ t("Élevée") }}</a></li>
                        <li><a class="dropdown-item py-2" href="?priorite=moyenne"><i class="fas fa-minus-circle me-2" style="color: #2563eb;"></i>{{ t("Moyenne") }}</a></li>
                        <li><a class="dropdown-item py-2" href="?priorite=faible"><i class="fas fa-info-circle me-2" style="color: #64748b;"></i>{{ t("Faible") }}</a></li>
                    </ul>
                </div>
                
                {% if missions_data|length == 0 %}
                <button class="btn px-4 py-2 d-flex align-items-center gap-2" 
                        data-bs-toggle="modal" data-bs-target="#addMissionModal"
                        style="border-radius: 10px; background: #2563eb; color: white; border: none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
                    <i class="fas fa-plus"></i>
                    <span class="d-none d-md-inline">{{ t("Ajouter") }}</span>
                </button>
                {% endif %}
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if missions_data %}
            <div class="table-responsive">
                <table class="table mb-0" style="min-width: 1400px;">
                    <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                        <tr>
                            <th width="40" class="px-4 py-3">
                                <input type="checkbox" id="selectAllMissions" onchange="toggleAllMissions()" style="accent-color: #2563eb;">
                            </th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold" style="color: #64748b;">{{ t("RÉFÉRENCE") }}</th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold" style="color: #64748b;">{{ t("TITRE & DESCRIPTION") }}</th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold" style="color: #64748b;">{{ t("PRIORITÉ") }}</th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold" style="color: #64748b;">{{ t("PLANIFICATION") }}</th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold" style="color: #64748b;">{{ t("STATUT") }}</th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold" style="color: #64748b;">{{ t("RISQUE") }}</th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold" style="color: #64748b;">{{ t("RESPONSABLE") }}</th>
                            <th class="px-4 py-3 text-uppercase small fw-semibold text-center" style="color: #64748b;">{{ t("ACTIONS") }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mission in missions_data %}
                        <tr style="border-bottom: 1px solid #f1f5f9; transition: all 0.2s ease; {% if mission.est_en_retard %}background: #fff3e0;{% endif %}" 
                           onmouseover="this.style.backgroundColor='#f8fafc'" 
                           onmouseout="this.style.backgroundColor='{% if mission.est_en_retard %}#fff3e0{% else %}transparent{% endif %}'">
                            <!-- COLONNE 1 : CHECKBOX -->
                            <td class="px-4 py-3">
                                <input type="checkbox" class="mission-checkbox" value="{{ mission.id }}" 
                                       onchange="toggleMissionSelection({{ mission.id }}, this)" style="accent-color: #2563eb;">
                            </td>
                            
                            <!-- COLONNE 2 : RÉFÉRENCE -->
                            <td class="px-4 py-3">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge px-3 py-2 fw-normal" style="background: #f8fafc; color: #2563eb; border: 1px solid #e2e8f0; border-radius: 20px;">
                                        {{ mission.reference }}
                                    </span>
                                    {% if mission.est_en_retard %}
                                    <span class="badge px-2 py-1" style="background: #b91c1c; color: white; border-radius: 20px;" data-bs-toggle="tooltip" title="{{ t("Mission en retard") }}">
                                        <i class="fas fa-exclamation"></i>
                                    </span>
                                    {% endif %}
                                    {% if mission.audit_id %}
                                    <span class="badge px-2 py-1" style="background: #2563eb; color: white; border-radius: 20px;" data-bs-toggle="tooltip" title="{{ t("Audit associé") }}">
                                        <i class="fas fa-link"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- COLONNE 3 : TITRE ET DESCRIPTION -->
                            <td class="px-4 py-3">
                                <div>
                                    <a href="#" class="text-decoration-none fw-semibold" style="color: #2563eb;" 
                                       data-bs-toggle="modal" data-bs-target="#missionModal{{ mission.id }}">
                                        {{ mission.titre }}
                                    </a>
                                    {% if mission.description %}
                                    <p class="mb-0 small" style="color: #64748b; max-width: 300px;">
                                        {{ mission.description|truncate(80) }}
                                    </p>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- COLONNE 4 : PRIORITÉ -->
                            <td class="px-4 py-3">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle" style="width: 10px; height: 10px; background: {% if mission.priorite == 'critique' %}#b91c1c{% elif mission.priorite == 'elevee' %}#b45309{% elif mission.priorite == 'moyenne' %}#2563eb{% else %}#64748b{% endif %};"></div>
                                    <span class="badge px-3 py-2 fw-normal" 
                                          style="background: {% if mission.priorite == 'critique' %}#b91c1c; color: white;
                                                 {% elif mission.priorite == 'elevee' %}#b45309; color: white;
                                                 {% elif mission.priorite == 'moyenne' %}#2563eb; color: white;
                                                 {% else %}#64748b; color: white;{% endif %}; border-radius: 20px;">
                                        {{ mission.priorite|capitalize if mission.priorite else 'Non défini' }}
                                    </span>
                                </div>
                                {% if mission.niveau_risque_associe %}
                                <small class="d-block mt-1" style="color: #64748b;">
                                    {{ t("Risque") }}: {{ mission.niveau_risque_associe }}
                                </small>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 5 : PLANIFICATION -->
                            <td class="px-4 py-3">
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold" style="color: #0f172a;">
                                        {{ mission.annee_prevue }}
                                        {% if mission.trimestre_prevue %}
                                        - T{{ mission.trimestre_prevue }}
                                        {% endif %}
                                    </span>
                                    <small style="color: #64748b;">
                                        <i class="fas fa-clock me-1" style="color: #64748b;"></i>{{ mission.duree_estimee or 0 }} {{ t("jours") }}
                                    </small>
                                    {% if mission.jours_restants > 0 %}
                                    <small style="color: #059669;">
                                        <i class="far fa-calendar me-1"></i>{{ mission.jours_restants }}j {{ t("restants") }}
                                    </small>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- COLONNE 6 : STATUT -->
                            <td class="px-4 py-3">
                                <span class="badge px-3 py-2 fw-normal" 
                                      style="background: {% if mission.statut == 'planifie' %}#64748b; color: white; border: 1px solid #e2e8f0;
                                             {% elif mission.statut == 'en_cours' %}#2563eb; color: white;
                                             {% elif mission.statut == 'termine' %}#059669; color: white;
                                             {% else %}#b45309; color: white;{% endif %}; border-radius: 20px;">
                                    {{ mission.statut|replace('_', ' ')|title if mission.statut else 'Non défini' }}
                                </span>
                                {% if mission.date_debut_reelle %}
                                <small class="d-block mt-1" style="color: #64748b;">
                                    {% if mission.date_debut_reelle is string %}
                                        {{ t("Début") }}: {{ mission.date_debut_reelle.split('-')[2] }}/{{ mission.date_debut_reelle.split('-')[1] }}
                                    {% else %}
                                        {{ t("Début") }}: {{ mission.date_debut_reelle }}
                                    {% endif %}
                                </small>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 7 : RISQUE ASSOCIÉ -->
                            <td class="px-4 py-3">
                                {% if mission.risque %}
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle p-1" style="background: #fed7aa;">
                                        <i class="fas fa-exclamation-triangle" style="color: #b45309; font-size: 0.8rem;"></i>
                                    </div>
                                    <div>
                                        <a href="{{ url_for('detail_risque', id=mission.risque.id) }}" 
                                           class="text-decoration-none d-block small fw-semibold" style="color: #b45309;">
                                            {{ mission.risque.reference if mission.risque.reference else 'N/A' }}
                                        </a>
                                        <small class="d-block" style="color: #64748b; max-width: 150px;">
                                            {{ mission.risque.intitule|truncate(30) if mission.risque.intitule else 'Pas de titre' }}
                                        </small>
                                    </div>
                                </div>
                                {% else %}
                                <span class="small" style="color: #94a3b8;">{{ t("Aucun risque") }}</span>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 8 : RESPONSABLE -->
                            <td class="px-4 py-3">
                                {% if mission.responsable %}
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 30px; height: 30px; background: #2563eb;">
                                        <i class="fas fa-user text-white small"></i>
                                    </div>
                                    <span class="small fw-semibold" style="color: #0f172a;">{{ mission.responsable.username }}</span>
                                </div>
                                {% else %}
                                <span class="small" style="color: #94a3b8;">{{ t("Non assigné") }}</span>
                                {% endif %}
                            </td>
                            
                            <!-- COLONNE 9 : ACTIONS -->
                            <td class="px-4 py-3 text-center">
                                <div class="btn-group" role="group" style="display: inline-flex; gap: 2px;">
                                    <button type="button" class="btn btn-sm px-3" 
                                            data-bs-toggle="modal" data-bs-target="#missionModal{{ mission.id }}"
                                            title="{{ t("Détails") }}"
                                            style="background: #f8fafc; color: #2563eb; border: 1px solid #e2e8f0; border-radius: 8px 0 0 8px;">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    
                                    <div class="btn-group" role="group">
                                        <button type="button" 
                                                class="btn btn-sm px-3 dropdown-toggle" 
                                                id="dropdownActions{{ mission.id }}"
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false"
                                                style="background: #f8fafc; color: #334155; border: 1px solid #e2e8f0; border-left: none; border-radius: 0 8px 8px 0;">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownActions{{ mission.id }}" style="border-radius: 12px; padding: 8px;">
                                            {% if not mission.audit_id and mission.statut == 'planifie' %}
                                            <li>
                                                <a class="dropdown-item py-2" href="{{ url_for('convertir_mission_audit', id=mission.id) }}">
                                                    <i class="fas fa-play me-2" style="color: #059669;"></i>{{ t("Convertir en audit") }}
                                                </a>
                                            </li>
                                            {% elif mission.audit_id %}
                                            <li>
                                                <a class="dropdown-item py-2" href="{{ url_for('detail_audit', id=mission.audit_id) }}">
                                                    <i class="fas fa-external-link-alt me-2" style="color: #2563eb;"></i>{{ t("Voir l'audit") }}
                                                </a>
                                            </li>
                                            {% endif %}
                                            <li>
                                                <a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#editMissionModal{{ mission.id }}">
                                                    <i class="fas fa-edit me-2" style="color: #b45309;"></i>{{ t("Modifier") }}
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#reprogrammerMissionModal{{ mission.id }}">
                                                    <i class="fas fa-calendar-alt me-2" style="color: #2563eb;"></i>{{ t("Reprogrammer") }}
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item py-2" href="{{ url_for('plan_pluie_programme', programme_id=programme.id) }}">
                                                    <i class="fas fa-umbrella me-2" style="color: #b45309;"></i>{{ t("Plan de repli") }}
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item py-2 text-danger" href="#" onclick="openSupprimerMissionModal({{ mission.id }}); return false;">
                                                    <i class="fas fa-trash me-2" style="color: #b91c1c;"></i>{{ t("Supprimer") }}
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Message d'information sur le filtre -->
            {% if request.args.get('statut') or request.args.get('priorite') %}
            <div class="alert d-flex justify-content-between align-items-center mt-3 mx-3 p-3" style="background: #dbeafe; border-radius: 12px;" id="filterInfo">
                <div>
                    <i class="fas fa-filter me-2" style="color: #2563eb;"></i>
                    <span id="filterInfoText" style="color: #0f172a;">
                        {{ visible_rows_count if visible_rows_count else missions_data|rejectattr('hidden', 'defined')|list|length }} {{ t("mission(s) sur") }} {{ missions_data|length }} {{ t("affichée(s)") }}
                    </span>
                </div>
                <a href="?" class="text-decoration-none small fw-semibold" style="color: #2563eb;">{{ t("Réinitialiser les filtres") }}</a>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-clipboard-list fa-3x" style="color: #cbd5e1;"></i>
                </div>
                <h5 class="fw-semibold mb-2" style="color: #0f172a;">{{ t("Aucune mission d'audit") }}</h5>
                <p class="mb-4" style="color: #64748b;">{{ t("Ce programme ne contient pas encore de missions d'audit.") }}</p>
                <div class="d-flex justify-content-center gap-3">
                    {% if programme.methode_generation == 'auto_risques' %}
                    <a href="{{ url_for('generer_missions_auto_programme', id=programme.id) }}" 
                       class="btn px-4 py-2 d-flex align-items-center gap-2"
                       style="border-radius: 10px; background: #7c3aed; color: white; border: none; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
                        <i class="fas fa-robot"></i>
                        {{ t("Générer automatiquement") }}
                    </a>
                    {% endif %}
                    <button class="btn px-4 py-2 d-flex align-items-center gap-2" 
                            data-bs-toggle="modal" data-bs-target="#addMissionModal"
                            style="border-radius: 10px; background: #2563eb; color: white; border: none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
                        <i class="fas fa-plus"></i>
                        {{ t("Ajouter manuellement") }}
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODALS - GESTION DU PROGRAMME -->
<!-- ============================================ -->

<!-- Modal de modification du programme -->
<div class="modal fade" id="editProgrammeModal{{ programme.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #2563eb; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-edit fa-lg" style="color: #2563eb;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Modifier le programme") }}</h5>
                        <span class="small text-white opacity-75">{{ programme.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('modifier_programme_audit', id=programme.id) }}">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("NOM DU PROGRAMME") }} *</label>
                            <input type="text" class="form-control border-0 bg-light px-4 py-3" name="nom" 
                                   value="{{ programme.nom }}" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("PÉRIODE") }} *</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="periode" required style="border-radius: 12px;">
                                <option value="annuel" {% if programme.periode == 'annuel' %}selected{% endif %}>Annuel</option>
                                <option value="triennal" {% if programme.periode == 'triennal' %}selected{% endif %}>Triennal</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("DESCRIPTION") }}</label>
                            <textarea class="form-control border-0 bg-light px-4 py-3" name="description" rows="3" style="border-radius: 12px;">{{ programme.description or '' }}</textarea>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("ANNÉE DÉBUT") }} *</label>
                            <input type="number" class="form-control border-0 bg-light px-4 py-3" name="annee_debut" 
                                   value="{{ programme.annee_debut }}" min="{{ now().year }}" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("ANNÉE FIN") }} *</label>
                            <input type="number" class="form-control border-0 bg-light px-4 py-3" name="annee_fin" 
                                   value="{{ programme.annee_fin }}" min="{{ programme.annee_debut }}" required style="border-radius: 12px;">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("MÉTHODE DE GÉNÉRATION") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="methode_generation" style="border-radius: 12px;">
                                <option value="manuel" {% if programme.methode_generation == 'manuel' %}selected{% endif %}>Manuel</option>
                                <option value="auto_risques" {% if programme.methode_generation == 'auto_risques' %}selected{% endif %}>Automatique</option>
                                <option value="hybride" {% if programme.methode_generation == 'hybride' %}selected{% endif %}>Hybride</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("FRÉQUENCE D'AUDIT") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="frequence_audit" style="border-radius: 12px;">
                                <option value="">{{ t("Non spécifiée") }}</option>
                                <option value="annuelle" {% if programme.frequence_audit == 'annuelle' %}selected{% endif %}>Annuelle</option>
                                <option value="semestrielle" {% if programme.frequence_audit == 'semestrielle' %}selected{% endif %}>Semestrielle</option>
                                <option value="trimestrielle" {% if programme.frequence_audit == 'trimestrielle' %}selected{% endif %}>Trimestrielle</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("DURÉE MOYENNE") }} ({{ t("jours") }})</label>
                            <input type="number" class="form-control border-0 bg-light px-4 py-3" name="duree_moyenne_mission" 
                                   value="{{ programme.duree_moyenne_mission or 5 }}" min="1" max="30" style="border-radius: 12px;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RESSOURCES") }} ({{ t("jours/homme/an") }})</label>
                            <input type="number" class="form-control border-0 bg-light px-4 py-3" name="ressources_disponibles" 
                                   value="{{ programme.ressources_disponibles or 100 }}" min="10" max="1000" style="border-radius: 12px;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #2563eb; color: white; border: none;">
                        <i class="fas fa-save me-2"></i>{{ t("Enregistrer") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'approbation du programme -->
<div class="modal fade" id="approuverModal{{ programme.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #059669; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-check-circle fa-lg" style="color: #059669;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Approuver le programme") }}</h5>
                        <span class="small text-white opacity-75">{{ programme.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('approuver_programme_audit', id=programme.id) }}">
                <div class="modal-body p-4">
                    <div class="d-flex align-items-center gap-3 p-3 mb-3" style="background: #f8fafc; border-radius: 12px;">
                        <div class="rounded-circle p-2" style="background: #dcfce7;">
                            <i class="fas fa-info-circle" style="color: #059669;"></i>
                        </div>
                        <div>
                            <div class="fw-semibold" style="color: #0f172a;">{{ programme.nom }}</div>
                            <small style="color: #64748b;">{{ programme.annee_debut }}-{{ programme.annee_fin }}</small>
                        </div>
                    </div>
                    
                    <p class="mb-3" style="color: #334155;">{{ t("Une fois approuvé, le programme passera au statut") }} <span class="badge px-3 py-2" style="background: #059669; color: white; border-radius: 20px;">{{ t("Actif") }}</span></p>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("DATE D'APPROBATION") }}</label>
                        <input type="date" class="form-control border-0 bg-light px-4 py-3" name="date_approbation" 
                               value="{{ now().strftime('%Y-%m-%d') if now else '' }}"
                               style="border-radius: 12px;">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("COMMENTAIRES") }}</label>
                        <textarea class="form-control border-0 bg-light px-4 py-3" name="commentaires" rows="2" style="border-radius: 12px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #059669; color: white; border: none;">
                        <i class="fas fa-check-circle me-2"></i>{{ t("Approuver") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de désapprobation du programme -->
<div class="modal fade" id="desapprouverModal{{ programme.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #b45309; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-ban fa-lg" style="color: #b45309;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Désapprouver le programme") }}</h5>
                        <span class="small text-white opacity-75">{{ programme.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('desapprouver_programme_audit', id=programme.id) }}">
                <div class="modal-body p-4">
                    <div class="d-flex align-items-center gap-3 p-3 mb-3" style="background: #fff3e0; border-radius: 12px;">
                        <div class="rounded-circle p-2" style="background: #fed7aa;">
                            <i class="fas fa-exclamation-triangle" style="color: #b45309;"></i>
                        </div>
                        <div>
                            <div class="fw-semibold" style="color: #0f172a;">{{ programme.nom }}</div>
                            <small style="color: #64748b;">{{ t("Le programme repassera en statut") }} <span class="badge px-2" style="background: #7c3aed; color: white;">{{ t("En élaboration") }}</span></small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RAISON DE LA DÉSAPPROBATION") }} *</label>
                        <select class="form-select border-0 bg-light px-4 py-3" name="raison" required style="border-radius: 12px;">
                            <option value="">{{ t("Sélectionnez une raison...") }}</option>
                            <option value="Informations incomplètes">📋 {{ t("Informations incomplètes") }}</option>
                            <option value="Risques non évalués">⚠️ {{ t("Risques non évalués") }}</option>
                            <option value="Ressources insuffisantes">👥 {{ t("Ressources insuffisantes") }}</option>
                            <option value="Changement de priorité">🎯 {{ t("Changement de priorité") }}</option>
                            <option value="Autre">📌 {{ t("Autre") }}</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("COMMENTAIRES") }}</label>
                        <textarea class="form-control border-0 bg-light px-4 py-3" name="commentaires" rows="2" style="border-radius: 12px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #b45309; color: white; border: none;">
                        <i class="fas fa-ban me-2"></i>{{ t("Désapprouver") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'archivage du programme -->
<div class="modal fade" id="archiverModal{{ programme.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #b91c1c; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-archive fa-lg" style="color: #b91c1c;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Archiver le programme") }}</h5>
                        <span class="small text-white opacity-75">{{ programme.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('archiver_programme_audit', id=programme.id) }}">
                <div class="modal-body p-4">
                    <div class="d-flex align-items-center gap-3 p-3 mb-3" style="background: #fee2e2; border-radius: 12px;">
                        <div class="rounded-circle p-2" style="background: #fecaca;">
                            <i class="fas fa-exclamation-triangle" style="color: #b91c1c;"></i>
                        </div>
                        <div>
                            <div class="fw-semibold" style="color: #0f172a;">{{ programme.nom }}</div>
                            <small style="color: #64748b;">{{ t("Le programme sera déplacé vers les archives") }}</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RAISON DE L'ARCHIVAGE") }} *</label>
                        <select class="form-select border-0 bg-light px-4 py-3" name="raison" required style="border-radius: 12px;">
                            <option value="">{{ t("Sélectionnez une raison...") }}</option>
                            <option value="Programme terminé">{{ t("Programme terminé") }}</option>
                            <option value="Période expirée">{{ t("Période expirée") }}</option>
                            <option value="Remplacement">{{ t("Remplacé par un nouveau programme") }}</option>
                            <option value="Annulation">{{ t("Programme annulé") }}</option>
                            <option value="Autre">{{ t("Autre") }}</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("COMMENTAIRES") }}</label>
                        <textarea class="form-control border-0 bg-light px-4 py-3" name="commentaire" rows="2" style="border-radius: 12px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #b91c1c; color: white; border: none;">
                        <i class="fas fa-archive me-2"></i>{{ t("Confirmer l'archivage") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODALS - GESTION DES MISSIONS -->
<!-- ============================================ -->

<!-- Modal d'ajout de mission -->
<div class="modal fade" id="addMissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #2563eb; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-plus-circle fa-lg" style="color: #2563eb;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Ajouter une mission d'audit") }}</h5>
                        <span class="small text-white opacity-75">{{ programme.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('ajouter_mission_programme', programme_id=programme.id) }}">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("TITRE DE LA MISSION") }} *</label>
                            <input type="text" class="form-control border-0 bg-light px-4 py-3" name="titre" 
                                   placeholder="{{ t("Ex: Audit des processus financiers") }}" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("PRIORITÉ") }} *</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="priorite" required style="border-radius: 12px;">
                                <option value="">{{ t("Sélectionnez...") }}</option>
                                <option value="critique">🔴 {{ t("Critique") }}</option>
                                <option value="elevee">🟠 {{ t("Élevée") }}</option>
                                <option value="moyenne">🔵 {{ t("Moyenne") }}</option>
                                <option value="faible">⚪ {{ t("Faible") }}</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("DESCRIPTION") }}</label>
                            <textarea class="form-control border-0 bg-light px-4 py-3" name="description" rows="3" 
                                      placeholder="{{ t("Description détaillée de la mission...") }}" style="border-radius: 12px;"></textarea>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("ANNÉE PRÉVUE") }} *</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="annee_prevue" required style="border-radius: 12px;">
                                {% for annee in range(programme.annee_debut, programme.annee_fin + 1) %}
                                <option value="{{ annee }}" {% if annee == programme.annee_debut %}selected{% endif %}>
                                    {{ annee }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("TRIMESTRE") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="trimestre_prevue" style="border-radius: 12px;">
                                <option value="">{{ t("Non spécifié") }}</option>
                                <option value="1">T1 - {{ t("1er trimestre") }}</option>
                                <option value="2">T2 - {{ t("2ème trimestre") }}</option>
                                <option value="3">T3 - {{ t("3ème trimestre") }}</option>
                                <option value="4">T4 - {{ t("4ème trimestre") }}</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("DURÉE ESTIMÉE") }} ({{ t("jours") }})</label>
                            <input type="number" class="form-control border-0 bg-light px-4 py-3" name="duree_estimee" 
                                   value="{{ programme.duree_moyenne_mission or 5 }}" min="1" max="60" style="border-radius: 12px;">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>{{ t("RISQUE ASSOCIÉ") }}
                            </label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="risque_id" style="border-radius: 12px;">
                                <option value="">{{ t("Aucun risque associé") }}</option>
                                {% for risque in risques_disponibles %}
                                <option value="{{ risque.id }}">
                                    {{ risque.reference if risque.reference else risque.id }} - {{ risque.intitule|truncate(40) if risque.intitule else 'Pas de titre' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">
                                <i class="fas fa-user text-primary me-1"></i>{{ t("RESPONSABLE") }}
                            </label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="responsable_id" style="border-radius: 12px;">
                                <option value="">{{ t("Non assigné") }}</option>
                                {% for user in utilisateurs %}
                                <option value="{{ user.id }}">
                                    {{ user.nom if user.nom else user.username }} {{ user.prenom if user.prenom else '' }} ({{ user.role if user.role else 'Utilisateur' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #2563eb; color: white; border: none;">
                        <i class="fas fa-save me-2"></i>{{ t("Créer la mission") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals de détail des missions -->
{% for mission in missions_data %}
<div class="modal fade" id="missionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: {% if mission.priorite == 'critique' %}#b91c1c{% elif mission.priorite == 'elevee' %}#b45309{% elif mission.priorite == 'moyenne' %}#2563eb{% else %}#64748b{% endif %}; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-clipboard-check fa-lg" style="color: {% if mission.priorite == 'critique' %}#b91c1c{% elif mission.priorite == 'elevee' %}#b45309{% elif mission.priorite == 'moyenne' %}#2563eb{% else %}#64748b{% endif %};"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ mission.reference }}</h5>
                        <p class="mb-0 text-white opacity-75 small">{{ mission.titre }}</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-8">
                        <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("DESCRIPTION") }}</span>
                        <div class="p-3 mb-4 rounded-2" style="background: #f8fafc;">
                            {{ mission.description or 'Aucune description fournie'|nl2br }}
                        </div>
                        
                        {% if mission.risque %}
                        <span class="text-uppercase small fw-semibold mb-2 d-block" style="color: #64748b;">{{ t("RISQUE ASSOCIÉ") }}</span>
                        <div class="p-3 mb-4 rounded-2" style="background: #fff3e0;">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1" style="color: #b45309;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        {{ mission.risque.reference }} - {{ mission.risque.intitule }}
                                    </h6>
                                    <p class="small mb-2" style="color: #64748b;">{{ mission.risque.description|truncate(200) if mission.risque.description else 'Pas de description' }}</p>
                                </div>
                                <a href="{{ url_for('detail_risque', id=mission.risque.id) }}" 
                                   class="btn btn-sm px-3" style="border-radius: 8px; background: white; color: #b45309; border: 1px solid #fed7aa;">
                                    <i class="fas fa-external-link-alt me-1"></i>{{ t("Voir") }}
                                </a>
                            </div>
                            <div class="d-flex gap-3">
                                {% if mission.risque.categorie %}
                                <small style="color: #64748b;">
                                    <i class="fas fa-tag me-1" style="color: #b45309;"></i>
                                    {{ mission.risque.categorie }}
                                </small>
                                {% endif %}
                                {% if mission.niveau_risque_associe %}
                                <small style="color: #64748b;">
                                    <i class="fas fa-bolt me-1" style="color: #b45309;"></i>
                                    {{ mission.niveau_risque_associe }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <span class="text-uppercase small fw-semibold mb-3 d-block" style="color: #64748b;">{{ t("INFORMATIONS") }}</span>
                        
                        <div class="mb-4">
                            <small class="d-block mb-1" style="color: #64748b;">{{ t("Priorité") }}</small>
                            <span class="badge px-3 py-2" 
                                  style="background: {% if mission.priorite == 'critique' %}#b91c1c; color: white;
                                         {% elif mission.priorite == 'elevee' %}#b45309; color: white;
                                         {% elif mission.priorite == 'moyenne' %}#2563eb; color: white;
                                         {% else %}#64748b; color: white;{% endif %}; border-radius: 20px;">
                                {{ mission.priorite|upper if mission.priorite else 'N/A' }}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <small class="d-block mb-1" style="color: #64748b;">{{ t("Statut") }}</small>
                            <span class="badge px-3 py-2" 
                                  style="background: {% if mission.statut == 'planifie' %}#64748b; color: white;
                                         {% elif mission.statut == 'en_cours' %}#2563eb; color: white;
                                         {% elif mission.statut == 'termine' %}#059669; color: white;
                                         {% else %}#b45309; color: white;{% endif %}; border-radius: 20px;">
                                {{ mission.statut|replace('_', ' ')|title if mission.statut else 'Non défini' }}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <small class="d-block mb-1" style="color: #64748b;">{{ t("Planification") }}</small>
                            <div class="d-flex flex-column">
                                <span class="fw-semibold" style="color: #0f172a;">
                                    {{ mission.annee_prevue }}
                                    {% if mission.trimestre_prevue %}
                                    - T{{ mission.trimestre_prevue }}
                                    {% endif %}
                                </span>
                                <small style="color: #64748b;">
                                    {{ t("Durée") }}: {{ mission.duree_estimee or 0 }} {{ t("jours") }}
                                </small>
                                {% if mission.jours_restants > 0 %}
                                <small style="color: #059669;">
                                    <i class="fas fa-clock me-1"></i>{{ mission.jours_restants }} {{ t("jours restants") }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if mission.responsable %}
                        <div class="mb-4">
                            <small class="d-block mb-1" style="color: #64748b;">{{ t("Responsable") }}</small>
                            <div class="d-flex align-items-center gap-2">
                                <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 36px; height: 36px; background: #2563eb;">
                                    <i class="fas fa-user text-white small"></i>
                                </div>
                                <div>
                                    <span class="d-block fw-semibold" style="color: #0f172a;">{{ mission.responsable.username }}</span>
                                    <small style="color: #64748b;">{{ mission.responsable.role }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if mission.audit_id %}
                        <div class="p-3 rounded-2" style="background: #dbeafe;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-link" style="color: #2563eb;"></i>
                                <div>
                                    <strong style="color: #0f172a;">{{ t("Audit associé") }}</strong>
                                    <div>
                                        <a href="{{ url_for('detail_audit', id=mission.audit_id) }}" 
                                           class="text-decoration-none small" style="color: #2563eb;">
                                            {% if mission.audit %}
                                                {{ mission.audit.reference }}
                                            {% else %}
                                                {{ t("Audit") }} #{{ mission.audit_id }}
                                            {% endif %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                        style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                    <i class="fas fa-times me-2"></i>{{ t("Fermer") }}
                </button>
                {% if not mission.audit_id and mission.statut == 'planifie' %}
                <a href="{{ url_for('convertir_mission_audit', id=mission.id) }}" 
                   class="btn w-100 py-2" style="border-radius: 10px; background: #059669; color: white; border: none;">
                    <i class="fas fa-play me-2"></i>{{ t("Convertir en audit") }}
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal de modification de mission -->
{% for mission in missions_data %}
<div class="modal fade" id="editMissionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #b45309; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-edit fa-lg" style="color: #b45309;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Modifier la mission") }}</h5>
                        <span class="small text-white opacity-75">{{ mission.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('modifier_mission_audit', mission_id=mission.id) }}">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("TITRE DE LA MISSION") }} *</label>
                            <input type="text" class="form-control border-0 bg-light px-4 py-3" name="titre" 
                                   value="{{ mission.titre }}" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("PRIORITÉ") }} *</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="priorite" required style="border-radius: 12px;">
                                <option value="critique" {% if mission.priorite == 'critique' %}selected{% endif %}>🔴 {{ t("Critique") }}</option>
                                <option value="elevee" {% if mission.priorite == 'elevee' %}selected{% endif %}>🟠 {{ t("Élevée") }}</option>
                                <option value="moyenne" {% if mission.priorite == 'moyenne' %}selected{% endif %}>🔵 {{ t("Moyenne") }}</option>
                                <option value="faible" {% if mission.priorite == 'faible' %}selected{% endif %}>⚪ {{ t("Faible") }}</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("DESCRIPTION") }}</label>
                            <textarea class="form-control border-0 bg-light px-4 py-3" name="description" rows="3" style="border-radius: 12px;">{{ mission.description or '' }}</textarea>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("ANNÉE PRÉVUE") }} *</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="annee_prevue" required style="border-radius: 12px;">
                                {% for annee in range(programme.annee_debut, programme.annee_fin + 1) %}
                                <option value="{{ annee }}" {% if annee == mission.annee_prevue %}selected{% endif %}>
                                    {{ annee }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("TRIMESTRE") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="trimestre_prevue" style="border-radius: 12px;">
                                <option value="">{{ t("Non spécifié") }}</option>
                                <option value="1" {% if mission.trimestre_prevue == 1 %}selected{% endif %}>T1 - {{ t("1er trimestre") }}</option>
                                <option value="2" {% if mission.trimestre_prevue == 2 %}selected{% endif %}>T2 - {{ t("2ème trimestre") }}</option>
                                <option value="3" {% if mission.trimestre_prevue == 3 %}selected{% endif %}>T3 - {{ t("3ème trimestre") }}</option>
                                <option value="4" {% if mission.trimestre_prevue == 4 %}selected{% endif %}>T4 - {{ t("4ème trimestre") }}</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("DURÉE ESTIMÉE") }} ({{ t("jours") }})</label>
                            <input type="number" class="form-control border-0 bg-light px-4 py-3" name="duree_estimee" 
                                   value="{{ mission.duree_estimee or 5 }}" min="1" max="60" style="border-radius: 12px;">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RISQUE ASSOCIÉ") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="risque_id" style="border-radius: 12px;">
                                <option value="">{{ t("Aucun risque") }}</option>
                                {% for risque in risques_disponibles %}
                                <option value="{{ risque.id }}" {% if mission.risque and mission.risque.id == risque.id %}selected{% endif %}>
                                    {{ risque.reference }} - {{ risque.intitule|truncate(40) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RESPONSABLE") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="responsable_id" style="border-radius: 12px;">
                                <option value="">{{ t("Non assigné") }}</option>
                                {% for user in utilisateurs %}
                                <option value="{{ user.id }}" {% if mission.responsable and mission.responsable.id == user.id %}selected{% endif %}>
                                    {{ user.nom or user.username }} {{ user.prenom or '' }} ({{ user.role or 'Utilisateur' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("STATUT") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="statut" style="border-radius: 12px;">
                                <option value="planifie" {% if mission.statut == 'planifie' %}selected{% endif %}>📋 {{ t("Planifiée") }}</option>
                                <option value="en_cours" {% if mission.statut == 'en_cours' %}selected{% endif %}>⚙️ {{ t("En cours") }}</option>
                                <option value="termine" {% if mission.statut == 'termine' %}selected{% endif %}>✅ {{ t("Terminée") }}</option>
                                <option value="reporte" {% if mission.statut == 'reporte' %}selected{% endif %}>⏰ {{ t("Reportée") }}</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #b45309; color: white; border: none;">
                        <i class="fas fa-save me-2"></i>{{ t("Enregistrer") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de reprogrammation de mission -->
<div class="modal fade" id="reprogrammerMissionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #2563eb; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-calendar-alt fa-lg" style="color: #2563eb;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Reprogrammer") }}</h5>
                        <span class="small text-white opacity-75">{{ mission.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('reprogrammer_mission_audit', mission_id=mission.id) }}">
                <div class="modal-body p-4">
                    <div class="alert d-flex align-items-center gap-3 p-3 mb-4" style="background: #dbeafe; border-radius: 12px;">
                        <i class="fas fa-info-circle" style="color: #2563eb;"></i>
                        <span style="color: #0f172a;">{{ t("Modifiez les dates prévues pour cette mission.") }}</span>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("NOUVELLE ANNÉE") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="nouvelle_annee" style="border-radius: 12px;">
                                <option value="">{{ t("Non modifié") }}</option>
                                {% for annee in range(programme.annee_debut, programme.annee_fin + 1) %}
                                <option value="{{ annee }}" {% if annee == mission.annee_prevue %}selected{% endif %}>
                                    {{ annee }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("NOUVEAU TRIMESTRE") }}</label>
                            <select class="form-select border-0 bg-light px-4 py-3" name="nouveau_trimestre" style="border-radius: 12px;">
                                <option value="">{{ t("Non modifié") }}</option>
                                <option value="1" {% if mission.trimestre_prevue == 1 %}selected{% endif %}>T1 - {{ t("1er trimestre") }}</option>
                                <option value="2" {% if mission.trimestre_prevue == 2 %}selected{% endif %}>T2 - {{ t("2ème trimestre") }}</option>
                                <option value="3" {% if mission.trimestre_prevue == 3 %}selected{% endif %}>T3 - {{ t("3ème trimestre") }}</option>
                                <option value="4" {% if mission.trimestre_prevue == 4 %}selected{% endif %}>T4 - {{ t("4ème trimestre") }}</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("NOUVELLE DATE DE DÉBUT") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-4 py-3" name="nouvelle_date_debut" 
                                   value="{{ mission.date_debut_prevue.strftime('%Y-%m-%d') if mission.date_debut_prevue else '' }}"
                                   style="border-radius: 12px;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("NOUVELLE DATE DE FIN") }}</label>
                            <input type="date" class="form-control border-0 bg-light px-4 py-3" name="nouvelle_date_fin" 
                                   value="{{ mission.date_fin_prevue.strftime('%Y-%m-%d') if mission.date_fin_prevue else '' }}"
                                   style="border-radius: 12px;">
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RAISON DE LA REPROGRAMMATION") }}</label>
                            <textarea class="form-control border-0 bg-light px-4 py-3" name="raison" rows="2" 
                                      placeholder="{{ t("Expliquez pourquoi cette mission est reprogrammée...") }}" style="border-radius: 12px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #2563eb; color: white; border: none;">
                        <i class="fas fa-calendar-check me-2"></i>{{ t("Reprogrammer") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de suppression de mission -->
<div class="modal fade" id="supprimerMissionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #b91c1c; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-trash fa-lg" style="color: #b91c1c;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Supprimer la mission") }}</h5>
                        <span class="small text-white opacity-75">{{ mission.reference }}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('supprimer_mission_audit', mission_id=mission.id) }}">
                <div class="modal-body p-4">
                    <div class="d-flex align-items-center gap-3 p-3 mb-3" style="background: #fee2e2; border-radius: 12px;">
                        <div class="rounded-circle p-2" style="background: #fecaca;">
                            <i class="fas fa-exclamation-triangle" style="color: #b91c1c;"></i>
                        </div>
                        <div>
                            <h6 class="fw-semibold mb-1" style="color: #0f172a;">{{ t("Confirmation de suppression") }}</h6>
                            <p class="mb-0 small" style="color: #64748b;">
                                {{ t("Êtes-vous sûr de vouloir supprimer la mission") }} <strong>{{ mission.reference }}</strong> ?<br>
                                {{ t("Cette action est irréversible.") }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RAISON DE LA SUPPRESSION") }} *</label>
                        <select class="form-select border-0 bg-light px-4 py-3" name="raison" required style="border-radius: 12px;">
                            <option value="">{{ t("Sélectionnez une raison...") }}</option>
                            <option value="mission_annulee">📌 {{ t("Mission annulée") }}</option>
                            <option value="plan_change">📅 {{ t("Planification modifiée") }}</option>
                            <option value="doublon">🔄 {{ t("Mission en doublon") }}</option>
                            <option value="autre">❓ {{ t("Autre") }}</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("COMMENTAIRES") }}</label>
                        <textarea class="form-control border-0 bg-light px-4 py-3" name="commentaires" rows="2" 
                                  placeholder="{{ t("Détaillez la raison de la suppression...") }}" style="border-radius: 12px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                            style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                        <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                    </button>
                    <button type="submit" class="btn w-100 py-2" style="border-radius: 10px; background: #b91c1c; color: white; border: none;">
                        <i class="fas fa-trash me-2"></i>{{ t("Confirmer la suppression") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal de suppression en bloc -->
<div class="modal fade" id="supprimerBlocModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="p-4" style="background: #b91c1c; border-radius: 20px 20px 0 0;">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-white p-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-trash-alt fa-lg" style="color: #b91c1c;"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-white mb-1">{{ t("Supprimer les missions sélectionnées") }}</h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            
            <div class="modal-body p-4">
                <div class="d-flex align-items-center gap-3 p-3 mb-3" style="background: #fee2e2; border-radius: 12px;">
                    <div class="rounded-circle p-2" style="background: #fecaca;">
                        <i class="fas fa-exclamation-triangle" style="color: #b91c1c;"></i>
                    </div>
                    <div>
                        <h6 class="fw-semibold mb-1" style="color: #0f172a;">{{ t("Attention !") }}</h6>
                        <p class="mb-0 small" style="color: #64748b;" id="selectedCountMessage">0 {{ t("mission(s) sélectionnée(s)") }}</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("RAISON DE LA SUPPRESSION") }} *</label>
                    <select class="form-select border-0 bg-light px-4 py-3" id="blocRaison" required style="border-radius: 12px;">
                        <option value="Missions annulées">{{ t("Missions annulées") }}</option>
                        <option value="Changement de planning">{{ t("Changement de planning") }}</option>
                        <option value="Risques obsolètes">{{ t("Risques obsolètes") }}</option>
                        <option value="Doublons">{{ t("Missions en doublon") }}</option>
                        <option value="Autre">{{ t("Autre") }}</option>
                    </select>
                </div>
                
                <div class="mb-3" id="autreRaisonContainer" style="display: none;">
                    <label class="form-label fw-semibold small text-uppercase" style="color: #64748b;">{{ t("PRÉCISEZ LA RAISON") }}</label>
                    <input type="text" class="form-control border-0 bg-light px-4 py-3" id="autreRaison" placeholder="{{ t("Raison de la suppression...") }}" style="border-radius: 12px;">
                </div>

                <div class="mt-3 p-3 rounded-2" style="background: #f8fafc;" id="missionsListe">
                    <!-- La liste des missions sélectionnées sera injectée ici -->
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn w-100 py-2 mb-2" data-bs-dismiss="modal"
                        style="border-radius: 10px; background: #f8fafc; color: #334155; border: 1px solid #e2e8f0;">
                    <i class="fas fa-times me-2"></i>{{ t("Annuler") }}
                </button>
                <button type="button" class="btn w-100 py-2" id="confirmBlocDelete" style="border-radius: 10px; background: #b91c1c; color: white; border: none;">
                    <i class="fas fa-trash me-2"></i>{{ t("Supprimer définitivement") }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ========== VARIABLES GLOBALES ==========
let selectedMissions = new Set();
let missionsData = {{ missions_data|tojson|safe }};

// ========== FONCTIONS DE NETTOYAGE DES MODALS ==========
function cleanupModals() {
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('padding-right');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('margin-right');
}

// ========== FONCTIONS D'OUVERTURE DES MODALS ==========
function openApproveModal(programmeId) {
    cleanupModals();
    const modalElement = document.getElementById('approuverModal' + programmeId);
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement, { backdrop: 'static', keyboard: true });
        modal.show();
        modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
    }
}

function openDesapprouverModal(programmeId) {
    cleanupModals();
    const modalElement = document.getElementById('desapprouverModal' + programmeId);
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement, { backdrop: 'static', keyboard: true });
        modal.show();
        modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
    }
}

function openArchiveModal(programmeId) {
    cleanupModals();
    const modalElement = document.getElementById('archiverModal' + programmeId);
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement, { backdrop: 'static', keyboard: true });
        modal.show();
        modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
    }
}

function openEditModal(programmeId) {
    cleanupModals();
    const modalElement = document.getElementById('editProgrammeModal' + programmeId);
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement, { backdrop: 'static', keyboard: true });
        modal.show();
        modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
    }
}

function openSupprimerMissionModal(missionId) {
    cleanupModals();
    const modalElement = document.getElementById('supprimerMissionModal' + missionId);
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement, { backdrop: 'static', keyboard: true });
        modal.show();
        modalElement.addEventListener('hidden.bs.modal', cleanupModals, { once: true });
    }
}

function dupliquerProgramme(programmeId) {
    if (confirm('{{ t("Voulez-vous dupliquer ce programme ?") }}')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/programme-audit/${programmeId}/dupliquer`;
        document.body.appendChild(form);
        form.submit();
    }
}

function regenererMissions(programmeId) {
    if (confirm('{{ t("Voulez-vous regénérer automatiquement les missions ?") }}')) {
        window.location.href = `/programme-audit/${programmeId}/generer-auto`;
    }
}

// ========== GESTION DES CHECKBOX ==========
function toggleMissionSelection(missionId, checkbox) {
    if (checkbox.checked) {
        selectedMissions.add(missionId);
    } else {
        selectedMissions.delete(missionId);
    }
    updateSelectionUI();
}

function toggleAllMissions() {
    const selectAllCheckbox = document.getElementById('selectAllMissions');
    const checkboxes = document.querySelectorAll('.mission-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        const missionId = parseInt(checkbox.value);
        if (selectAllCheckbox.checked) {
            selectedMissions.add(missionId);
        } else {
            selectedMissions.delete(missionId);
        }
    });
    
    updateSelectionUI();
}

function updateSelectionUI() {
    const count = selectedMissions.size;
    const selectionBar = document.getElementById('selectionBar');
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    if (count > 0) {
        selectionBar.classList.remove('d-none');
        selectionBar.classList.add('d-flex');
        selectedCount.textContent = count;
        deleteSelectedBtn.disabled = false;
    } else {
        selectionBar.classList.add('d-none');
        selectionBar.classList.remove('d-flex');
    }
    
    const selectAllCheckbox = document.getElementById('selectAllMissions');
    if (selectAllCheckbox) {
        const totalCheckboxes = document.querySelectorAll('.mission-checkbox').length;
        selectAllCheckbox.checked = (count === totalCheckboxes && totalCheckboxes > 0);
        selectAllCheckbox.indeterminate = (count > 0 && count < totalCheckboxes);
    }
}

function deselectAll() {
    document.querySelectorAll('.mission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllMissions').checked = false;
    selectedMissions.clear();
    updateSelectionUI();
}

// ========== SUPPRESSION EN BLOC ==========
function preparerSuppressionBloc() {
    if (selectedMissions.size === 0) return;
    
    const modal = new bootstrap.Modal(document.getElementById('supprimerBlocModal'));
    const message = document.getElementById('selectedCountMessage');
    message.textContent = `${selectedMissions.size} {{ t("mission(s) sélectionnée(s)") }}`;
    
    const missionsListe = document.getElementById('missionsListe');
    const missionsHtml = [];
    
    selectedMissions.forEach(id => {
        const mission = missionsData.find(m => m.id === id);
        if (mission) {
            missionsHtml.push(`
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="fas fa-times-circle" style="color: #b91c1c;"></i>
                    <span style="color: #0f172a;"><strong>${mission.reference}</strong> - ${mission.titre}</span>
                </div>
            `);
        }
    });
    
    missionsListe.innerHTML = missionsHtml.join('');
    
    modal.show();
}

// ========== GESTION DE LA RAISON ==========
document.getElementById('blocRaison')?.addEventListener('change', function() {
    const autreContainer = document.getElementById('autreRaisonContainer');
    autreContainer.style.display = this.value === 'Autre' ? 'block' : 'none';
});

// ========== CONFIRMATION SUPPRESSION EN BLOC ==========
document.getElementById('confirmBlocDelete')?.addEventListener('click', function() {
    const raisonSelect = document.getElementById('blocRaison');
    let raison = raisonSelect.value;
    
    if (raison === 'Autre') {
        raison = document.getElementById('autreRaison').value;
        if (!raison) {
            alert('{{ t("Veuillez préciser la raison de la suppression") }}');
            return;
        }
    }
    
    const missionIds = Array.from(selectedMissions);
    
    fetch(`/programme-audit/{{ programme.id }}/missions/supprimer-bloc`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            mission_ids: missionIds,
            raison: raison
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('✅ ' + data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('supprimerBlocModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('❌ ' + data.message, 'danger');
        }
    })
    .catch(() => showNotification('❌ {{ t("Erreur réseau") }}', 'danger'));
});

// ========== NOTIFICATIONS ==========
function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow`;
    notif.style.zIndex = 9999;
    notif.style.minWidth = '300px';
    notif.style.animation = 'slideIn 0.3s ease-out';
    notif.style.borderRadius = '12px';
    notif.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 4000);
}

// ========== INITIALISATION ==========
document.addEventListener('DOMContentLoaded', function() {
    // Nettoyage initial
    cleanupModals();
    
    // Initialiser les tooltips Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialiser les dropdowns Bootstrap
    if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
        var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
        dropdownElementList.map(function (dropdownToggleEl) {
            return new bootstrap.Dropdown(dropdownToggleEl);
        });
    }
    
    // Nettoyage après fermeture de modal
    $(document).on('hidden.bs.modal', '.modal', cleanupModals);
    
    // ========== GRAPHIQUE DE RÉPARTITION PAR PRIORITÉ ==========
    const prioriteCtx = document.getElementById('prioriteChart');
    if (prioriteCtx) {
        const counts = {
            'critique': 0,
            'elevee': 0,
            'moyenne': 0,
            'faible': 0
        };
        
        document.querySelectorAll('.priority-indicator').forEach(indicator => {
            if (indicator.classList.contains('bg-danger')) counts.critique++;
            else if (indicator.classList.contains('bg-warning')) counts.elevee++;
            else if (indicator.classList.contains('bg-info')) counts.moyenne++;
            else if (indicator.classList.contains('bg-secondary')) counts.faible++;
        });
        
        const hasData = Object.values(counts).some(count => count > 0);
        
        if (hasData) {
            const labels = [];
            const data = [];
            const backgroundColors = {
                'critique': '#b91c1c',
                'elevee': '#b45309',
                'moyenne': '#2563eb',
                'faible': '#64748b'
            };
            const backgroundColorsArray = [];
            
            Object.entries(counts).forEach(([priorite, count]) => {
                if (count > 0) {
                    labels.push(priorite.charAt(0).toUpperCase() + priorite.slice(1));
                    data.push(count);
                    backgroundColorsArray.push(backgroundColors[priorite]);
                }
            });
            
            new Chart(prioriteCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColorsArray,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} mission${value > 1 ? 's' : ''} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        } else {
            prioriteCtx.style.display = 'none';
            const parentCard = prioriteCtx.closest('.card-body');
            if (parentCard) {
                const message = document.createElement('div');
                message.className = 'text-center py-4';
                message.style.color = '#94a3b8';
                message.innerHTML = '<i class="fas fa-chart-pie fa-3x mb-3 opacity-25"></i><p>{{ t("Aucune mission pour générer le graphique") }}</p>';
                parentCard.insertBefore(message, parentCard.querySelector('.row'));
            }
        }
    }
    
    // ========== GESTION DES FILTRES ==========
    const urlParams = new URLSearchParams(window.location.search);
    const statutFilter = urlParams.get('statut');
    const prioriteFilter = urlParams.get('priorite');
    
    if (statutFilter || prioriteFilter) {
        // Filtrer les lignes du tableau
        document.querySelectorAll('tbody tr').forEach(row => {
            let show = true;
            
            if (statutFilter) {
                const statutCell = row.querySelector('td:nth-child(6) .badge');
                if (statutCell) {
                    const rowStatut = statutCell.textContent.trim().toLowerCase().replace(/\s+/g, '_');
                    show = show && (rowStatut.includes(statutFilter.toLowerCase()) || 
                                   statutFilter.toLowerCase().includes(rowStatut));
                }
            }
            
            if (prioriteFilter && show) {
                const prioriteCell = row.querySelector('td:nth-child(4) .badge');
                if (prioriteCell) {
                    const rowPriorite = prioriteCell.textContent.trim().toLowerCase();
                    const prioriteMap = {
                        'critique': ['critique'],
                        'elevee': ['élevée', 'elevee'],
                        'moyenne': ['moyenne'],
                        'faible': ['faible']
                    };
                    
                    let match = false;
                    const filterValue = prioriteFilter.toLowerCase();
                    Object.keys(prioriteMap).forEach(key => {
                        if (filterValue.includes(key) || key.includes(filterValue)) {
                            if (prioriteMap[key].some(p => rowPriorite.includes(p))) {
                                match = true;
                            }
                        }
                    });
                    show = show && match;
                }
            }
            
            row.style.display = show ? '' : 'none';
        });
        
        // Afficher le compteur de résultats
        const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])').length;
        const totalRows = document.querySelectorAll('tbody tr').length;
        
        const filterInfoText = document.getElementById('filterInfoText');
        if (filterInfoText) {
            filterInfoText.textContent = `${visibleRows} {{ t("mission(s) sur") }} ${totalRows} {{ t("affichée(s)") }}`;
        }
    }
});

// Ajouter le style pour l'animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .btn, .card {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    }
    
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
    }
    
    .dropdown-menu {
        border: none;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        padding: 8px;
    }
    
    .dropdown-item {
        border-radius: 8px;
        padding: 10px 16px;
        transition: all 0.2s ease;
    }
    
    .dropdown-item:hover {
        background: #f8fafc;
        transform: translateX(4px);
    }
    
    [data-bs-theme="dark"] {
        color-scheme: dark;
    }
    
    [data-bs-theme="dark"] body {
        background: #0f172a;
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .card {
        background: #1e293b !important;
        border-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] h1, 
    [data-bs-theme="dark"] h2, 
    [data-bs-theme="dark"] h3, 
    [data-bs-theme="dark"] h4, 
    [data-bs-theme="dark"] h5, 
    [data-bs-theme="dark"] h6 {
        color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .text-muted,
    [data-bs-theme="dark"] small:not(.text-white) {
        color: #94a3b8 !important;
    }
    
    [data-bs-theme="dark"] .table {
        color: #e2e8f0;
        background: #1e293b;
    }
    
    [data-bs-theme="dark"] .table thead {
        background: #334155 !important;
        border-color: #475569 !important;
    }
    
    [data-bs-theme="dark"] .table thead th {
        color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .table tbody tr {
        border-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] .table tbody tr:hover {
        background-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] .table td {
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .btn:not(.btn-primary):not([style*="background: #2563eb"]):not([style*="background: #059669"]):not([style*="background: #b91c1c"]) {
        background: #334155 !important;
        border-color: #475569 !important;
        color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .dropdown-menu {
        background: #1e293b;
    }
    
    [data-bs-theme="dark"] .dropdown-item {
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .dropdown-item:hover {
        background: #334155;
        color: #f1f5f9;
    }
    
    [data-bs-theme="dark"] [style*="background: #f8fafc"] {
        background: #334155 !important;
    }
    
    [data-bs-theme="dark"] [style*="color: #0f172a"] {
        color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] [style*="color: #334155"] {
        color: #e2e8f0 !important;
    }
    
    [data-bs-theme="dark"] [style*="color: #64748b"] {
        color: #94a3b8 !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
