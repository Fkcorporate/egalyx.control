{% extends "base.html" %}

{% block title %}Modifier la mission - {{ mission.reference }} - Egalyx{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('liste_programmes_audit') }}">Programmes</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('detail_programme_audit', id=programme.id) }}">{{ programme.nom }}</a>
                    </li>
                    <li class="breadcrumb-item active">Modifier mission</li>
                </ol>
            </nav>
            <h1 class="h2 mb-0">
                <i class="fas fa-edit text-warning me-2"></i>
                Modifier la mission
            </h1>
            <p class="text-muted mb-0">{{ mission.reference }} - {{ mission.titre }}</p>
        </div>
        <a href="{{ url_for('detail_programme_audit', id=programme.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour
        </a>
    </div>

    <!-- Formulaire de modification -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Informations de la mission</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('modifier_mission_audit', mission_id=mission.id) }}">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label fw-semibold">Titre de la mission *</label>
                                <input type="text" class="form-control" name="titre" 
                                       value="{{ mission.titre }}" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Priorité *</label>
                                <select class="form-select" name="priorite" required>
                                    <option value="critique" {% if mission.priorite == 'critique' %}selected{% endif %}>Critique</option>
                                    <option value="elevee" {% if mission.priorite == 'elevee' %}selected{% endif %}>Élevée</option>
                                    <option value="moyenne" {% if mission.priorite == 'moyenne' %}selected{% endif %}>Moyenne</option>
                                    <option value="faible" {% if mission.priorite == 'faible' %}selected{% endif %}>Faible</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Description</label>
                            <textarea class="form-control" name="description" rows="4">{{ mission.description or '' }}</textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Année prévue *</label>
                                <select class="form-select" name="annee_prevue" required>
                                    {% for annee in range(programme.annee_debut, programme.annee_fin + 1) %}
                                    <option value="{{ annee }}" {% if annee == mission.annee_prevue %}selected{% endif %}>
                                        {{ annee }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Trimestre</label>
                                <select class="form-select" name="trimestre_prevue">
                                    <option value="">Non spécifié</option>
                                    <option value="1" {% if mission.trimestre_prevue == 1 %}selected{% endif %}>1er trimestre</option>
                                    <option value="2" {% if mission.trimestre_prevue == 2 %}selected{% endif %}>2ème trimestre</option>
                                    <option value="3" {% if mission.trimestre_prevue == 3 %}selected{% endif %}>3ème trimestre</option>
                                    <option value="4" {% if mission.trimestre_prevue == 4 %}selected{% endif %}>4ème trimestre</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Durée estimée (jours)</label>
                                <input type="number" class="form-control" name="duree_estimee" 
                                       value="{{ mission.duree_estimee or 5 }}" min="1" max="60">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Date début prévue</label>
                                <input type="date" class="form-control" name="date_debut_prevue" 
                                       value="{{ mission.date_debut_prevue.strftime('%Y-%m-%d') if mission.date_debut_prevue else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Date fin prévue</label>
                                <input type="date" class="form-control" name="date_fin_prevue" 
                                       value="{{ mission.date_fin_prevue.strftime('%Y-%m-%d') if mission.date_fin_prevue else '' }}">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Risque associé</label>
                                <select class="form-select" name="risque_id">
                                    <option value="">Aucun risque</option>
                                    {% for risque in risques_disponibles %}
                                    <option value="{{ risque.id }}" {% if mission.risque and mission.risque.id == risque.id %}selected{% endif %}>
                                        {{ risque.reference }} - {{ risque.intitule|truncate(40) }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Responsable</label>
                                <select class="form-select" name="responsable_id">
                                    <option value="">Non assigné</option>
                                    {% for user in utilisateurs %}
                                    <option value="{{ user.id }}" {% if mission.responsable and mission.responsable.id == user.id %}selected{% endif %}>
                                        {{ user.nom or user.username }} {{ user.prenom or '' }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Statut</label>
                                <select class="form-select" name="statut">
                                    <option value="planifie" {% if mission.statut == 'planifie' %}selected{% endif %}>Planifiée</option>
                                    <option value="en_cours" {% if mission.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                                    <option value="termine" {% if mission.statut == 'termine' %}selected{% endif %}>Terminée</option>
                                    <option value="reporte" {% if mission.statut == 'reporte' %}selected{% endif %}>Reportée</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Progression (%)</label>
                                <input type="number" class="form-control" name="progression" 
                                       value="{{ mission.progression or 0 }}" min="0" max="100">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Commentaire / Note</label>
                            <textarea class="form-control" name="commentaire_repli" rows="2">{{ mission.commentaire_repli or '' }}</textarea>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('detail_programme_audit', id=programme.id) }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-2"></i>Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}