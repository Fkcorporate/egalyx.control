{% extends "base.html" %}

{% block title %}Plan de Repli - {{ programme.nom }} - Programme d'Audit - Egalyx{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('liste_programmes_audit') }}">Programmes d'Audit</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('detail_programme_audit', id=programme.id) }}">{{ programme.nom }}</a></li>
                    <li class="breadcrumb-item active">Plan de repli</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-umbrella text-warning me-2"></i>
                        Plan de Repli - {{ programme.nom }}
                    </h1>
                    <p class="text-muted mb-0">Gestion des impr√©vus et des reports de missions</p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('detail_programme_audit', id=programme.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour
                    </a>
                    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addPlanModal">
                        <i class="fas fa-plus me-2"></i>Nouveau plan
                    </button>
                    <button type="button" class="btn btn-outline-info" id="simulateDelay">
                        <i class="fas fa-play-circle me-2"></i>Simuler un retard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes actives -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        Alertes actives
                    </h5>
                </div>
                <div class="card-body">
                    {% set alertes_actives = [] %}
                    {% for mission in programme.missions if mission.est_en_retard %}
                        {% set alertes_actives = alertes_actives + [mission] %}
                    {% endfor %}
                    
                    {% if alertes_actives %}
                    <div class="alert alert-warning">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading mb-2">
                                    {{ alertes_actives|length }} mission(s) en retard
                                </h5>
                                <p class="mb-0">
                                    Les missions suivantes ont d√©pass√© leur date de fin pr√©vue.
                                    Consid√©rez l'activation d'un plan de repli.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Mission</th>
                                    <th>Retard</th>
                                    <th>Priorit√©</th>
                                    <th>Plan de repli disponible</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mission in alertes_actives %}
                                <tr>
                                    <td>
                                        <strong>{{ mission.reference }}</strong><br>
                                        <small>{{ mission.titre|truncate(50) }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger">
                                            {% if mission.date_fin_prevue %}
                                            {{ (datetime.now().date() - mission.date_fin_prevue).days }} jours
                                            {% else %}
                                            Non d√©finie
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 
                                            'danger' if mission.priorite == 'critique' 
                                            else 'warning' if mission.priorite == 'elevee' 
                                            else 'info' if mission.priorite == 'moyenne' 
                                            else 'secondary' 
                                        }}">
                                            {{ mission.priorite|capitalize }}
                                        </span>
                                    </td>
                                    <td>
                                        {% set plan_repli = plans_pluie|selectattr('mission_principale_id', 'equalto', mission.id)|first %}
                                        {% if plan_repli %}
                                        <span class="badge bg-success">Disponible</span>
                                        <br>
                                        <small>{{ plan_repli.mission_remplacement.reference }}</small>
                                        {% else %}
                                        <span class="badge bg-secondary">Aucun</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if plan_repli %}
                                        <button class="btn btn-sm btn-outline-success" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#activatePlanModal{{ plan_repli.id }}">
                                            <i class="fas fa-play me-1"></i>Activer
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-primary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#createPlanModal{{ mission.id }}">
                                            <i class="fas fa-plus me-1"></i>Cr√©er
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">Aucune alerte active</h5>
                        <p class="text-muted">Toutes les missions respectent actuellement leur planning</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Plans de repli existants -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-umbrella me-2"></i>
                        Plans de repli configur√©s
                    </h5>
                    <span class="badge bg-primary">{{ plans_pluie|length }}</span>
                </div>
                <div class="card-body">
                    {% if plans_pluie %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nom du plan</th>
                                    <th>Mission principale</th>
                                    <th>Mission de remplacement</th>
                                    <th>Condition de d√©clenchement</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plan in plans_pluie %}
                                <tr>
                                    <td>
                                        <strong>{{ plan.nom }}</strong>
                                        {% if plan.description %}
                                        <br>
                                        <small class="text-muted">{{ plan.description|truncate(50) }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="#" data-bs-toggle="modal" 
                                           data-bs-target="#missionModal{{ plan.mission_principale_id }}">
                                            {{ plan.mission_principale.reference }}
                                        </a>
                                        <br>
                                        <small class="text-muted">
                                            {{ plan.mission_principale.titre|truncate(40) }}
                                        </small>
                                    </td>
                                    <td>
                                        <a href="#" data-bs-toggle="modal" 
                                           data-bs-target="#missionModal{{ plan.mission_remplacement_id }}">
                                            {{ plan.mission_remplacement.reference }}
                                        </a>
                                        <br>
                                        <small class="text-muted">
                                            {{ plan.mission_remplacement.titre|truncate(40) }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if plan.condition_type == 'retard' %}
                                        <span class="badge bg-warning">Retard > {{ plan.condition_seuil }} jours</span>
                                        {% elif plan.condition_type == 'indisponibilite' %}
                                        <span class="badge bg-info">Indisponibilit√© ressource</span>
                                        {% else %}
                                        <span class="badge bg-danger">Situation d'urgence</span>
                                        {% endif %}
                                        {% if plan.condition_description %}
                                        <br>
                                        <small class="text-muted">{{ plan.condition_description }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 
                                            'success' if plan.statut == 'actif' 
                                            else 'primary' if plan.statut == 'declenche' 
                                            else 'secondary' 
                                        }}">
                                            {{ plan.statut|capitalize }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#detailPlanModal{{ plan.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if plan.statut == 'actif' %}
                                            <button class="btn btn-outline-warning" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editPlanModal{{ plan.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-success" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#activatePlanModal{{ plan.id }}">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="supprimerPlan({{ plan.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-umbrella fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Aucun plan de repli configur√©</h5>
                        <p class="text-muted">Cr√©ez votre premier plan de repli pour g√©rer les impr√©vus</p>
                        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addPlanModal">
                            <i class="fas fa-plus me-2"></i>Cr√©er un plan de repli
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Missions disponibles pour repli -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-times me-2"></i>
                        Missions susceptibles d'√™tre report√©es
                        <span class="badge bg-secondary ms-2">{{ missions_reportables|length }}</span>
                    </h6>
                </div>
                <div class="card-body">
                    {% if missions_reportables %}
                    <div class="list-group">
                        {% for mission in missions_reportables %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ mission.reference }}</h6>
                                    <p class="mb-1 small">{{ mission.titre|truncate(60) }}</p>
                                    <div class="d-flex gap-2">
                                        <small class="text-muted">
                                            <i class="fas fa-flag me-1"></i>
                                            <span class="badge bg-{{ 
                                                'danger' if mission.priorite == 'critique' 
                                                else 'warning' if mission.priorite == 'elevee'
                                                else 'info' if mission.priorite == 'moyenne'
                                                else 'secondary' 
                                            }}">
                                                {{ mission.priorite|capitalize }}
                                            </span>
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ mission.annee_prevue }} - T{{ mission.trimestre_prevue or 'N/C' }}
                                        </small>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#createPlanModal{{ mission.id }}">
                                        <i class="fas fa-umbrella me-1"></i>Plan de repli
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted mb-0">Toutes les missions semblent stables</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Missions de remplacement disponibles
                        <span class="badge bg-secondary ms-2">{{ missions_remplacement|length }}</span>
                    </h6>
                </div>
                <div class="card-body">
                    {% if missions_remplacement %}
                    <div class="list-group">
                        {% for mission in missions_remplacement %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ mission.reference }}</h6>
                                    <p class="mb-1 small">{{ mission.titre|truncate(60) }}</p>
                                    <div class="d-flex gap-2">
                                        <small class="text-muted">
                                            <i class="fas fa-flag me-1"></i>
                                            <span class="badge bg-{{ 
                                                'danger' if mission.priorite == 'critique' 
                                                else 'warning' if mission.priorite == 'elevee'
                                                else 'info' if mission.priorite == 'moyenne'
                                                else 'secondary' 
                                            }}">
                                                {{ mission.priorite|capitalize }}
                                            </span>
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ mission.annee_prevue }} - T{{ mission.trimestre_prevue or 'N/C' }}
                                        </small>
                                    </div>
                                </div>
                                <div>
                                    <span class="badge bg-success">Disponible</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-circle fa-2x text-warning mb-2"></i>
                        <p class="text-muted mb-0">Aucune mission de remplacement disponible</p>
                        <small class="text-muted">Cr√©ez d'abord des missions planifi√©es dans le futur</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== MODAL CR√âATION PLAN DE REPLI ========== -->
<div class="modal fade" id="addPlanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-umbrella me-2"></i>
                    Cr√©er un plan de repli
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('creer_plan_pluie', programme_id=programme.id) }}">
                <div class="modal-body">
                    <!-- Nom du plan -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Nom du plan *</label>
                        <input type="text" class="form-control" name="nom" 
                               placeholder="Ex: Plan de repli Audit financier" required>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea class="form-control" name="description" rows="2" 
                                  placeholder="D√©crivez le contexte de ce plan..."></textarea>
                    </div>
                    
                    <div class="row">
                        <!-- Mission principale -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-exclamation-triangle text-danger me-1"></i>
                                Mission √† reporter *
                            </label>
                            <select class="form-select" name="mission_principale_id" required id="missionPrincipaleSelect">
                                <option value="">S√©lectionnez une mission...</option>
                                {% for mission in missions_reportables %}
                                <option value="{{ mission.id }}">
                                    {{ mission.reference }} - {{ mission.titre|truncate(50) }}
                                    ({{ mission.annee_prevue }} T{{ mission.trimestre_prevue or 'N/C' }})
                                    [{{ mission.priorite|capitalize }}]
                                </option>
                                {% else %}
                                <option value="" disabled>Aucune mission reportable disponible</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                Mission qui pourrait √™tre report√©e en cas de probl√®me
                            </small>
                        </div>
                        
                        <!-- Mission de remplacement -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar-check text-success me-1"></i>
                                Mission de remplacement *
                            </label>
                            <select class="form-select" name="mission_remplacement_id" required id="missionRemplacementSelect">
                                <option value="">S√©lectionnez une mission...</option>
                                {% for mission in missions_remplacement %}
                                <option value="{{ mission.id }}">
                                    {{ mission.reference }} - {{ mission.titre|truncate(50) }}
                                    ({{ mission.annee_prevue }} T{{ mission.trimestre_prevue or 'N/C' }})
                                    [{{ mission.priorite|capitalize }}]
                                </option>
                                {% else %}
                                <option value="" disabled>Aucune mission de remplacement disponible</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                Mission qui sera avanc√©e pour remplacer la mission report√©e
                            </small>
                        </div>
                    </div>
                    
                    <!-- Condition de d√©clenchement -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Condition de d√©clenchement *</label>
                        </div>
                        <div class="col-md-6 mb-3">
                            <select class="form-select" name="condition_type" required id="conditionTypeSelect">
                                <option value="retard" selected>‚è∞ Retard de plus de X jours</option>
                                <option value="indisponibilite">üë• Indisponibilit√© des ressources</option>
                                <option value="urgence">üö® Situation d'urgence</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="seuilContainer">
                            <div class="input-group">
                                <span class="input-group-text">Seuil</span>
                                <input type="number" class="form-control" name="condition_seuil" 
                                       id="conditionSeuil" value="15" min="1" max="90">
                                <span class="input-group-text">jours</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description de la condition -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Description de la condition</label>
                        <textarea class="form-control" name="condition_description" id="conditionDescription" rows="2">
Si la mission prend plus de 15 jours de retard, elle sera report√©e et remplac√©e.
                        </textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Conseil :</strong> Choisissez une mission de remplacement de priorit√© 
                        similaire ou inf√©rieure et planifi√©e dans le futur.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-umbrella me-2"></i>Cr√©er le plan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals de cr√©ation rapide -->
{% for mission in missions_reportables %}
<div class="modal fade" id="createPlanModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cr√©er un plan de repli pour {{ mission.reference }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('creer_plan_pluie', programme_id=programme.id) }}">
                <input type="hidden" name="mission_principale_id" value="{{ mission.id }}">
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom du plan *</label>
                            <input type="text" class="form-control" name="nom" required 
                                   value="Plan de repli pour {{ mission.reference }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type de condition *</label>
                            <select class="form-select" name="condition_type" required>
                                <option value="retard" selected>Retard de plus de X jours</option>
                                <option value="indisponibilite">Indisponibilit√© des ressources</option>
                                <option value="urgence">Situation d'urgence</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mission de remplacement *</label>
                        <select class="form-select" name="mission_remplacement_id" required>
                            <option value="">S√©lectionnez une mission...</option>
                            {% for remplacement in missions_remplacement %}
                            <option value="{{ remplacement.id }}">
                                {{ remplacement.reference }} ({{ remplacement.annee_prevue }}-T{{ remplacement.trimestre_prevue or 'N/C' }}) 
                                - {{ remplacement.titre|truncate(40) }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">
                            S√©lectionnez une mission future qui pourra √™tre avanc√©e
                        </small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Seuil de retard (jours) *</label>
                            <input type="number" class="form-control" name="condition_seuil" 
                                   value="15" min="1" max="90" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description des conditions</label>
                        <textarea class="form-control" name="condition_description" rows="2">
Si la mission {{ mission.reference }} prend plus de 15 jours de retard, 
elle sera report√©e et remplac√©e par la mission s√©lectionn√©e.
                        </textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">Cr√©er le plan</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% for plan in plans_pluie %}
<!-- Modal d√©tail plan -->
<div class="modal fade" id="detailPlanModal{{ plan.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ plan.nom }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Mission principale</h6>
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6>{{ plan.mission_principale.reference }}</h6>
                                <p>{{ plan.mission_principale.titre }}</p>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-muted">
                                            Priorit√©: 
                                            <span class="badge bg-{{ 
                                                'danger' if plan.mission_principale.priorite == 'critique' 
                                                else 'warning' if plan.mission_principale.priorite == 'elevee'
                                                else 'info' if plan.mission_principale.priorite == 'moyenne'
                                                else 'secondary' 
                                            }}">
                                                {{ plan.mission_principale.priorite|capitalize }}
                                            </span>
                                        </small>
                                    </div>
                                    <div>
                                        <small class="text-muted">
                                            Statut: {{ plan.mission_principale.statut|replace('_', ' ')|title }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Mission de remplacement</h6>
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6>{{ plan.mission_remplacement.reference }}</h6>
                                <p>{{ plan.mission_remplacement.titre }}</p>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-muted">
                                            Priorit√©: 
                                            <span class="badge bg-{{ 
                                                'danger' if plan.mission_remplacement.priorite == 'critique' 
                                                else 'warning' if plan.mission_remplacement.priorite == 'elevee'
                                                else 'info' if plan.mission_remplacement.priorite == 'moyenne'
                                                else 'secondary' 
                                            }}">
                                                {{ plan.mission_remplacement.priorite|capitalize }}
                                            </span>
                                        </small>
                                    </div>
                                    <div>
                                        <small class="text-muted">
                                            Statut: {{ plan.mission_remplacement.statut|replace('_', ' ')|title }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6 class="mt-4">Conditions de d√©clenchement</h6>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Type :</strong> {{ plan.condition_type|replace('_', ' ')|title }}</p>
                        {% if plan.condition_seuil %}
                        <p><strong>Seuil :</strong> {{ plan.condition_seuil }} jours</p>
                        {% endif %}
                        {% if plan.condition_description %}
                        <p><strong>Description :</strong><br>{{ plan.condition_description }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Ce plan sera automatiquement activ√© lorsque les conditions seront remplies,
                    ou peut √™tre activ√© manuellement si n√©cessaire.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                {% if plan.statut == 'actif' %}
                <button class="btn btn-warning" 
                        data-bs-toggle="modal" 
                        data-bs-target="#activatePlanModal{{ plan.id }}"
                        data-bs-dismiss="modal">
                    <i class="fas fa-play me-2"></i>Activer maintenant
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal √©dition plan -->
<div class="modal fade" id="editPlanModal{{ plan.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Modifier le plan
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('modifier_plan_pluie', plan_id=plan.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom du plan *</label>
                            <input type="text" class="form-control" name="nom" required 
                                   value="{{ plan.nom }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type de condition *</label>
                            <select class="form-select" name="condition_type" required>
                                <option value="retard" {% if plan.condition_type == 'retard' %}selected{% endif %}>Retard de plus de X jours</option>
                                <option value="indisponibilite" {% if plan.condition_type == 'indisponibilite' %}selected{% endif %}>Indisponibilit√© des ressources</option>
                                <option value="urgence" {% if plan.condition_type == 'urgence' %}selected{% endif %}>Situation d'urgence</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2">{{ plan.description or '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mission de remplacement *</label>
                            <select class="form-select" name="mission_remplacement_id" required>
                                <option value="">S√©lectionnez une mission...</option>
                                {% for mission in programme.missions if mission.statut == 'planifie' and mission.id != plan.mission_principale_id %}
                                <option value="{{ mission.id }}" {% if mission.id == plan.mission_remplacement_id %}selected{% endif %}>
                                    {{ mission.reference }} ({{ mission.annee_prevue }}-T{{ mission.trimestre_prevue or 'N/C' }}) 
                                    - {{ mission.titre|truncate(40) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Seuil (jours) *</label>
                            <input type="number" class="form-control" name="condition_seuil" 
                                   value="{{ plan.condition_seuil or 15 }}" min="1" max="90">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description des conditions</label>
                        <textarea class="form-control" name="condition_description" rows="2">{{ plan.condition_description or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal activation plan -->
{% if plan.statut == 'actif' %}
<div class="modal fade" id="activatePlanModal{{ plan.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-play me-2"></i>Activer le plan
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('activer_plan_pluie', plan_id=plan.id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <h6 class="alert-heading">Activation imm√©diate</h6>
                            <p class="mb-0">
                                Vous √™tes sur le point d'activer le plan <strong>{{ plan.nom }}</strong>.
                                Ceci reportera la mission principale et avancera la mission de remplacement.
                            </p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>Impact de l'activation :</h6>
                            <ul class="mb-0">
                                <li><strong>Mission principale :</strong> {{ plan.mission_principale.reference }} ‚Üí Report√©e</li>
                                <li><strong>Mission de remplacement :</strong> {{ plan.mission_remplacement.reference }} ‚Üí Avanc√©e</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Raison de l'activation *</label>
                        <select class="form-select" name="raison" required>
                            <option value="">S√©lectionnez...</option>
                            <option value="retard">Retard significatif</option>
                            <option value="indisponibilite">Indisponibilit√© ressource</option>
                            <option value="urgence">Situation d'urgence</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Commentaires</label>
                        <textarea class="form-control" name="commentaires" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">Activer</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Modals de d√©tail des missions -->
{% for mission in programme.missions %}
<div class="modal fade" id="missionModal{{ mission.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ mission.reference }} - {{ mission.titre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Description</h6>
                        <p>{{ mission.description or 'Aucune description' }}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Informations</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>Priorit√©:</td>
                                <td>
                                    <span class="badge bg-{{ 
                                        'danger' if mission.priorite == 'critique' 
                                        else 'warning' if mission.priorite == 'elevee'
                                        else 'info' if mission.priorite == 'moyenne'
                                        else 'secondary' 
                                    }}">
                                        {{ mission.priorite|capitalize }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td>Statut:</td>
                                <td>{{ mission.statut|replace('_', ' ')|title }}</td>
                            </tr>
                            <tr>
                                <td>Planification:</td>
                                <td>{{ mission.annee_prevue }} - T{{ mission.trimestre_prevue or 'N/C' }}</td>
                            </tr>
                            <tr>
                                <td>Dur√©e:</td>
                                <td>{{ mission.duree_estimee or 0 }} jours</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // Simulation de retard
    $('#simulateDelay').click(function() {
        const jours = prompt('Simuler un retard de combien de jours ?', '15');
        if (jours && !isNaN(jours)) {
            const btn = $(this);
            const originalHtml = btn.html();
            btn.html('<i class="fas fa-spinner fa-spin me-2"></i>Simulation...');
            btn.prop('disabled', true);
            
            fetch("{{ url_for('simuler_retard', programme_id=programme.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `jours=${jours}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Simulation effectu√©e : ${data.alertes} alerte(s) g√©n√©r√©e(s)`);
                    location.reload();
                } else {
                    alert('Erreur: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la simulation');
            })
            .finally(() => {
                btn.html(originalHtml);
                btn.prop('disabled', false);
            });
        }
    });

    // Validation des missions de remplacement
    $('#missionRemplacementSelect').change(function() {
        const principale = $('#missionPrincipaleSelect').val();
        const remplacement = $(this).val();
        
        if (principale && remplacement && principale === remplacement) {
            alert('‚ö†Ô∏è La mission de remplacement ne peut pas √™tre la m√™me que la mission principale');
            $(this).val('');
        }
    });

    // Auto-compl√©tion du nom du plan
    function updatePlanName() {
        const principale = $('#missionPrincipaleSelect option:selected').text();
        const remplacement = $('#missionRemplacementSelect option:selected').text();
        
        if (principale && remplacement && principale !== 'S√©lectionnez une mission...' && remplacement !== 'S√©lectionnez une mission...') {
            const principaleRef = principale.split(' - ')[0];
            const remplacementRef = remplacement.split(' - ')[0];
            $('input[name="nom"]').val(`Plan de repli : ${principaleRef} ‚Üí ${remplacementRef}`);
        }
    }
    
    $('#missionPrincipaleSelect, #missionRemplacementSelect').change(updatePlanName);
    
    // Gestion des conditions
    $('#conditionTypeSelect').change(function() {
        if ($(this).val() === 'retard') {
            $('#seuilContainer').show();
        } else {
            $('#seuilContainer').hide();
        }
    }).trigger('change');
    
    // Fonction de suppression
    window.supprimerPlan = function(planId) {
        if (confirm('Supprimer ce plan de repli ?')) {
            fetch(`/plan-pluie/${planId}/supprimer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Plan supprim√©');
                    location.reload();
                } else {
                    alert('Erreur: ' + data.message);
                }
            });
        }
    };
});
</script>
{% endblock %}