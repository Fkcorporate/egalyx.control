{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-plus-circle me-2"></i>
        {% if action == 'creer' %}
            Nouveau plan d'action
        {% else %}
            Modifier le plan d'action
        {% endif %}
    </h2>
    <a href="{{ url_for('detail_risque', id=risque.id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Retour au risque
    </a>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    Plan d'action pour le risque {{ risque.reference }}
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" id="planActionForm">
                    {{ form.hidden_tag() }}
                    
                    <!-- Informations sur le risque -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Plan d'action pour le risque : 
                        <strong>{{ risque.reference }} - {{ risque.intitule }}</strong>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.risque_id.label(class="form-label fw-bold") }}
                            <input type="text" class="form-control" value="{{ risque.reference }} - {{ risque.intitule }}" disabled>
                            {{ form.risque_id(class="d-none") }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.dispositif_id.label(class="form-label fw-bold") }}
                            {{ form.dispositif_id(class="form-control") }}
                            <small class="form-text text-muted">
                                Laissez vide si non lié à un dispositif spécifique
                            </small>
                        </div>
                    </div>
                    
                    <!-- Titre et description -->
                    <div class="mb-3">
                        {{ form.titre.label(class="form-label fw-bold") }}
                        {{ form.titre(class="form-control", placeholder="Ex: Mise en place de contrôles supplémentaires") }}
                        {% if form.titre.errors %}
                        <div class="text-danger">
                            {% for error in form.titre.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        {{ form.description.label(class="form-label fw-bold") }}
                        {{ form.description(class="form-control", rows="4", 
                                          placeholder="Décrivez les actions à mettre en place, les objectifs, les bénéfices attendus...") }}
                        {% if form.description.errors %}
                        <div class="text-danger">
                            {% for error in form.description.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            {{ form.responsable_id.label(class="form-label fw-bold") }}
                            {{ form.responsable_id(class="form-select") }}
                            {% if form.responsable_id.errors %}
                            <div class="text-danger">
                                {% for error in form.responsable_id.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.priorite.label(class="form-label fw-bold") }}
                            {{ form.priorite(class="form-select") }}
                            {% if form.priorite.errors %}
                            <div class="text-danger">
                                {% for error in form.priorite.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Dates -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            {{ form.date_debut.label(class="form-label fw-bold") }}
                            {{ form.date_debut(class="form-control", type="date") }}
                            {% if form.date_debut.errors %}
                            <div class="text-danger">
                                {% for error in form.date_debut.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.date_echeance.label(class="form-label fw-bold") }}
                            {{ form.date_echeance(class="form-control", type="date") }}
                            {% if form.date_echeance.errors %}
                            <div class="text-danger">
                                {% for error in form.date_echeance.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Boutons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('detail_risque', id=risque.id) }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            {% if action == 'creer' %}
                                <i class="fas fa-check me-1"></i> Créer le plan d'action
                            {% else %}
                                <i class="fas fa-save me-1"></i> Enregistrer les modifications
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const inOneMonth = new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0];
    
    const dateDebutField = document.getElementById('date_debut');
    const dateEcheanceField = document.getElementById('date_echeance');
    
    if (dateDebutField && !dateDebutField.value) {
        dateDebutField.value = today;
    }
    if (dateEcheanceField && !dateEcheanceField.value) {
        dateEcheanceField.value = inOneMonth;
    }
    
    // Validation des dates
    const form = document.getElementById('planActionForm');
    form.addEventListener('submit', function(event) {
        const dateDebut = new Date(dateDebutField.value);
        const dateEcheance = new Date(dateEcheanceField.value);
        
        if (dateEcheance < dateDebut) {
            event.preventDefault();
            alert('La date d\'échéance doit être postérieure à la date de début.');
            dateEcheanceField.focus();
            return false;
        }
        
        // Validation de la priorité pour les échéances rapprochées
        const diffTime = dateEcheance - dateDebut;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 7) {
            const prioriteField = document.getElementById('priorite');
            if (prioriteField.value !== 'critique' && prioriteField.value !== 'haute') {
                if (!confirm('Le plan se termine dans moins d\'une semaine. Voulez-vous vraiment définir une priorité basse/moyenne ?')) {
                    event.preventDefault();
                    return false;
                }
            }
        }
    });
});
</script>
{% endblock %}