{% extends "base.html" %}

{% block content %}
<style>
    /* ============================================
       STYLES SPÉCIFIQUES - DÉTAIL PLAN INDÉPENDANT
       ============================================ */
    
    /* ========== VARIABLES CSS POUR LE MODE SOMBRE ========== */
    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --border-color: #e2e8f0;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --text-muted: #64748b;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --success: #28a745;
        --success-light: rgba(40, 167, 69, 0.15);
        --warning: #ffc107;
        --warning-light: rgba(255, 193, 7, 0.15);
        --danger: #dc3545;
        --danger-light: rgba(220, 53, 69, 0.15);
        --info: #17a2b8;
        --info-light: rgba(23, 162, 184, 0.15);
    }

    [data-bs-theme="dark"] {
        --bg-primary: #1e293b;
        --bg-secondary: #0f172a;
        --bg-tertiary: #1e293b;
        --border-color: #334155;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --text-muted: #94a3b8;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --success: #34ce57;
        --success-light: rgba(52, 206, 87, 0.25);
        --warning: #ffcd39;
        --warning-light: rgba(255, 205, 57, 0.25);
        --danger: #e4606d;
        --danger-light: rgba(228, 96, 109, 0.25);
        --info: #3dd5f3;
        --info-light: rgba(61, 213, 243, 0.25);
    }

    /* Classes utilitaires */
    .bg-adaptive-primary {
        background: var(--bg-primary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .bg-adaptive-secondary {
        background: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .bg-adaptive-tertiary {
        background: var(--bg-tertiary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .text-adaptive {
        color: var(--text-primary) !important;
    }

    .text-adaptive-secondary {
        color: var(--text-secondary) !important;
    }

    .border-adaptive {
        border-color: var(--border-color) !important;
    }

    /* Variables de base */
    .plan-container {
        max-width: 1600px;
        margin: 0 auto;
    }

    /* ========== EN-TÊTE DE PAGE ========== */
    .page-header {
        background: linear-gradient(135deg, #0A1929 0%, #1A3C6B 100%);
        border-radius: 24px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: visible !important;
        z-index: 1000;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -5%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 50%;
        transform: rotate(25deg);
        pointer-events: none;
        z-index: 0;
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -5%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: rotate(-15deg);
        pointer-events: none;
        z-index: 0;
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-title {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 1rem;
    }

    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .breadcrumb-item a:hover {
        color: white;
        transform: translateX(2px);
    }

    .breadcrumb-item.active {
        color: white;
        font-weight: 500;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
        position: relative;
        z-index: 1000;
    }

    .fk-btn {
        padding: 0.7rem 1.4rem;
        border-radius: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        text-decoration: none;
        z-index: 1000;
        position: relative;
        letter-spacing: 0.3px;
    }

    .fk-btn-primary {
        background: linear-gradient(135deg, #0066CC, #3B82F6);
        color: white;
        box-shadow: 0 8px 20px rgba(0, 102, 204, 0.3);
    }

    .fk-btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(0, 102, 204, 0.4);
        color: white;
    }

    .fk-btn-success {
        background: linear-gradient(135deg, #28a745, #34ce57);
        color: white;
        box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
    }

    .fk-btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(40, 167, 69, 0.4);
        color: white;
    }

    .fk-btn-warning {
        background: linear-gradient(135deg, #ffc107, #ffcd39);
        color: #212529;
        box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
    }

    .fk-btn-warning:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(255, 193, 7, 0.4);
        color: #212529;
    }

    .fk-btn-info {
        background: linear-gradient(135deg, #17a2b8, #3dd5f3);
        color: white;
        box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
    }

    .fk-btn-info:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(23, 162, 184, 0.4);
        color: white;
    }

    .fk-btn-secondary {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: white;
    }

    .fk-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-3px);
        color: white;
    }

    .fk-btn-outline-light {
        background: transparent;
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
    }

    .fk-btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: white;
        transform: translateY(-3px);
    }

    /* ========== DROPDOWN ========== */
    .dropdown-menu {
        background: var(--bg-primary) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 16px !important;
        box-shadow: 0 20px 40px var(--shadow-color) !important;
        padding: 0.75rem !important;
    }

    .dropdown-item {
        padding: 0.75rem 1rem !important;
        border-radius: 10px !important;
        color: var(--text-primary) !important;
        transition: all 0.2s ease;
    }

    .dropdown-item i {
        width: 22px;
        color: var(--success);
    }

    .dropdown-item:hover {
        background: var(--success-light) !important;
        color: var(--success) !important;
        transform: translateX(5px);
    }

    .dropdown-item.text-warning i {
        color: var(--warning);
    }

    .dropdown-item.text-warning:hover {
        background: var(--warning-light) !important;
        color: var(--warning) !important;
    }

    /* ========== CARTES ========== */
    .card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow: 0 4px 20px var(--shadow-color);
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 8px 30px var(--shadow-color);
        transform: translateY(-2px);
    }

    .card-header {
        background: linear-gradient(135deg, var(--success), #34ce57);
        border-bottom: 1px solid var(--border-color);
        color: white;
        padding: 1rem 1.5rem;
        border-top-left-radius: 16px !important;
        border-top-right-radius: 16px !important;
    }

    .card-header.bg-info {
        background: linear-gradient(135deg, var(--info), #3dd5f3);
    }

    .card-header.bg-warning {
        background: linear-gradient(135deg, var(--warning), #ffcd39);
        color: #212529;
    }

    .card-header.bg-light {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
    }

    .card-header.bg-secondary {
        background: linear-gradient(135deg, #6c757d, #868e96);
    }

    .card-body {
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 1.5rem;
    }

    /* ========== TABLEAUX ========== */
    .table {
        color: var(--text-primary);
    }

    .table-borderless th {
        color: var(--text-secondary);
    }

    .table-borderless td {
        color: var(--text-primary);
    }

    .table-hover tbody tr:hover {
        background: var(--bg-tertiary);
    }

    .text-muted {
        color: var(--text-muted) !important;
    }

    .bg-light {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
    }

    /* ========== PROGRESS BAR ========== */
    .progress {
        background: var(--border-color);
        border-radius: 50px;
    }

    .progress-bar.bg-success {
        background: var(--success) !important;
    }

    .progress-bar.bg-warning {
        background: var(--warning) !important;
    }

    .progress-bar.bg-danger {
        background: var(--danger) !important;
    }

    .progress-bar.bg-secondary {
        background: var(--text-secondary) !important;
    }

    .progress-bar.bg-info {
        background: var(--info) !important;
    }

    /* ========== BADGES ========== */
    .badge.bg-success {
        background: var(--success) !important;
        color: white !important;
    }

    .badge.bg-warning {
        background: var(--warning) !important;
        color: #212529 !important;
    }

    .badge.bg-danger {
        background: var(--danger) !important;
        color: white !important;
    }

    .badge.bg-secondary {
        background: var(--text-secondary) !important;
        color: white !important;
    }

    .badge.bg-info {
        background: var(--info) !important;
        color: white !important;
    }

    /* Badges de statut */
    .badge-statut {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 1rem;
        border-radius: 30px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-statut.en_attente {
        background: rgba(100, 116, 139, 0.25);
        color: var(--text-secondary);
        border: 1px solid rgba(100, 116, 139, 0.4);
    }

    .badge-statut.en_cours {
        background: var(--warning-light);
        color: var(--warning);
        border: 1px solid rgba(255, 193, 7, 0.4);
    }

    .badge-statut.termine {
        background: var(--success-light);
        color: var(--success);
        border: 1px solid rgba(40, 167, 69, 0.4);
    }

    .badge-statut.suspendu {
        background: rgba(102, 16, 242, 0.25);
        color: #a78bfa;
        border: 1px solid rgba(102, 16, 242, 0.4);
    }

    .badge-statut.annule {
        background: var(--danger-light);
        color: var(--danger);
        border: 1px solid rgba(220, 53, 69, 0.4);
    }

    .badge-priorite {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 30px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-priorite.critique {
        background: #DC2626;
        color: white;
    }

    .badge-priorite.haute {
        background: #F59E0B;
        color: white;
    }

    .badge-priorite.moyenne {
        background: #3B82F6;
        color: white;
    }

    .badge-priorite.basse {
        background: #64748b;
        color: white;
    }

    /* ========== FORMULAIRES ========== */
    .form-select, .form-control {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 10px;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--success);
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25);
        outline: none;
    }

    .form-select option {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .form-range {
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
    }

    .form-range::-webkit-slider-thumb {
        background: var(--success);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
    }

    /* ========== BOUTONS ========== */
    .btn-outline-secondary {
        border-color: var(--border-color);
        color: var(--text-secondary);
    }

    .btn-outline-secondary:hover {
        background: var(--bg-tertiary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .btn-outline-success {
        border-color: var(--success);
        color: var(--success);
    }

    .btn-outline-success:hover {
        background: var(--success);
        color: white;
    }

    .btn-outline-warning {
        border-color: var(--warning);
        color: var(--warning);
    }

    .btn-outline-warning:hover {
        background: var(--warning);
        color: #212529;
    }

    .btn-outline-danger {
        border-color: var(--danger);
        color: var(--danger);
    }

    .btn-outline-danger:hover {
        background: var(--danger);
        color: white;
    }

    .btn-outline-info {
        border-color: var(--info);
        color: var(--info);
    }

    .btn-outline-info:hover {
        background: var(--info);
        color: white;
    }

    .btn-group .btn {
        border-radius: 8px !important;
        margin-right: 4px;
    }

    /* ========== TIMELINE ========== */
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-marker {
        position: absolute;
        left: -30px;
        top: 0;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid var(--bg-primary);
        box-shadow: 0 0 0 2px var(--border-color);
    }

    .timeline-marker.bg-success {
        background: var(--success);
    }

    .timeline-marker.bg-danger {
        background: var(--danger);
    }

    .timeline-marker.bg-info {
        background: var(--info);
    }

    .timeline-content {
        padding-left: 10px;
    }

    .timeline-content h6 {
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    /* ========== DRAG & DROP ========== */
    .dragging {
        opacity: 0.5;
        background: var(--bg-tertiary) !important;
    }

    .drag-handle {
        cursor: move;
        color: var(--text-secondary);
    }

    /* ========== LISTE GROUP ========== */
    .list-group-item {
        background: var(--bg-primary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .list-group-item .fw-bold {
        color: var(--text-primary);
    }

    /* ========== ALERTES ========== */
    .alert {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px var(--shadow-color);
    }

    .alert-success {
        background: var(--success-light);
        color: var(--success);
    }

    .alert-warning {
        background: var(--warning-light);
        color: var(--warning);
    }

    .alert-info {
        background: var(--info-light);
        color: var(--info);
    }

    .alert-danger {
        background: var(--danger-light);
        color: var(--danger);
    }

    /* ========== ANIMATIONS ========== */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes highlightUpdate {
        0% { background-color: rgba(40, 167, 69, 0.2); }
        100% { background-color: transparent; }
    }

    .animate-in {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    .highlight-update {
        animation: highlightUpdate 1s ease;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .btn-group {
            width: 100%;
        }

        .btn-group .btn {
            flex: 1;
        }

        .progression-slider {
            width: 80px;
        }
    }
</style>

<div class="plan-container">
    <!-- ========== EN-TÊTE ========== -->
    <div class="page-header animate-in">
        <div class="page-header-content">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('liste_plans_action_independants') }}">Plans indépendants</a></li>
                            <li class="breadcrumb-item active">{{ plan.reference }}</li>
                        </ol>
                    </nav>
                    
                    <div class="page-title">
                        <i class="fas fa-tasks me-2" style="color: #28a745;"></i>{{ plan.reference }}
                        <span class="badge-statut {{ plan.statut }}">
                            {{ plan.statut|replace('_', ' ')|title }}
                        </span>
                        {% if plan.est_en_retard %}
                        <span class="badge-statut" style="background: rgba(220, 53, 69, 0.25); color: #dc3545;">
                            <i class="fas fa-exclamation-triangle me-1"></i>EN RETARD
                        </span>
                        {% endif %}
                    </div>
                    
                    <p class="text-white-50 mb-0">{{ plan.nom }}</p>
                </div>
                
                <div class="col-auto">
                    <div class="header-actions">
                        <a href="{{ url_for('liste_plans_action_independants') }}" class="fk-btn fk-btn-outline-light">
                            <i class="fas fa-arrow-left"></i> Retour
                        </a>
                        
                        <a href="{{ url_for('modifier_plan_action_independant', plan_id=plan.id) }}" class="fk-btn fk-btn-warning">
                            <i class="fas fa-edit"></i> Modifier
                        </a>
                        
                        <a href="{{ url_for('espace_travail_plan_action_independant', plan_id=plan.id) }}" class="fk-btn fk-btn-info">
                            <i class="fas fa-comments"></i> Espace travail
                        </a>
                        
                        <div class="dropdown">
                            <button class="fk-btn fk-btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-cog"></i> Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="ajouterSousAction()">
                                        <i class="fas fa-plus"></i>Ajouter sous-action
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="changerStatutPlan()">
                                        <i class="fas fa-flag"></i>Changer statut
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-warning" href="#" onclick="archiverPlan()">
                                        <i class="fas fa-archive"></i>Archiver
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category if category != 'message' else 'info' }} alert-dismissible fade show animate-in" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'warning' else 'info-circle' }} me-2 fa-lg"></i>
                        <div>{{ message }}</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ========== INFORMATIONS PRINCIPALES ========== -->
    <div class="row mb-4">
        <!-- Colonne gauche - Infos principales -->
        <div class="col-md-8">
            <div class="card animate-in">
                <div class="card-header bg-success">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i> Informations</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%" class="text-adaptive-secondary">Référence:</th>
                                    <td><strong class="text-success">{{ plan.reference }}</strong></td>
                                </tr>
                                <tr>
                                    <th class="text-adaptive-secondary">Nom:</th>
                                    <td class="text-adaptive">{{ plan.nom }}</td>
                                </tr>
                                <tr>
                                    <th class="text-adaptive-secondary">Type:</th>
                                    <td>
                                        <span class="badge bg-success">
                                            <i class="fas fa-star me-1"></i> Plan indépendant
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-adaptive-secondary">Statut:</th>
                                    <td>
                                        <span class="badge-statut {{ plan.statut }}">
                                            {{ plan.statut|replace('_', ' ')|title }}
                                        </span>
                                        {% if plan.est_en_retard %}
                                        <span class="badge bg-danger ms-1">EN RETARD</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%" class="text-adaptive-secondary">Responsable:</th>
                                    <td>
                                        {% if plan.responsable %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user me-2 text-success"></i>
                                            <div>
                                                <div class="text-adaptive">{{ plan.responsable.username }}</div>
                                                <small class="text-adaptive-secondary">{{ plan.responsable.email }}</small>
                                            </div>
                                        </div>
                                        {% else %}
                                        <span class="text-adaptive-secondary"><i class="fas fa-user-slash me-1"></i>Non assigné</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-adaptive-secondary">Date début:</th>
                                    <td class="text-adaptive">
                                        <i class="fas fa-calendar-alt me-1 text-adaptive-secondary"></i>
                                        {{ plan.date_debut.strftime('%d/%m/%Y') if plan.date_debut else '-' }}
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-adaptive-secondary">Date échéance:</th>
                                    <td class="text-adaptive">
                                        <i class="fas fa-flag-checkered me-1 text-adaptive-secondary"></i>
                                        {{ plan.date_fin_prevue.strftime('%d/%m/%Y') if plan.date_fin_prevue else '-' }}
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-adaptive-secondary">Créé par:</th>
                                    <td class="text-adaptive">
                                        <i class="fas fa-user-plus me-1 text-adaptive-secondary"></i>
                                        {{ plan.createur.username if plan.createur else 'Système' }}
                                        <small class="text-adaptive-secondary">le {{ plan.created_at.strftime('%d/%m/%Y') }}</small>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if plan.description %}
                    <div class="mt-3">
                        <h6 class="text-adaptive"><i class="fas fa-align-left me-2 text-success"></i>Description:</h6>
                        <div class="border rounded p-3 bg-adaptive-secondary">
                            {{ plan.description|nl2br|safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Colonne droite - Progression -->
        <div class="col-md-4">
            <!-- Progression principale -->
            <div class="card mb-4 animate-in">
                <div class="card-header bg-info">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i> Progression</h6>
                </div>
                <div class="card-body text-center">
                    <div class="display-4 text-success mb-2" id="progressionGlobale">
                        {{ pourcentage_avancement }}%
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" id="progressionBar" 
                             style="width: {{ pourcentage_avancement }}%">
                        </div>
                    </div>
                    <p class="mt-2 mb-1 text-adaptive">
                        <span class="fw-bold" id="sousActionsTerminees">{{ sous_actions_terminees }}</span>
                        sur 
                        <span class="fw-bold" id="totalSousActions">{{ total_sous_actions }}</span> 
                        sous-actions terminées
                    </p>
                    <small class="text-adaptive-secondary">
                        Dernière mise à jour: {{ plan.updated_at.strftime('%d/%m/%Y %H:%M') }}
                    </small>
                </div>
            </div>
            
            <!-- Contrôle de progression rapide -->
            <div class="card mb-4 animate-in">
                <div class="card-header bg-warning">
                    <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i> Progression rapide</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2 text-adaptive">Définir la progression globale:</p>
                    <div class="btn-group w-100 mb-2" role="group">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="setProgressionFixe(0)">
                            0%
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="setProgressionFixe(25)">
                            25%
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="setProgressionFixe(50)">
                            50%
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setProgressionFixe(75)">
                            75%
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="setProgressionFixe(100)">
                            100%
                        </button>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-sm btn-success" onclick="ajouterSousAction()">
                            <i class="fas fa-plus me-1"></i> Nouvelle sous-action
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="changerStatutPlan()">
                            <i class="fas fa-flag me-1"></i> Changer statut
                        </button>
                        {% if plan.statut != 'termine' %}
                        <button class="btn btn-sm btn-primary" onclick="terminerPlan()">
                            <i class="fas fa-check-circle me-1"></i> Terminer le plan
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Dates importantes -->
            <div class="card animate-in">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-calendar-alt me-2 text-success"></i> Calendrier</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th class="text-adaptive-secondary">Début:</th>
                            <td class="text-adaptive">{{ plan.date_debut.strftime('%d/%m/%Y') if plan.date_debut else '-' }}</td>
                        </tr>
                        <tr>
                            <th class="text-adaptive-secondary">Échéance:</th>
                            <td class="text-adaptive">{{ plan.date_fin_prevue.strftime('%d/%m/%Y') if plan.date_fin_prevue else '-' }}</td>
                        </tr>
                        <tr>
                            <th class="text-adaptive-secondary">Terminé le:</th>
                            <td class="text-adaptive">{{ plan.date_fin_reelle.strftime('%d/%m/%Y') if plan.date_fin_reelle else '-' }}</td>
                        </tr>
                        <tr>
                            <th class="text-adaptive-secondary">Jours restants:</th>
                            <td>
                                {% if plan.date_fin_prevue and plan.statut != 'termine' %}
                                    {% set jours_restants = (plan.date_fin_prevue - datetime.now().date()).days %}
                                    <span class="fw-bold text-{% if jours_restants <= 7 %}danger{% elif jours_restants <= 30 %}warning{% else %}success{% endif %}">
                                        {% if jours_restants > 0 %}
                                            {{ jours_restants }} jour(s)
                                        {% elif jours_restants == 0 %}
                                            <i class="fas fa-exclamation-triangle"></i> Aujourd'hui!
                                        {% else %}
                                            <i class="fas fa-exclamation-circle"></i> Retard de {{ -jours_restants }} jour(s)
                                        {% endif %}
                                    </span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== DÉTAIL DE LA PROGRESSION ========== -->
    <div class="card mb-4 animate-in">
        <div class="card-header bg-success d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Détail de la progression</h6>
            <div class="btn-group">
                <button class="btn btn-sm btn-light" onclick="rafraichirProgression()">
                    <i class="fas fa-sync-alt me-1"></i> Recalculer
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="display-6 text-success" id="countTerminees">
                        {{ sous_actions|selectattr('statut', 'equalto', 'termine')|list|length }}
                    </div>
                    <small class="text-adaptive-secondary">Terminées</small>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-success" id="barTerminees"
                             style="width: {{ (sous_actions|selectattr('statut', 'equalto', 'termine')|list|length / total_sous_actions * 100) if total_sous_actions > 0 else 0 }}%">
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="display-6 text-warning" id="countEnCours">
                        {{ sous_actions|selectattr('statut', 'equalto', 'en_cours')|list|length }}
                    </div>
                    <small class="text-adaptive-secondary">En cours</small>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-warning" id="barEnCours"
                             style="width: {{ (sous_actions|selectattr('statut', 'equalto', 'en_cours')|list|length / total_sous_actions * 100) if total_sous_actions > 0 else 0 }}%">
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="display-6 text-secondary" id="countAFaire">
                        {{ sous_actions|selectattr('statut', 'equalto', 'a_faire')|list|length }}
                    </div>
                    <small class="text-adaptive-secondary">À faire</small>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-secondary" id="barAFaire"
                             style="width: {{ (sous_actions|selectattr('statut', 'equalto', 'a_faire')|list|length / total_sous_actions * 100) if total_sous_actions > 0 else 0 }}%">
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="display-6 text-danger" id="countRetardees">
                        {{ sous_actions|selectattr('statut', 'equalto', 'retarde')|list|length }}
                    </div>
                    <small class="text-adaptive-secondary">Retardées</small>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-danger" id="barRetardees"
                             style="width: {{ (sous_actions|selectattr('statut', 'equalto', 'retarde')|list|length / total_sous_actions * 100) if total_sous_actions > 0 else 0 }}%">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Légende -->
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="d-flex justify-content-center gap-3">
                        <span class="badge bg-success">Terminées (100%)</span>
                        <span class="badge bg-warning">En cours (50-99%)</span>
                        <span class="badge bg-secondary">À faire (0-49%)</span>
                        <span class="badge bg-danger">Retardées</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== SOUS-ACTIONS ========== -->
    <div class="card mb-4 animate-in">
        <div class="card-header bg-success d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-list-check me-2"></i> Sous-actions ({{ sous_actions|length }})</h6>
            <div class="btn-group">
                <button class="btn btn-sm btn-light" onclick="ajouterSousAction()">
                    <i class="fas fa-plus"></i> Ajouter
                </button>
                <button class="btn btn-sm btn-light" onclick="reorganiserSousActions()">
                    <i class="fas fa-sort"></i> Réorganiser
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if sous_actions %}
            <div class="table-responsive">
                <table class="table table-hover" id="sousActionsTable">
                    <thead>
                        <tr>
                            <th width="5%" class="text-adaptive-secondary">#</th>
                            <th width="30%" class="text-adaptive-secondary">Description</th>
                            <th width="15%" class="text-adaptive-secondary">Statut</th>
                            <th width="15%" class="text-adaptive-secondary">Dates</th>
                            <th width="20%" class="text-adaptive-secondary">Progression</th>
                            <th width="15%" class="text-adaptive-secondary">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sousActionsBody">
                        {% for action in sous_actions %}
                        <tr id="sous-action-{{ action.id }}" data-id="{{ action.id }}" draggable="true">
                            <td class="drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                                <span class="ms-1">{{ loop.index }}</span>
                            </td>
                            <td>
                                {% if action.reference %}
                                <div class="fw-bold text-success">{{ action.reference }}</div>
                                {% endif %}
                                <div class="sous-action-description text-adaptive">{{ action.description|truncate(80) }}</div>
                                {% if action.responsable %}
                                <small class="text-adaptive-secondary">
                                    <i class="fas fa-user"></i> {{ action.responsable.username }}
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <select class="form-select form-select-sm statut-select" 
                                        data-id="{{ action.id }}"
                                        onchange="changerStatutSousAction({{ action.id }}, this.value)">
                                    <option value="a_faire" {% if action.statut == 'a_faire' %}selected{% endif %}>À faire (0-49%)</option>
                                    <option value="en_cours" {% if action.statut == 'en_cours' %}selected{% endif %}>En cours (50-99%)</option>
                                    <option value="termine" {% if action.statut == 'termine' %}selected{% endif %}>Terminé (100%)</option>
                                    <option value="retarde" {% if action.statut == 'retarde' %}selected{% endif %}>Retardé</option>
                                </select>
                            </td>
                            <td>
                                <div class="small text-adaptive">
                                    {% if action.date_debut %}
                                    <div><i class="fas fa-calendar-alt me-1 text-adaptive-secondary"></i>{{ action.date_debut.strftime('%d/%m/%y') }}</div>
                                    {% endif %}
                                    {% if action.date_fin_prevue %}
                                    <div><i class="fas fa-hourglass-end me-1 text-adaptive-secondary"></i>{{ action.date_fin_prevue.strftime('%d/%m/%y') }}</div>
                                    {% endif %}
                                    {% if action.est_en_retard and action.statut != 'termine' %}
                                    <div class="text-danger">
                                        <i class="fas fa-exclamation-triangle"></i> En retard
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress flex-grow-1" style="height: 8px;">
                                        <div class="progress-bar 
                                            {% if action.pourcentage_realisation >= 100 %}bg-success
                                            {% elif action.pourcentage_realisation >= 50 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                             id="progress-bar-{{ action.id }}"
                                             style="width: {{ action.pourcentage_realisation }}%">
                                        </div>
                                    </div>
                                    <span class="small fw-bold" id="percentage-{{ action.id }}">
                                        {{ action.pourcentage_realisation }}%
                                    </span>
                                </div>
                                <div class="d-flex align-items-center mt-2">
                                    <input type="range" class="form-range progression-slider" 
                                           min="0" max="100" step="25"
                                           value="{{ action.pourcentage_realisation }}"
                                           data-id="{{ action.id }}"
                                           onchange="changerProgressionSousAction({{ action.id }}, this.value)">
                                    <button class="btn btn-sm btn-outline-success ms-2" 
                                            onclick="appliquerProgressionFixe({{ action.id }}, 100)"
                                            title="Terminer à 100%">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('espace_travail_sous_action', sous_action_id=action.id) }}" 
                                       class="btn btn-outline-info" title="Espace de travail">
                                        <i class="fas fa-comments"></i>
                                    </a>
                                    <button class="btn btn-outline-primary" 
                                            onclick="modifierSousAction({{ action.id }})"
                                            title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-success" 
                                            onclick="terminerSousAction({{ action.id }})"
                                            title="Terminer" {% if action.statut == 'termine' %}disabled{% endif %}>
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="supprimerSousActionTableau({{ action.id }})"
                                            title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-list-check fa-4x text-adaptive-secondary mb-3"></i>
                <h5 class="text-adaptive">Aucune sous-action définie</h5>
                <p class="text-adaptive-secondary mb-4">Commencez par ajouter des sous-actions à ce plan</p>
                <button class="btn btn-lg btn-success" onclick="ajouterSousAction()">
                    <i class="fas fa-plus me-2"></i>Ajouter la première sous-action
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ========== COMMENTAIRES RÉCENTS ========== -->
    <div class="card mb-4 animate-in">
        <div class="card-header bg-info">
            <h6 class="mb-0"><i class="fas fa-comments me-2"></i> Commentaires récents</h6>
        </div>
        <div class="card-body">
            {% if commentaires %}
            <div class="list-group">
                {% for commentaire in commentaires[:5] %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <div class="fw-bold text-adaptive">
                            <i class="fas fa-user-circle me-1 text-info"></i>
                            {{ commentaire.utilisateur.username if commentaire.utilisateur else 'Système' }}
                        </div>
                        <small class="text-adaptive-secondary">{{ commentaire.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                    </div>
                    <div class="mt-2 text-adaptive">{{ commentaire.contenu|truncate(200) }}</div>
                    {% if commentaire.fichiers %}
                    <div class="mt-2 text-adaptive-secondary">
                        <i class="fas fa-paperclip me-1"></i>
                        {{ commentaire.fichiers|length }} fichier(s) joint(s)
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <a href="{{ url_for('espace_travail_plan_action_independant', plan_id=plan.id) }}" 
                   class="btn btn-outline-info">
                    Voir tous les commentaires ({{ commentaires|length }})
                </a>
            </div>
            {% else %}
            <div class="text-center py-3">
                <i class="fas fa-comments fa-3x text-adaptive-secondary mb-2"></i>
                <p class="text-adaptive-secondary">Aucun commentaire pour le moment</p>
                <a href="{{ url_for('espace_travail_plan_action_independant', plan_id=plan.id) }}" 
                   class="btn btn-outline-info">
                    Aller à l'espace de travail
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ========== HISTORIQUE ========== -->
    <div class="card mb-4 animate-in">
        <div class="card-header bg-secondary">
            <h6 class="mb-0"><i class="fas fa-history me-2"></i> Historique</h6>
        </div>
        <div class="card-body">
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-marker bg-success"></div>
                    <div class="timeline-content">
                        <h6 class="text-adaptive">Plan créé</h6>
                        <p class="text-adaptive-secondary mb-1">Créé par {{ plan.createur.username if plan.createur else 'Système' }}</p>
                        <small class="text-adaptive-secondary">{{ plan.created_at.strftime('%d/%m/%Y à %H:%M') }}</small>
                    </div>
                </div>
                
                {% if plan.statut == 'termine' and plan.date_fin_reelle %}
                <div class="timeline-item">
                    <div class="timeline-marker bg-success"></div>
                    <div class="timeline-content">
                        <h6 class="text-adaptive">Plan terminé</h6>
                        <p class="text-adaptive-secondary mb-1">Marqué comme terminé</p>
                        <small class="text-adaptive-secondary">{{ plan.date_fin_reelle.strftime('%d/%m/%Y') }}</small>
                    </div>
                </div>
                {% endif %}
                
                {% if plan.est_en_retard %}
                <div class="timeline-item">
                    <div class="timeline-marker bg-danger"></div>
                    <div class="timeline-content">
                        <h6 class="text-adaptive">En retard</h6>
                        <p class="text-adaptive-secondary mb-1">La date d'échéance est dépassée</p>
                        <small class="text-adaptive-secondary">Échéance: {{ plan.date_fin_prevue.strftime('%d/%m/%Y') }}</small>
                    </div>
                </div>
                {% endif %}
                
                {% if sous_actions|selectattr('statut', 'equalto', 'termine')|list|length > 0 %}
                <div class="timeline-item">
                    <div class="timeline-marker bg-info"></div>
                    <div class="timeline-content">
                        <h6 class="text-adaptive">Sous-actions terminées</h6>
                        <p class="text-adaptive-secondary mb-1">
                            {{ sous_actions|selectattr('statut', 'equalto', 'termine')|list|length }} 
                            sous-action(s) terminée(s)
                        </p>
                        <small class="text-adaptive-secondary">Progression: {{ pourcentage_avancement }}%</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Debug info (admin only) -->
    {% if current_user.role == 'super_admin' or current_user.is_client_admin %}
    <div class="card mt-4 border-warning animate-in">
        <div class="card-header bg-warning">
            <h6 class="mb-0"><i class="fas fa-bug me-2"></i> Debug Info (Admin only)</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><th class="text-adaptive-secondary">Plan ID:</th><td class="text-adaptive">{{ plan.id }}</td></tr>
                        <tr><th class="text-adaptive-secondary">Plan Client ID:</th><td class="text-adaptive">{{ plan.client_id }}</td></tr>
                        <tr><th class="text-adaptive-secondary">Created By:</th><td class="text-adaptive">{{ plan.created_by }}</td></tr>
                        <tr><th class="text-adaptive-secondary">Responsable:</th><td class="text-adaptive">{{ plan.responsable_id }}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><th class="text-adaptive-secondary">Your Client ID:</th><td class="text-adaptive">{{ current_user.client_id }}</td></tr>
                        <tr><th class="text-adaptive-secondary">Your Role:</th><td class="text-adaptive">{{ current_user.role }}</td></tr>
                        <tr><th class="text-adaptive-secondary">Is Client Admin:</th><td class="text-adaptive">{{ current_user.is_client_admin }}</td></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal générique -->
<div class="modal fade" id="genericModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="genericModalTitle">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="genericModalBody"></div>
            <div class="modal-footer" id="genericModalFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary">Valider</button>
            </div>
        </div>
    </div>
</div>

<!-- Token CSRF -->
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block scripts %}
<script>
// ============================================
// VARIABLES GLOBALES
// ============================================
const planId = {{ plan.id }};
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token() }}';

// ============================================
// FONCTIONS POUR LES SOUS-ACTIONS
// ============================================

function ajouterSousAction() {
    window.location.href = "{{ url_for('nouveau_sous_action_independant', plan_id=plan.id) }}";
}

function modifierSousAction(sousActionId) {
    window.location.href = `/sous-action-independant/${sousActionId}/modifier`;
}

function terminerSousAction(sousActionId) {
    if (confirm('Marquer cette sous-action comme terminée à 100% ?')) {
        fetch(`/sous-action-independant/${sousActionId}/terminer`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSousActionUI(sousActionId, 100, 'termine');
                rafraichirProgression();
                showToast('success', '✅ Sous-action terminée');
            } else {
                showToast('error', '❌ ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '❌ Erreur réseau');
        });
    }
}

function supprimerSousActionTableau(sousActionId) {
    if (confirm('Supprimer cette sous-action ?')) {
        fetch(`/sous-action-independant/${sousActionId}/supprimer`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById(`sous-action-${sousActionId}`);
                if (row) {
                    row.remove();
                    rafraichirProgression();
                    showToast('success', '✅ Sous-action supprimée');
                }
            } else {
                showToast('error', '❌ ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '❌ Erreur réseau');
        });
    }
}

function changerStatutSousAction(sousActionId, statut) {
    let progression = 0;
    if (statut === 'termine') progression = 100;
    else if (statut === 'en_cours') progression = 50;
    else if (statut === 'a_faire') progression = 25;
    else if (statut === 'retarde') progression = 25;
    
    fetch(`/sous-action-independant/${sousActionId}/changer-statut`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ statut: statut, progression: progression })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSousActionUI(sousActionId, progression, statut);
            rafraichirProgression();
            showToast('success', `✅ Statut changé à ${statut}`);
        } else {
            showToast('error', '❌ ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', '❌ Erreur réseau');
    });
}

function changerProgressionSousAction(sousActionId, progression) {
    progression = Math.round(progression / 25) * 25;
    
    fetch(`/sous-action-independant/${sousActionId}/changer-progression`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ progression: parseInt(progression) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSousActionUI(sousActionId, progression, data.statut);
            rafraichirProgression();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function appliquerProgressionFixe(sousActionId, progression) {
    if (confirm(`Définir cette sous-action à ${progression}% ?`)) {
        fetch(`/sous-action-independant/${sousActionId}/changer-progression`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ progression: progression })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSousActionUI(sousActionId, progression, data.statut);
                rafraichirProgression();
                showToast('success', `✅ Progression définie à ${progression}%`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '❌ Erreur réseau');
        });
    }
}

function updateSousActionUI(sousActionId, progression, statut) {
    const row = document.getElementById(`sous-action-${sousActionId}`);
    if (!row) return;
    
    const progressBar = document.getElementById(`progress-bar-${sousActionId}`);
    if (progressBar) {
        progressBar.style.width = progression + '%';
        progressBar.className = `progress-bar ${
            progression >= 100 ? 'bg-success' :
            progression >= 50 ? 'bg-warning' : 'bg-danger'
        }`;
    }
    
    const percentageSpan = document.getElementById(`percentage-${sousActionId}`);
    if (percentageSpan) percentageSpan.textContent = progression + '%';
    
    const slider = row.querySelector('.progression-slider');
    if (slider) slider.value = progression;
    
    const select = row.querySelector('.statut-select');
    if (select) select.value = statut;
    
    row.classList.add('highlight-update');
    setTimeout(() => row.classList.remove('highlight-update'), 1000);
}

// ============================================
// FONCTIONS POUR LE PLAN
// ============================================

function changerStatutPlan() {
    const html = `
        <form method="POST" action="/plan-action-independant/{{ plan.id }}/changer-statut" id="formStatutPlan">
            <input type="hidden" name="csrf_token" value="${csrfToken}">
            <div class="mb-3">
                <label class="form-label fw-bold text-adaptive">Nouveau statut :</label>
                <select class="form-select" name="statut" required>
                    <option value="en_attente" ${'{{ "selected" if plan.statut == "en_attente" else "" }}'.replace(/[{}]/g, '')}>En attente</option>
                    <option value="en_cours" ${'{{ "selected" if plan.statut == "en_cours" else "" }}'.replace(/[{}]/g, '')}>En cours</option>
                    <option value="termine" ${'{{ "selected" if plan.statut == "termine" else "" }}'.replace(/[{}]/g, '')}>Terminé</option>
                    <option value="suspendu" ${'{{ "selected" if plan.statut == "suspendu" else "" }}'.replace(/[{}]/g, '')}>Suspendu</option>
                    <option value="annule" ${'{{ "selected" if plan.statut == "annule" else "" }}'.replace(/[{}]/g, '')}>Annulé</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold text-adaptive">Commentaire (optionnel) :</label>
                <textarea class="form-control" name="commentaire" rows="3" placeholder="Raison du changement de statut..."></textarea>
            </div>
        </form>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('genericModal'));
    document.getElementById('genericModalTitle').innerHTML = '<i class="fas fa-flag me-2 text-success"></i>Changer le statut du plan';
    document.getElementById('genericModalBody').innerHTML = html;
    document.getElementById('genericModalFooter').innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-success" form="formStatutPlan">Enregistrer</button>
    `;
    modal.show();
}

function terminerPlan() {
    if (confirm('Terminer ce plan d\'action ? Toutes les sous-actions seront marquées comme terminées à 100%.')) {
        fetch(`/plan-action-independant/${planId}/terminer`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', '✅ Plan terminé avec succès');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', '❌ ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '❌ Erreur réseau');
        });
    }
}

function archiverPlan() {
    if (confirm('Archiver ce plan d\'action ? Il sera déplacé dans les archives.')) {
        fetch(`/plan-action-independant/${planId}/archiver`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.ok) {
                showToast('success', '✅ Plan archivé');
                setTimeout(() => {
                    window.location.href = "{{ url_for('liste_plans_action_independants') }}";
                }, 1000);
            } else {
                showToast('error', '❌ Erreur lors de l\'archivage');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '❌ Erreur réseau');
        });
    }
}

function setProgressionFixe(percentage) {
    if (confirm(`Définir la progression globale à ${percentage}% ? Toutes les sous-actions seront ajustées proportionnellement.`)) {
        fetch(`/plan-action-independant/${planId}/set-progression-fixe`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ progression: percentage })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', `✅ ${data.message}`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', '❌ ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '❌ Erreur réseau');
        });
    }
}

function rafraichirProgression() {
    fetch(`/plan-action-independant/${planId}/progression-detail`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('progressionGlobale').textContent = data.details.progression + '%';
            document.getElementById('progressionBar').style.width = data.details.progression + '%';
            
            document.getElementById('sousActionsTerminees').textContent = data.details.terminees;
            document.getElementById('totalSousActions').textContent = data.details.total;
            document.getElementById('countTerminees').textContent = data.details.terminees;
            document.getElementById('countEnCours').textContent = data.details.en_cours;
            document.getElementById('countAFaire').textContent = data.details.a_faire;
            document.getElementById('countRetardees').textContent = data.details.retardees;
            
            const total = data.details.total || 1;
            document.getElementById('barTerminees').style.width = (data.details.terminees / total * 100) + '%';
            document.getElementById('barEnCours').style.width = (data.details.en_cours / total * 100) + '%';
            document.getElementById('barAFaire').style.width = (data.details.a_faire / total * 100) + '%';
            document.getElementById('barRetardees').style.width = (data.details.retardees / total * 100) + '%';
            
            showToast('info', '🔄 Progression mise à jour');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// ============================================
// DRAG & DROP
// ============================================
let draggedRow = null;

function reorganiserSousActions() {
    const rows = document.querySelectorAll('#sousActionsBody tr');
    rows.forEach(row => {
        row.setAttribute('draggable', 'true');
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragend', handleDragEnd);
    });
    showToast('info', '🔄 Mode réorganisation activé. Glissez-déposez les sous-actions.');
}

function handleDragStart(e) {
    draggedRow = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
    this.classList.add('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDrop(e) {
    e.preventDefault();
    if (draggedRow !== this) {
        const allRows = Array.from(document.querySelectorAll('#sousActionsBody tr'));
        const draggedIndex = allRows.indexOf(draggedRow);
        const targetIndex = allRows.indexOf(this);
        
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedRow, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedRow, this);
        }
        
        updateRowNumbers();
    }
}

function handleDragEnd() {
    this.classList.remove('dragging');
    sauvegarderOrdreSousActions();
}

function updateRowNumbers() {
    const rows = document.querySelectorAll('#sousActionsBody tr');
    rows.forEach((row, index) => {
        const td = row.querySelector('.drag-handle');
        if (td) {
            const icon = td.querySelector('i');
            td.innerHTML = '';
            td.appendChild(icon.cloneNode(true));
            td.appendChild(document.createTextNode(' ' + (index + 1)));
        }
    });
}

function sauvegarderOrdreSousActions() {
    const rows = document.querySelectorAll('#sousActionsBody tr');
    const ids = Array.from(rows).map(row => row.getAttribute('data-id'));
    
    fetch(`/plan-action-independant/${planId}/reorganiser-sous-actions`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ids: ids })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', '✅ Ordre sauvegardé');
        }
    });
}

// ============================================
// TOAST NOTIFICATION
// ============================================
function showToast(type, message) {
    const titles = {
        'success': 'Succès',
        'error': 'Erreur',
        'warning': 'Attention',
        'info': 'Information'
    };
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2 fa-lg"></i>
            <div>
                <strong>${titles[type]}</strong><br>
                <span>${message}</span>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transition = 'opacity 0.3s ease';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ============================================
// INITIALISATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Page détail plan indépendant chargée');
    console.log('Plan ID:', planId);
    
    const sliders = document.querySelectorAll('.progression-slider');
    sliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const value = Math.round(this.value / 25) * 25;
            const sousActionId = this.getAttribute('data-id');
            const percentageSpan = document.getElementById(`percentage-${sousActionId}`);
            if (percentageSpan) {
                percentageSpan.textContent = value + '%';
            }
        });
    });
    
    // Gestion des dropdowns
    document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdown = this.nextElementSibling;
            
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                if (menu !== dropdown) menu.classList.remove('show');
            });
            
            if (dropdown) {
                dropdown.classList.toggle('show');
                this.setAttribute('aria-expanded', dropdown.classList.contains('show'));
            }
        });
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
                const btn = menu.previousElementSibling;
                if (btn) btn.setAttribute('aria-expanded', 'false');
            });
        }
    });
});
</script>
{% endblock %}
