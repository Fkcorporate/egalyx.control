{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-tasks me-2"></i> Plans d'action - {{ risque.reference }}
    </h2>
    <div class="btn-toolbar">
        <a href="{{ url_for('detail_risque', id=risque.id) }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Retour au risque
        </a>
        <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=risque.id) }}" 
           class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Nouveau plan
        </a>
    </div>
</div>

<!-- Filtres rapides -->
<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-filter me-2"></i> Filtres</h6>
    </div>
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-3">
                <select class="form-select" id="filterStatut" onchange="filtrerTable()">
                    <option value="">Tous les statuts</option>
                    <option value="en_attente">En attente</option>
                    <option value="en_cours">En cours</option>
                    <option value="termine">Terminé</option>
                    <option value="suspendu">Suspendu</option>
                    <option value="annule">Annulé</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filterPriorite" onchange="filtrerTable()">
                    <option value="">Toutes les priorités</option>
                    <option value="critique">Critique</option>
                    <option value="haute">Haute</option>
                    <option value="moyenne">Moyenne</option>
                    <option value="basse">Basse</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filterResponsable" onchange="filtrerTable()">
                    <option value="">Tous les responsables</option>
                    {% for responsable in responsables_uniques %}
                    <option value="{{ responsable.id }}">{{ responsable.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" onclick="resetFiltres()">
                    <i class="fas fa-redo me-1"></i> Réinitialiser
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistiques avec indicateur d'archives -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h3 class="text-primary">{{ stats.total }}</h3>
                <p class="text-muted mb-0">Actifs</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h3 class="text-warning">{{ stats.en_cours }}</h3>
                <p class="text-muted mb-0">En cours</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center border-success">
            <div class="card-body">
                <h3 class="text-success">{{ stats.termines }}</h3>
                <p class="text-muted mb-0">Terminés</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center border-danger">
            <div class="card-body">
                <h3 class="text-danger">{{ stats.en_retard }}</h3>
                <p class="text-muted mb-0">En retard</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center border-secondary">
            <div class="card-body">
                <h3 class="text-secondary">{{ stats.archives }}</h3>
                <p class="text-muted mb-0">Archives</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center border-info">
            <div class="card-body">
                <h3 class="text-info">{{ plans_action|length }}</h3>
                <p class="text-muted mb-0">Total affiché</p>
            </div>
        </div>
    </div>
</div>

<!-- Indicateur de vue actuelle -->
<div class="alert alert-{{ 'warning' if voir_archives else 'info' }} d-flex justify-content-between align-items-center mb-3">
    <div>
        <i class="fas fa-{{ 'archive' if voir_archives else 'eye' }} me-2"></i>
        {% if voir_archives %}
        <strong>Vue archives</strong> - Affichage des plans archivés
        {% else %}
        <strong>Vue active</strong> - Affichage des plans en cours
        {% endif %}
        <span class="badge bg-{{ 'warning' if voir_archives else 'info' }} ms-2">
            {{ plans_action|length }} plan(s)
        </span>
    </div>
    <div>
        {% if voir_archives %}
        <a href="{{ url_for('voir_plans_action_risque', risque_id=risque.id) }}" 
           class="btn btn-sm btn-info">
            <i class="fas fa-eye me-1"></i> Voir les actifs
        </a>
        {% else %}
        <a href="{{ url_for('voir_plans_action_risque', risque_id=risque.id, archives='oui') }}" 
           class="btn btn-sm btn-warning">
            <i class="fas fa-archive me-1"></i> Voir les archives ({{ stats.archives }})
        </a>
        {% endif %}
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Plans d'action pour le risque {{ risque.reference }} - {{ risque.intitule }}
            <span class="badge bg-{{ 'warning' if voir_archives else 'primary' }} ms-2">
                {{ plans_action|length }}
            </span>
            {% if voir_archives %}
            <span class="badge bg-warning ms-1">
                <i class="fas fa-archive"></i> Vue archives
            </span>
            {% endif %}
        </h6>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" onclick="exporterTable()">
                <i class="fas fa-download me-1"></i> Exporter
            </button>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown">
                    <i class="fas fa-eye me-1"></i> Vue
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a class="dropdown-item" href="{{ url_for('voir_plans_action_risque', risque_id=risque.id) }}">
                            <i class="fas fa-eye text-primary me-2"></i> Voir actifs
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('voir_plans_action_risque', risque_id=risque.id, archives='oui') }}">
                            <i class="fas fa-archive text-warning me-2"></i> Voir archives
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        {% if plans_action %}
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="plansTable">
                <thead class="table-light">
                    <tr>
                        <th width="10%">Référence</th>
                        <th width="20%">Nom</th>
                        <th width="10%">Statut</th>
                        <th width="10%">Priorité</th>
                        <th width="10%">Progression</th>
                        <th width="15%">Dates</th>
                        <th width="15%">Responsable</th>
                        <th width="10%" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plan in plans_action %}
                    <tr class="plan-row {% if plan.is_archived or plan.statut_archive|default('actif') == 'archive' %}table-secondary archive-row{% endif %}" 
                        data-plan-id="{{ plan.id }}"
                        data-statut="{{ plan.statut }}"
                        data-priorite="{{ plan.priorite }}"
                        data-responsable="{{ plan.responsable_id }}"
                        data-archived="{% if plan.is_archived or plan.statut_archive|default('actif') == 'archive' %}true{% else %}false{% endif %}"
                        data-statut-archive="{{ plan.statut_archive|default('actif') }}">
                        
                        <td>
                            {% if plan.is_archived or plan.statut_archive|default('actif') == 'archive' %}
                            <div class="d-flex align-items-center">
                                <i class="fas fa-archive text-secondary me-2" title="Archivé"></i>
                                <div>
                                    <strong class="text-muted">{{ plan.reference }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-alt"></i>
                                        {{ plan.updated_at.strftime('%d/%m/%Y') if plan.updated_at else 'Non daté' }}
                                    </small>
                                </div>
                            </div>
                            {% else %}
                            <strong class="text-dark">{{ plan.reference }}</strong>
                            {% endif %}
                        </td>
                        
                        <td>
                            <div class="fw-semibold {% if plan.is_archived or plan.statut_archive|default('actif') == 'archive' %}text-muted{% endif %}">
                                {{ plan.nom|truncate(40) }}
                            </div>
                            {% if plan.description %}
                            <small class="text-muted">{{ plan.description|truncate(60) }}</small>
                            {% endif %}
                        </td>
                        
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-{{ plan.couleur_statut }} me-2">
                                    {{ plan.statut|replace('_', ' ')|title }}
                                </span>
                                {% if plan.est_en_retard and not plan.is_archived %}
                                <i class="fas fa-exclamation-triangle text-danger" title="En retard"></i>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td>
                            {% if plan.priorite == 'critique' %}
                            <span class="badge bg-danger">{{ plan.priorite|title }}</span>
                            {% elif plan.priorite == 'haute' %}
                            <span class="badge bg-warning text-dark">{{ plan.priorite|title }}</span>
                            {% elif plan.priorite == 'moyenne' %}
                            <span class="badge bg-info">{{ plan.priorite|title }}</span>
                            {% elif plan.priorite == 'basse' %}
                            <span class="badge bg-secondary">{{ plan.priorite|title }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1" style="height: 10px;">
                                    <div class="progress-bar 
                                        {% if plan.progression_reelle >= 80 %}bg-success
                                        {% elif plan.progression_reelle >= 50 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                         style="width: {{ plan.progression_reelle }}%">
                                    </div>
                                </div>
                                <span class="ms-2 small">{{ plan.progression_reelle }}%</span>
                            </div>
                            {% if plan.sous_actions %}
                            <small class="text-muted">
                                {{ plan.sous_actions|selectattr('statut', 'equalto', 'termine')|list|length }}/{{ plan.sous_actions|length }}
                            </small>
                            {% endif %}
                        </td>
                        
                        <td>
                            <div class="small">
                                <div>Début: {{ plan.date_debut.strftime('%d/%m/%y') if plan.date_debut else '-' }}</div>
                                <div>Échéance: {{ plan.date_fin_prevue.strftime('%d/%m/%y') if plan.date_fin_prevue else '-' }}</div>
                                {% if plan.is_archived or plan.statut_archive|default('actif') == 'archive' %}
                                <div class="text-secondary">
                                    <small><i class="fas fa-archive"></i> Archivé: {{ plan.updated_at.strftime('%d/%m/%y') if plan.updated_at else '-' }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td>
                            {% if plan.responsable %}
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user me-2 text-muted"></i>
                                {{ plan.responsable.username }}
                            </div>
                            {% else %}
                            <span class="text-muted">Non assigné</span>
                            {% endif %}
                        </td>
                        
                        <td>
                            <div class="btn-group btn-group-sm d-flex justify-content-center">
                                <!-- Bouton Voir -->
                                <a href="{{ url_for('detail_plan_action_risque', plan_id=plan.id) }}" 
                                   class="btn btn-outline-primary" title="Voir">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if not voir_archives %}
                                <!-- Bouton Modifier - SEULEMENT dans la vue actifs -->
                                {% if plan.statut_archive|default('actif') == 'actif' %}
                                <a href="{{ url_for('modifier_plan_action_risque', plan_id=plan.id) }}" 
                                   class="btn btn-outline-warning" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                                
                                <!-- Bouton Archiver - SEULEMENT dans la vue actifs -->
                                <form method="POST" action="{{ url_for('archiver_plan_risque', plan_id=plan.id) }}" 
                                      class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-secondary" 
                                            title="Archiver"
                                            onclick="return confirm('Archiver le plan \'{{ plan.reference }}\' ?');">
                                        <i class="fas fa-archive"></i>
                                    </button>
                                </form>
                                
                                {% else %}
                                <!-- Bouton Désarchiver - SEULEMENT dans la vue archives -->
                                <form method="POST" action="{{ url_for('desarchiver_plan_risque', plan_id=plan.id) }}" 
                                      class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-success" 
                                            title="Désarchiver"
                                            onclick="return confirm('Désarchiver le plan \'{{ plan.reference }}\' ?');">
                                        <i class="fas fa-box-open"></i>
                                    </button>
                                </form>
                                
                                <!-- Bouton Supprimer - SEULEMENT dans la vue archives -->
                                <button class="btn btn-outline-danger" 
                                        title="Supprimer définitivement"
                                        onclick="supprimerPlan({{ plan.id }}, '{{ plan.reference }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            {% if voir_archives %}
            <i class="fas fa-archive fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">Aucun plan d'action archivé</h5>
            <p class="text-muted mb-4">Aucun plan d'action n'a été archivé pour ce risque.</p>
            <a href="{{ url_for('voir_plans_action_risque', risque_id=risque.id) }}" class="btn btn-info">
                <i class="fas fa-eye me-1"></i> Voir les plans actifs
            </a>
            {% else %}
            <i class="fas fa-tasks fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">Aucun plan d'action</h5>
            <p class="text-muted mb-4">Aucun plan d'action n'a été créé pour ce risque.</p>
            <a href="{{ url_for('nouveau_plan_action_pour_risque', risque_id=risque.id) }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Créer un premier plan d'action
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <!-- Pagination -->
    {% if plans_action|length > 10 %}
    <div class="card-footer">
        <nav aria-label="Navigation des plans">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Précédent</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Suivant</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Vue synthèse -->
<div class="card shadow mt-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Vue synthèse</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <canvas id="chartStatut" height="200"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="chartProgression" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Filtrage de la table
function filtrerTable() {
    const filterStatut = document.getElementById('filterStatut').value;
    const filterPriorite = document.getElementById('filterPriorite').value;
    const filterResponsable = document.getElementById('filterResponsable').value;
    
    const rows = document.querySelectorAll('.plan-row');
    
    rows.forEach(row => {
        const statut = row.getAttribute('data-statut');
        const priorite = row.getAttribute('data-priorite');
        const responsable = row.getAttribute('data-responsable');
        
        let afficher = true;
        
        // Filtre statut
        if (filterStatut && statut !== filterStatut) {
            afficher = false;
        }
        
        // Filtre priorité
        if (filterPriorite && priorite !== filterPriorite) {
            afficher = false;
        }
        
        // Filtre responsable
        if (filterResponsable && responsable !== filterResponsable) {
            afficher = false;
        }
        
        row.style.display = afficher ? '' : 'none';
    });
}

// Réinitialiser les filtres
function resetFiltres() {
    document.getElementById('filterStatut').value = '';
    document.getElementById('filterPriorite').value = '';
    document.getElementById('filterResponsable').value = '';
    filtrerTable();
}

// Exporter la table
function exporterTable() {
    // Simple export CSV
    let csv = 'Référence,Nom,Statut,Priorité,Progression,Début,Échéance,Responsable,Statut_Archive\n';
    
    document.querySelectorAll('.plan-row').forEach(row => {
        if (row.style.display !== 'none') {
            const cells = row.querySelectorAll('td');
            const rowData = Array.from(cells).slice(0, 7).map(cell => {
                let text = cell.textContent.trim();
                // Nettoyer le texte pour CSV
                text = text.replace(/\n/g, ' ').replace(/,/g, ';');
                return `"${text}"`;
            });
            
            // Ajouter le statut d'archive
            const isArchived = row.getAttribute('data-archived') === 'true';
            rowData.push(`"${isArchived ? 'Archivé' : 'Actif'}"`);
            
            csv += rowData.join(',') + '\n';
        }
    });
    
    // Créer et télécharger le fichier
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `plans-action-risque-{{ risque.reference }}-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Actions rapides (pour les plans actifs seulement)
function changerStatutRapide(planId) {
    const html = `
        <form id="formStatutRapide">
            <div class="mb-3">
                <label class="form-label">Nouveau statut :</label>
                <select class="form-select" name="statut" required>
                    <option value="en_attente">En attente</option>
                    <option value="en_cours">En cours</option>
                    <option value="termine">Terminé</option>
                    <option value="suspendu">Suspendu</option>
                    <option value="annule">Annulé</option>
                </select>
            </div>
        </form>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('genericModal'));
    document.getElementById('genericModalTitle').innerHTML = 'Changer statut du plan';
    document.getElementById('genericModalBody').innerHTML = html;
    document.getElementById('genericModalFooter').innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="confirmerChangerStatut(${planId})">
            Enregistrer
        </button>
    `;
    modal.show();
}

function confirmerChangerStatut(planId) {
    const statut = document.querySelector('#formStatutRapide select').value;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '{{ csrf_token() }}';
    
    fetch(`/plan-action-risque/${planId}/changer-statut-rapide`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ statut: statut })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('genericModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur réseau');
    });
}

// Fonction pour supprimer définitivement un plan (ARCHIVES SEULEMENT)
function supprimerPlan(planId, reference) {
    const confirmationMessage = `Êtes-vous sûr de vouloir supprimer DÉFINITIVEMENT le plan d'action archivé "${reference}" ?\n\n⚠️ Cette action est irréversible !\n\nLe plan et toutes ses sous-actions associées seront définitivement supprimés.`;
    
    if (confirm(confirmationMessage)) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '{{ csrf_token() }}';
        
        fetch(`/plan-action-risque/${planId}/supprimer`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher un message de succès
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                alertDiv.style.zIndex = '1050';
                alertDiv.innerHTML = `
                    <strong>✅ Suppression réussie !</strong> Le plan a été supprimé définitivement.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Fermer l'alerte après 3 secondes
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }, 3000);
                
                // Rafraîchir la page après un court délai
                setTimeout(() => {
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        location.reload();
                    }
                }, 1000);
            } else {
                alert('❌ Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Erreur réseau lors de la suppression');
        });
    }
}

// Graphiques
document.addEventListener('DOMContentLoaded', function() {
    // Graphique des statuts
    const ctxStatut = document.getElementById('chartStatut');
    if (ctxStatut) {
        const plansAffiches = {{ plans_action_json|tojson|safe }};
        
        const statuts = {
            'en_attente': plansAffiches.filter(p => p.statut === 'en_attente').length,
            'en_cours': plansAffiches.filter(p => p.statut === 'en_cours').length,
            'termine': plansAffiches.filter(p => p.statut === 'termine').length,
            'suspendu': plansAffiches.filter(p => p.statut === 'suspendu').length,
            'annule': plansAffiches.filter(p => p.statut === 'annule').length
        };
        
        new Chart(ctxStatut, {
            type: 'doughnut',
            data: {
                labels: ['En attente', 'En cours', 'Terminé', 'Suspendu', 'Annulé'],
                datasets: [{
                    data: Object.values(statuts),
                    backgroundColor: [
                        '#6c757d',
                        '#ffc107',
                        '#198754',
                        '#6610f2',
                        '#dc3545'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: '{{ "Répartition par statut (archives)" if voir_archives else "Répartition par statut (actifs)" }}'
                    }
                }
            }
        });
    }
    
    // Graphique de progression
    const ctxProgression = document.getElementById('chartProgression');
    if (ctxProgression) {
        const plansAffiches = {{ plans_action_json|tojson|safe }};
        
        const progressions = {
            '0-25': plansAffiches.filter(p => (p.progression_reelle || 0) <= 25).length,
            '26-50': plansAffiches.filter(p => (p.progression_reelle || 0) > 25 && (p.progression_reelle || 0) <= 50).length,
            '51-75': plansAffiches.filter(p => (p.progression_reelle || 0) > 50 && (p.progression_reelle || 0) <= 75).length,
            '76-99': plansAffiches.filter(p => (p.progression_reelle || 0) > 75 && (p.progression_reelle || 0) < 100).length,
            '100': plansAffiches.filter(p => (p.progression_reelle || 0) === 100).length
        };
        
        new Chart(ctxProgression, {
            type: 'bar',
            data: {
                labels: ['0-25%', '26-50%', '51-75%', '76-99%', '100%'],
                datasets: [{
                    label: 'Nombre de plans',
                    data: Object.values(progressions),
                    backgroundColor: '{{ "#ffc107" if voir_archives else "#0d6efd" }}'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: '{{ "Distribution de la progression (archives)" if voir_archives else "Distribution de la progression" }}'
                    }
                }
            }
        });
    }
});
</script>

<style>
.archive-row {
    opacity: 0.9;
}

.archive-row:hover {
    background-color: #f8f9fa !important;
    opacity: 1;
}

.fa-archive {
    color: #6c757d;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.archive-row .btn-outline-warning {
    opacity: 0.7;
}

.archive-row .btn-outline-warning:hover {
    opacity: 1;
}

/* Style pour les boutons d'action */
.btn-group .btn {
    border-radius: 4px !important;
}

.btn-group .btn:not(:last-child) {
    margin-right: 2px;
}

/* Style spécifique pour le bouton supprimer dans les archives */
.btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
}

/* Animation pour la suppression */
@keyframes fadeOutDelete {
    from { 
        opacity: 1;
        transform: scale(1);
    }
    to { 
        opacity: 0;
        transform: scale(0.95);
    }
}

.delete-animation {
    animation: fadeOutDelete 0.5s ease forwards;
}
</style>
{% endblock %}